{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}
{{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}

{%- style -%}
    .tooltip {
      position: absolute;
      text-align: center;
      width: 120px;
      height: 45px;
      padding: 2px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0;
      border-radius: 8px;
      pointer-events: none;
    }

    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    }


    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    }
    .image-with-text p {
      text-align: left;
      hyphens: auto;
      -webkit-hyphens: auto;
    }
    .border {
      border: 0.2rem solid #17161c;
    }
    .bordertop {
      border-top: 0.2rem solid #17161c;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      border: none !important;
      border-top: 0.2rem solid #17161c !important;
    }
    td {
      border: none !important;
      /* border-top: 0.2rem solid #17161c !important; */
    }
    .report-type-container {
      border-top: 0.2rem solid #17161c;
    }
    .report-type-container:first-child {
      border-top: none;
    }

    .flex-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-header {
      text-decoration: underline; /* Underline the text */
      cursor: pointer; /* Change cursor to a hand pointer */
      margin-left: 10px;
    }
    .icons {
      margin-left: auto;
      margin-right: 0;
      flex-grow: 0;
      flex-shrink: 0;
      width: 35%; /* occupies 30% of the flex container */
      justify-content: flex-end; /* aligns icons to the right within their space */
      display: flex;
    }

    .arrow {
      margin-left: 10px;
      margin-right: 10px; /* Optional: Add some space between the arrow and the text */
      transition: transform 0.3s ease;
    }

    .icons i {
      margin-left: 10px;
      cursor: pointer;
    }

    .flex-header.rotated .arrow {
      transform: rotate(90deg);
    }
    .trashcan,
    .info {
      cursor: pointer;
    }
    .nonlivedata {
      display: block;
    }
    .livedata {
      display: none;
    }

    .toggle-container {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
      /* margin-left: 10px; */
      vertical-align: middle;
      margin: auto;
      flex-shrink: 0;
  }

  .toggle-container input {
      opacity: 0;
      width: 0;
      height: 0;
  }

  .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
  }

  .toggle-slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
  }

  input:checked + .toggle-slider {
      background-color: #2255ff;
  }

  input:focus + .toggle-slider {
      box-shadow: 0 0 1px #2255ff;
  }

  input:checked + .toggle-slider:before {
      transform: translateX(26px);
  }
    .toggle-options {
    align-items: center;
    display: flex;
  }
  div.display-flex {
      display: flex;
      align-items: center; /* Align items vertically in the middle */
      justify-content: flex-start; /* Align items to the start of the container */
      gap: 10px; /* Adjust as needed, adds space between children */
  }


#tabs-container {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
    overflow-x: auto;
}

.tab-button, .tab-button-credentials {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

.tab-button:hover, .tab-button-credentials:hover {
    background-color: #eaeaea;
}

.tab-button.active, .tab-button-credentials.active {
    background-color: #2255ff;
    color: #fafafa;
    font-weight: bold;
}

.tab-button, .tab-button-credentials {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

  .tab {
      cursor: pointer;
      padding: 10px;
      margin-right: 5px;
      background-color: #f1f1f1;
      border: solid 1px #ccc;
      border-bottom: none;
    }
    .tab:hover {
      background-color: #ddd;
    }
    .tab-content {
      border: solid 1px #ccc;
      padding: 10px;
      display: none;
    }
    .active, .tab:hover {
      background-color: #2255FF;
      color: #fafafa;
    }

  #countrySelectionContainer {
    display: none; /* Start hidden */
    position: relative; /* Position it below the icon or wherever it fits */
    background-color: #fff;
    top: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    z-index: 1; /* Make sure it's above other content */
    border-radius: 1rem;
  }

  #countrySelectionContainer ul {
    list-style: none; /* Remove default list styling */
    margin: 0;
    padding: 0;
  }

  #countrySelectionContainer li {
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer; /* Change cursor on hover */
  }

  #countrySelectionContainer li:hover {
    background-color: #f6f6f6;
  }
  #countrySelectionContainer li:last-child {
    border-bottom: none;
  }

 
  .setting {
    width: fit-content;
  }

  .setting-item {
    position: relative;
  }

  .setting-item label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    position: relative;
    cursor: pointer;
  }

  .setting-item input[type="text"],
  .setting-item select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-sizing: border-box;
  }

  .setting-item input[type="checkbox"] {
    margin-right: 10px;
  }

  .tooltip {
    display: none;
    position: absolute;
    background-color: #555;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    z-index: 1;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 10px;
    opacity: 0;
    transition: opacity 0.3s;
    width: 200px;
  }

  .setting-item label:hover .tooltip {
    display: block;
    opacity: 1;
  }
  .subentry {
    display: none;
    margin-left: 20px;
  }
  
#tabs-container {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
    overflow-x: auto;
}


#user-icon svg {
  height: 25px;
  width: 25px;
}
.button-container {
  padding-bottom: 2rem;
  display: flex;
}
{%- endstyle -%}
{% if customer.tags contains 'member' %}
  <!-- Load d3.js -->
  <!-- <script src="https://d3js.org/d3.v4.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  
{% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> {% endcomment %}
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>-->
{% comment %} <script src="https://code.jquery.com/jquery-3.6.0.js"></script> {% endcomment %}
{% comment %} <script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"></script> {% endcomment %}
{% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> {% endcomment %}
{% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script> {% endcomment %}
{% comment %} <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" /> {% endcomment %}
  {% comment %} {% render 'forsure-guide' %} {% endcomment %}
  {% render 'forsure-simple-notification' %}
  <div class="section-{{ section.id }}-padding">
    <div style="padding-bottom: 5rem;display: none;" id="generalSettingsContainer">
      <div class="configbox page-width border" style="padding: 0;border-radius:1rem;padding:3px;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
          <h2>Configure General Settings</h2>
          <div style="display: flex; align-items: center;">
            <div id="user-icon"  style="cursor: pointer;background: #fafafa;padding-top: 5px;margin-right: 1rem;" onclick="window.location.href='/account?logged_in'">
              {% render 'icon-user' %}
            </div>
            <h5 style="text-decoration: underline;cursor: pointer;margin-right: 2rem;" onclick="window.location.href='/account?logged_in'">{{ customer.email }}</h5>
          </div>
        </div>
        <div class="display-flex" style="margin: auto;width: fit-content;display:flex"></div>
        <div id="generalConfig" class="bordertop page-width" style="background-color: #fafafa;">
          <div style="display: none" >
            <h3 style="width: 50%;display:flex;align-items:center;gap:3rem">Demo Data<div style="background-color: #2255ff;color:#fafafa;padding:0.5rem;border-radius:1rem;" id="demoDataStatus"></div></h3>
            <div style="margin: auto;margin-right: 2rem;display:flex;gap:2rem">
              <button class="button" id="createDemoDataButton" onclick="createDemoData()" style="display:none;">Create Demo Data</button>
              <button class="button" id="deleteDemoDataButton" onclick="deleteDemoData()" style="display:none;background-color:red;">Delete Demo Data</button>
            </div>
          </div>
          <hr style="width: 100%; border-top: 0.2rem solid #17161c;display:none;">
          <h3 class="flex-header" style="margin-left: 2rem">Company Information
          </h3>
          <div id="configurationGeneral" style="border-radius: 10px; background-color: #fafafa;position:relative;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd;">Setting</th>
                  <th style="text-align: left; padding: 10px; border-bottom: 1px solid #ddd;">Value</th>
                </tr>
              </thead>
              <tbody id="settingsTableBody">
                <!-- General Settings Inputs will be dynamically inserted here -->
              </tbody>
            </table>
            <div class="button-container">
              <button
                id="submitChanges"
                class="button"
                style="display: flex;margin-left: auto;"
                onclick="submitSettings()"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>

    async function createDemoData() {
      try {
        let data = await unifiedSendRequest(DEMODATA, { method: 'POST' });
        getDemoDataStatus();
      } catch (error) {
        console.error(error.message);
      }
    }

    async function deleteDemoData() {
      try {
        let data = await unifiedSendRequest(DEMODATA, { method: 'DELETE' });
        getDemoDataStatus();
      } catch (error) {
        console.error(error.message);
      }
    }

    async function getDemoDataStatus() {
      try {
        let data = await unifiedSendRequest(DEMODATASTATUS, { method: 'GET' });
        if (data) {
          document.getElementById('demoDataStatus').textContent = 'Active';
          document.getElementById('demoDataStatus').style.backgroundColor = '#2255ff';
          document.getElementById('createDemoDataButton').innerHTML = 'Recreate Demo Data';
          document.getElementById('createDemoDataButton').style.display = 'block';
          document.getElementById('deleteDemoDataButton').style.display = 'block';
        } else {
          document.getElementById('demoDataStatus').textContent = 'Inactive';
          document.getElementById('demoDataStatus').style.backgroundColor = '#ccc';
          document.getElementById('createDemoDataButton').innerHTML = 'Create Demo Data';
          document.getElementById('createDemoDataButton').style.display = 'block';
          document.getElementById('deleteDemoDataButton').style.display = 'none';
        }
      } catch (error) {
        console.error(error.message);
      }
    }
    
    async function getGeneralSettingsDefinition() {
      try {
        let data = await unifiedSendRequest(GETGENERALSETTINGSDEFINITION, { method: 'GET' });
        return data;  
      } catch (error) {
        console.error(error.message);
        showMessage('Failed to get settings definition ' + error.message, false);
      }
    }

    async function getGeneralSettings() {
      try {
        let data = await unifiedSendRequest(GETGENERALCONFIG, { method: 'GET' });
        return data;
      } catch (error) {
        console.error(error.message);
        showMessage('Failed to get settings definition ' + error.message, false);
      }
    }

    {% comment %} async function getAvailableCountriesSettings() {
      try {
        let data = await unifiedSendRequest(GETGENERALCONFIGCOUNTRY, { method: 'GET' });
        return data;
      } catch (error) {
        console.error(error.message);
        showMessage('Failed to get settings definition ' + error.message, false);
      }
    } {% endcomment %}

var generalSettingsDefinition;
var generalSettings;
var availableCountriesSettings = {};
  
async function initializeSettings() {
  try {
    document.getElementById('generalSettingsContainer').style.display = 'block';
    generalSettingsDefinition = await getGeneralSettingsDefinition();
    generalSettings = await getGeneralSettings();
    {% comment %} availableCountriesSettings = await getAvailableCountriesSettings(); {% endcomment %}
    {% comment %} await getDemoDataStatus(); {% endcomment %}

    renderGeneralSettings();
    {% comment %} await renderCountryTabs(availableCountriesSettings); {% endcomment %}
  } catch (error) {
    console.error('Failed to initialize settings:', error);
  }
}
  
function renderGeneralSettings() {
  const settingsTableBody = document.getElementById('settingsTableBody');
  settingsTableBody.innerHTML = '';

  generalSettingsDefinition.forEach(setting => {
    const currentValue = generalSettings[setting.key] || '';
    let inputElement;

    if (setting.input_type === 'input') {
      if (typeof setting.default === 'number') {
        inputElement = `<input class=\"setting form-control\" type=\"number\" id=\"${setting.key}\" name=\"${setting.key}\" value=\"${currentValue}\" placeholder=\"${setting.default}\">`;
      } else {
        inputElement = `<input class=\"setting form-control\" type=\"text\" id=\"${setting.key}\" name=\"${setting.key}\" value=\"${currentValue}\" placeholder=\"${setting.default}\">`;
      }
    } else if (setting.input_type === 'checkbox') {
      inputElement = `<input class=\"setting\" type=\"checkbox\" id=\"${setting.key}\" name=\"${setting.key}\" ${currentValue ? 'checked' : ''} onchange=\"toggleSubentries('${setting.key}', this.checked)\">`;
    }

    settingsTableBody.innerHTML += `
      <tr class=\"setting-item\" data-key=\"${setting.key}\">
        <td><label style="width: fit-content;">${setting.title}<div class=\"tooltip\">${setting.description}</div></label></td>
        <td>${inputElement}</td>
      </tr>
    `;
  });

  // Initialize subentry visibility based on current checkbox state
  generalSettingsDefinition.forEach(setting => {
    if (setting.input_type === 'checkbox' && setting.subentries) {
      const control = document.getElementById(setting.key);
      toggleSubentries(setting.key, control.checked);
    }
  });
}
  
function toggleSubentries(key, isChecked) {
  const def = generalSettingsDefinition.find(s => s.key === key);
  const trueSubs = (def.subentries && def.subentries.true) || [];
  const falseSubs = (def.subentries && def.subentries.false) || [];

  // Show true subentries when checked, hide when unchecked
  trueSubs.forEach(subKey => {
    const row = document.getElementById(`subentry-${subKey}`);
    if (row) row.style.display = isChecked ? 'table-row' : 'none';
  });

  // Show false subentries when unchecked, hide when checked
  falseSubs.forEach(subKey => {
    const row = document.getElementById(`subentry-${subKey}`);
    if (row) row.style.display = !isChecked ? 'table-row' : 'none';
  });
}

{% comment %} 
async function openClientsModal() {
  var clientDataNew = await getClientsFile();
  document.getElementById('editClientsModal').style.display = 'block';
  document.getElementById('clientsModalOverlay').style.display = 'block';

  if (!clientDataNew) {
      console.error('No client data to display.');
      return;
  }

  // Parse JSON data into an HTML table
  const tabsContainer = document.getElementById('tabs-container');
  const dataContainer = document.getElementById('clientsDatatableContainer');
  tabsContainer.innerHTML = '';
  dataContainer.innerHTML = '';

  const countries = Object.keys(clientDataNew);
  console.log(countries);
  countries.forEach((country, index) => {
      const tabButton = document.createElement('button');
      tabButton.textContent = country;
      tabButton.className = 'tab-button-credentials';
      tabButton.style.margin = '5px';
      tabButton.dataset.country = country;

      tabButton.addEventListener('click', () => {
          dataContainer.innerHTML = '';
          highlightActiveTab(index);
          renderCountryData(clientDataNew[country], country);
      });

      tabsContainer.appendChild(tabButton);
  });

  // Auto-click the first tab if available
  if (countries.length > 0) {
      document.querySelector('.tab-button-credentials').click();
  } {% endcomment %}

  {% comment %} function highlightActiveTab(activeIndex) {
      const buttons = document.querySelectorAll('.tab-button-credentials');
      buttons.forEach((btn, index) => {
          btn.classList.toggle('active', index === activeIndex);
      });
  } {% endcomment %}
{% comment %} 
  function renderCountryData(data, country) {
      data = data.map(row => ({
          ...row,
          country: country
      }));
      if (data.length === 0) {
          dataContainer.innerHTML = '<p>No client data available for this country.</p>';
          return;
      }

      // Dynamically determine columns
      const dynamicColumns = Object.keys(data[0])
          .filter(key => key !== 'client')
          .reduce((acc, field) => {
              const baseField = field.split(' ')[1] + ' ' + field.split(' ').slice(2).join(' '); // Scheme + Wastestream
              if (!acc[baseField]) acc[baseField] = {};
              if (field.startsWith('Login')) acc[baseField]['Login'] = field;
              if (field.startsWith('Password')) acc[baseField]['Password'] = field;
              if (field.startsWith('Notes')) acc[baseField]['Notes'] = field;
              if (field.startsWith('ExtraInfo')) acc[baseField]['ExtraInfo'] = field;
              return acc;
          }, {});

      // Generate Tabulator column definitions
      const columns = [{ title: 'Client', field: 'client', headerSort: false, editor: 'input' },
                       { title: 'Country', field: 'country', headerSort: false, visible: false }];
      Object.keys(dynamicColumns).forEach((key) => {
          const group = dynamicColumns[key];
          if (group.Login) columns.push({ title: `Login ${key}`, field: group.Login, headerSort: false, editor: 'input' });
          if (group.Password) columns.push({ title: `Password ${key}`, field: group.Password, headerSort: false, editor: 'input',
            formatter: (cell) => {
                const value = cell.getValue();
                return `<div class="blurred" title="Content blurred for privacy">${value}</div>`;
            }
          });
          if (group.Notes) columns.push({ title: `Notes ${key}`, field: group.Notes, headerSort: false, editor: 'input' });
          if (group.ExtraInfo) columns.push({ title: `Extra Info ${key}`, field: group.ExtraInfo, headerSort: false, editor: 'input' });
      });

      const table = new Tabulator("#clientsDatatableContainer", {
          data: data,
          layout: "fitDataFill",
          pagination: data.length > 10,
          paginationSize: 10,
          columns: columns,
      });
      datatable = table;
  }
}

async function getClientsFile() {
  try {
        const data = await unifiedSendRequest(CLIENTSFILE, {method: 'GET'});
        // Check if an error message already exists
        if (data['status_code'] === 200) {
          return data['data']['data'];
        }
    } catch (error) {
        console.error(error);
        showMessage('Failed to fetch clients file ' + error.message, false);
    }
}

function closeClientsModal() {
  document.getElementById('editClientsModal').style.display = 'none';
  document.getElementById('clientsModalOverlay').style.display = 'none';
}

var pros = null;
async function addNewPRO() {
  try {
    document.body.style.cursor = 'wait';
    pros = await unifiedSendRequest(GETPROS, { method: 'GET' });
    renderCountryDropdown();
    document.body.style.cursor = 'default';
  } catch (error) {
    console.error(error);
    showMessage('Failed to get pros', false);
    document.body.style.cursor = 'default';
  }
  document.getElementById('addPROModal').style.display = 'block';
  document.getElementById('addPROModalOverlay').style.display = 'block';
}

function closeAddPROModal() {
  document.getElementById('addPROModal').style.display = 'none';
  document.getElementById('addPROModalOverlay').style.display = 'none';
}

function renderCountryDropdown() {
  const countrySelect = document.getElementById('countrySelect');
  countrySelect.innerHTML = '';
  countrySelect.appendChild(document.createElement('option'));
  countrySelect.options[0].value = '';
  countrySelect.options[0].textContent = 'Select Country';
  Object.keys(pros).forEach(country => {
    const option = document.createElement('option');
    option.value = country;
    option.textContent = country;
    countrySelect.appendChild(option);
  });
  countrySelect.onchange = function () {
    renderWastestreamDropdown(countrySelect.value);
  };
  document.getElementById('wastestreamSelect').value = '';
  document.getElementById('schemeSelect').value = '';
  document.getElementById('wastestreamSelect').disabled = true;
  document.getElementById('schemeSelect').disabled = true;
  $('.selectpicker').selectpicker('refresh');
}

function renderWastestreamDropdown(country) {
  const wastestreamSelect = document.getElementById('wastestreamSelect');
  document.getElementById('wastestreamSelect').disabled = false;
  wastestreamSelect.innerHTML = '';
  wastestreamSelect.appendChild(document.createElement('option'));
  wastestreamSelect.options[0].value = '';
  wastestreamSelect.options[0].textContent = 'Select Wastestream';
  Object.keys(pros[country]).forEach(wastestream => {
    const option = document.createElement('option');
    option.value = wastestream;
    option.textContent = wastestream;
    wastestreamSelect.appendChild(option);
  });
  wastestreamSelect.onchange = function () {
    renderSchemeDropdown(country, wastestreamSelect.value);
  }
  document.getElementById('schemeSelect').value = '';
  document.getElementById('schemeSelect').disabled = true;
  $('.selectpicker').selectpicker('refresh');
}

function renderSchemeDropdown(country, wastestream) {
  const schemeSelect = document.getElementById('schemeSelect');
  document.getElementById('schemeSelect').disabled = false;
  schemeSelect.innerHTML = '';
  schemeSelect.appendChild(document.createElement('option'));
  schemeSelect.options[0].value = '';
  schemeSelect.options[0].textContent = 'Select Scheme';
  // list of schemes
  const schemes = pros[country][wastestream];
  // sort schemes by name
  schemes.sort((a, b) => a.localeCompare(b));
  // add schemes to dropdown
  schemes.forEach((scheme, idx) => {
    const option = document.createElement('option');
    option.value = scheme;
    option.textContent = scheme;
    schemeSelect.appendChild(option);
  });
  $('.selectpicker').selectpicker('refresh');
} {% endcomment %}


{% comment %} async function saveAddPRO() {
  try {
    const login = document.getElementById('loginInput').value;
    const password = document.getElementById('passwordInput').value;
    const notes = document.getElementById('notesInput').value;
    const extraInfo = document.getElementById('extraInfoInput').value;
    const country = document.getElementById('countrySelect').value;
    const wastestream = document.getElementById('wastestreamSelect').value;
    const scheme = document.getElementById('schemeSelect').value;
    const formData = new FormData();
    formData.append('country', country);
    formData.append('wastestream', wastestream);
    formData.append('scheme', scheme);
    formData.append('login', login);
    formData.append('password', password);
    formData.append('notes', notes);
    formData.append('extra_info', extraInfo);
    const data = await unifiedSendRequest(CLIENTSFILEADD, { formData: formData });
    if (data['success']) {
      showMessage('PRO added successfully', true);
      closeAddPROModal();
      openClientsModal();
    } else if (data['success'] == false) {
      showMessage(data['detail'], false);
    } else {
      showMessage('Failed to add PRO', false);
    }
  } catch (error) {
    console.error('Failed to save PRO:', error);
    showMessage('Failed to save PRO', false);
  }
} {% endcomment %}


{% comment %} async function saveClientsEdits() {
  try {
      // Get Tabulator instance
      const table = datatable;

      // Retrieve all data from the table without transformation
      let data = table.getData();

      // Convert all inputs to strings and replace null with ''
      const formattedData = data.map(entry => {
          const updatedEntry = {};
          for (const key in entry) {
              if (entry.hasOwnProperty(key)) {
                  let val = entry[key] === null ? '' : String(entry[key]);
                  val = val.replace('undefined', '');
                  updatedEntry[key] = val;
              }
              entry['country'] = document.getElementsByClassName('tab-button-credentials active')[0].getAttribute('data-country');
          }
          return updatedEntry;
      });
      console.log(formattedData);
      // Send the raw data to the backend
      const response = await unifiedSendRequest(CLIENTSFILEUPDATE, {
          formData: JSON.stringify({ clients: formattedData }),
          headerArgs: { 'Content-Type': 'application/json' }
      });

      // Handle response
      if (response.status_code === 200) {
          showMessage('Clients data saved successfully.', true);
          closeClientsModal();
      } else {
          console.error('Error saving data:', response);
          showMessage('Failed to save clients data.', false);
      }
  } catch (error) {
      console.error('Error in saveClientsEdits:', error);
      showMessage('Failed to save clients data: ' + error.message, false);
  }
} {% endcomment %}

  
{% comment %} async function renderCountryTabs(availableCountriesSettings) {
    const countryTabs = document.getElementById('countryTabs');
    countryTabs.innerHTML = '';
    Object.keys(availableCountriesSettings).forEach(country => {
      if (availableCountriesSettings[country].recommended) {
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.classList.add('tab-button');
        tab.textContent = country;
        tab.onclick = async () => {
          await selectCountry(tab, country);
        };
        countryTabs.appendChild(tab);
      }
    });

    const addCountryTab = document.createElement('div');
    addCountryTab.className = 'tab';
    addCountryTab.classList.add('tab-button');
    addCountryTab.textContent = 'Add Country';
    addCountryTab.onclick = () => showCountrySelection();
    countryTabs.appendChild(addCountryTab);
  } {% endcomment %}

  {% comment %} function showCountrySelection() {
    const container = document.getElementById('countrySelectionContainer');
    const alreadySelected = [...document.getElementById('countryTabs').querySelectorAll('.tab')].map(tab => tab.textContent);
    const avail = Object.keys(availableCountriesSettings).filter(country => !availableCountriesSettings[country].recommended && !alreadySelected.includes(country));
    if (avail.length === 0) {
      showMessage('No available countries, please contact support at info@for-sure.net if you need to add a country.', false);
      return;
    }
    container.innerHTML = '<ul>' + avail.map(country => `
      <li onclick="addCountry('${country}')">${country}</li>
    `).join('') + '</ul>';
    container.style.display = 'block';
    container.addEventListener('clickOutside', () => {
      container.style.display = 'none';
    });
  } {% endcomment %}

  {% comment %} async function addCountry(country) {
    // Logic to add the selected country
    const countryTabs = document.getElementById('countryTabs');
    const tab = document.createElement('div');
    tab.className = 'tab';
    tab.classList.add('tab-button');
    tab.textContent = country;
    tab.onclick = async () => {
      await selectCountry(tab, country);
    };
    tab.click();
    countryTabs.insertBefore(tab, countryTabs.firstChild);
    // Hide the selection container after adding
    document.getElementById('countrySelectionContainer').style.display = 'none';
  } {% endcomment %}


  {% comment %} async function selectCountry(tab, country) {
    try {
      // remove active class from all tabs
      countryTabs.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      tab.classList.add('active');
      const container = document.getElementById('reportDataContainer');
      container.style.border = '0.2rem solid #17161c';
      container.style.borderRadius = '8px';
      container.style.overflow = 'hidden';
      container.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.1)';
      container.innerHTML = ''; // Clear previous content
      var labels = await getCountryLabels(country);
      Object.keys(availableCountriesSettings[country]).forEach(reportType => {
        if (reportType === 'recommended') {
          return;
        }
        const reportTypeContainer = document.createElement('div');  
        reportTypeContainer.className = 'report-type-container';
        const reportHeader = document.createElement('h4');
        reportHeader.style.textAlign = 'center';
        reportHeader.textContent = reportType;
        reportTypeContainer.appendChild(reportHeader);
        
        const pros = availableCountriesSettings[country][reportType];
        const optionsTable = document.createElement('table');
        optionsTable.className = 'options-table';
        const optionsTableRow = document.createElement('tr');
        optionsTableRow.className = 'options-table-row';
        const placeholder = document.createElement('td');
        placeholder.style.width = '15%';
        placeholder.style.padding = '2rem';
        optionsTableRow.appendChild(placeholder);
        const label = document.createElement('td');
        label.style.height = '6rem';
        label.style.padding = '2rem';
        label.style.width = '35%';
        label.textContent = 'PRO';
        optionsTableRow.appendChild(label);
        const proSelectContainer = document.createElement('td');
        proSelectContainer.style.padding = '2rem';
        proSelectContainer.style.display = 'flex';
        proSelectContainer.style.alignItems = 'center';
        const proSelect = document.createElement('select');
        proSelect.className = 'pro-select selectpicker';
        proSelect.style.padding = '0.5rem';
        proSelect.onchange = async () => {
          const selectedPro = proSelect.value;
          renderProLabels(labels[reportType][selectedPro], optionsTable, country, reportType);
        };
        pros.forEach(pro => {
          const option = document.createElement('option');
          option.value = pro;
          option.textContent = pro;
          proSelect.appendChild(option);
        });
        proSelectContainer.appendChild(proSelect);
        optionsTableRow.appendChild(proSelectContainer);
        const placeholder2 = document.createElement('td');
        placeholder2.style.width = '15%';
        placeholder2.style.padding = '2rem';
        optionsTableRow.appendChild(placeholder2);
        optionsTable.appendChild(optionsTableRow);
        reportTypeContainer.appendChild(optionsTable);
        var proLabels = labels[reportType][proSelect.value];
        renderProLabels(proLabels, optionsTable, country, reportType);
        container.appendChild(reportTypeContainer);
      });
      $('.selectpicker').selectpicker('refresh');
    } catch (error) {
      console.error('Failed to get country labels:', error);
    }
  } {% endcomment %}

  {% comment %} function renderProLabels(proLabels, proLabelContainer, country, reportType) {
    // remove all children of proLabelContainer except the class options-table-row
    for (let i = proLabelContainer.children.length - 1; i >= 0; i--) {
      if (proLabelContainer.children[i].className !== 'options-table-row') {
        proLabelContainer.removeChild(proLabelContainer.children[i]);
      }
    } 
    Object.keys(proLabels).forEach(key => {
      const field = proLabels[key];
      const fieldContainer = document.createElement('tr');
      fieldContainer.className = 'field-container';
      const placeholder = document.createElement('td');
      placeholder.style.width = '15%';
      placeholder.style.padding = '2rem';
      fieldContainer.appendChild(placeholder);
      const label = document.createElement('td');
      label.style.height = '6rem';
      label.style.padding = '2rem';
      label.style.width = '35%';
      label.textContent = field.title;
      label.title = field.description;
      fieldContainer.appendChild(label);

      let inputElement;
      const optionContainer = document.createElement('td');
      optionContainer.style.padding = '2rem';
      optionContainer.style.display = 'flex';
      optionContainer.style.alignItems = 'center';
      if (field.input_type === 'dropdown') {
        inputElement = document.createElement('select');
        inputElement.className = 'selectpicker';
        inputElement.style.padding = '0.5rem';
        field.options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          inputElement.appendChild(optionElement);
        });
      } else if (field.input_type === 'select') {
        inputElement = document.createElement('select');
        inputElement.className = 'selectpicker';
        inputElement.style.padding = '0.5rem';
        field.options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option['name'];
          optionElement.textContent = option['name'];
          inputElement.appendChild(optionElement);
        });
      } else if (field.input_type === 'input' || field.input_type === 'text') {
        inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.value = field.default || '';
      } else if (field.input_type === 'textarea') {
        inputElement = document.createElement('textarea');
        inputElement.value = field.default || '';
      } else if (field.input_type === 'checkbox') {
        inputElement = document.createElement('input');
        inputElement.type = 'checkbox';
        inputElement.checked = field.default || false;
      }

      // Add data attributes for later data collection
      inputElement.setAttribute('data-category', reportType);
      inputElement.setAttribute('data-country', country);
      inputElement.setAttribute('data-name', field.key);
      optionContainer.appendChild(inputElement);
      const placeholder3 = document.createElement('td');
      placeholder3.style.width = '15%';
      placeholder3.style.padding = '2rem';
      fieldContainer.appendChild(optionContainer);
      fieldContainer.appendChild(placeholder3);
      proLabelContainer.appendChild(fieldContainer);
    });
    $('.selectpicker').selectpicker('refresh');
  } {% endcomment %}

  async function submitSettings() {
    const reportDataContainer = document.getElementById('reportDataContainer');
    const formElements = reportDataContainer.querySelectorAll("input, select");  // Get both inputs and selects
    const dataToSend = { countries: {} };
    for (const entry of document.querySelectorAll(".setting")) {
      key = entry.getAttribute('name');
      if (entry.type === "checkbox") {
        // actual boolean
        value = entry.checked;
      } else {
        // text, number, etc.
        value = entry.value;
      }
      if (entry.type === "number") {
        value = parseInt(value);
      }
      if (value !== null && !isNaN(value)) {
        dataToSend[key] = value;
      }
    }
  
    formElements.forEach(element => {
      const category = element.getAttribute('data-category');
      const country = element.getAttribute('data-country');
      const inputName = element.getAttribute('data-name');
      
      // Get value based on element type
      const inputValue = element.tagName === "SELECT" 
        ? element.value  // For dropdowns
        : element.type === "text" 
          ? (element.value || element.placeholder)  // For text inputs
          : element.checked;  // For checkboxes
  
      // Check and initialize country within 'countries' if not already present
      if (country && !dataToSend.countries[country]) {
        dataToSend.countries[country] = {};
      }
  
      // Define targetObject to point to the right level where the data should be inserted
      let targetObject = country ? dataToSend.countries[country] : dataToSend;
  
      // If category is specified, further narrow down targetObject
      if (category) {
        if (!targetObject[category]) {
          targetObject[category] = {};
        }
        targetObject = targetObject[category];
      }
  
      // Assign the input value or checked status to the correct place in the structure
      if (inputName) {  // Only add if inputName exists
        targetObject[inputName] = inputValue;
      }
    });
  
    try {
      var response = await unifiedSendRequest(GETGENERALCONFIG, {
        method: 'POST',  // Ensure the method is POST for sending data
        formData: JSON.stringify(dataToSend), 
        headerArgs: { 'Content-Type': 'application/json' }
      });
      showMessage('Submitted settings successfully', true);
    } catch (error) {
      console.error('Error submitting settings', error);
      showMessage('Failed to submit settings ' + error.message, false);
    }
  }

  
  function showGuide() {
    startGuide([
        { element: "main", group: "{{ 'software.guide.general.welcome.group' | t }}", title: "{{ 'software.guide.general.welcome.title' | t }}", text: "{{ 'software.guide.general.welcome.text' | t }}", where: 'middle' },
        { element: "#accessManagement", group: "{{ 'software.guide.general.users.group' | t }}", title: "{{ 'software.guide.general.users.title' | t }}", text: "{{ 'software.guide.general.users.text' | t }}", where: 'below' },
        { element: "#addUserButton", group: "{{ 'software.guide.general.addUser.group' | t }}", title: "{{ 'software.guide.general.addUser.title' | t }}", text: "{{ 'software.guide.general.addUser.text' | t }}", where: 'right' },
        { element: "#addApiTokenButton", group: "{{ 'software.guide.general.addAPIToken.group' | t }}", title: "{{ 'software.guide.general.addAPIToken.title' | t }}", text: "{{ 'software.guide.general.addAPIToken.text' | t }}", where: 'left' },
        { element: "#configurationGeneral", group: "{{ 'software.guide.general.configuration.group' | t }}", title: "{{ 'software.guide.general.configuration.title' | t }}", text: "{{ 'software.guide.general.configuration.text' | t }}", where: 'below' },
        { element: "#countryTabs", group: "{{ 'software.guide.general.countryTabs.group' | t }}", title: "{{ 'software.guide.general.countryTabs.title' | t }}", text: "{{ 'software.guide.general.countryTabs.text' | t }}", where: 'left' },
        { element: "#submitChanges", group: "{{ 'software.guide.general.saveChanges.group' | t }}", title: "{{ 'software.guide.general.saveChanges.title' | t }}", text: "{{ 'software.guide.general.saveChanges.text' | t }}", where: 'left' },
    ]);
    setCookie('showedGuideGeneral', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
}

waitForPermission(function() {
  if (window.userPermissions['forsure-configuration'] && window.userPermissions['generalsettings']) {
    document.getElementById('generalSettingsContainer').style.display = 'block';
    initializeSettings();
    if(readCookie('showedGuideGeneral') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    }
  }
});
</script>

{% else %}

{% endif %}

{% schema %}
{
  "name": "t:sections.forsure_settings.name",
  "class": "section",
  "settings": [
    {
      "type": "select",
      "id": "desktop_image_width",
      "options": [
        {
          "value": "small",
          "label": "t:sections.forsure_config.settings.desktop_image_width.options__1.label"
        },
        {
          "value": "medium",
          "label": "t:sections.forsure_config.settings.desktop_image_width.options__2.label"
        },
        {
          "value": "large",
          "label": "t:sections.forsure_config.settings.desktop_image_width.options__3.label"
        }
      ],
      "default": "medium",
      "label": "t:sections.forsure_config.settings.desktop_image_width.label",
      "info": "t:sections.forsure_config.settings.desktop_image_width.info"
    },
    {
      "type": "select",
      "id": "layout",
      "options": [
        {
          "value": "image_first",
          "label": "t:sections.forsure_config.settings.layout.options__1.label"
        },
        {
          "value": "text_first",
          "label": "t:sections.forsure_config.settings.layout.options__2.label"
        }
      ],
      "default": "image_first",
      "label": "t:sections.forsure_config.settings.layout.label",
      "info": "t:sections.forsure_config.settings.layout.info"
    },
    {
      "type": "select",
      "id": "desktop_content_position",
      "options": [
        {
          "value": "top",
          "label": "t:sections.forsure_config.settings.desktop_content_position.options__1.label"
        },
        {
          "value": "middle",
          "label": "t:sections.forsure_config.settings.desktop_content_position.options__2.label"
        },
        {
          "value": "bottom",
          "label": "t:sections.forsure_config.settings.desktop_content_position.options__3.label"
        }
      ],
      "default": "top",
      "label": "t:sections.forsure_config.settings.desktop_content_position.label"
    },
    {
      "type": "select",
      "id": "desktop_content_alignment",
      "options": [
        {
          "value": "left",
          "label": "t:sections.forsure_config.settings.desktop_content_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:sections.forsure_config.settings.desktop_content_alignment.options__2.label"
        },
        {
          "value": "right",
          "label": "t:sections.forsure_config.settings.desktop_content_alignment.options__3.label"
        }
      ],
      "default": "left",
      "label": "t:sections.forsure_config.settings.desktop_content_alignment.label"
    },
    {
      "type": "select",
      "id": "content_layout",
      "options": [
        {
          "value": "no-overlap",
          "label": "t:sections.forsure_config.settings.content_layout.options__1.label"
        },
        {
          "value": "overlap",
          "label": "t:sections.forsure_config.settings.content_layout.options__2.label"
        }
      ],
      "default": "no-overlap",
      "label": "t:sections.forsure_config.settings.content_layout.label"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "options": [
        {
          "value": "accent-1",
          "label": "t:sections.all.colors.accent_1.label"
        },
        {
          "value": "accent-2",
          "label": "t:sections.all.colors.accent_2.label"
        },
        {
          "value": "background-1",
          "label": "t:sections.all.colors.background_1.label"
        },
        {
          "value": "background-2",
          "label": "t:sections.all.colors.background_2.label"
        },
        {
          "value": "inverse",
          "label": "t:sections.all.colors.inverse.label"
        }
      ],
      "default": "background-1",
      "label": "t:sections.all.colors.label"
    },
    {
      "type": "select",
      "id": "color_scheme2",
      "options": [
        {
          "value": "accent-1",
          "label": "t:sections.all.colors.accent_1.label"
        },
        {
          "value": "accent-2",
          "label": "t:sections.all.colors.accent_2.label"
        },
        {
          "value": "background-1",
          "label": "t:sections.all.colors.background_1.label"
        },
        {
          "value": "background-2",
          "label": "t:sections.all.colors.background_2.label"
        },
        {
          "value": "inverse",
          "label": "t:sections.all.colors.inverse.label"
        }
      ],
      "default": "background-1",
      "label": "t:sections.all.colors.label"
    },
    {
      "type": "header",
      "content": "Mobile layout"
    },
    {
      "type": "select",
      "id": "mobile_content_alignment",
      "options": [
        {
          "value": "left",
          "label": "t:sections.forsure_config.settings.mobile_content_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:sections.forsure_config.settings.mobile_content_alignment.options__2.label"
        },
        {
          "value": "right",
          "label": "t:sections.forsure_config.settings.mobile_content_alignment.options__3.label"
        }
      ],
      "default": "left",
      "label": "t:sections.forsure_config.settings.mobile_content_alignment.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "image_picker",
      "id": "trashcan",
      "label": "Trashcan"
    },
    {
      "type": "image_picker",
      "id": "arrow",
      "label": "Arrow"
    },
    {
      "type": "image_picker",
      "id": "info",
      "label": "Info"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "t:sections.forsure_settings.presets.name"
    }
  ]
}
{% endschema %}
