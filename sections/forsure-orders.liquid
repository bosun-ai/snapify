{% comment %}
  Page template: Orders Dashboard
  File: /templates/page.orders-dashboard.liquid
  Notes:
  - Demo data only (Shopify storefront templates can’t read orders directly).
  - Replace with app blocks or AJAX to load real data if needed.
{% endcomment %}
{% style %}

.orders-dashboard { --rail: 76px; --gap: 16px; --info: 320px; --radius: 14px; }
.orders-dashboard * { box-sizing: border-box; }

.od-wrap {
  gap: var(--gap);
  min-height: 70vh;
  border: 1px solid rgba(0,0,0,.08);
  border-radius: var(--radius);
  padding: var(--gap);
  background: var(--color-background, #fff);
}

.od-wrap{ display:flex; }
.od-rail{ flex:0 0 76px; }
.od-main{ flex:1 1 auto; min-width:0;height: fit-content; }
.od-info{ flex:0 0 320px; }

/* Timeframe block in header */
.od-dates {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 12px;
  background: #fff;
}
.od-date {
  display: inline-grid;
  gap: 4px;
  font-size: 12px;
}
.od-date > input[type="date"] {
  padding: 6px 8px;
  border: 1px solid rgba(0,0,0,.15);
  border-radius: 10px;
  font-size: 14px;
}
@media (max-width: 720px) {
  .od-dates { flex-wrap: wrap; width: 100%; }
}

/* Rail */
.od-rail {
  display: grid;
  grid-auto-rows: 1fr;
  gap: 10px;
  background: #f7f7f8;
  border-radius: var(--radius);
  padding: 10px;
  height: fit-content;
}
.od-rail-btn {
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 12px;
  background: #fff;
  width: 70px;
  aspect-ratio: 1/1;
  font-weight: 700;
  font-size: 22px;
  display: grid;
  place-items: center;
  cursor: pointer;
  transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
}
.od-rail-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 10px rgba(0,0,0,.06); }
.od-rail-btn.is-active { outline: 2px solid #111; }

/* Main */
.od-main {
  background: #fff;
  border-radius: var(--radius);
  padding: 0;
  display: grid;
  grid-template-rows: auto 1fr;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,.08);
}
.od-topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(0,0,0,.06);
  gap: 10px;
}
.od-title { font-weight: 600; }
.od-actions { display: flex; align-items: center; gap: 8px; }

.od-btn {
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: 12px; padding: 8px 12px; border: 1px solid rgba(0,0,0,.12);
  font-size: 14px; cursor: pointer; background: #fff;
}
.od-btn--primary { background: #111; color: #fff; border-color: #111; }
.od-btn--ghost { background: transparent;     border: 0.1rem solid #17161c;}
.od-upload input[type=file] { width: 0; height: 0; opacity: 0; }

/* Filters button */
.od-filter { position: relative; display: inline-block; margin-right: 1rem; }
/* .od-filter > summary {
  list-style: none; display: inline-flex; align-items: center; justify-content: center;
  padding: 8px 12px; border-radius: 12px; border: 1px solid #111;
  background: #fff; color: #111; font-weight: 600; font-size: 14px; line-height: 1; cursor: pointer;
} */
.od-filter > summary::-webkit-details-marker { display: none; }
.od-filter[open] > summary { background: #f2f2f2; border-color: #111; }
.od-filter-form {
  position: absolute; right: 0; top: calc(100% + 8px);
  background: #fff; border: 1px solid rgba(0,0,0,.1);
  border-radius: 12px; padding: 12px; display: grid; gap: 10px; z-index: 3;
  box-shadow: 0 12px 24px rgba(0,0,0,.08);
}
.od-filter-form label { display: grid; gap: 6px; font-size: 12px; }
.od-filter-form input, .od-filter-form select {
  border: 1px solid rgba(0,0,0,.15); border-radius: 10px; padding: 8px;
}
.od-filter-row { display: flex; gap: 8px; justify-content: flex-end; }

/* =======================
   LIST GRIDS
======================= */

/* Orders tab — header and rows share the SAME tracks incl. caret col */
.od-list[data-tab-panel="orders"] .od-list-header,
.od-list[data-tab-panel="orders"] .od-row {
  display: grid;
  grid-template-columns: 28px 140px 1.1fr 1.1fr 140px 140px 30px;
  gap: 10px;
  align-items: center;
}

.od-list[data-tab-panel="returns"] .od-list-header,
.od-list[data-tab-panel="returns"] .od-row {
  display: grid;
  grid-template-columns: 28px 140px 1.1fr 1.1fr 30px;
  gap: 10px;
  align-items: center;
}

.od-list[data-tab-panel="fulfilment"] .od-list-header,
.od-list[data-tab-panel="fulfilment"] .od-row {
  display: grid;
  grid-template-columns: 1.1fr 1.1fr 1.1fr 1.1fr 1.1fr 30px;
  gap: 10px;
  align-items: center;
}

/* Header caret placeholder */
.od-list-header--orders .od-col--caret {
  width: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Align text consistently */
.od-list .od-col,
.od-list-header .od-col {
  text-align: center;
}

/* Header styling */
.od-list-header {
  padding: 10px 14px; font-size: 12px; font-weight: 600; color: #555;
  background: #fafafa; border-bottom: 1px solid rgba(0,0,0,.06);
}

/* Rows */
.od-rows { list-style: none; margin: 0; padding: 0; overflow: auto; }
.od-row {
  padding: 12px 14px; border-bottom: 1px solid rgba(0,0,0,.05);
  cursor: pointer;
}
.od-row:hover { background: #fcfcfc; }
.is-selected {
  outline: none;
  box-shadow: inset 0 0 0 2px #17161c;
  /* outline: 2px solid #17161c; outline-offset: -2px;  */
}
.od-col--sm { white-space: nowrap; }

/* Caret toggle button */
.od-row--order .od-toggle {
  appearance:none; border:1px solid rgba(0,0,0,.25); background:#fff; color:#333;
  border-radius:8px; width:24px; height:24px;
  display:grid; place-items:center;
  margin: 0;                /* FIX: removed margin-right */
  justify-self: center;     /* center in caret column */
  cursor:pointer;
}
.od-caret{ transition: transform .15s ease; transform: rotate(-90deg);}
.od-caret-expanded{ transform: rotate(0deg); }

/* Sub-rows container */
.od-subrows {
  grid-column: 2 / -1;
  padding: 10px 8px 12px 8px;
  background: #fafafa;
  border-left: 3px solid rgba(0,0,0,.08);
  margin-top: 8px;
  border-radius: 8px;
}

/* Sub-rows header */
.od-subheader {
  display: grid;
  gap: 10px;
  font-size: 12px;
  font-weight: 600;
  color: #666;
  margin: 0 0 6px 18px;
}

.od-orders-sub {
  grid-template-columns: 1.4fr 1fr 80px 1.4fr;
}

.od-returns-sub {
  grid-template-columns: 1.4fr 1fr 1fr 1.4fr;
}

/* Sub-rows list + items */
.od-sublist { list-style: none; margin: 0; padding: 0 0 0 18px; }
.od-subrow {
  display: grid;
  gap: 10px;
  align-items: center;
  padding: 1rem;
  border-top: 1px dashed rgba(0,0,0,.08);
}
.od-subrow:first-child { border-top: 0; }

/* Subrow columns */
.od-subcol--prod { display: flex; align-items: center; gap: 8px; }
.od-branch {
  width: 14px; height: 14px; border-left: 2px solid #7c7c7c; border-bottom: 2px solid #7c7c7c;
  border-radius: 0 0 0 4px; margin-right: 2px;
}
.od-link { color: #3b5cff; text-decoration: none; }
.od-link:hover { text-decoration: underline; }
.od-subcol--sku code {
  background: #f0f3ff; border: 1px solid #dfe5ff; border-radius: 6px; padding: 2px 6px; font-size: 12px;
}
.od-subcol--qty { font-weight: 600; }

.od-subcol {
  display: block!important;
  text-align: center;
}

/* Legislation badges */
.od-tag {
  display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 12px; font-weight: 600;
  border: 1px solid transparent; margin-right: 6px;
}
.od-tag--w       { background:#eaf2ff; border-color:#c9dbff; color:#1a3da8; }
.od-tag--b       { background:#eafbea; border-color:#c6efc6; color:#1d7a1d; }
.od-tag--p       { background:#fff5e5; border-color:#ffe0b3; color:#8a5b0a; }

/* Info */
.od-info {
  background: #fff; border: 1px solid rgba(0,0,0,.08);
  border-radius: var(--radius); padding: 14px; display: grid; align-content: start;
  height: calc(50vh + 103px);
}
.od-info-body {
  overflow: auto;
  height: calc(50vh + 75px);
}

.od-info-empty { color: #666; opacity: .9; }
.od-info-title { margin: 0 0 10px; font-size: 16px; padding-left: 1rem;}
.od-info-description { margin: 0 0 10px; font-size: 12px; padding-left: 1rem;}
.od-info-grid { display: grid; grid-template-columns: 1fr; gap: 8px;padding-left: 1rem;}
.od-info-grid dt { font-size: 12px; color: #666; }
.od-info-grid dd { margin: 0; font-weight: 600; width: fit-content;min-height: 20px;min-width: 5rem;}

.is-hidden { display: none !important; }

#od-summary.active {
  color: #fafafa;
}

.disabledbutton {
  opacity: 0.5;
  cursor: not-allowed!important;
}

.od-col--select input[type="checkbox"] {
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease;
}

/* show on hover or when row is selected */
.od-row:hover .od-col--select input,
.od-subrow:hover .od-col--select input,
.od-row.is-selected .od-col--select input,
.od-subrow.is-selected .od-col--select input {
  opacity: 1;
  pointer-events: auto;
}


.od-modal {
  display: none; 
  position: fixed;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,.4);
  justify-content: center;
  align-items: center;
}

/* Modal box */
.od-modal-content {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  width: 400px;
  max-width: 90%;
  box-shadow: 0 8px 24px rgba(0,0,0,.2);
  position: relative;
}

/* Close button */
.od-modal-close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
}
.od-modal-close:hover { color: #900; }

.od-modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 16px;
}


    /* Loading spinner */
.loadingSpinner {
  border: 4px solid rgba(34, 85, 255, 0.1);
  border-top: 4px solid #2255ff;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: auto;
  display: flex!important;
}
.loadingSpinnerContainer{
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#icon-orders svg, #icon-fulfilment svg {
  width: 5rem;
  height: 5rem;
}
#icon-orders, #icon-return, #icon-fulfilment {
  margin-top: 0.5rem;
}

#icon-return svg {
  width: 6rem;
  height: 6rem;
  margin-left: -0.2rem;
}


/* Responsive */
@media (max-width: 1100px) {
  .od-wrap { grid-template-columns: var(--rail) 1fr; }
  .od-info { grid-column: 1 / -1; }
}
@media (max-width: 720px) {
  .od-list-header, .od-row { grid-template-columns: 120px 1fr 120px; }
  .od-list-header .od-col:nth-child(3), .od-row .od-col:nth-child(3),
  .od-list-header .od-col:nth-child(5), .od-row .od-col:nth-child(5) { display: none; }
  .od-topbar { flex-wrap: wrap; }

  .od-subheader, .od-subrow { grid-template-columns: 1fr 1fr; }
  .od-subcol--qty, .od-subcol--tags { grid-column: 1 / -1; }
}
{% endstyle %}
{% render 'forsure-upload-module' %}
<div class="page-width" style="margin-top: 5rem;padding: 0;">
  <section id="orders-dashboard" class="orders-dashboard" data-initial-tab="orders" aria-label="Orders dashboard">
    <div class="od-wrap">
      <!-- Left rail -->
      <aside class="od-rail" aria-label="Modes">
        <button class="od-rail-btn is-active" data-tab="orders" title="Orders" onclick="setTab('orders')"><span id="icon-orders">{% render 'icon-goods' %}</span></button>
        <button class="od-rail-btn" data-tab="returns" title="Returns" onclick="setTab('returns')"><span id="icon-return">{% render 'icon-warehouse' %}</span></button>
        <button class="od-rail-btn" data-tab="fulfilment" title="Fulfilment" onclick="setTab('fulfilment')"><span id="icon-fulfilment">{% render 'icon-packaging' %}</span></button>
      </aside>

      <!-- Main -->
      <main class="od-main">
        <!-- Top bar -->
        <div class="od-topbar">
          <div class="od-title" id="od-title">Orders</div>
          <div class="od-actions">
            <button class="od-btn od-btn--ghost" data-action="edit" style="display: none;margin-right: 1rem;" id="bulkedit" onclick="openEditModal()">Multi Edit</button>
            <div id="filter-container">
              <details class="od-filter" id="od-filter">
                <summary id="od-summary" class="od-btn od-btn--ghost">Filters</summary>
                <form class="od-filter-form" onsubmit="return false">
                  <label>
                    Search
                    <input type="search" name="q" placeholder="Search orders, customers…" id="search" />
                  </label>
                              <!-- Timeframe in header -->
                  <div>
                    <label>
                      Source
                      <select id="source">
                        <option value="">All</option>
                      </select>
                    </label>
                  </div>
                  <label>
                  Dates
                  </label>
              <div class="od-dates" aria-label="Timeframe">
                
                <label class="od-date">
                  <span>From</span>
                  <input type="date" id="startDate" />
                </label>
                <label class="od-date">
                  <span>To</span>
                  <input type="date" id="endDate" />
                </label>
              </div>
                  <div class="od-filter-row">
                    <button class="od-btn od-btn--primary" data-action="apply-filters" onclick="applyFilter()">Apply</button>
                    <button class="od-btn od-btn--ghost" data-action="clear-filters" type="reset">Clear</button>
                  </div>
                </form>
              </details>
            </div>
            <button class="od-btn od-btn--ghost" data-action="close-upload" style="display: none;" id="close-upload" onclick="closeUpload()">Close</button>
            <button class="od-btn od-btn--primary" data-action="upload" onclick="openUpload()" id="upload-button">Upload</button>
          </div>
        </div>
        <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

        <div id="upload" style="display: none;width: 100%;">
          <div class="dropZone" id="fileListDropZone" style="position: relative;border: 2px dashed #17161c;margin: 2rem;height: 50vh;display: block;overflow: auto;height: 40vh;">
            <div id="imagecontainerwrapper" style="display: flex;align-items: center;height: 100%;width: 100%;justify-content: center;">
              <div>
                <div style="padding:1rem;width: fit-content;margin: auto;" id="upload-imagecontainerupload">
                  <img width="220px" id="upload-imageupload" src="{{ section.settings.upload | image_url }}" alt="{{ section.settings.upload.alt | escape }}" loading="lazy">
                </div>
                <div id="upload-textupload" style="text-align: center;">
                  Drag & Drop your Order List here. You can upload multiple files at once.
                </div>
              </div>
            </div>
            <div class="fileList" id="fileList_file_list" style="width:100%; padding:2rem"></div>
        </div>
        <input type="file" id="file_list" style="display: none" multiple>
        <div id="errorsorder_list"></div>
        </div>

        <!-- Orders tab -->
        <div class="od-list" data-tab-panel="orders" aria-labelledby="orders-tab" id="orders-tab">
          <!-- Header with caret column -->
          <div id="orders-list-header" class="od-list-header od-list-header--orders">
            <div class="od-col od-col--caret" aria-hidden="true"></div>
            <div class="od-col od-col--sm">Date</div>
            <div class="od-col">Order</div>
            <div class="od-col">Profile</div>
            <div class="od-col od-col--sm">Status</div>
            <div class="od-col od-col--sm">Country</div>
            <div class="od-col od-col--selectall">
              <input type="checkbox" id="select-all-orders" />
            </div>
          </div>

          <ul class="od-rows" id="orders-list" style="height: 50vh;">
            <li style="text-align: center; padding: 10px;">Fetching orders...</li>
          </ul>
        </div>

        <!-- Returns tab -->
        <div class="od-list is-hidden" data-tab-panel="returns" aria-labelledby="returns-tab" id="returns-tab">
          <div id="returns-list-header" class="od-list-header od-list-header--orders">
            <div class="od-col od-col--caret" aria-hidden="true"></div>
            <div class="od-col od-col--sm">Date Returned</div>
            <div class="od-col">Order ID</div>
            <div class="od-col od-col--sm">Status</div>
            <div class="od-col od-col--selectall">
              <input type="checkbox" id="select-all-returns" />
            </div>
          </div>
          <ul class="od-rows" id="returns-list" style="height: 50vh;">
            <li style="text-align: center; padding: 10px;">Fetching returns...</li>
          </ul>
        </div>

        <!-- Fulfilment tab -->
        <div class="od-list is-hidden" data-tab-panel="fulfilment" aria-labelledby="fulfilment-tab" id="fulfilment-tab">
          <div id="fulfilment-list-header" class="od-list-header od-list-header--orders">
            <div class="od-col od-col--sm">Order ID</div>
            <div class="od-col">Total Weight</div>
            <div class="od-col">Main Type</div>
            <div class="od-col">Main Type Weight</div>
            <div class="od-col od-col--sm">Status</div>
            <div class="od-col od-col--selectall">
              <input type="checkbox" id="select-all-fulfilment" />
            </div>
          </div>
          <ul class="od-rows" id="fulfilment-list" style="height: 50vh;">
            <li style="text-align: center; padding: 10px;">Fetching fulfilment...</li>
          </ul>
        </div>
</main>

      <!-- Info panel -->
      <aside class="od-info" aria-live="polite" aria-label="Info" id="od-info">
        <div id="od-info-empty" class="od-info-empty">Select a row to see details.</div>
        <div id="od-info-body" class="od-info-body is-hidden">
          <h3 id="od-info-title" class="od-info-title"></h3>
          <h3 id="od-info-description" class="od-info-description" style="display: none;">[Click on a value to edit it.]</h3>
          <dl id="od-info-grid" class="od-info-grid">
          </dl>
        </div>
      </aside>
    </div>
  </section>
</div>
<div id="editModal" class="od-modal" aria-hidden="true">
  <div class="od-modal-content">
    <span class="od-modal-close" id="editModalClose" onclick="closeEditModal()">&times;</span>
    <h2 id="editModalTitle" style="margin-top: 0rem;margin-bottom: 1rem;"></h2>
    <p id="editModalBody"></p>
    <div style="display: flex;gap: 10px;">
      <select id="editModalSelect" class="btn dropdown-toggle bs-placeholder btn-default" style="position: relative;width: 50%;text-align: left;">
      </select>
      <input type="text" id="editModalInput" placeholder="New value" style="width: 50%;">
    </div>
    <div class="od-modal-actions">
      <button class="od-btn od-btn--ghost" id="editModalCancel" onclick="closeEditModal()">Cancel</button>
      <button class="od-btn od-btn--primary" id="editModalConfirm" onclick="editModalConfirm()">Confirm</button>
    </div>
  </div>
</div>
<script src="{{ 'forsure-profile.js' | asset_url }}" defer></script>

<script>
var uploadVisible = false;
function openUpload() {
  if (uploadVisible) {
    uploadFiles();
    return;
  }
  unselectAll();
  document.getElementById('upload').style.display = 'block';
  document.getElementById('close-upload').style.display = 'block';
  document.getElementById('filter-container').style.display = 'none';
  document.getElementById('upload-textupload').style.display = 'block';
  document.getElementById('upload-button').style.backgroundColor = '#2255ff';
  document.getElementById('upload-textupload').innerText = 'Drag & Drop your ' + activeTab.charAt(0).toUpperCase() + activeTab.slice(1) + ' List here. You can upload multiple files at once.';
  document.getElementById('upload-button').innerText = 'Upload ' + activeTab;
  document.getElementById('upload-button').disabled = true;
  document.getElementById('upload-button').classList.add('disabledbutton');
  document.getElementById('upload-button').title = 'Please upload a file first';
  document.getElementById('upload-imagecontainerupload').style.display = 'block';
  document.getElementById('imagecontainerwrapper').style.height = '100%';

  document.querySelectorAll('.od-list').forEach(b => b.style.display = 'none');
  document.getElementById('od-info').style.display = 'none';
  uploadVisible = true;
}

function closeUpload() {
  document.getElementById('upload').style.display = 'none';
  document.getElementById('close-upload').style.display = 'none';
  document.getElementById('filter-container').style.display = 'block';
  document.getElementById('upload-button').style.backgroundColor = '#17161c';
  document.getElementById('upload-button').innerText = 'Upload';
  document.getElementById("upload-button").disabled = false;
  document.getElementById("upload-button").classList.remove('disabledbutton');
  document.getElementById("upload-button").title = '';
  document.querySelectorAll('.od-list').forEach(b => b.style.display = 'block');
  document.getElementById('od-info').style.display = 'block';
  uploadVisible = false;
}

function showSpinner() {
  // prevent duplicates
  console.log(activeTab);
  const container = document.querySelector("#" + activeTab + "-tab");
  if (container.querySelector(".loadingSpinnerContainer")) return;

  const spinnerContainer = document.createElement("div");
  spinnerContainer.className = "loadingSpinnerContainer";
  spinnerContainer.innerHTML = `<div class="loadingSpinner"></div>`;

  container.style.position = "relative"; // anchor for absolute
  container.appendChild(spinnerContainer);
}

function hideSpinner() {
  const container = document.querySelector("#" + activeTab + "-tab");
  const el = container.querySelector(".loadingSpinnerContainer");
  if (el) el.remove();
}

setupDropZone(document.getElementById('fileListDropZone'), document.getElementById('file_list'), 'fileList_file_list');

function canSwitchTab(tab) {
  if (uploadVisible) {
    if (document.querySelectorAll('#fileList_file_list .file-row').length > 0) {
      return confirm('Are you sure you want to switch tabs? You have uploaded files that will be lost.');
    }
  }
  return true;
}

function hideUploadImages() {
  document.getElementById('upload-imagecontainerupload').style.display = 'none';
  document.getElementById('imagecontainerwrapper').style.height = 'fit-content';
}

function showUploadImages() {
  document.getElementById('upload-imagecontainerupload').style.display = 'block';
  document.getElementById('imagecontainerwrapper').style.height = '100%';
}

function clearFileList() {
  document.getElementById('fileList_file_list').innerHTML = '';
  document.getElementById('file_list').value = '';
}

function escapeHtml(v){
  return String(v??'').replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}

function toYMD(v) {
  const d = new Date(v);
  return !v || Number.isNaN(+d)
    ? String(v ?? '')
    : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

async function setTab(tab) {
  if (!canSwitchTab(tab)) {
    return;
  }
  unselectAll();
  if (uploadVisible) {
    clearFileList();
    document.getElementById('upload-textupload').innerText = 'Drag & Drop your ' + tab.charAt(0).toUpperCase() + tab.slice(1) + ' List here. You can upload multiple files at once.';
    document.getElementById('upload-button').innerText = 'Upload ' + tab.charAt(0).toUpperCase() + tab.slice(1);
    document.getElementById('upload-imagecontainerupload').style.display = 'block';
  }
  document.querySelectorAll('.od-rail-btn').forEach(b => b.classList.toggle('is-active', b.dataset.tab === tab));
  document.querySelectorAll('.od-list').forEach(p => p.classList.toggle('is-hidden', p.dataset.tabPanel !== tab));

  const title = document.getElementById('od-title');
  if (title) title.textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
  activeTab = tab;
  if (getOffset() == 0) {
    await appendData(true);
  }
}

function getOffset() {
  if (activeTab == 'orders') {
    return nextOffsetOrders;
  } else if (activeTab == 'returns') {
    return nextOffsetReturns;
  } else if (activeTab == 'fulfilment') {
    return nextOffsetFulfilment;
  }
}

function setOffset(offset, all=false) {
  if (activeTab == 'orders' || all) {
    nextOffsetOrders = offset;
  } 
  if (activeTab == 'returns' || all) {
    nextOffsetReturns = offset;
  } 
  if (activeTab == 'fulfilment' || all) {
    nextOffsetFulfilment = offset;
  }
}

var search = '';
var startDate = '';
var endDate = '';
var sourcefile = '';
function applyFilter() {
  search = document.getElementById('search').value;
  startDate = document.getElementById('startDate').value;
  endDate = document.getElementById('endDate').value;
  sourcefile = document.getElementById('source').value;
  unselectAll();
  // reset offsets to reload all pages
  setOffset(0, true);
  appendData(true);
  document.getElementById('od-filter').removeAttribute("open");
  if (search != '' || startDate != '' || endDate != '' || sourcefile != '') {
    document.getElementById("od-summary").classList.add("active");
  } else {
    document.getElementById("od-summary").classList.remove("active");
  }
}

const orderGroupOrder = ['Order ID', 'Bought On', 'Profile', 'Status', 'Country', 'Customer'];
const returnGroupOrder = ['Order ID', 'Returned On', 'Status', 'Source'];
const fulfilmentGroupOrder = ['Order ID', 'Fulfilment Day', 'Total Weight', 'Main Type', 'Main Type Weight', 'Name', 'Country'];
const groupDict = {
  'orders': orderGroupOrder,
  'returns': returnGroupOrder,
  'fulfilment': fulfilmentGroupOrder
};
const orderProductOrder = ['General'];
const returnProductOrder = ['SKU', 'Amount', 'Name'];
const productDict = {
  'orders': orderProductOrder,
  'returns': returnProductOrder,
  'fulfilment': []
};

var activeTab = 'orders';

function customSort(a, b, order) {
  // unknown entries should be at the end
  const indexA = order.indexOf(a);
  const indexB = order.indexOf(b);
  if (indexA == -1) return 1;
  if (indexB == -1) return -1;
  return indexA - indexB;
}

function showDetails(order, group=false, li=null) {
  document.querySelectorAll('.od-subrow').forEach(
    r=>r.classList.remove('is-selected'));
  document.querySelectorAll('.od-row--order').forEach(
    r=>{
      if (r.querySelector('.od-select').checked) {
        return;
      }
      r.classList.remove('is-selected');
    });
  li?.classList.add('is-selected');
  document.getElementById('od-info-grid').innerHTML = '';
  var title = activeTab == 'orders' ? 'Order Details' : activeTab == 'returns' ? 'Return Details' : 'Fulfilment Details';
  if (group) {
    document.getElementById('od-info-description').style.display = 'none';
    for (entry of Object.keys(order).sort((a, b) => customSort(a, b, groupDict[activeTab]))) {
      var div = document.createElement('div');
      var dt = document.createElement('dt');
      dt.textContent = entry;
      div.appendChild(dt);
      var dd = document.createElement('dd');
      if (entry == 'Products') {
        dd.textContent = order.Products.length;
      } else {
        dd.textContent = order[entry];
      }
      dd.style.cursor = 'default';
      dd.title = 'This field is not editable';
      div.appendChild(dd);
      document.getElementById('od-info-grid').appendChild(div);
    }

    {% comment %} document.getElementById('info-id').textContent = order.orderId;
    document.getElementById('info-kind').textContent = 'Orders';
    document.getElementById('info-date').textContent = order.date;
    document.getElementById('info-status').textContent = order.status;
    document.getElementById('info-country').textContent = order.country;
    document.getElementById('info-items').textContent = order.items.length; {% endcomment %}
  } else {
    document.getElementById('od-info-description').style.display = 'block';
    var productOrder = productDict[activeTab];
    if (activeTab == 'orders') {
      // if legislation is given, sort by that instead of the default order (so e.g. Packaging is first)
      legislation = order['General']['legislation'].sort((a, b) => customSort(a,b, ['WEEE', 'Batteries', 'Packaging'])) || [];
      productOrder = productOrder.concat(legislation);
    }
    for (const entry of Object.keys(order).sort((a, b) => customSort(a, b, productOrder))) {
      for (const subentry of Object.keys(order[entry])) {
        if (subentry == 'unmapped') {
          continue;
        }
        var div = document.createElement('div');
        var dt = document.createElement('dt');
        var label = subentry;
        var value = order[entry][subentry]['value'];
        var editable = order[entry][subentry]['editable'];
        if (subentry == 'legislation') {
          label = 'Legislation';
          value = order[entry][subentry].join(', ');
          editable = false;
        }
        dt.textContent = label;
        div.appendChild(dt);
        var dd = createDD(value, editable, order, entry, subentry);
        div.appendChild(dd);
        document.getElementById('od-info-grid').appendChild(div);
      }
      var br = document.createElement('br');
      document.getElementById('od-info-grid').appendChild(br);
    }
    title = 'Product Details';
  }
  document.getElementById('od-info-title').textContent = title;
  document.getElementById('od-info-body').classList.remove('is-hidden');
  document.getElementById('od-info-empty').classList.add('is-hidden');
}


function createDD(value, editable, order, entry, subentry)  {
  var dd = document.createElement('dd');
  dd.textContent = value;
  if (editable) {
    dd.contentEditable = 'true';
    let originalValue = value;
    let cancelled = false;
    dd.onblur = async (e) => {
      if (cancelled) {
        cancelled = false;                 // reset for next time
        e.target.textContent = originalValue; // restore
        return;                            // skip saving
      }
      if (e.target.textContent == originalValue) {
        return;
      }
      originalValue = e.target.textContent;
      await editValue(order, entry, subentry, e.target.textContent);
    };
    dd.onkeydown = (e) => {
      if (e.key === 'Enter') {
        e.target.blur();
      }
      if (e.key === "Escape") {
        e.preventDefault();
        cancelled = true;
        e.target.blur();
      }
    };
    dd.style.cursor = 'text';
  } else {
    dd.style.cursor = 'default';
    dd.title = 'This field is not editable';
  }
  return dd;
}

function showDetailsFulfilment(order, li=null) {
  document.querySelectorAll('.od-subrow').forEach(
    r=>r.classList.remove('is-selected'));
  document.querySelectorAll('.od-row--order').forEach(
    r=>{
      if (r.querySelector('.od-select').checked) {
        return;
      }
      r.classList.remove('is-selected');
    });
  li?.classList.add('is-selected');
  document.getElementById('od-info-grid').innerHTML = '';
  var title = 'Fulfilment Details';
  for (entry of Object.keys(order).sort((a, b) => customSort(a, b, ['General', 'WEEE', 'Batteries', 'Packaging']))) {
    for (subentry of Object.keys(order[entry])) {
      if (subentry == 'unmapped') {
        continue;
      }
      var div = document.createElement('div');
      var dt = document.createElement('dt');
      var label = subentry;
      var value = order[entry][subentry]['value'];
      var editable = order[entry][subentry]['editable'];
      dt.textContent = label;
      div.appendChild(dt);
      var dd = createDD(value, editable, order, entry, subentry);
      div.appendChild(dd);
      document.getElementById('od-info-grid').appendChild(div);
    }
    var br = document.createElement('br');
    document.getElementById('od-info-grid').appendChild(br);
  }
  document.getElementById('od-info-title').textContent = title;
  document.getElementById('od-info-body').classList.remove('is-hidden');
  document.getElementById('od-info-empty').classList.add('is-hidden');
}

async function editValue(order, entry, subentry, newValue) {
  // TODO save to database
  console.log(newValue, order, entry, subentry);
  try {
    var change = {
      new_value: newValue,
      change_type: activeTab,
      label_group: entry,
      country: order['General']['Country']['value'],
      label: subentry,
      order_id: order['General']['Order ID']['value'],
      sku: order['General']['SKU']?.['value'] || ''
    }
    var changes = [change];
    var bulkChanges = {
      changes: changes
    }
    var response = await unifiedSendRequest(CHANGES, {formData: JSON.stringify(bulkChanges), headerArgs: {'Content-Type': 'application/json'}});
    if (response.status_code != 200) {
      showMessage('Failed to save changes', false);
    }
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to save changes', false);
  }

}

async function editValues(orders, group, subentry, newValue) {
  // TODO save to database
  console.log(newValue, orders, group, subentry);
  var changes = [];
  try {
    for (var order of orders) {
      var change = {
        new_value: newValue,
        change_type: activeTab,
        label_group: group,
        country: order['General']['Country']['value'],
        label: subentry,
        order_id: order['General']['Order ID']['value'],
        sku: order['General']['SKU']?.['value'] || ''
      }
      changes.push(change);
    }
    var bulkChanges = {
      changes: changes
    }
    var response = await unifiedSendRequest(CHANGES, {formData: JSON.stringify(bulkChanges), headerArgs: {'Content-Type': 'application/json'}});
    if (response.status_code != 200) {
      showMessage('Failed to save changes', false);
    }
    return response;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to save changes', false);
    return false;
  }
}

function buildSubrows(row, items) {
    const existing = row.querySelector('.od-subrows');
    if (existing) {
      existing.hidden = !existing.hidden;
      return;
    }

    const wrap = document.createElement('div');
    wrap.className = 'od-subrows';

    if (activeTab === 'orders') {
      ul = buildOrdersSubheader(wrap);
    } else if (activeTab == 'returns') {
      ul = buildReturnsSubheader(wrap);
    }

    (items || []).forEach(it => {
      if (activeTab == 'orders') { li = buildOrdersSubrows(it); } else if (activeTab == 'returns') { li = buildReturnsSubrows(it); }
      ul.appendChild(li);
    });
    row.appendChild(wrap);
}

function buildOrdersSubheader(wrap) {
    const header = document.createElement('div');
    header.className = 'od-subheader od-orders-sub';

    const prod = document.createElement('div');
    prod.className = 'od-subcol od-subcol--prod';
    prod.textContent = 'Product';

    const sku = document.createElement('div');
    sku.className = 'od-subcol od-subcol--sku';
    sku.textContent = 'SKU';

    const qty = document.createElement('div');
    qty.className = 'od-subcol od-subcol--qty';
    qty.textContent = 'Amount';

    const tags = document.createElement('div');
    tags.className = 'od-subcol od-subcol--tags';
    tags.textContent = 'Legislation';

    const ul = document.createElement('ul');
    ul.className = 'od-sublist';

    header.append(prod, sku, qty, tags);
    wrap.appendChild(header);
    wrap.appendChild(ul);
    return ul;
}

function buildReturnsSubheader(wrap) {
    const header = document.createElement('div');
    header.className = 'od-subheader od-returns-sub';

    const prod = document.createElement('div');
    prod.className = 'od-subcol od-subcol--prod';
    prod.textContent = 'Product';

    const sku = document.createElement('div');
    sku.className = 'od-subcol od-subcol--sku';
    sku.textContent = 'SKU';

    const qtyOrdered = document.createElement('div');
    qtyOrdered.className = 'od-subcol od-subcol--qty';
    qtyOrdered.textContent = 'Amount Ordered';

    const qtyReturned = document.createElement('div');
    qtyReturned.className = 'od-subcol od-subcol--qty';
    qtyReturned.textContent = 'Amount Returned';

    const ul = document.createElement('ul');
    ul.className = 'od-sublist';

    header.append(prod, sku, qtyOrdered, qtyReturned);
    wrap.appendChild(header);
    wrap.appendChild(ul);
    return ul;
}

function buildOrdersSubrows(it) {
  const li = document.createElement('li');
    li.className='od-subrow od-orders-sub';
    li.dataset.id = it['General']['SKU']['value']||'';
    li.onclick = () => showDetails(it, false, li);
    li.innerHTML = `
      <div class="od-subcol od-subcol--prod">${escapeHtml(it['General']['Name']['value']|| it['General']['Product Name']['value']||'')}</div>
      <div class="od-subcol od-subcol--sku"><code>${escapeHtml(it['General']['SKU']['value']||'')}</code></div>
      <div class="od-subcol od-subcol--qty">${escapeHtml(it['General']['Amount']['value']||'')}</div>
      <div class="od-subcol od-subcol--tags"></div>`;
    const tagsBox = li.querySelector('.od-subcol--tags');
    (it['General'].legislation||[]).forEach(t=>{
      const s = document.createElement('span');
      s.className = `od-tag od-tag--${String(t).charAt(0).toLowerCase().replace(/\s+/g,'-')}`;
      s.textContent = t.charAt(0).toUpperCase();
      tagsBox.appendChild(s);
    });
    return li;
  }

function buildReturnsSubrows(it) {
  const li = document.createElement('li');
  li.className='od-subrow od-returns-sub';
  li.onclick = () => showDetails(it, false, li);
  li.innerHTML = `
    <div class="od-subcol od-subcol--prod">${escapeHtml(it['General']['Name']['value']|| it['General']['Product Name']['value']||'')}</div>
    <div class="od-subcol od-subcol--sku"><code>${escapeHtml(it['General']['SKU']['value']||'')}</code></div>
    <div class="od-subcol od-subcol--qty">${escapeHtml(it['General']['Amount Ordered']['value']||'')}</div>
    <div class="od-subcol od-subcol--qty">${escapeHtml(it['General']['Amount Returned']['value']||'')}</div>`;
  return li;
}

function expandOrder(li, group) {
  showDetails(group, true, li);
  buildSubrows(li, group.Products);
}

/**
 * Build one <li> row for the Orders list from a grouped order.
 * Expects: { orderId, date, customer, status, country }
 */
 function createOrderListItem(group) {
  const li = document.createElement('li');
  li.className = 'od-row od-row--order';
  li.dataset.id = group['Order ID'] || '';
  li.dataset.kind = 'orders';
  li.tabIndex = 0;
  li.setAttribute('aria-expanded', 'false');
  li.onclick = (e) => {
    if (e.target.closest('.od-subrows')) return;
    e.stopPropagation();
    li.querySelector('.od-caret').classList.toggle('od-caret-expanded');
    expandOrder(li, group);
  };

  li.innerHTML = `
    <button class="od-toggle" type="button" aria-label="Toggle product lines" title="Show products">
      <span class="od-caret" aria-hidden="true">{% render 'icon-arrow-rounded' %}</span>
    </button>
    <div class="od-col od-col--sm">${escapeHtml(toYMD(group['Bought On']) || '')}</div>
    <div class="od-col">${escapeHtml(group['Order ID'])}</div>
    <div class="od-col">${escapeHtml(group['Profile'] || 'Unknown')}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['Status'] || 'Processing')}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['Country'] || '')}</div>
    <div class="od-col od-col--select">
      <input type="checkbox" class="od-select" />
    </div>
  `;

  // get the rendered checkbox and stop row click when using it
  const checkbox = li.querySelector('.od-select');
  checkbox.addEventListener('click', e => {
    e.stopPropagation();
  });
  return li;
}

/**
 * Build one <li> row for the Orders list from a grouped order.
 * Expects: { orderId, date, customer, status, country }
 */
 function createReturnListItem(group) {
  const li = document.createElement('li');
  li.className = 'od-row od-row--order';
  li.dataset.id = group['Order ID'] || '';
  li.dataset.kind = 'returns';
  li.tabIndex = 0;
  li.setAttribute('aria-expanded', 'false');
  li.onclick = (e) => {
    if (e.target.closest('.od-subrows')) return;
    e.stopPropagation();
    li.querySelector('.od-caret').classList.toggle('od-caret-expanded');
    expandOrder(li, group);
  };

  li.innerHTML = `
    <button class="od-toggle" type="button" aria-label="Toggle product lines" title="Show products">
      <span class="od-caret" aria-hidden="true">{% render 'icon-arrow-rounded' %}</span>
    </button>
    <div class="od-col od-col--sm">${escapeHtml(toYMD(group['Returned On']) || '')}</div>
    <div class="od-col">${escapeHtml(group['Order ID'])}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['Status'] || 'Pending')}</div>
    <div class="od-col od-col--select">
      <input type="checkbox" class="od-select" />
    </div>
  `;

  // get the rendered checkbox and stop row click when using it
  const checkbox = li.querySelector('.od-select');
  checkbox.addEventListener('click', e => {
    e.stopPropagation();
  });
  return li;
}

function createFulfilmentListItem(group) {
  const li = document.createElement('li');
  console.log(group);
  li.className = 'od-row od-row--order';
  li.dataset.id = group['General']['Order ID']['value'] || '';
  li.dataset.kind = 'fulfilment';
  li.tabIndex = 0;
  li.setAttribute('aria-expanded', 'false');
  li.innerHTML = `
    <div class="od-col">${escapeHtml(group['General']['Order ID']['value'])}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['General']['Total Weight']['value'] || 'Unknown')}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['General']['Main Type']['value'] || 'Unknown')}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['General']['Main Type Weight']['value'] || 'Unknown')}</div>
    <div class="od-col od-col--sm">${escapeHtml(group['General']['Status']['value'] || 'Pending')}</div>
    <div class="od-col od-col--select">
      <input type="checkbox" class="od-select" />
    </div>
  `;
  const checkbox = li.querySelector('.od-select');
  checkbox.addEventListener('click', e => {
    e.stopPropagation();
  });
  li.onclick = () => showDetailsFulfilment(group, li);
  return li;
}

/**
 * Render many grouped orders into the <ul id="orders-list">.
 * @param {Array<Object>} groups
 * @param {container?:Element|string, clear?:boolean} opts
 * @returns {HTMLElement|null} the list element
 */
function renderOrderGroups(groups = [], opts = {}, tab = 'orders') {
  const { container, clear = true } = opts;
  const list =
    typeof container === 'string'
      ? document.querySelector(container)
      : container instanceof Element
      ? container
      : document.getElementById(tab + '-list');

  if (!list) return null;
  if (clear) list.innerHTML = '';
  if (groups.length == 0) {
    const liElement = document.createElement('li');
    liElement.style.textAlign = 'center';
    liElement.style.padding = '10px';
    liElement.style.display = 'block';
    if (nextOffsetOrders == null && tab == 'orders'  || nextOffsetReturns == null && tab == 'returns' || nextOffsetFulfilment == null && tab == 'fulfilment') {
      liElement.textContent = 'No more ' + tab + ' found';
    } else {
      liElement.textContent = 'No ' + tab + ' found';
    }
    list.appendChild(liElement);
    return list;
  }
  console.log(groups);
  console.log(tab);
  for (const g of groups) list.appendChild(tab == 'orders' ? createOrderListItem(g) : tab == 'returns' ? createReturnListItem(g) : createFulfilmentListItem(g));
  return list;
}

nextOffsetOrders = 0;
nextOffsetReturns = 0;
nextOffsetFulfilment = 0;
total = {};
var receivedData = {};
async function loadData(offset=0, limit=50) {
  try {
    if(activeTab == 'orders') {
      dataEndpoint = ORDERS;
    } else if (activeTab == 'returns') {
      dataEndpoint = RETURNS;
    } else if (activeTab == 'fulfilment') {
      dataEndpoint = FULFILMENT;
    }
    const params = new URLSearchParams();
    params.append('offset', offset);
    params.append('limit', limit);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (search) params.append('search', search);
    if (sourcefile) params.append('source', sourcefile);
    const res = await unifiedSendRequest(dataEndpoint + `?${params.toString()}`, { method: 'GET' });
    if (activeTab == 'orders') {
      nextOffsetOrders = res.next_offset;
    } else if (activeTab == 'returns') {
      nextOffsetReturns = res.next_offset;
    } else if (activeTab == 'fulfilment') {
      nextOffsetFulfilment = res.next_offset;
    }
    total[activeTab] = res.total;
    receivedData[activeTab] = res.items;
    document.getElementById('source').innerHTML = '';
    var option = document.createElement('option');
    option.value = '';
    option.textContent = 'All';
    document.getElementById('source').appendChild(option);
    for (var src of res.source_names.sort()) {
      var option = document.createElement('option');
      option.value = src;
      option.textContent = src;
      document.getElementById('source').appendChild(option);
    }
    return Object.values(res.items);
  } catch (error) {
    console.error(error);
    showMessage('Failed to load ' + activeTab, false);
    return [];
  }
}

let loading = false;
async function appendData(force=false) {
  if (loading && !force) return;
  loading = true;
  if (activeTab == 'orders') {
    nextOffsetData = nextOffsetOrders;
  } else if (activeTab == 'returns') {
    nextOffsetData = nextOffsetReturns;
  } else if (activeTab == 'fulfilment') {
    nextOffsetData = nextOffsetFulfilment;
  }
  if (nextOffsetData == null) { // no more data
    return;
  }
  if (force) {
    showSpinner();
  }
  var currentTab = activeTab;
  const newData = await loadData(nextOffsetData);
  if (currentTab != activeTab) {
    return;
  }
  renderOrderGroups(newData, { container: '#' + activeTab + '-list', clear: force }, activeTab);
  checkOverflow();
  if (force) {
    hideSpinner();
  }
  loading = false;
}

// attach scroll listener
const container = document.getElementById('orders-list');
const containerReturns = document.getElementById('returns-list');
const containerFulfilment = document.getElementById('fulfilment-list');

container.addEventListener('scroll', async () => {
  const threshold = 100; // px from bottom
  if (container.scrollTop + container.clientHeight >= container.scrollHeight - threshold) {
    await appendData();
  }
});

containerReturns.addEventListener('scroll', async () => {
  const threshold = 100; // px from bottom
  if (containerReturns.scrollTop + containerReturns.clientHeight >= containerReturns.scrollHeight - threshold) {
    await appendData();
  }
});

containerFulfilment.addEventListener('scroll', async () => {
  const threshold = 100; // px from bottom
  if (containerFulfilment.scrollTop + containerFulfilment.clientHeight >= containerFulfilment.scrollHeight - threshold) {
    await appendData();
  }
});

var ordersToEdit = [];
var allSelected = false;
function openEditModal() {
  const modal = document.getElementById('editModal');
  const title = document.getElementById('editModalTitle');
  const body = document.getElementById('editModalBody');

  // compute total
  allSelected = document.getElementById('select-all-' + activeTab).checked;
  let totalSelected = total[activeTab];
  var selectedEntriesList = document.querySelectorAll(`#${activeTab}-list .od-select:checked`);

  var editModalSelect = document.getElementById('editModalSelect');
  editModalSelect.innerHTML = '';
  ordersToEdit = [];
  for (var entry of selectedEntriesList) {
    var orderId = entry.closest('li').dataset.id;
    ordersToEdit.push({ orderId: orderId });
  }

  var exampleEntry = ordersToEdit[0];
  if (activeTab == 'fulfilment') {
    var exampleEntryData = receivedData[activeTab][exampleEntry.orderId];
  } else {
    var exampleEntryData = receivedData[activeTab][exampleEntry.orderId].Products[0];
  }

  for (var optGroup of Object.keys(exampleEntryData).sort((a, b) => customSort(a, b, groupDict[activeTab]))) {
    var optionGroup = document.createElement('optgroup');
    optionGroup.label = optGroup;
    optionGroup.value = optGroup;
    var optionGroupOptions = 0;
    for (var option of Object.keys(exampleEntryData[optGroup])) {
        if (option == 'unmapped') {
          continue;
        }
        if (option == 'legislation') {
          continue;
        }
        if (!exampleEntryData[optGroup][option]['editable']) {
          continue;
        }
        var optionElement = document.createElement('option');
        optionElement.textContent = option;
        optionElement.value = option;
        optionElement.dataset.group = optGroup;
        optionElement.dataset.country = exampleEntryData['General']['Country']['value'];
        optionGroup.appendChild(optionElement);
        optionGroupOptions++;
    }
    if (optionGroupOptions == 0) {
      continue;
    }
    editModalSelect.appendChild(optionGroup);
  }

  if (!allSelected) {
    totalSelected = ordersToEdit.length;
  }

  title.textContent = `Edit ${activeTab}`;
  if (totalSelected == 1) {
    body.textContent = `Editing 1 entry`;
  } else {
    body.textContent = `Editing ${totalSelected} entries`;
  }

  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

// Close modal helper
function closeEditModal() {
  const modal = document.getElementById('editModal');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
  document.getElementById('editModalSelect').value = '';
  document.getElementById('editModalInput').value = '';
}


async function editModalConfirm() {
  nrEntries = allSelected ? total[activeTab] : ordersToEdit.length;
  var editValue = document.getElementById('editModalSelect').value;
  var editGroup = document.getElementById('editModalSelect').querySelector('option:checked').dataset.group;
  var country = document.getElementById('editModalSelect').querySelector('option:checked').dataset.country;
  var editInput = document.getElementById('editModalInput').value;
  if (editValue == '') {
    showMessage('Please select a value to edit', false);
    return;
  }
  if (editInput == '') {
    showMessage('Please enter a new value', false);
    return;
  }
  var confirmed = confirm('You are about to change the value of ' + nrEntries + ' entries for ' + editValue + ' to ' + editInput + '. This cannot be undone. Are you sure you want to continue?');
  if (confirmed) {
    if (allSelected) {
      try {
        var formData = new FormData();
        formData.append('change_type', activeTab);
        formData.append('label_group', editGroup);
        formData.append('label', editValue);
        formData.append('country', country);
        formData.append('new_value', editInput);
        if(search) formData.append('search', search);
        if(startDate) formData.append('start_date', startDate);
        if(endDate) formData.append('end_date', endDate);
        if(sourcefile) formData.append('source', sourcefile);
        var response = await unifiedSendRequest(CHANGES + '/query', {formData: formData});
        if (response.status_code == 200) {
          showMessage('Changes saved successfully', true);
          closeEditModal();
          unselectAll();
          setOffset(0, true);
          appendData(true);
        } else {
          showMessage('Failed to save changes', false);
        }
        return;
      } catch (error) {
        console.error(error.message);
        showMessage('Failed to save changes', false);
        return;
      }
    }
    var dataToEdit = [];
    for (var order of ordersToEdit) {
      if (activeTab == 'fulfilment') {
        dataToEdit.push(receivedData[activeTab][order.orderId]);
      } else {
        for (var product of receivedData[activeTab][order.orderId].Products) {
          dataToEdit.push(product);
        }
      }
    }
    var response = await editValues(dataToEdit, editGroup, editValue, editInput);
    if (response) {
      showMessage('Changes saved successfully', true);
      closeEditModal();
      unselectAll();
      setOffset(0, true);
      appendData(true);
    } else {
      showMessage('Failed to save changes', false);
    }
  }
}

function updateHeaderCheckbox(listId, headerId) {
  const checkboxes = document.querySelectorAll(`#${listId} .od-select`);
  const header = document.getElementById(headerId);

  const checkedCount = [...checkboxes].filter(cb => cb.checked).length;
  if (checkedCount === 0) {
    header.checked = false;
    header.indeterminate = false;
    document.getElementById('bulkedit').style.display = 'none';
  } else if (checkedCount === checkboxes.length) {
    header.checked = true;
    header.indeterminate = false;
    document.getElementById('bulkedit').style.display = 'block';
  } else {
    header.checked = false;
    header.indeterminate = true;
    document.getElementById('bulkedit').style.display = 'block';
  }
}

function unselectAll() {
  document.querySelectorAll('#' + activeTab + '-list .od-select').forEach(cb => {
    cb.checked = false;
    cb.closest('li').classList.remove('is-selected');
  });
  updateHeaderCheckbox('' + activeTab + '-list', 'select-all-' + activeTab);
}

document.addEventListener('change', e => {

  if (e.target.id === 'select-all-' + activeTab) {
    const checked = e.target.checked;
    document.querySelectorAll('#' + activeTab + '-list .od-select').forEach(cb => {
      cb.checked = checked;
      cb.closest('li').classList.toggle('is-selected', checked);
    });
    updateHeaderCheckbox('' + activeTab + '-list', 'select-all-' + activeTab);
  }

  if (e.target.classList.contains('od-select')) {
    const li = e.target.closest('li');
    li.classList.toggle('is-selected', e.target.checked);
    e.stopPropagation();
    updateHeaderCheckbox('' + activeTab + '-list', 'select-all-' + activeTab);
  }
});

function checkOverflow() {
  const containerOverflow = document.querySelector("#" + activeTab + "-list");
  const targetOverflow = document.querySelector("#" + activeTab + "-list-header");
  if (containerOverflow.scrollHeight > containerOverflow.clientHeight) {
    targetOverflow.style.paddingRight = "3rem"; // or addClass
  } else {
    targetOverflow.style.paddingRight = "14px";
  }
}

window.addEventListener("resize", () => checkOverflow());

var orders = [];
waitForPermission(async function() {
  if (window.userPermissions['forsure-orders']) {
    orders = await appendData(true);
  }
});

</script>

{% schema %}
  {
    "name": "t:sections.forsure_orders.name",
    "class": "section",
    "settings": [
      {
        "type": "image_picker",
        "id": "upload",
        "label": "Upload"
      },
      {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_orders.presets.name"
      }
    ]
  }
{% endschema %}