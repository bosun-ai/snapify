{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}


{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
    z-index: 1000;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }
  td {
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
    cursor: pointer;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share,
  .send {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }

.table-header-title {
  overflow: hidden;
  transition: max-height 0.5s ease-out;
}
.table-header-title-hidden {
  max-height: 0;
  overflow: hidden;
}
.svg-arrow {
  transform: rotate(90deg);
  transition: transform 0.3s ease; /* Smooth transition for rotation */
}

.collapsed {
  transform: rotate(0deg); /* Rotate arrow 90 degrees when collapsed */
}

tr {
  border-top: 0.2rem solid #17161c !important;
}

.tabulator-page.active {
    color: #2255FF!important;
  }


  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 100;
}

.modal-content {
    position: absolute;
    border-radius: 25px;
    border-width: 0.2rem;
    border-style: solid;
    border-color: #17161c;
    width: 90%;
    max-width: 450px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.modalContainer {
  border-radius: 3rem;
  overflow: hidden;
}

.tooltipSave {
  position: absolute;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  z-index: 1;
  top: 30%;
  left: 50%;
  margin-left: -60px;
  transform: translate(-50%, -50%);
  transition: opacity 0.3s;
}
  .tabulator-row {
    cursor: default!important;
  }
  .tabulator-group-toggle {
    cursor: pointer!important;
  }
.tabulator-arrow {
    display: block!important;
}
  .configbox {
        position: relative;
    background-color: #fafafa;
  }
  #downloads table {
    position: relative;
    background: #fafafa;
}
  #downloads {
    position: relative;
  }
{%- endstyle -%}
{% if customer.tags contains 'member' %}
<div id="classicalHistory" style="display: none">

  <!-- Load d3.js -->
  <!-- <script src="https://d3js.org/d3.v4.js"></script> --><script src="https://cdn.jsdelivr.net/npm/d3@7"> </script>
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <script src="{{ 'forsure-endpoints.js' | asset_url }}"></script>
  <script src="{{ 'forsure-data-loader.js' | asset_url }}"></script>
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>
  {% render 'forsure-simple-notification' %}
  <div id="tooltipWarn" class="tooltip" style="display: none;">Tooltip content</div>
  <div id='tooltip' class="tooltipSave"></div>
<div style="min-height: calc(100vh - 11rem);">
  <!-- Create a div where the graph will take place -->
  <div id='inprogressbox' class="configbox page-width border" style="padding: 0;margin-bottom: 5rem;border-radius:1rem">
    <div>
      <h2 class="flex-header" style="margin-left: 2rem">
        <span id="inprogressheader" class="table-header">
          <svg id="inprogressarrow" style="margin-right: 2rem;" class="svg-arrow" width="20.593" height="22.88" viewBox="0 0 80.593 122.88"><polygon style="fill:#17161c;" points="0,0 30.82,0 80.593,61.44 30.82,122.88 0,122.88 49.772,61.44 0,0"></polygon></svg>
          In Progress</span>
        <span class="icons">
          <!-- <i id="filter" class="icon-1"><img width="20px" src="{{ section.settings.filter | image_url }}" alt="{{ section.settings.filter.alt | escape }}" loading="lazy"></i> -->
          <i id="downloadAll" class="icon-2"><img
              width="20px"
              src="{{ section.settings.download | image_url }}"
              alt="{{ section.settings.download.alt | escape }}"
              loading="lazy"></i>
          <i id="deleteAll" class="icon-3"><img
              width="20px"
              src="{{ section.settings.trashcan | image_url }}"
              alt="{{ section.settings.trashcan.alt | escape }}"
              loading="lazy"></i>
          <input
            type="checkbox"
            id="selectAllCheckbox"
            class="icon-4"
            style="margin-left: 2rem;margin-right: 1em"></span>
      </h2>
      <div id="inprogress" class="table-header-title"></div>
    </div>
  </div>
  <div id='historybox' class="configbox page-width border" style="padding: 0;border-radius:1rem">
    <div>
      <h2 class="flex-header" style="margin-left: 2rem">
        <span id="historyheader" class="table-header">
          <svg id="historyarrow" style="margin-right: 2rem;" class="svg-arrow" width="20.593" height="22.88" viewBox="0 0 80.593 122.88"><polygon style="fill:#17161c;" points="0,0 30.82,0 80.593,61.44 30.82,122.88 0,122.88 49.772,61.44 0,0"></polygon></svg>
          History
        </span>
        <span class="icons">
          <!-- <i id="filter" class="icon-1"><img width="20px" src="{{ section.settings.filter | image_url }}" alt="{{ section.settings.filter.alt | escape }}" loading="lazy"></i> -->
          <i id="downloadAll" class="icon-2"><img
              width="20px"
              src="{{ section.settings.download | image_url }}"
              alt="{{ section.settings.download.alt | escape }}"
              loading="lazy"></i>
          <i id="deleteAll" class="icon-3"><img
              width="20px"
              src="{{ section.settings.trashcan | image_url }}"
              alt="{{ section.settings.trashcan.alt | escape }}"
              loading="lazy"></i>
          <input
            type="checkbox"
            id="selectAllCheckbox"
            class="icon-4"
            style="margin-left: 2rem;margin-right: 1em">
          </span>
      </h2>
      <div id="downloads" class="table-header-title"></div>
    </div>
  </div>
  <div id="overlay"></div>
  <div id="report-table" style="z-index:50;display: none">
    <div id="report-table-data" style="max-height: 60vh;"></div>
    <button class="button" id="send-report" style="display: none;margin-top: 1rem;margin-left: auto;">File report</button>
  </div>
</div>

<div id="validateModal" class="modal isolate" style="display: none;">
 <div class="modal-content modalContainer" style="background: #fafafa;">
       <div id="title" style="background: #2255ff; padding: 2rem">
          <h2 style="color:#fafafa;text-align:center;">Are you sure?</h2>
        </div>
    <div class="rich-text__wrapper modal-content-text rich-text__wrapper--center page-width">
      <div class="rich-text__blocks center"><div class="rich-text__text textblock rte" style="color: #17161c; width: 88%; margin: 0 auto;margin-top:4rem;text-align: justify;text-align-last: left;">
        Make sure you double check the data before continuing.
        <br>
        <p style="color:#a80000;padding: 2rem 0;text-align: justify;text-align-last: left;">Important: After you press send, the report data will be automatically sent to the corresponding institution.</p>
      </div>
        <div style="margin-top: 0;margin-bottom: 2rem;">
          <button class="button" style="background-color: #17161c;margin-right: 2rem;" onclick="closeModal()">Close</button>
          <button class="button" id="validated-report-send">File Report</button>
        </div>
      </div>
    </div>
  </div>
</div>

  {% render 'forsure-login' %}
  <script>

    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

function closeModal() {
  document.getElementById('validateModal').style.display = 'none';
}

    
function createTable(configDiv, tableData, inprogress) {
    // Clear any existing fields
    configDiv.innerHTML = "";
    var addInprogress = '';
    if (inprogress) {
      addInprogress = 'inprogress';
    }

// Create a table element
const table = document.createElement('table');
table.style.width = '100%';

// Enhanced visibility control
let countryVisibility = {};
let categoryVisibility = {};

Object.keys(tableData).forEach(country => {
  const countryKey = addInprogress + `country_${country}`; // Unique identifier for each country
  countryVisibility[countryKey] = false; // Start with each country collapsed

  // Create and append a row for the country
  const countryRow = document.createElement('tr');
  const countryCol = document.createElement('td');
  countryCol.style.width = '80%';
  countryCol.style.fontWeight = 'bold';
  countryCol.style.fontSize = 'large';
  var svg = `<svg id="${addInprogress}arrow_${country}" class="svg-arrow collapsed" style="margin-right: 2rem;" width="20.593" height="22.88" viewBox="0 0 80.593 122.88"><polygon style="fill:#17161c;" points="0,0 30.82,0 80.593,61.44 30.82,122.88 0,122.88 49.772,61.44 0,0"></polygon></svg>`;
  countryCol.innerHTML = svg + country;
  countryCol.style.cursor = 'pointer';
  countryRow.appendChild(countryCol);
  table.appendChild(countryRow);

  countryCol.addEventListener('click', () => {
    countryVisibility[countryKey] = !countryVisibility[countryKey]; // Toggle visibility of the country
    document.getElementById(addInprogress + `arrow_${country}`).classList.toggle('collapsed');
    // Apply visibility changes to categories and their rows within this country
    document.querySelectorAll(`.${addInprogress}category-${country}, .${addInprogress}row-${country}`).forEach(row => {
      const rowCategoryKey = row.getAttribute('data-category-key');
      // Check if the row is a category or an item within a category
      if (row.classList.contains(addInprogress + `category-${country}`)) {
        row.style.display = countryVisibility[countryKey] ? '' : 'none';
      } else if (countryVisibility[countryKey] && categoryVisibility[rowCategoryKey]) {
        // Show row if both country and category are expanded
        row.style.display = '';
      } else {
        // Hide row otherwise
        row.style.display = 'none';
      }
    });
  });

  Object.keys(tableData[country]).forEach((category, index) => {
    const categoryKey = addInprogress + `category_${country}_${index}`;
    categoryVisibility[categoryKey] = false; // Start with categories collapsed

    const categoryData = tableData[country][category];

    // Create a section header for the category
    const headerRow = document.createElement('tr');
    headerRow.className = addInprogress + `category-${country}`; // Class for toggling visibility
    headerRow.setAttribute('data-category-key', categoryKey); // Track category key
    headerRow.style.display = 'none'; // Start hidden
    const headerCol = document.createElement('td');
    headerCol.colSpan = 6;
    headerCol.style.paddingLeft = '4rem';
    headerCol.style.fontWeight = 'bold';
    headerCol.style.fontSize = 'large';
    var svg = `<svg id="arrow_${country}_${category}" class="collapsed svg-arrow" style="margin-right: 2rem;" width="20.593" height="22.88" viewBox="0 0 80.593 122.88"><polygon style="fill:#17161c;" points="0,0 30.82,0 80.593,61.44 30.82,122.88 0,122.88 49.772,61.44 0,0"></polygon></svg>`;
    headerCol.innerHTML = svg + `${category}`;
    headerCol.style.cursor = 'pointer';
    headerRow.appendChild(headerCol);
    table.appendChild(headerRow);

    headerCol.addEventListener('click', () => {
      categoryVisibility[categoryKey] = !categoryVisibility[categoryKey]; // Toggle visibility
      document.getElementById(`arrow_${country}_${category}`).classList.toggle('collapsed');
      document.querySelectorAll(`.${addInprogress}row-${country}_${index}`).forEach(row => {
        row.style.display = categoryVisibility[categoryKey] ? '' : 'none'; // Apply visibility
      });
    });

    // List the Debugger and filename entries
    ['Excluded_data', 'Debugger', 'filename'].forEach(type => {
      if (categoryData[type]) {
        const tableRow = document.createElement('tr');
        tableRow.classList.add(`${addInprogress}row-${country}_${index}`, `${addInprogress}row-${country}`); // Class for toggling visibility
        tableRow.setAttribute('data-category-key', categoryKey); // Track category key
        tableRow.style.display = 'none'; // Start hidden
        
        const itemCol = document.createElement('td');
        itemCol.style.paddingLeft = '8rem';
        itemCol.style.width = '80%';
        itemCol.innerHTML = categoryData[type]['reportname'];
        tableRow.appendChild(itemCol);

        // var warnCol = addWarnIcon(categoryData[type]['warning'], inprogress);
        // tableRow.appendChild(warnCol);
        
        var openCol = addOpenIcon(categoryData[type]['reportname'], inprogress);
        tableRow.appendChild(openCol);

        var downloadCol = addDownloadCol(categoryData[type]['reportname'], inprogress);
        tableRow.appendChild(downloadCol);

        var shareCol = addShareCol(categoryData[type]['reportname'], inprogress);
        tableRow.appendChild(shareCol);

        var trashCol = addTrashIcon(categoryData[type]['reportname'], inprogress);
        tableRow.appendChild(trashCol);

        if (type == 'filename') {
          // only send normal reports
          var openCol = sendReportIcon(categoryData[type]['reportname'], inprogress);
          tableRow.appendChild(openCol);
        } else {
          tableRow.appendChild(createCol(''));
        }

        var checkboxCol = addCheckboxCol(categoryData[type]['reportname'], inprogress);
        tableRow.appendChild(checkboxCol);

        table.appendChild(tableRow);
      }
    });
  });
});

// Append the table to the configuration div
configDiv.appendChild(table);
}

function createCol(content, title = '', alignRight = false) {
          const col = document.createElement('td');
          col.style.width = '4rem';
          col.style.padding = '10px'; // Add padding
          if (alignRight) {
            col.style.textAlign = 'right'; // Align content to the right
          }col.innerHTML = content;
          return col;
}

function addOpenIcon(data, inprogress) {
        const openCol = createCol('<i class="open"><img width="20px" src="                         {{ section.settings.open | image_url }} " alt="                         {{ section.settings.open.alt | escape }}" loading="lazy"></i>', "Open report"); // Placeholder icon
        openCol.addEventListener('click', async function() {
          displayReport(data, inprogress);
        });
  return openCol;
}

function sendReportIcon(data, inprogress) {
        const openCol = createCol('<i class="send"><img width="20px" src="                         {{ section.settings.send_report | image_url }} " alt="                         {{ section.settings.send_report.alt | escape }}" loading="lazy"></i>', "Send report"); // Placeholder icon
        openCol.addEventListener('click', async function() {
          displayReport(data, inprogress, true);
        });
  return openCol;
}


function addWarnIcon(data, inprogress) {
  var level = data['level'];
  var message = data['message'];
  var errorIcon = '';
  var icon = ''
  if (level == 1) {
    icon = '<i class="open"><img width="20px" src="{{ section.settings.open | image_url }} " alt="{{ section.settings.open.alt | escape }}" loading="lazy"></i>';
  } else {
    icon = '<i class="open"><img width="20px" src="{{ section.settings.download | image_url }} " alt="{{ section.settings.download.alt | escape }}" loading="lazy"></i>';
  }
  const warnCol = createCol(icon, "Open report"); // Placeholder icon
  warnCol.addEventListener('click', async function(event) {
      displayTooltip(message, inprogress, event);
  });
  return warnCol;
}

function displayTooltip(message, inprogress, event) {
    const tooltip = document.getElementById('tooltipWarn');
    // Update tooltip content dynamically, e.g., using 'data' and 'inprogress'
    tooltip.innerHTML = message;
    // Position tooltip at the click position
    tooltip.style.left = event.pageX + 'px';
    tooltip.style.top = event.pageY + 'px';
    // Show the tooltip
    tooltip.style.display = 'block';
}

function addDownloadCol(data, inprogress) {
  const downloadCol = createCol('<i class="download"><img width="20px" src="                         {{ section.settings.download | image_url }} " alt="                         {{ section.settings.download.alt | escape }}" loading="lazy"></i>', "Download report"); // Placeholder icon
        downloadCol.addEventListener('click', async function() {
          try {
            const reportData = new FormData();
            reportData.append("report_name", data);
            reportData.append("inprogress", inprogress);
            const reportdata = await unifiedSendRequest(GETSINGLEREPORT, {formData: reportData});
            console.log(reportdata);
          } catch (error) {
            console.error(error.message);
            TOKEN = false;
          }
        });
  return downloadCol;
}

function addShareCol(data, inprogress) {
  const shareCol = createCol('<i class="share"><img width="20px" src="                         {{ section.settings.share | image_url }} " alt="                         {{ section.settings.share.alt | escape }}" loading="lazy"></i>', "Share report"); // Placeholder icon
        shareCol.addEventListener('click', async function() {
          try {
            console.log(data);
            const reportData = new FormData();
            reportData.append("report_name", data);
            reportData.append("inprogress", inprogress);
            const downloadData = await unifiedSendRequest(CREATEDOWNLOADLINK, {formData: reportData});
            const subject = encodeURIComponent("Here is the EPR report " + downloadData.reportname);
            const body = encodeURIComponent("\n\nHere is the link to download the report: " + server_url + downloadData.link + "\nUsername: " + downloadData.username + "\nPassword: " + downloadData.password + "\n\n");

// Open the default mail client
            window.location.href = "mailto:?subject=" + subject + "&body=" + body;

          } catch (error) {
            console.error(error.message);
            TOKEN = false;
          }
        });
  return shareCol;
}

function addTrashIcon(data, inprogress) {
  const trashcanCol = createCol('<i class="trashcan"><img width="20px" src="                         {{ section.settings.trashcan | image_url }} " alt="                         {{ section.settings.trashcan.alt | escape }}" loading="lazy"></i>', "Delete report"); // Placeholder icon
        trashcanCol.addEventListener('click', async function() {
          try {
            const reportData = new FormData();
            reportData.append("report_name", data);
            reportData.append("inprogress", inprogress);
            const deleteData = await unifiedSendRequest(DELETEREPORT, {formData: reportData});
            getDownloads();
          } catch (error) {
            console.error(error.message);
            TOKEN = false;
          }
        });
  return trashcanCol;
}

function addCheckboxCol(data, inprogress) {
  const checkboxCol = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = data;
        checkbox.className = 'rowCheckbox';
        checkbox.addEventListener('change', function() {
          const allChecked = [...document.querySelectorAll('input[type="checkbox"].rowCheckbox')].every(ch => ch.checked);
          const allUnchecked = [...document.querySelectorAll('input[type="checkbox"].rowCheckbox')].every(ch => !ch.checked);

          if (allChecked) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else if (allUnchecked) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true; // This sets the checkbox to its "indeterminate" state
          }
        });
        checkboxCol.appendChild(checkbox);
  return checkboxCol;
}

document.getElementById('downloadAll').addEventListener('click', async function() {
      const checkboxes = document.querySelectorAll("#downloads table input[type='checkbox']");
      const selectedReports = [];
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedReports.push(checkbox.value);
        }
      });
      if (selectedReports.length === 0) {
        console.log("No reports selected for downloading.");
        return;
      }
      console.log("Download these reports:", selectedReports);
      try {
        const reportData = new FormData();
        selectedReports.forEach(reportName => {
          reportData.append("report_names", reportName);
        });
        const data = await unifiedSendRequest(DOWNLOADMULTIPLEREPORTS, {formData: reportData});
        console.log(data);
      } catch (error) {
        console.error(error.message);
        TOKEN = false;
      }
    });
    document.getElementById('deleteAll').addEventListener('click', async function() {
      const checkboxes = document.querySelectorAll("#downloads table input[type='checkbox']");
      const selectedReports = [];
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedReports.push(checkbox.value);
        }
      });
      if (selectedReports.length === 0) {
        console.log("No reports selected for deletion.");
        return;
      }
      console.log("Delete these reports:", selectedReports);
      try {
        const reportData = new FormData();
        selectedReports.forEach(reportName => {
          reportData.append("report_names", reportName);
        });

        const data = await unifiedSendRequest(DELETEMULTIPLEREPORTS, {formData: reportData});
        getDownloads();
      } catch (error) {
        console.error(error.message);
        TOKEN = false;
      }
    });
    document.addEventListener('DOMContentLoaded', function() {

// Event listener for select all checkbox
      selectAllCheckbox.addEventListener('change', function() {
        const individualCheckboxes = document.querySelectorAll('input[type="checkbox"].rowCheckbox'); // Assuming your individual checkboxes have a class "rowCheckbox"
        individualCheckboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
      });

});

    async function getDownloads() {
      try {
        let data = await unifiedSendRequest(GETREPORTNAMES);
        console.log(data);

// Get the configuration div
        const configDiv = document.getElementById("downloads");

        createTable(configDiv, data, false);

      } catch (error) {
        console.error(error.message);
        TOKEN = false;
      }
    }

    async function getInprogress() {
      // try {
        let data = await unifiedSendRequest(GETREPORTNAMESINPROGRESS);
        console.log(data);

// Get the configuration div
        const configDiv = document.getElementById("inprogress");

        createTable(configDiv, data, true);

      // } catch (error) {
      //   console.error(error.message);
      //   TOKEN = false;
      // }
    }

    function showModal() {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('report-table').style.display = 'block';
    }

    function hideModal() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('report-table').style.display = 'none';
    }

    // Function to create columns from the keys of the first data object
    function createColumnsFromData(data) {
      if (data.length === 0) {
        return [];
      }
      return Object.keys(data[0]).map(key => {
        return {
          title: convertStringFormat(key), // Use the key as the title
          field: key,  // Use the key as the field
          visible: key !== "Category" // Hide the Category column since it's used for grouping
        };
      });
    }
    const name_mapper = {
    'amount_total': 'Amount Total',
    'amount_b2b': 'Amount B2B',
    'amount_b2c': 'Amount B2C',
    'weight_total': 'Weight Total (kg)',
    'weight_b2b': 'Weight B2B (kg)',
    'weight_b2c': 'Weight B2C (kg)',
    'sku': 'SKU',
    'orderid': 'OrderID',
    'b2b': 'B2B'
  };

  function convertStringFormat(s) {
    if (name_mapper.hasOwnProperty(s)) {
      return name_mapper[s];
    }
    return s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  }

    async function displayReport(reportname, inprogress, validate=false) {
      try {
        const reportData = new FormData();
        reportData.append("report_name", reportname);
        reportData.append("inprogress", inprogress);
        const data = await unifiedSendRequest(DISPLAYREPORT, {formData: reportData});
        console.log(data);
        const columns = createColumnsFromData(data);
        const table = new Tabulator("#report-table-data", {
          data: data,
          layout: columns.length > 20? "fitDataFill": "fitColumns",
          // layout: "fitDataFill", // Fit columns to width of table (optional)
          groupBy: "Category",
          groupHeader: function(value, count, data, group) {
            return value; // returns just the category name without count
          },
          pagination: data.length > 20 ? true : false,
          paginationCounter: "rows",
          paginationSize: 20,
          columns: columns
        });
        const reportTable = document.getElementById('report-table');
        reportTable.style.display = 'block';
        if (validate) {
          document.getElementById('send-report').style.display = 'block';
          document.getElementById('send-report').onclick = function() {
            sendReport(reportname, inprogress);
          };
        } else {
          document.getElementById('send-report').style.display = 'none';
        }
        showModal();
      } catch (error) {
        console.error(error);
        TOKEN = false;
      }
    }
    document.getElementById('overlay').addEventListener('click', hideModal);

function sendReport(reportName, inprogress) {
      document.getElementById('validateModal').style.display = 'block';
      document.getElementById('validated-report-send').onclick = async function() {
        sendReportGov(reportName, inprogress);
      }
  }

  async function sendReportGov(reportName, inprogress) {
    try {
      const reportData = new FormData();
      reportData.append("report_name", reportName);
      reportData.append("inprogress", inprogress);
      const data = await unifiedSendRequest(SENDREPORT, {formData: reportData});
      console.log(data);
      if (data) {
        closeModal();
        hideModal();
        showTooltip("Report sent successfully", true);
      } else {
        showTooltip("Failed to send report", false);
      }
    } catch (error) {
      console.error(error);
      TOKEN = false;
      showTooltip("Failed to send report", false);
    }
  }

  function showTooltip(message, isSuccess) {
  var tooltip = document.getElementById('tooltip');
  if (!isSuccess) {
    tooltip.style.backgroundColor = "red"; // Different background for error
  } else {
    tooltip.style.backgroundColor = "#2255ff";
  }
  tooltip.textContent = message;


  setTimeout(() => {
    tooltip.style.display = 'block';
    setTimeout(() => {
      tooltip.style.display = 'none';
    }, 2000); // Show for 2 seconds
  }, 10); // Minor delay to ensure transition effect
}


  function toggleCollapse(collapsableId, arrowId) {
    var arrowElement = document.getElementById(arrowId);
    var element = document.getElementById(collapsableId);
    element.classList.toggle('columnsLeftContentListHidden');
    if (element.classList.contains('columnsLeftContentListHidden')) {
      element.style.maxHeight = 0;
    } else {
      //element.style.maxHeight = element.scrollHeight + "px";
      element.style.removeProperty('max-height');
    }

    arrowElement.classList.toggle('collapsed');
  }

    function toggleInProgress() {
      toggleCollapse('inprogress', 'inprogressarrow');
    }

    function toggleHistory() {
      toggleCollapse('downloads', 'historyarrow');
    }

    document.getElementById('inprogressheader').addEventListener('click', toggleInProgress);
    document.getElementById('historyheader').addEventListener('click', toggleHistory);
    getDownloads();
    getInprogress();


document.addEventListener("DOMContentLoaded", function() {
  const tooltip = document.querySelector('.tooltipSave');
  function updateTooltipPosition() {
    const scrollHeight = window.pageYOffset || document.documentElement.scrollTop;
    const viewportHeight = window.innerHeight;
    const topPosition = (viewportHeight * 0.3) + scrollHeight;
    tooltip.style.top = `${topPosition}px`;
  }

  // Update position when the page is loaded and whenever it is scrolled or resized
  updateTooltipPosition();
  window.addEventListener('scroll', updateTooltipPosition);
  window.addEventListener('resize', updateTooltipPosition);
});


function showGuide() {
    startGuide([
        { element: "main", group: "{{ 'software.guide.download.welcome.group' | t }}", title: "{{ 'software.guide.download.welcome.title' | t }}", text: "{{ 'software.guide.download.welcome.text' | t }}", where: 'middle' },
        { element: "#inprogressbox", group: "{{ 'software.guide.download.inprogress.group' | t }}", title: "{{ 'software.guide.download.inprogress.title' | t }}", text: "{{ 'software.guide.download.inprogress.text' | t }}", where: 'below' },
        { element: "#historybox", group: "{{ 'software.guide.download.history.group' | t }}", title: "{{ 'software.guide.download.history.title' | t }}", text: "{{ 'software.guide.download.history.text' | t }}", where: 'inside' },
        { element: "#downloads", group: "{{ 'software.guide.download.country.group' | t }}", title: "{{ 'software.guide.download.country.title' | t }}", text: "{{ 'software.guide.download.country.text' | t }}", where: 'below', displayTemp: true },
        { element: "#downloads table tr:nth-child(3)", group: "{{ 'software.guide.download.debugger.group' | t }}", title: "{{ 'software.guide.download.debugger.title' | t }}", text: "{{ 'software.guide.download.debugger.text' | t }}", where: 'below', secondElement: '#downloads', displayTemp: true},
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.report.group' | t }}", title: "{{ 'software.guide.download.report.title' | t }}", text: "{{ 'software.guide.download.report.text' | t }}", where: 'below', secondElement: '#downloads', displayTemp: true},
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.open.group' | t }}", title: "{{ 'software.guide.download.open.title' | t }}", text: "{{ 'software.guide.download.open.text' | t }}", secondElement: '#downloads', where: 'below', displayTemp: true },
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.download.group' | t }}", title: "{{ 'software.guide.download.download.title' | t }}", text: "{{ 'software.guide.download.download.text' | t }}", secondElement: '#downloads', where: 'below', displayTemp: true },
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.share.group' | t }}", title: "{{ 'software.guide.download.share.title' | t }}", text: "{{ 'software.guide.download.open.text' | t }}", secondElement: '#downloads', where: 'below', displayTemp: true },
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.delete.group' | t }}", title: "{{ 'software.guide.download.delete.title' | t }}", text: "{{ 'software.guide.download.delete.text' | t }}", secondElement: '#downloads', where: 'below', displayTemp: true },
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.send.group' | t }}", title: "{{ 'software.guide.download.send.title' | t }}", text: "{{ 'software.guide.download.send.text' | t }}", secondElement: '#downloads', where: 'below', displayTemp: true },
        { element: "#downloads table tr:nth-child(4)", group: "{{ 'software.guide.download.checkbox.group' | t }}", title: "{{ 'software.guide.download.checkbox.title' | t }}", text: "{{ 'software.guide.download.checkbox.text' | t }}", secondElement: '#downloads', where: 'below', displayTemp: true }
    ]);
    setCookie('showedGuideDownload', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
}


document.addEventListener('DOMContentLoaded', function() {
  if(readCookie('showedGuideDownload') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
      setCookie('showedGuideDownload', 'true', 300);
    }
  });

  </script>
</div>

{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_download.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_download.settings.desktop_image_width.label",
        "info": "t:sections.forsure_download.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_download.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_download.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_download.settings.layout.label",
        "info": "t:sections.forsure_download.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_download.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_download.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "image_picker",
        "id": "send_report",
        "label": "Send Report"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_download.presets.name"
      }
    ]
  }
{% endschema %}