{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}
{{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    /* border: none !important; */
    border: 0.1rem solid #17161c !important;
  }
  th, td {
    border: 0.1rem solid #17161c!important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 1; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    max-height: 61vh; /* 80% of the viewport height */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }
  #editableTable_wrapper {
    margin: 0.5rem;
  }
  .odd {
    background-color: #f0f0f0!important;
  }

  .align-with-column {
    position: absolute;
    bottom: -50px; /* Adjust as needed */
}
.button {
    z-index: 0;
}
#overlayExitNewCol {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }
  #newColPopup {
    display: none;
    position: fixed;
    top: 40%;
    left: 40%;
    background-color: #fafafa;
    z-index: 3; /* Display in front of other overlay */
    padding: 2rem;
    border-radius: 3rem;
  }

#confirmPopup {
    /* Styling for popup */
    position: fixed;
    /* Other styling as needed */
}
#editableTable_filter {
  margin-bottom: 2rem;
}
.custom-table-wrapper {
    overflow-x: auto;
    width: 100%; /* Ensure the wrapper spans the full width */
}

#deactivateEditModeSave:hover, #savestorecategory:hover {
    color: #fafafa;
}

.button--secondary {
  border: 0.2rem solid #17161c!important;
}

#overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #popup {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fafafa;
    border: #17161c solid 0.2rem;
    border-radius: 2rem;
    z-index: 2; /* Displayed in front of the overlay */
    width: 40%; /* Adjust width as needed */
    max-width: 40%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }
  .disabled {
    pointer-events: none; /* Prevents clicks */
    opacity: 0.8; /* Make it look visually disabled */
}
  .glyphicon-ok:before {
    content: "\2713"
  }

.person-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin: 5px;
    text-align: center;
}

    /* Container for all online people icons */
#onlinePeople {
    display: flex;
    flex-wrap: wrap;
    margin: auto;
    margin-right: 0;
}

{%- endstyle -%}
{% if customer.tags contains 'member' or customer.tags contains 'vendor' %}
  <script src="{{ 'forsure-endpoints.js' | asset_url }}"></script>
  <script src="{{ 'forsure-data-loader.js' | asset_url }}"></script>
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>
  {% render 'forsure-login' %}
  {% render 'forsure-guide' %}
  {% render 'forsure-simple-notification' %}
  <div id="guideButton" aria-label="Guide"  onclick="showGuideFromButton(this)"
      style="color: black;margin-top:2rem;position: fixed;bottom: 10%;left: 2%;">
    <svg xmlns="http://www.w3.org/2000/svg" height="4rem" version="1.0" viewBox="0 0 200 200" style="cursor: pointer" onclick="showGuide()">
      <path id="path2382" d="m165.33 113.44a103.61 103.61 0 1 1 -207.22 0 103.61 103.61 0 1 1 207.22 0z" stroke-width="0" fill="#fafafa" transform="matrix(.93739 0 0 .93739 42.143 -6.3392)"></path>
      <g id="layer1">
        <path id="path2413" d="m100 0c-55.2 0-100 44.8-100 100-5.0495e-15 55.2 44.8 100 100 100s100-44.8 100-100-44.8-100-100-100zm0 12.812c48.13 0 87.19 39.058 87.19 87.188s-39.06 87.19-87.19 87.19-87.188-39.06-87.188-87.19 39.058-87.188 87.188-87.188zm1.47 21.25c-5.45 0.03-10.653 0.737-15.282 2.063-4.699 1.346-9.126 3.484-12.876 6.219-3.238 2.362-6.333 5.391-8.687 8.531-4.159 5.549-6.461 11.651-7.063 18.687-0.04 0.468-0.07 0.868-0.062 0.876 0.016 0.016 21.702 2.687 21.812 2.687 0.053 0 0.113-0.234 0.282-0.937 1.941-8.085 5.486-13.521 10.968-16.813 4.32-2.594 9.808-3.612 15.778-2.969 2.74 0.295 5.21 0.96 7.38 2 2.71 1.301 5.18 3.361 6.94 5.813 1.54 2.156 2.46 4.584 2.75 7.312 0.08 0.759 0.05 2.48-0.03 3.219-0.23 1.826-0.7 3.378-1.5 4.969-0.81 1.597-1.48 2.514-2.76 3.812-2.03 2.077-5.18 4.829-10.78 9.407-3.6 2.944-6.04 5.156-8.12 7.343-4.943 5.179-7.191 9.069-8.564 14.719-0.905 3.72-1.256 7.55-1.156 13.19 0.025 1.4 0.062 2.73 0.062 2.97v0.43h21.598l0.03-2.4c0.03-3.27 0.21-5.37 0.56-7.41 0.57-3.27 1.43-5 3.94-7.81 1.6-1.8 3.7-3.76 6.93-6.47 4.77-3.991 8.11-6.99 11.26-10.125 4.91-4.907 7.46-8.26 9.28-12.187 1.43-3.092 2.22-6.166 2.46-9.532 0.06-0.816 0.07-3.03 0-3.968-0.45-7.043-3.1-13.253-8.15-19.032-0.8-0.909-2.78-2.887-3.72-3.718-4.96-4.394-10.69-7.353-17.56-9.094-4.19-1.062-8.23-1.6-13.35-1.75-0.78-0.023-1.59-0.036-2.37-0.032zm-10.908 103.6v22h21.998v-22h-21.998z"></path>
      </g>
    </svg>
  </div>
  <link href="https://cdn.datatables.net/v/dt/dt-1.13.7/datatables.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/v/dt/dt-1.13.7/datatables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" />
  <input
    type="file"
    id="category_list"
    style="display: none">
  <button id="deleteButton" style="position: absolute;display:none;z-index:2" onclick="deleteColumn()">X</button>
  <button id="deleteButtonRow" style="position: absolute;display:none;z-index:2" onclick="deleteRow()">X</button>
  {% render 'forsure-rules' %}
  <div style="padding: 3rem;margin: 3rem;border-radius: 2rem;border:0.2rem solid #17161c">
    <div id="overlay"></div>
    <div id="popup" style="z-index:50;display: none">
      <div id="popupcontent" style="width: 70%; margin: auto">
          <h2 style="text-align: center">Connect to your store</h2>
          <div><h4>Choose from Profiles</h4>
            <select
                id="profileDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
          </div>
          <div>
            <h4>Or add it manually</h4>
            <div>
              <table>
                <tr>
                  <td><label for="storeUrl">Store URL:</label></td>
                  <td><input type="text" id="storeUrl" placeholder="Store URL"/></td>
                </tr>
                <tr>
                  <td><label for="token">Token:</label></td>
                  <td><input type="password" id="token" placeholder="shpat..." /></td>
                </tr>
                <tr>
                  <td><label for="username">Username:</label></td>
                  <td><input type="text" id="username" placeholder="username" /></td>
                </tr>
                <tr>
                  <td><label for="password">Password:</label></td>
                  <td><input type="password" id="password" placeholder="****" /></td>
                </tr>
              </table>
            </div>
          </div>
          <div>
            <div id="progress-container" style="width: 100%; background-color: #f3f3f3; border-radius: 5px; margin-top: 20px;">
                <div id="progress-bar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px;display: block;"></div>
            </div>
          </div>
          <a id="savestorecategory" onclick="importFromStore()" class="button" style="margin: 1rem;cursor: pointer;">Save</a>
      </div>
    </div>
    <div style="width: 96%;overflow-x: auto;margin-left: 2%;margin-right: 2%;">
      <div id="icons" style="display: flex;justify-content: space-between;">
        <div>
          <div id="addCategoryButton">
              <a id="activateCategoryMode" onclick="activateCategorylistMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Category List</a>
          </div>
          <div id="categoryModeActivated" style="display: none">
              <a id="deactivateCategorylistMode" onclick="deactivateCategorylistMode(false)" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Cancel</a>
              <a onclick="document.getElementById('category_list').click()" style="cursor:pointer;margin: 1rem;"
              class="button button--secondary" id="uploadCategorylistButton">Upload categorylist</a>
              <a id="categorylistfromstore" onclick="openImportFromStorePopup()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add from Store</a>
          </div>
        </div>
        <div id="onlinePeople">
        </div>
        <div id="editButton">
          <a id="activateEditMode" onclick="activateEditMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Edit</a>
        </div>
        <div id="editModeActivated" style="display: none">
          <a id="deactivateEditMode" onclick="deactivateEditMode(false)" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Cancel</a>
          <a id="addRowBtn" onclick="addNewRow()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Row</a>
          <a id="addColumnBtn" onclick="addNewColumn()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Column</a>
          <a id="addRuleBtn" onclick="displayRules()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Rule</a>
          <a id="deactivateEditModeSave" onclick="deactivateEditMode(true)" class="button" style="margin: 1rem;cursor: pointer;">Save</a>
        </div>
      </div>
      <div id="errorsDiv" style="color: red; display: none;text-align: center"></div>
      <table id="editableTable" style="width:100%; overflow-x: auto">
        <thead></thead>
      </table>
    </div>
  </div>
  <script>
    document.getElementById('category_list').addEventListener('change', uploadCategoryList);
    $(document).ready(getCategorylistDetails);

    async function uploadCategoryList() {
      var errorDiv = document.getElementById('errorsDiv');
      errorDiv.style.display = 'none';
      var files = event.target.files;
      if (files.length) {
        try {
          const file = event.target.files[0];
          const formData = new FormData();
          formData.append('category_list', file);

// TODO remove profile
          await unifiedSendRequest(UPLOADCATEGORYLIST + `?profile=1`, {formData: formData});
          // window.location.reload();

        } catch (error) {
          console.error(error);
          errorDiv.style.display = 'block';
          errorDiv.innerText = error;
        }
      }
    }

    function openImportFromStorePopup() {
      document.getElementById('popup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
    function hideModal() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('popup').style.display = 'none';
    }

    document.getElementById('overlay').addEventListener('click', hideModal);

async function fillDropdown(dropdownId, filters, key) {
  dropdownId = "profileDropdown", 
  filters = {
      'country': [],
      'start_time': null,
      'end_time': null,
      'profile': [],
      'report_name': [],
      'categories': []
  };
  key = 'profile'
  try {
      const response = await unifiedSendRequest(STATSREPORTS, {formData: JSON.stringify(filters), 
          headerArgs: {'Content-Type': 'application/json'}});
      console.log(response);

      const dropdown = document.getElementById(dropdownId);

      dropdown.innerHTML = "";

      const entries = response[key];
      console.log(`Filling dropdown ${key} with ${entries}`);
      
      entries.forEach(entry => {
          const option = document.createElement("option");
          if(key === 'profile'){
              option.value = entry['profile_id'];
              option.textContent = entry['profile_name'];
          } else {
              option.value = entry;
              option.textContent = entry;
          }
          if (filters[key].includes(entry)) {
              option.selected = true;
          }
          dropdown.appendChild(option);
      });
      $(`#${dropdownId}`).selectpicker('refresh');
      let selectedOptions = $(`#${dropdownId}`).find('option:selected');
      let displayText = selectedOptions.map(function() {
          return $(this).text(); // or $(this).val() if you want to display the value
      }).get().join(', ');
      // Check if there is any selection, otherwise set to default text
      displayText = displayText.length > 0 ? displayText : 'Nothing selected';

      // Update the display text
      $(`#${dropdownId}`).closest('.filter-group').find('.filter-option-inner-inner').text(displayText);
  } catch (error) {
      console.error(error.message);
      TOKEN = false;
  }
}
document.addEventListener('DOMContentLoaded', fillDropdown);
var currentProfile = null;
function updateProfile() {
  const selProfiles = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    console.log(`Selected profiles: ${selProfiles}`);
    currentProfile = selProfiles;
}
document.getElementById('profileDropdown').addEventListener('change', updateProfile);

var importStoreUpdateInterval = null;
async function importFromStore() {
  try {
        var dataToSend = {
          'profile': currentProfile,
          'store_url': document.getElementById('storeUrl').value,
          'token': document.getElementById('token').value,
          'username': document.getElementById('username').value,
          'password': document.getElementById('password').value
        }
        const response = await unifiedSendRequest(UPLOADCATEGORYLISTSTORE, {formData: JSON.stringify(dataToSend), headerArgs: { 'Content-Type': 'application/json'}});
        document.getElementById('popupcontent').classList.add('disabled');
        document.getElementById('popup').style.cursor = 'progress';
    } catch (error) {
        console.error('Error fetching categorylist:', error);
        showMessage('An error occurred while fetching categorylist.' + error, false);
    }
    setTimeout(() => {
        importStoreUpdateInterval = setInterval(importFromStoreUpdates, 1000);
    }, 1000); // Delay of 1 second before starting the interval
}

async function importFromStoreUpdates() {
  try {
        const response = await unifiedSendRequest(UPLOADCATEGORYLISTSTORESTATUS, {method: 'GET'});
        if (response.status == 'success') {
            showMessage('Fetched categorylist successfully', true);
            updateProgressBar(100);
            clearInterval(importStoreUpdateInterval);
            hideModal();
        } else if (response.status == 'in_progress') {
            console.log(response);
            current_element = response.message[0];
            total_elements = response.message[1];
            const progressPercentage = (current_element / total_elements) * 100;
            updateProgressBar(progressPercentage);
            return;
        } else {
            console.error('Error fetching categorylist:', error);
            showMessage('Failed to fetch categorylist. Please try again.', false);
            clearInterval(importStoreUpdateInterval);
        }
    } catch (error) {
        console.error('Error fetching categorylist:', error);
        showMessage('An error occurred while fetching categorylist.' + error, false);
        clearInterval(importStoreUpdateInterval);
    }
    document.getElementById('popupcontent').classList.remove('disabled');
    document.getElementById('popup').style.cursor = 'default';
}

function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = percentage + '%';
}

function getUniqueColor(userid) {
    let hash = 0;
    for (let i = 0; i < userid.length; i++) {
        hash = userid.charCodeAt(i) + ((hash << 5) - hash);
    }
    // Generate color using hash
    const r = (hash >> 24) & 0xFF;
    const g = (hash >> 16) & 0xFF;
    const b = (hash >> 8) & 0xFF;
    return `rgb(${r % 256}, ${g % 256}, ${b % 256})`;
}

async function getToken() {
    if (!TOKEN) {
      data = await requestToken();
      console.log(data);
      TOKEN = data["access_token"];
    }
  }

const ws = new WebSocket(`${websocket_url}/${CATEGORYLISTWEBSOCKET}`);
var userid = '';


ws.onopen = function(event) {
    console.log("WebSocket is connected");
    getToken();
    // You can send an initial message like user information when they connect
    ws.send(JSON.stringify({ type: "join", token: TOKEN}));
};

ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    console.log("Message from server:", message);
    if (message.message === 'Invalid token') {
      getToken(); // TODO resend previous message
      if (message.previous === 'join') {
        ws.send(JSON.stringify({ type: "join", token: TOKEN}));
      }
    }
    if (message.type === 'user') {
      // server returns the id of this specific user
      userid = message.name;
      updateActiveUsers(message);
    } else if (message.type === 'user_list') {
      updateActiveUsers(message);
    }
    // Update your datatable or UI with the information received
};

ws.onclose = function(event) {
    console.log("WebSocket is closed now.");
};

// Send a message when the user leaves the page
window.onbeforeunload = function() {
    ws.send(JSON.stringify({ type: "leave", user: "User1" }));
};

function updateActiveUsers(message) {
  var peopleIconContainer = document.getElementById('onlinePeople');
      peopleIconContainer.innerHTML = '';
      if (message.users.length == 1) {
        // only the current user is active so no need to show users
        return;
      }
      message.users.forEach(name => {
        console.log(name);
        console.log(getUniqueColor(name));
        const fullName = name.split('_', 1)[0];
        const initials = fullName.split(' ').map(word => word[0]).join('');
        var title = fullName;
        if (name === userid) {
          title = 'You';
        }
        var personIcon = document.createElement('div');
        personIcon.className = 'person-icon';
        personIcon.innerText = initials;
        personIcon.title = title;
        personIcon.style.backgroundColor = getUniqueColor(name);
        peopleIconContainer.appendChild(personIcon);
      })
}


    let editMode = false;
    var columnNames = {};
async function getCategorylistDetails() {
      var data = await unifiedSendRequest(GETCATEGORYLISTDETAILS, {method: 'GET'});
      data = Object.values(data).map(item => {
          for (let i = 1; i <= 100; i++) {
              item[`HiddenColumn${i}`] = '';
          }
          return item;
      });
      var headers = Object.keys(data[Object.keys(data)[0]]);
      var cols = headers.map(key => {
          return { data: key,
                   visible: !key.startsWith('HiddenColumn') 
          };
      });
      cols.forEach((col, index) => {
          columnNames[index] = col.data;
      });
      var idcol = await unifiedSendRequest(GETCATEGORYLISTIDCOL, {method: 'GET'});
      var thead = document.querySelector("#editableTable thead");

// Clear existing content in thead
      thead.innerHTML = '';

// Create and append the tr element
      var tr = document.createElement("tr");
      thead.appendChild(tr);

// Append th elements to the tr
      headers.forEach(function(header) {
        var th = document.createElement("th");
        th.textContent = header;
        th.addEventListener('mouseenter', function() {
            currentTh = this;
            deleteColumnButton();
        });
        th.addEventListener('mouseleave', function() {
          deleteColButtonTimer = setTimeout(function() {
              $('#deleteButton').hide();
          }, 1000);
        });
        tr.appendChild(th);
      });
      data = Object.values(data);
      var categoryTable = $('#editableTable').DataTable({responsive: true, data: data, 
            columns: cols,
            rowCallback: function(row, data, dataIndex) {
              $(row).attr('id', data[idcol]);
              const firstTd = row.querySelector('td');
          
              if (firstTd) {
                  // Do something with the first td
                  firstTd.addEventListener('mouseenter', function() {
                      currentRow = this;
                      clearTimeout(deleteRowButtonTimer);
                      deleteRowButton();
                  });
                  // row.addEventListener('mouseenter', function() {
                  //   console.log('Row enter');
                  //   clearTimeout(deleteRowButtonTimer);
                  // });
                  firstTd.addEventListener('mouseleave', function() {
                    deleteRowButtonTimer = setTimeout(function() {
                        $('#deleteButtonRow').hide();
                    }, 1000);
                  });
              }
          }});
      $('#deleteButtonRow').mouseenter(function(){
        clearTimeout(deleteRowButtonTimer);
      })
      $('#deleteButton').mouseenter(function(){
        clearTimeout(deleteColButtonTimer);
      })
      $('#editableTable tbody').on('click', 'td', async function() {
        if (!editMode) {
          return;
        }
        // Skip if already editing
        if ($(this).find('input').length > 0) {
          return;
        }
        var cell = categoryTable.cell(this);
        var originalContent = cell.data();       

        if (typeof originalContent === 'undefined'){
          return; // skip as it is error message
        }
        var input = $('<input>', {
          type: 'text',
          value: originalContent,
          blur: function(e) {
            var newValue = $(this).val();
            cell.data(newValue).draw(false);
          },
          keyup: function(e) {
            if (e.keyCode === 13) { // Enter key
              $(this).blur();
            }
          }
        });

        $(this).empty().append(input);
        input.focus();
      });
      
      $('#editableTable').wrap('<div class="custom-table-wrapper"></div>');
    }

    $('#editableTable thead').on('click', 'th', function(e) {
      if (editMode) {
          // Prevent default sorting when in edit mode
          

          var currentHeader = $(this);
          var columnIndex = currentHeader.index();
          if (currentHeader.find('input').length === 0) {
            e.stopImmediatePropagation();
            var currentText = currentHeader.text();
            var inputField = $('<input>', {
                type: 'text',
                placeholder: currentText,
                blur: function() {
                    if (this.value !== '') {
                      currentHeader.text(this.value);
                      columnNames[columnIndex] = this.value;
                    } else {
                      currentHeader.text(currentText);
                    }
                    $(this).remove();
                },
                keyup: function(e) {
                    if (e.which === 13) { // Enter key
                        $(this).blur();
                    }
                }
            });

            currentHeader.html(inputField);
            inputField.focus();
          }
      }
    });


    function toggleSorting(enableSorting) {
        var table = $('#editableTable').DataTable();
        table.columns().every(function () {
            var column = this;
            column.settings()[0].aoColumns[column[0][0]].bSortable = enableSorting;
        });
    }

    async function addNewRow() {
        var table = $('#editableTable').DataTable();

        // Get the number of columns in the table
        var numberOfColumns = table.columns().count();

        // Initialize an array to hold the new row data
        var newRowData = {};
        var data = await unifiedSendRequest(GETCATEGORYLISTDETAILS, {method: 'GET'});
        var headers = Object.keys(data[Object.keys(data)[0]]);
        var idcol = await unifiedSendRequest(GETCATEGORYLISTIDCOL, {method: 'GET'});
        table.columns().every(function(index) {
            var column = this;
            var header = column.dataSrc();
            if (header === idcol) {
              newRowData[header] = header;
            } else {
              newRowData[header] = null;
            }
        });
        // Add the new row to the DataTable and draw it
        table.row.add(newRowData).draw();

        // Move to the last page where the new row is
        table.page('last').draw('page');
    }

    function addNewColumn() {
      var table = $('#editableTable').DataTable();

      // Find the first hidden column
      var hiddenColumnIndex = -1;
      for (let i = 0; i < table.columns().nodes().length; i++) {
          if (!table.column(i).visible()) {
              hiddenColumnIndex = i;
              break;
          }
      }

      // If a hidden column is found, make it visible and rename it
      if (hiddenColumnIndex !== -1) {
          // Make the column visible
          table.column(hiddenColumnIndex).visible(true);

          // Rename the column (updating the header in the DOM)
          var header = $(table.column(hiddenColumnIndex).header());
          header.text('New Column'); // If newColumnName is not provided, default to 'New Column'
          columnNames[hiddenColumnIndex] = 'New Column';
          var scrollBody = $(table.table().node()).parent();
          scrollBody.animate({
              scrollLeft: scrollBody.get(0).scrollWidth
          }, 500); // 500ms for smooth scrolling animation
          // Optionally, if the table needs to be redrawn for the changes to take effect
          // table.draw();
      }

    }

  let currentTh = null;
  async function deleteColumn() {
      // Delete the column
      // closePopup();
      const columnName = currentTh.textContent;
      if(confirm(`Are you sure you want to delete ${columnName}?`)){
          var table = $('#editableTable').DataTable();
          table.column(currentTh.cellIndex).visible(false);
      }
  }
  
  let deleteColButtonTimer;
  function deleteColumnButton() {
    if (!editMode) {
      return;
     }
      // Your code for the mouseenter event
      clearTimeout(deleteColButtonTimer); // Clear existing timer
      const btn = document.getElementById('deleteButton');
      const thRect = currentTh.getBoundingClientRect();
      btn.style.top = `${thRect.top + window.scrollY - 20}px`; // Adjust as needed
      btn.style.left = `${thRect.left + (thRect.width / 2) - 10}px`; // Adjust as needed
      btn.style.display = 'block';
  }

  let deleteRowButtonTimer;
  function deleteRowButton() {
     if (!editMode) {
        return;
      }
      clearTimeout(deleteRowButtonTimer); // Clear existing timer
      const btn = document.getElementById('deleteButtonRow');
      const thRect = currentRow.getBoundingClientRect();
      btn.style.top = `${thRect.top + window.scrollY + 5}px`; // Adjust as needed
      btn.style.left = `${thRect.left - 20}px`; // Adjust as needed
      btn.style.display = 'block';
  }

  let currentRow = null;
  async function deleteRow() {
    var table = $('#editableTable').DataTable();
      // Delete the column
      // closePopup();
      const columnName = currentRow.textContent;
      clearTimeout(deleteRowButtonTimer);
      if(confirm(`Are you sure you want to delete ${columnName}?`)) {
        var rowNode = $(currentRow).closest('tr');
        var row = table.row(rowNode);
        row.remove();

        // Redraw the table to reflect changes
        table.draw(false);
      }
  }


  function activateEditMode() {
    document.getElementById('editModeActivated').style.display = 'block';
    document.getElementById('activateEditMode').style.display = 'none';
    editMode = true;
    toggleSorting(!editMode);
  }

  async function deactivateEditMode(save) {
    document.getElementById('editModeActivated').style.display = 'none';
    document.getElementById('activateEditMode').style.display = 'flex';
    document.getElementById('deleteButton').style.display = 'none';
    document.getElementById('deleteButtonRow').style.display = 'none';
    editMode = false;
    toggleSorting(!editMode);
    if (save) {
      await saveData();
    }
  }

  function activateCategorylistMode() {
    document.getElementById('categoryModeActivated').style.display = 'block';
    document.getElementById('activateCategoryMode').style.display = 'none';
    editMode = true;
    toggleSorting(!editMode);
  }

  async function deactivateCategorylistMode(save) {
    document.getElementById('categoryModeActivated').style.display = 'none';
    document.getElementById('activateCategoryMode').style.display = 'flex';
  }
  
  
  async function saveData() {
    var table = $('#editableTable').DataTable();
    var allData = table.rows().data().toArray();
    var processedData = allData.map(row => {
        let newRow = {};

        // Iterate through each column
        table.columns().every(function(index) {
            var column = this;
            var key = column.dataSrc();

            // Check if the column is visible
            if (column.visible()) {
                // Use columnNames to get the new key name or use the original key
                let newKey = columnNames[index] || key;
                newRow[newKey] = row[key];
            }
        });
        return newRow;
    });
    try {
        var formData = new FormData();
        formData.append('new_data', `${JSON.stringify(processedData)}`);
        var data = await unifiedSendRequest(SAVECATEGORYLIST, {formData: formData});
        if (data) {
          console.log('Saved successfully');
          showMessage('Saved changes ', true);
        }
      } catch (error) {
        console.error(error);
        showMessage('Failed to save changes ' + error.message, false);
      }
  }

  function showGuide() {
    startGuide([
        { element: "main", group: "{{ 'software.guide.categorylist.welcome.group' | t }}", title: "{{ 'software.guide.categorylist.welcome.title' | t }}", text: "{{ 'software.guide.categorylist.welcome.text' | t }}", where: 'middle' },
        { element: "#uploadCategorylistButton", group: "{{ 'software.guide.categorylist.upload.group' | t }}", title: "{{ 'software.guide.categorylist.upload.title' | t }}", text: "{{ 'software.guide.categorylist.upload.text' | t }}", where: 'below' },
        { element: "#editButton", group: "{{ 'software.guide.categorylist.edit.group' | t }}", title: "{{ 'software.guide.categorylist.edit.title' | t }}", text: "{{ 'software.guide.categorylist.edit.text' | t }}", where: 'below', secondElement: '#editModeActivated' }
    ]);
    setCookie('showedGuideCategory', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
  element.style.display = "none";
}
document.addEventListener('DOMContentLoaded', function() {
  if(readCookie('showedGuideCategory') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    }
  });

  </script>
{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_categorylist.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_categorylist.settings.desktop_image_width.label",
        "info": "t:sections.forsure_categorylist.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_categorylist.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_categorylist.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_categorylist.settings.layout.label",
        "info": "t:sections.forsure_categorylist.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_categorylist.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_categorylist.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_categorylist.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_categorylist.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_categorylist.presets.name"
      }
    ]
  }
{% endschema %}