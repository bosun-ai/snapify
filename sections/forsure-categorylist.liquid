{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}
{{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: fit-content;
    padding: 2px;
    font: 12px sans-serif;
    /* background: lightsteelblue; */
    text-color: #fafafa;
    border: 0;
    opacity: 1!important;
    border-radius: 8px;
    pointer-events: none;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    /* border: none !important; */
    border: 0.1rem solid #17161c !important;
  }
  th, td {
    border: 0.1rem solid #17161c!important;
    position: relative;
  }


  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 1; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    max-height: 61vh; /* 80% of the viewport height */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }
  #editableTable_wrapper {
    margin: 0.5rem;
  }
  .odd {
    background-color: #f0f0f0!important;
  }

  .align-with-column {
    position: absolute;
    bottom: -50px; /* Adjust as needed */
}
.button {
    z-index: 0;
}
#overlayExitNewCol {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }
  #newColPopup {
    display: none;
    position: fixed;
    top: 40%;
    left: 40%;
    background-color: #fafafa;
    z-index: 3; /* Display in front of other overlay */
    padding: 2rem;
    border-radius: 3rem;
  }

#confirmPopup {
    /* Styling for popup */
    position: fixed;
    /* Other styling as needed */
}
#editableTable_filter {
  margin-bottom: 2rem;
}
.custom-table-wrapper {
    overflow-x: auto;
    width: 100%; /* Ensure the wrapper spans the full width */
}

#deactivateEditModeSave:hover, #savestorecategory:hover {
    color: #fafafa;
}

.button--secondary {
  border: 0.2rem solid #17161c!important;
}

#overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #popup {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fafafa;
    border: #17161c solid 0.2rem;
    border-radius: 2rem;
    z-index: 2; /* Displayed in front of the overlay */
    width: 40%; /* Adjust width as needed */
    max-width: 40%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }
  .disabled {
    pointer-events: none; /* Prevents clicks */
    opacity: 0.8; /* Make it look visually disabled */
}
  .glyphicon-ok:before {
    content: "\2713"
  }

.person-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin: 5px;
    text-align: center;
}

    /* Container for all online people icons */
#onlinePeople {
    display: flex;
    flex-wrap: wrap;
    margin: auto;
    margin-right: 0;
}


#tabs-container {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
}

.tab-button {
    height: 40px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

.tab-button:hover {
    background-color: #eaeaea;
}

.tab-button.active {
    background-color: #2255ff;
    color: #fafafa;
    border-bottom: 2px solid #fff;
    font-weight: bold;
}

#tabs-container .dropdown-toggle {
    width: 10rem;
}
#versionsContainer .dropdown {
    width: fit-content;
}
#tabs-container .dropdown {
    width: fit-content!important;
}


.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    top: 1.5rem;
    position: absolute;
    right: 1.5rem;
    font-weight: bold;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .exclude {
    text-decoration: line-through;
  }

  /* Loading spinner */
#loadingSpinner, #loadingSpinnerCalendar {
    border: 4px solid rgba(34, 85, 255, 0.1);
    border-top: 4px solid #2255ff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: auto;
    display: flex;
}
#loadingSpinnerContainer, #loadingSpinnerCalendarContainer {
    position: absolute;
    top: 60%;
    left: 50%;
    transform: translate(-50%, -50%);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


.modal-content {
  background-color: #fefefe;
  padding: 1rem 2rem;
  border: 1px solid #888;
  width: fit-content;
  max-width: 80vw;
  margin: 15% auto;
  box-sizing: border-box;
}

.profile-wrapper {
  display: inline-block;
  max-width: 100%;
  padding: 2rem;
  padding-top: 0;
}

#profileTable {
  width: 100%;
  table-layout: auto;
}

#profileTable th, #profileTable td {
  white-space: nowrap;
  padding: 0.5rem;
  max-width: 20vw;
}
.invalid-entry {
  border: 0.2rem solid red!important;
}

td input {
  width: 100%;
}
{%- endstyle -%}
{% if customer.tags contains 'member' or customer.tags contains 'vendor' %}
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>
  {% render 'forsure-simple-notification' %}
  <link href="https://cdn.datatables.net/v/dt/dt-1.13.7/datatables.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/v/dt/dt-1.13.7/datatables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <input
    type="file"
    id="category_list"
    accept=".csv"
    style="display: none">
  <button id="deleteButton" style="position: absolute;display:none;z-index:2" onclick="deleteColumn()">X</button>
  <button id="deleteButtonRow" style="position: absolute;display:none;z-index:2" onclick="deleteRow()">X</button>
  {% render 'forsure-rules' %}
  <div id="loadingSpinnerContainer" style="display: none;">
    <div id="loadingSpinner" style="display: block!important;"></div>
  </div>
  <div id="categorylistWrapper" style="padding: 3rem;margin: 3rem;border-radius: 2rem;border:0.2rem solid #17161c;display: none;">
    <div id="overlay"></div>
    <div id="popup" style="z-index:50;display: none">
      <div id="popupcontent" style="width: 70%; margin: auto">
          <h2 style="text-align: center">Connect to your store</h2>
          <div><h4>Choose from Profiles</h4>
            <select
                id="profileDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
          </div>
          <div>
            <h4>Or add it manually</h4>
            <div>
              <table>
                <tr>
                  <td><label for="storeUrl">Store URL:</label></td>
                  <td><input type="text" id="storeUrl" placeholder="Store URL"/></td>
                </tr>
                <tr>
                  <td><label for="token">Token:</label></td>
                  <td><input type="password" id="token" placeholder="shpat..." /></td>
                </tr>
                <tr>
                  <td><label for="username">Username:</label></td>
                  <td><input type="text" id="username" placeholder="username" /></td>
                </tr>
                <tr>
                  <td><label for="password">Password:</label></td>
                  <td><input type="password" id="password" placeholder="****" /></td>
                </tr>
              </table>
            </div>
          </div>
          <div>
            <div id="progress-container" style="width: 100%; background-color: #f3f3f3; border-radius: 5px; margin-top: 20px;">
                <div id="progress-bar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px;display: block;"></div>
            </div>
          </div>
          <a id="savestorecategory" onclick="importFromStore()" class="button" style="margin: 1rem;cursor: pointer;">Save</a>
      </div>
    </div>
    <div style="width: 96%;overflow-x: auto;margin-left: 2%;margin-right: 2%;">
      <div id="icons" style="display: flex;justify-content: space-between;">
        <div>
          <div id="addCategoryButton">
              <a id="activateCategoryMode" onclick="activateCategorylistMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;background-color: #fafafa;position: relative">Add Category List</a>
          </div>
          <div id="categoryModeActivated" style="display: none">
              <a id="deactivateCategorylistMode" onclick="deactivateCategorylistMode(false)" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Cancel</a>
              <a onclick="document.getElementById('category_list').click()" style="cursor:pointer;margin: 1rem;"
              class="button button--secondary" id="uploadCategorylistButton">Upload categorylist</a>
              <a id="categorylistfromstore" onclick="openImportFromStorePopup()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add from Store
                <div class="greyedout-tooltip">Contact us to set up live data</div>
              </a>
          </div>
        </div>
        <div id="onlinePeople">
        </div>
        <div id="editButton">
          <a id="activateEditMode" onclick="activateEditMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Edit</a>
        </div>
        <div id="editModeActivated" style="display: none">
          <a id="deactivateEditMode" onclick="deactivateEditMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Cancel</a>
          <a id="addRowBtn" onclick="addNewRow()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Row</a>
          <a id="addColumnBtn" onclick="addNewColumn()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Column</a>
          <a id="addRuleBtn" onclick="displayRules()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Rule
            <div class="greyedout-tooltip">Contact us to set up rules</div>
          </a>
          <a id="deactivateEditModeSave" onclick="saveData()" class="button" style="margin: 1rem;cursor: pointer;">Save</a>
        </div>
      </div>
      <div style="display: flex;justify-content: space-between;">
        <div id="tabs-container"></div>
        <div id="versionsContainer">
            <select
                  id="categorylistVersions"
                  class="selectpicker"
                  data-live-search="true"
                  data-dropup-auto="false"
                  data-dropdown-align-right="true">
            </select>
        </div>
      </div>
      <div id="errorsDiv" style="color: red; display: none;text-align: center"></div>
      <table id="editableTable" style="width:100%; overflow-x: auto">
        <thead></thead>
      </table>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <div id="profileModal" class="modal losensitive">
    <div class="modal-content">
      <span id="closeMapping" class="close">&times;</span>
      <div class="profile-wrapper">
      <div style="display: flex; justify-content: space-between;">
        <h2>Select Mapping</h2>
        <button class="button" style="margin: auto 0;" id="saveProfile" onclick="saveMapping()">Save</button>
      </div>
      <div>Create the mapping you want to use for this file, each dropdown value with a star is required to be mapped.
        If you want to exclude a column, click the exclude button. Unmapped columns will be excluded from the report, but can be viewed in the dashboard.
      </div>
      <div id="profileDetails">
        <div style="display:flex;padding: 1rem 0;">
          <strong>File:</strong>
          <div id='profileFileName' style="margin-left:1rem"></div>
        </div>
        <table id="profileTable" style="margin: auto;">
          <tr>
            <th style="max-width: 20vw">Name</th>
            <th style="max-width: 20vw">Preview</th>
            <th style="max-width: 20vw">Mapping</th>
            <th width="10%">Exclude</th>
          </tr>
          <tbody id="profileTableBody">
          </tbody>
        </table>
        </div>
      </div>
    </div>
  </div>
  <div id="renameColumnModal" class="modal losensitive" style="display: none;">
    <div class="modal-content" style="width: 45vw;">
      <span id="closeRenameColumn" class="close" onclick="closeRenameColumnModal()">&times;</span>
      <h2 style="margin: 2rem;">Rename Column</h2>
      <div style="margin: 2rem;">
        <label for="renameColumnInput" style="width: 50%;">Current Column Name:</label>
        <span id="currentColumnName"></span>
      </div>
      <div style="margin: 2rem;">
        <label for="renameColumnInput" style="width: 50%;">New Column Name:</label>
        <input type="text" id="renameColumnInput" placeholder="New Column Name">
      </div>
      <div style="margin: 2rem;">
        <label for="renameColumnInput" style="width: 50%;">Corresponding Mapping:</label>
        <select id="renameColumnMapping" class="selectpicker">
          <option value="">Unmapped</option>
        </select>
      </div>
      <div style="display: flex; justify-content: space-between;margin: 2rem;">
        <div>
          <button class="button" style="background-color: #17161c;" onclick="closeRenameColumnModal()">Cancel</button>
        </div>
        <div>
          <button class="button" onclick="saveRenameColumn()">Rename</button>
        </div>
    </div>
    </div>
  </div>

  <div id="addColumnModal" class="modal losensitive" style="display: none;">
    <div class="modal-content" style="width: 45vw;">
      <span id="closeAddColumn" class="close" onclick="closeAddColumnModal()">&times;</span>
      <h2 style="margin: 2rem;">Add Column</h2>
      <div style="margin: 2rem;">
        <label for="addColumnInput" style="width: 50%;">New Column Name:</label>
        <input type="text" id="addColumnInput" placeholder="New Column Name">
      </div>
      <div style="margin: 2rem;">
        <label for="addColumnMapping" style="width: 50%;">Corresponding Mapping:</label>
        <select id="addColumnMapping" class="selectpicker">
          <option value="">Unmapped</option>
        </select>
      </div>
      <div style="display: flex; justify-content: space-between;margin: 2rem;">
        <div>
          <button class="button" style="background-color: #17161c;" onclick="closeAddColumnModal()">Cancel</button>
        </div>
        <div>
          <button class="button" onclick="saveAddColumn()">Add</button>
        </div>
    </div>
    </div>
  </div>
  <div id="confirmOverwriteModal" class="losensitive" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30%;
     background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 91;border: 0.1rem solid #17161c;">
    <h2>Confirm Overwrite</h2>
    <p>Are you sure you want to overwrite the existing mapping?</p>
    <div style="display: flex; justify-content: space-between;">
      <button class="button" onclick="confirmOverwrite()">Yes</button>
      <button class="button" style="background-color: #17161c;"onclick="closeConfirmOverwriteModal()">No</button>
    </div>
  </div>
  <script>
    document.getElementById('category_list').addEventListener('change', openProfileModal);

async function parseCSV(fileInput, nrows=3) {
  return new Promise((resolve, reject) => {
    Papa.parse(fileInput, {
      header: true,
      skipEmptyLines: true,
      preview: nrows,
      complete: function(results) {
        const data = results.data;
        const columnDict = {};

        if (data.length > 0) {
          const keys = Object.keys(data[0]);
          keys.forEach(key => {
            columnDict[key] = data.map(row => row[key]);
          });
        }
        resolve(columnDict);
      },
      error: function(err) {
        console.error(err);
        showMessage('Error parsing file ' + err.message, false);
        reject(err);
      }
    });
  });
}

    
async function openProfileModal(event) {
  const fileInput = event.target.files[0];
  if (!fileInput) {
    return;
  }
  if (fileInput.type !== 'text/csv' && fileInput.type !== 'application/vnd.ms-excel') {
    showMessage('Please upload a CSV file', false);
    return;
  }
  var loadingSpinnerContainer = document.getElementById('loadingSpinnerContainer');
  loadingSpinnerContainer.style.display = 'block';
  const fileName = fileInput.name;
  const modal = document.getElementById('profileModal');
  const profileSelect = document.getElementById('profileSelect');
  const profileDetails = document.getElementById('profileDetails');
  const profileFileName = document.getElementById('profileFileName');
  {% comment %} try { {% endcomment %}
    const csvData = await parseCSV(fileInput);
    var labelsV2Options = await getCategorylistLabelsV2Options();
    profileFileName.textContent = fileName;
    var profileTable = document.getElementById('profileTableBody');
    profileTable.innerHTML = '';
    Object.keys(csvData).forEach((key, index) => {
      const tr = document.createElement('tr');
      const tdKey = document.createElement('td');
      tdKey.textContent = key;
      tr.appendChild(tdKey);
      const tdEntry = document.createElement('td');
      var preview = csvData[key].filter(value => value !== '').join(', ');
      if (preview.length > 30) { // limit the preview to 100 characters
        preview = preview.slice(0, 30) + '...';
      }
      tdEntry.textContent = preview;
      tr.appendChild(tdEntry);

      const tdMapping = document.createElement('td');
      const selectMapping = document.createElement('select');
      selectMapping.classList.add('btn', 'bs-placeholder', 'btn-default');
      var defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Unmapped';
      defaultOption.selected = true;
      selectMapping.appendChild(defaultOption);
      selectMapping.setAttribute('data-name', key);
      // find closest match based on edit distance
      let bestMatchValue = '';
      let bestMatchScore = Infinity;
      let bestMatchOptions = [];
      Object.keys(labelsV2Options).forEach(groupKey => {
        var optionGroup = document.createElement('optgroup');
        optionGroup.label = groupKey;
        optionGroup.setAttribute('data-name', groupKey);
        labelsV2Options[groupKey].forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option.key;
          optionElement.setAttribute('data-units', option.options);
          var star = '';  
          if (option.required) {
            star = ' *';
          }
          optionElement.textContent = option.title + star;
          optionElement.setAttribute('data-description', option.description);
          {% comment %} optionElement.title = option.description; {% endcomment %}

          optionGroup.appendChild(optionElement);


          // Score similarity (very basic: case-insensitive substring match length)
          const titleLower = option.title.toLowerCase();
          const keyLower = key.toLowerCase();
          const distance = levenshtein(keyLower, titleLower);

          if (distance < bestMatchScore) {
            bestMatchScore = distance;
            bestMatchValue = option.key;
            bestMatchOptions = [optionElement];
          } else if (distance == bestMatchScore) {
            bestMatchOptions.push(optionElement);
          }
        });
        selectMapping.appendChild(optionGroup);
      });
      tdMapping.appendChild(selectMapping);
      tr.appendChild(tdMapping);
      const tdExclude = document.createElement('td');
      const checkboxExclude = document.createElement('input');
      checkboxExclude.type = 'checkbox';
      checkboxExclude.title = 'Exclude this column from the upload';
      checkboxExclude.addEventListener('change', function() {
        toggleExclude(checkboxExclude);
      });
      tdExclude.appendChild(checkboxExclude);
      tr.appendChild(tdExclude);
      profileTable.appendChild(tr);

      // dont select the best match if two are equally close
      // TODO enable once tested properly
      {% comment %} if (bestMatchOptions.length == 1) {
        setTimeout(() => {
          selectMapping.value = bestMatchOptions[0].value;
          // Refresh the UI
          $(selectMapping).selectpicker('refresh');
        }, 500);
        {% comment %} $(selectMapping).selectpicker('refresh'); {% endcomment %}
      } else {
        $(selectMapping).selectpicker('refresh');
      } {% endcomment %}
    });
  {% comment %} } catch (error) {
    console.error(error.message);
    showMessage('Failed to parse file ' + fileName, false);
    return;
  } {% endcomment %}


    getCategorylistLabels();
  // Display column details (mockup for demonstration)

  // Show the modal
  modal.style.display = 'block';

  // Close modal on click of close button
  document.getElementById('closeMapping').onclick = function() {
    closeMappingModal();
  };

}

function levenshtein(a, b) {
  const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);
  for (let j = 0; j <= a.length; j++) {
    matrix[0][j] = j;
  }

  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      if (b[i - 1] === a[j - 1]) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,    // deletion
          matrix[i][j - 1] + 1,    // insertion
          matrix[i - 1][j - 1] + 1 // substitution
        );
      }
    }
  }

  return matrix[b.length][a.length];
}

function toggleExclude(checkbox) {
  const row = checkbox.parentElement.parentElement;
  const exclude = checkbox.checked;
  row.classList.toggle('exclude', exclude);
  row.querySelector('select').disabled = exclude;
}

async function getCategorylistLabelsV2Options() {
  try {
    const data = await unifiedSendRequest(GETCATEGORYLISTLABELSV2OPTIONS, {method: 'GET'});
    return data;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get categorylist label options ' + error.message, false);
    return [];
  }
}


async function getCategorylistLabels() {
  try {
    var categorylistLabels = await unifiedSendRequest(GETCATEGORYLISTLABELSV2 + `?version=latest`, {method: 'GET'});
    var profileTable = document.getElementById('profileTableBody');
    if (Object.keys(categorylistLabels).length > 0) {
      profileTable.querySelectorAll('tr').forEach(row => {
        var select = row.querySelector('select');
        if (select.getAttribute('data-name') in categorylistLabels) {
          select.value = categorylistLabels[select.getAttribute('data-name')];
        } else {
          row.querySelector('input').click(); // if the column is not in the orderlist labels, then it is excluded
        }
      });
    } else {
      // new profile, so set all to unmapped
      profileTable.querySelectorAll('tr').forEach(row => {
        var select = row.querySelector('select');
        select.value = '';
        if (row.querySelector('input').checked) {
          row.querySelector('input').click();
        }
      });
    }
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get orderlist labels ' + error.message, false);
  }
}


var request_data = {};
    

async function saveMapping() {
  const mapping = {};
  const profileTable = document.getElementById('profileTableBody');
  const rows = profileTable.querySelectorAll('tr');
  rows.forEach(row => {
    var dropdown = row.querySelector('select');
    var key = dropdown.getAttribute('data-name');
    if (!dropdown.disabled) {
      var value = dropdown.value;
      mapping[key] = value;
    }
  });
  request_data = {'mapping': mapping};
  try {
    var response = await unifiedSendRequest(GETCATEGORYLISTLABELSV2COMPARE, {formData: JSON.stringify(request_data), headerArgs: {'Content-Type': 'application/json'}});
    if (response) {
      confirmOverwrite();
    } else {
      showConfirmOverwriteModal();
    }
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to save mapping ' + error.message, false);
  }
}


async function closeConfirmOverwriteModal() {
  document.getElementById('confirmOverwriteModal').style.display = 'none';
}

async function showConfirmOverwriteModal() {
  document.getElementById('confirmOverwriteModal').style.display = 'block';
}

async function closeMappingModal() {
  document.getElementById('profileModal').style.display = 'none';
  document.getElementById('loadingSpinnerContainer').style.display = 'none';
}


async function confirmOverwrite() {
  try {
    {% comment %} var response = await unifiedSendRequest(GETCATEGORYLISTLABELSV2, {formData: JSON.stringify(request_data), headerArgs: {'Content-Type': 'application/json'}}); {% endcomment %}
    await uploadCategoryList();
    closeConfirmOverwriteModal();
    closeMappingModal();
    {% comment %} showMessage('Mapping saved successfully', true); {% endcomment %}
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to save mapping ' + error.message, false);
  }
}

async function uploadCategoryList() {
  var errorDiv = document.getElementById('errorsDiv');
  errorDiv.style.display = 'none';
  var files = document.getElementById('category_list').files;
  if (files.length) {
    try {
      const file = files[0];
      const formData = new FormData();
      formData.append('category_list', file);
      formData.append('categorylabels', JSON.stringify(request_data));

      // TODO remove profile
      res = await unifiedSendRequest(UPLOADCATEGORYLIST, {formData: formData});
      if (res.message) {
        showMessage('Categorylist uploaded successfully. ' + res.message, true);
        await fillVersionDropdown();
      } else {
        showMessage('Categorylist uploaded successfully', true);
      }
      // window.location.reload();
    } catch (error) {
      console.error(error);
      errorDiv.style.display = 'block';
      errorDiv.innerText = error;
    }
  }
}

function openImportFromStorePopup() {
  document.getElementById('popup').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
}
function hideModalCategorylist() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('popup').style.display = 'none';
}

document.getElementById('overlay').addEventListener('click', hideModalCategorylist);

var allColumns = [];
async function selectCountries() {
    const tabsContainer = document.getElementById('tabs-container');
    tabsContainer.innerHTML = '';
    try {
        const countryDict = {};
        const generalDict = {};
        for (const [entry, value] of Object.entries(categorylistLabels)) {
            const group = value.group || 'Ungrouped';
            if (group == 'General') {
              generalDict[entry] = value;
              allColumns.push(entry);
            } else {
              if (!countryDict[group]) {
                  countryDict[group] = {};
              }
              countryDict[group][entry] = value;
              allColumns.push(entry);
            }
        }
        const sortedCountryDict = Object.keys(countryDict).sort((a, b) => {
          if (a === 'BE') return 1;    // BE goes after everything else
          if (b === 'BE') return -1;
          return a.localeCompare(b);  // default alphabetical
        });

        const countryCodes = sortedCountryDict;
        // Create buttons for first x countries
        var lenDisplayedCountries = 10;
        countryCodes.slice(0, lenDisplayedCountries).forEach((countryCode, index) => {
            const tabButton = document.createElement('button');
            tabButton.textContent = countryCode;
            tabButton.className = 'tab-button';
            tabButton.style.margin = '5px';
            tabButton.dataset.country = countryCode;

            tabButton.addEventListener('click', () => {
                highlightActiveTab(index);
                showCountryData(countryDict[countryCode], countryCode, generalDict);
            });

            tabsContainer.appendChild(tabButton);
        });

        // Create dropdown for the remaining countries
        if (countryCodes.length > lenDisplayedCountries) {
            const selectWrapper = document.createElement('div');
            selectWrapper.style.display = 'inline-block';
            selectWrapper.style.margin = '5px';

            const selectElement = document.createElement('select');
            selectElement.id = 'countryDropdownSelect';
            selectElement.className = 'selectpicker';
            selectElement.width = '5rem';
            selectElement.setAttribute('data-live-search', 'true');
            const option = document.createElement('option');
            option.value = 'More';
            option.textContent = 'More';
            option.disabled = true;
            selectElement.appendChild(option);

            countryCodes.slice(lenDisplayedCountries).forEach((countryCode) => {
                const option = document.createElement('option');
                option.value = countryCode;
                option.textContent = countryCode;
                selectElement.appendChild(option);
            });

            selectWrapper.appendChild(selectElement);
            tabsContainer.appendChild(selectWrapper);

            // Refresh the selectpicker UI after adding options
            $('.selectpicker').selectpicker('refresh');
            $('#countryDropdownSelect').selectpicker('val', 'More');
            // Add event listener for selection
            $('#countryDropdownSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                const selectedCountry = $(this).val();
                if (selectedCountry) {
                    // Create a button for the selected country (if not already present)
                    if (!tabsContainer.querySelector(`[data-country="${selectedCountry}"]`)) {
                        const selectedButton = document.createElement('button');
                        selectedButton.textContent = selectedCountry;
                        selectedButton.className = 'tab-button';
                        selectedButton.style.margin = '5px';
                        selectedButton.dataset.country = selectedCountry;

                        selectedButton.addEventListener('click', () => {
                            let index = document.querySelectorAll('.tab-button').length;
                            highlightActiveTab(index-1);
                            showCountryData(countryDict[selectedCountry], selectedCountry, generalDict);
                        });

                        tabsContainer.insertBefore(selectedButton, selectWrapper);
                    }
                    const allTabButtons = tabsContainer.querySelectorAll('.tab-button');
                    const selectedButton = tabsContainer.querySelector(`[data-country="${selectedCountry}"]`);
                    const index = Array.from(allTabButtons).indexOf(selectedButton);
                    highlightActiveTab(index);

                    // Call showCountryData immediately
                    showCountryData(countryDict[selectedCountry], selectedCountry, generalDict);

                    // Reset the dropdown to not remain selected
                    $(this).selectpicker('val', 'More');
                }
            });
        }
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get countries ' + error.message, false);
    }
}

function highlightActiveTab(activeIndex) {
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach((btn, index) => {
        btn.classList.toggle('active', index === activeIndex);
    });
}

let activeCountry = null;
let previouslyHiddenColumns = new Set();
function showCountryData(countryData, countryCode, generalDict) {
    const table = $('#editableTable').DataTable();

    // If the same tab is clicked again -> show all columns
    if (activeCountry === countryCode) {
        highlightActiveTab(-1);  // unselect
        previouslyHiddenColumns.forEach(column => {
            column.visible(true);
        });
        previouslyHiddenColumns.clear();
        activeCountry = null;
        return;
    }
    // Otherwise, filter columns to match that country's labels
    activeCountry = countryCode;
    const countryLabels = Object.keys(countryData);
    const generalColumns = Object.keys(generalDict);

    // Loop through datatable columns and show/hide based on country data
    table.columns().every(function () {
        const column = this;
        const headerText = $(column.header()).text().trim();

        if (countryLabels.includes(headerText) || generalColumns.includes(headerText)) {
            column.visible(true);
        } else {
            if (column.visible()) {
                column.visible(false);
                previouslyHiddenColumns.add(column);
            }
        }
    });
}

var versionId = null;
async function fillVersionDropdown() {
    try {
        document.getElementById('activateEditMode').disabled = true;
        document.getElementById('activateEditMode').style.backgroundColor = '#ddd';
        document.getElementById('activateEditMode').style.cursor = 'not-allowed';
        document.getElementById('activateEditMode').onclick = null;
        let data = await unifiedSendRequest(CATEGORYLISTVERSION, {method: 'GET'});
        
        if (!data || data.length === 0) {
            {% comment %} data = generateMockVersions(); {% endcomment %}
            document.getElementById('versionsContainer').style.display = 'none';
            document.getElementById('activateEditMode').disabled = true;
            document.getElementById('activateEditMode').style.backgroundColor = '#ddd';
            document.getElementById('activateEditMode').style.cursor = 'not-allowed';
            document.getElementById('activateEditMode').onclick = null;
            return;
        }
        const dropdown = document.getElementById('categorylistVersions');
        dropdown.innerHTML = ''; // Clear existing options

        data.forEach(item => {
            const option = document.createElement('option');
            const icon = item.approved ? '✅' : '❌';
            option.value = item.version;
            option.textContent = `${item.version}`;
            dropdown.appendChild(option);
        });

        // Refresh Bootstrap selectpicker UI
        $('.selectpicker').selectpicker('refresh');

        dropdown.addEventListener('change', async (event) => {
            versionId = event.target.value;  // single value
            await getCategorylistDetails(versionId);
        });
        versionId = data[0].version;
        await getCategorylistDetails(versionId);
        document.getElementById('activateEditMode').disabled = false;
        document.getElementById('activateEditMode').style.backgroundColor = '#fafafa';
        document.getElementById('activateEditMode').style.cursor = 'pointer';
        document.getElementById('activateEditMode').onclick = function() {
            activateEditMode();
        };
        if (document.getElementById('tabs-container').children[0]) {
          document.getElementById('tabs-container').children[0].click();
        }
    } catch (error) {
        console.error(error.message);
        {% comment %} showMessage('Failed to get versions ' + error.message, false); {% endcomment %}
    }
}

// Optional mock data generator (last 5 months example)
function generateMockVersions() {
    const mock = [];
    const now = new Date();
    for (let i = 0; i < 5; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const version = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        mock.push({
            version: version,
            approved: Math.random() < 0.8  // random approval for mock
        });
    }
    return mock;
}


var importStoreUpdateInterval = null;
async function importFromStore() {
  try {
        var dataToSend = {
          'profile': currentProfile,
          'store_url': document.getElementById('storeUrl').value,
          'token': document.getElementById('token').value,
          'username': document.getElementById('username').value,
          'password': document.getElementById('password').value
        }
        const response = await unifiedSendRequest(UPLOADCATEGORYLISTSTORE, {formData: JSON.stringify(dataToSend), headerArgs: { 'Content-Type': 'application/json'}});
        document.getElementById('popupcontent').classList.add('disabled');
        document.getElementById('popup').style.cursor = 'progress';
    } catch (error) {
        console.error('Error fetching categorylist:', error);
        showMessage('An error occurred while fetching categorylist.' + error, false);
    }
    setTimeout(() => {
        importStoreUpdateInterval = setInterval(importFromStoreUpdates, 1000);
    }, 1000); // Delay of 1 second before starting the interval
}

async function importFromStoreUpdates() {
  try {
        const response = await unifiedSendRequest(UPLOADCATEGORYLISTSTORESTATUS, {method: 'GET'});
        if (response.status == 'success') {
            showMessage('Fetched categorylist successfully', true);
            updateProgressBar(100);
            clearInterval(importStoreUpdateInterval);
            hideModalCategorylist();
        } else if (response.status == 'in_progress') {
            current_element = response.message[0];
            total_elements = response.message[1];
            const progressPercentage = (current_element / total_elements) * 100;
            updateProgressBar(progressPercentage);
            return;
        } else {
            console.error('Error fetching categorylist:', error);
            showMessage('Failed to fetch categorylist. Please try again.', false);
            clearInterval(importStoreUpdateInterval);
        }
    } catch (error) {
        console.error('Error fetching categorylist:', error);
        showMessage('An error occurred while fetching categorylist.' + error, false);
        clearInterval(importStoreUpdateInterval);
    }
    document.getElementById('popupcontent').classList.remove('disabled');
    document.getElementById('popup').style.cursor = 'default';
}

function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = percentage + '%';
}

function getUniqueColor(userid) {
    let hash = 0;
    for (let i = 0; i < userid.length; i++) {
        hash = userid.charCodeAt(i) + ((hash << 5) - hash);
    }
    // Generate color using hash
    const r = (hash >> 24) & 0xFF;
    const g = (hash >> 16) & 0xFF;
    const b = (hash >> 8) & 0xFF;
    return `rgb(${r % 256}, ${g % 256}, ${b % 256})`;
}

async function getToken() {
    if (!TOKEN) {
      data = await requestToken();
      TOKEN = data["access_token"];
    }
  }

const ws = new WebSocket(`${websocket_url}/${CATEGORYLISTWEBSOCKET}`);
var userid = '';


ws.onopen = function(event) {
    getToken();
    // You can send an initial message like user information when they connect
    ws.send(JSON.stringify({ type: "join", token: TOKEN}));
};

ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    if (message.message === 'Invalid token') {
      getToken(); // TODO resend previous message
      if (message.previous === 'join') {
        ws.send(JSON.stringify({ type: "join", token: TOKEN}));
      }
    }
    if (message.type === 'user') {
      // server returns the id of this specific user
      userid = message.name;
      updateActiveUsers(message);
    } else if (message.type === 'user_list') {
      updateActiveUsers(message);
    }
    // Update your datatable or UI with the information received
};

ws.onclose = function(event) {
};

// Send a message when the user leaves the page
window.onbeforeunload = function() {
    ws.send(JSON.stringify({ type: "leave", user: "User1" }));
};

function updateActiveUsers(message) {
  var peopleIconContainer = document.getElementById('onlinePeople');
      peopleIconContainer.innerHTML = '';
      if (message.data.length == 1) {
        // only the current user is active so no need to show users
        return;
      }
      message.data.forEach(name => {
        const fullName = name.split('_', 1)[0];
        const initials = fullName.split(' ').map(word => word[0]).join('');
        var title = fullName;
        if (name === userid) {
          title = 'You';
        }
        var personIcon = document.createElement('div');
        personIcon.className = 'person-icon';
        personIcon.innerText = initials;
        personIcon.title = title;
        personIcon.style.backgroundColor = getUniqueColor(name);
        peopleIconContainer.appendChild(personIcon);
      })
}


let editMode = false;
var columnNames = {};
var categorylistLabels = {};
var col_order = [];
async function getCategorylistDetails() {
      var catlabels = await unifiedSendRequest(GETCATEGORYLISTLABELSV2DETAILS += `?version_id=${versionId}`, {method: 'GET'});
      col_order = catlabels['col_order'];
      categorylistLabels = catlabels['output_dict'];
      let url = GETCATEGORYLISTDETAILS;
      url += `?version_id=${versionId}`;
      var data = await unifiedSendRequest(url, {method: 'GET'});
      data = Object.values(data).map(item => {
          {% comment %} for (let i = 1; i <= 100; i++) {
              item[`HiddenColumn${i}`] = '';
          } {% endcomment %}
          const reorderedItem = {};
          // Add keys from col_order first
          col_order.forEach(key => {
              reorderedItem[key] = item.hasOwnProperty(key) ? item[key] : '';
          });

          // Add remaining keys (not in col_order) after
          Object.keys(item).forEach(key => {
              if (!col_order.includes(key)) {
                  reorderedItem[key] = item[key];
              }
          });

          return reorderedItem;
      });
      var headers = Object.keys(data[Object.keys(data)[0]]);
      var cols = headers.map(key => {
          return { data: key,
                   {% comment %} visible: !key.startsWith('HiddenColumn') {% endcomment %}
          };
      });
      cols.forEach((col, index) => {
          columnNames[index] = col.data;
      });
      var idcol = await unifiedSendRequest(GETCATEGORYLISTIDCOL, {method: 'GET'});
      var thead = document.querySelector("#editableTable thead");
      thead.innerHTML = '';

      //var thead = document.createElement('thead');
      // Create and append the tr element
      var tr = document.createElement("tr");

      // Append th elements to the tr
      headers.forEach(function(header) {
        var th = document.createElement("th");
        th.textContent = header;
        th.addEventListener('mouseenter', function() {
            currentTh = this;
            if (categorylistLabels[header]) {
              th.title = categorylistLabels[header]['description'];
            }
            deleteColumnButton();
        });
        th.addEventListener('mouseleave', function() {
          deleteColButtonTimer = setTimeout(function() {
              $('#deleteButton').hide();
          }, 1000);
        });
        tr.appendChild(th);
      });
      thead.appendChild(tr);

      if ( $.fn.DataTable.isDataTable('#editableTable') ) {
            $('#editableTable').DataTable().destroy();
            //$('#editableTable').empty();  // Clear existing DOM content
            highlightActiveTab(-1);
      }

      //document.getElementById('editableTable').appendChild(thead);
      data = Object.values(data);
      var categoryTable = $('#editableTable').DataTable({responsive: true, data: data,
            columns: cols,
            rowCallback: function(row, data, dataIndex) {
              $(row).attr('id', data[idcol]);
              const firstTd = row.querySelector('td');
              const api = this.api();
              if (firstTd) {
                  // Do something with the first td
                  firstTd.addEventListener('mouseenter', function() {
                      currentRow = this;
                      clearTimeout(deleteRowButtonTimer);
                      deleteRowButton();
                  });
                  // row.addEventListener('mouseenter', function() {
                  //   clearTimeout(deleteRowButtonTimer);
                  // });
                  firstTd.addEventListener('mouseleave', function() {
                    deleteRowButtonTimer = setTimeout(function() {
                        $('#deleteButtonRow').hide();
                    }, 1000);
                  });
                  $(row).find('td').each(function() {
                    var cell = api.cell(this);
                    var colIdx = cell.index().column;
                    var columnName = api.column(colIdx).header().textContent.trim();
                    var subentries = categorylistLabels[columnName]?.subentries || [];
                
                    if (subentries.length > 0) {
                      let foundEntry = false;
                      subentries.forEach(subentry => {
                        if (String(cell.data()) === String(subentry.key)) {
                          this.title = subentry.title;
                          foundEntry = true;
                        }
                      });
                      if (!foundEntry && cell.data() !== '') {
                        this.title = 'Invalid entry found';
                        this.classList.add('invalid-entry');
                      } else {
                        this.classList.remove('invalid-entry');
                      }
                    }
                  });
              }
          }
        });
      $('#deleteButtonRow').mouseenter(function(){
        clearTimeout(deleteRowButtonTimer);
      })
      $('#deleteButton').mouseenter(function(){
        clearTimeout(deleteColButtonTimer);
      })
      $('#editableTable tbody').on('click', 'td', async function() {
        if (!editMode) {
          return;
        }
        // Skip if already editing
        if ($(this).find('input').length > 0) {
          return;
        }
        closeCurrentEditor();
        var cell = categoryTable.cell(this);
        var originalContent = cell.data();

        if (typeof originalContent === 'undefined'){
          return; // skip as it is error message
        }
        var colIdx = categoryTable.cell(this).index().column;
        var columnName = categoryTable.column(colIdx).header().textContent.trim();
        var subentries = categorylistLabels[columnName]?.subentries || [];
        var options = [];
        const td = $(this);
        $(this).empty();
        if (subentries && subentries.length > 0) {
          
            // Create input field
            const input = $('<input>', {
              type: 'text',
              class: 'inline-editor',
              value: originalContent,
              autocomplete: 'off',
              css: {
                width: '100%',
                position: 'relative'
              }
            });

            // Create suggestion dropdown
            const dropdown = $('<div>', {
              class: 'suggestion-box',
              css: {
                position: 'absolute',
                top: td.position().bottom + td.height(),
                left: 0,
                background: '#fff',
                border: '1px solid #ccc',
                zIndex: 9999,
                width: td.width() + 40,
                maxHeight: '150px',
                overflowY: 'auto'
              }
            });

            // Add suggestions to dropdown
            subentries.forEach(subentry => {
              const option = $('<div>', {
                text: subentry.key,
                title: subentry.title,
                css: {
                  padding: '4px 8px',
                  cursor: 'pointer'
                },
                click: function () {
                  input.val(subentry.key);
                  saveValue();
                },
                mouseenter: function () {
                  $(this).css('background', '#eee');
                },
                mouseleave: function () {
                  $(this).css('background', '#fff');
                }
              });
              dropdown.append(option);
            });

            const saveValue = () => {
              const newValue = input.val();
              cell.data(newValue).draw(false);
              td.empty().text(newValue);
              dropdown.remove(); // cleanup
            };

            input.on('input', function () {
              if (subentries.length > 0) {
                dropdown.show();
              }
            });

            let keepDropdownOpen = false;

            dropdown.on('mousedown', function () {
              keepDropdownOpen = true;
            });

            input.on('blur', function () {
              if (!keepDropdownOpen) {
                saveValue();
              }
              setTimeout(() => {
                keepDropdownOpen = false; // reset
              }, 200);
            });

            input.on('keydown', function (e) {
              if (e.key === 'Enter') {
                saveValue();
              }
              if (e.key === 'Escape') {
                dropdown.remove();
                td.empty().text(originalContent);
              }
            });

            $(this).append(input);
            $(this).append(dropdown);
            input.focus();
            currentEditor = input;
            currentDropdown = dropdown;
        } else {
          input = $('<input>', {
            type: 'text',
            value: originalContent,
            blur: function(e) {
              var newValue = $(this).val();
              cell.data(newValue).draw(false);
            },
            keyup: function(e) {
              if (e.keyCode === 13) { // Enter key
                $(this).blur();
              }
            }
          });  
          $(this).empty().append(input);
          input.focus();
          currentEditor = input;
          currentDropdown = null;
        }

      });
      $('#editableTable tbody').on('mouseenter', 'td', function() {
        var colIdx = categoryTable.cell(this).index().column;
        var td = categoryTable.cell(this).node();
        // Get the column name from the column definition
        var columnName = categoryTable.column(colIdx).header().textContent;

        var subentries = categorylistLabels[columnName.trim()]?.subentries || [];
        var cell = categoryTable.cell(this);
        if (subentries && subentries.length > 0) {
          var foundEntry = false;
          subentries.forEach(subentry => {
            if (String(cell.data()) === String(subentry.key)) {
              td.title = subentry.title;
              foundEntry = true;
            }
          });
          if (!foundEntry && cell.data() !== '') {
            td.title = 'Invalid entry found';
          }
        }
      });

      $('#editableTable').wrap('<div class="custom-table-wrapper"></div>');
      selectCountries();
      function closeCurrentEditor() {
        if (currentEditor && currentEditor.length > 0) {
          const tdElement = currentEditor.closest('td');
          if (tdElement && tdElement.length > 0) {
            const cell = categoryTable.cell(tdElement);
            const newValue = currentEditor.val();
            cell.data(newValue).draw(false);
            tdElement.empty().text(newValue);
          }
        }
      
        if (currentDropdown && currentDropdown.length > 0) {
          currentDropdown.remove();
        }
      
        // Reset references
        currentEditor = null;
        currentDropdown = null;
    }
    
    $(document).on('mousedown', function (e) {
      const clickedInsideEditor = $(e.target).closest('td').find('.inline-editor').length > 0;
      const clickedInsideDropdown = $(e.target).closest('.suggestion-box').length > 0;
    
      if (!clickedInsideEditor && !clickedInsideDropdown) {
        try {
          closeCurrentEditor();
        } catch (error) {
        }
      }
    });
}

let currentEditor = null;
let currentDropdown = null;


$('#editableTable thead').on('click', 'th', async function(e) {
  if (editMode) {
      await renameColumn(this, e);
      return;
  }
});

async function renameColumn(th, e) {
  document.body.style.cursor = 'wait';
  document.getElementById('editableTable').style.cursor = 'wait';
  // Prevent default sorting when in edit mode
  e.stopImmediatePropagation();
  var currentHeader = $(th);
  var columnIndex = currentHeader.index();
  var currentText = currentHeader.text();
  var currentLabel = categorylistLabels[currentText];
  if (currentLabel) {
    currentLabel = currentLabel.key;
  } else {
    currentLabel = '';
  }
  document.getElementById('currentColumnName').textContent = currentText;
  document.getElementById('renameColumnInput').value = currentText;
  var labelsV2Options = await getCategorylistLabelsV2Options();
  Object.keys(labelsV2Options).forEach(groupKey => {
    var optionGroup = document.createElement('optgroup');
    optionGroup.label = groupKey;
    optionGroup.setAttribute('data-name', groupKey);
    labelsV2Options[groupKey].forEach(option => {
      const optionElement = document.createElement('option');
      optionElement.value = option.key;
      optionElement.setAttribute('data-units', option.options);
      var star = '';  
      if (option.required) {
        star = ' *';
      }
      if (option.key === currentLabel) {
        optionElement.selected = true;
      }
      optionElement.textContent = option.title + star;
      optionGroup.appendChild(optionElement);
    });
    document.getElementById('renameColumnMapping').appendChild(optionGroup);
  });
  $('#renameColumnMapping').selectpicker({
    dropupAuto: false,
    size: 8
  });
  $('#renameColumnMapping').selectpicker('refresh');
  document.getElementById('renameColumnModal').style.display = 'block';
  $('#deleteButtonRow').hide();
  $('#deleteButton').hide();
  document.body.style.cursor = 'default';
  document.getElementById('editableTable').style.cursor = 'default';
}

async function saveRenameColumn() {
  var oldColumnName = document.getElementById('currentColumnName').textContent.trim();
  var newColumnName = document.getElementById('renameColumnInput').value.trim();
  var newMapping = document.getElementById('renameColumnMapping').value;
  var oldMapping = categorylistLabels[oldColumnName];
  if (oldMapping) {
    oldMapping = oldMapping.key;
  } else {
    oldMapping = '';
  }
  var formData = new FormData();
  formData.append('oldColumnName', oldColumnName);
  formData.append('newColumnName', newColumnName);
  formData.append('newMapping', newMapping);
  formData.append('oldMapping', oldMapping);
  formData.append('version_id', versionId);
  var data = await unifiedSendRequest(CATEGORYLISTRENAMECOLUMN, {formData: formData});
  if (data.success) {
    closeRenameColumnModal();
    showMessage(data.message, true);
    await fillVersionDropdown();
  } else {
    showMessage(data.message, false);
  }
}

function closeRenameColumnModal() {
  document.getElementById('renameColumnModal').style.display = 'none';
}

function closeAddColumnModal() {
  document.getElementById('addColumnModal').style.display = 'none';
}

async function saveAddColumn() {
  var newColumnName = document.getElementById('addColumnInput').value.trim();
  var newMapping = document.getElementById('addColumnMapping').value;
  var formData = new FormData();
  formData.append('newColumnName', newColumnName);
  formData.append('newMapping', newMapping);
  formData.append('version_id', versionId);
  var data = await unifiedSendRequest(CATEGORYLISTADDCOLUMN, {formData: formData});
  if (data.success) {
    closeAddColumnModal();
    showMessage(data.message, true);
    await fillVersionDropdown();
  } else {
    showMessage(data.message, false);
  }
}

function toggleSorting(enableSorting) {
    var table = $('#editableTable').DataTable();
    table.columns().every(function () {
        var column = this;
        column.settings()[0].aoColumns[column[0][0]].bSortable = enableSorting;
    });
}

async function addNewRow() {
    var table = $('#editableTable').DataTable();

    // Get the number of columns in the table
    var numberOfColumns = table.columns().count();

    // Initialize an array to hold the new row data
    var newRowData = {};
    var data = await unifiedSendRequest(GETCATEGORYLISTDETAILS + `?version_id=${versionId}`, {method: 'GET'});
    var headers = Object.keys(data[Object.keys(data)[0]]);
    var idcol = await unifiedSendRequest(GETCATEGORYLISTIDCOL, {method: 'GET'});
    table.columns().every(function(index) {
        var column = this;
        var header = column.dataSrc();
        if (header === idcol) {
          newRowData[header] = header;
        } else {
          newRowData[header] = null;
        }
    });
    // Add the new row to the DataTable and draw it
    table.row.add(newRowData).draw();

    // Move to the last page where the new row is
    {% comment %} table.page('last').draw('page'); {% endcomment %}
}

async function addNewColumn() {
  document.getElementById('editableTable').style.cursor = 'wait';
  document.body.style.cursor = 'wait';
  var labelsV2Options = await getCategorylistLabelsV2Options();
  document.getElementById('addColumnMapping').innerHTML = '';
  Object.keys(labelsV2Options).forEach(groupKey => {
    var optionGroup = document.createElement('optgroup');
    optionGroup.label = groupKey;
    optionGroup.setAttribute('data-name', groupKey);
    labelsV2Options[groupKey].forEach(option => {
      const optionElement = document.createElement('option');
      optionElement.value = option.key;
      optionElement.setAttribute('data-tooltip', option.description || '');
      optionElement.setAttribute('data-units', option.options);
      var star = '';  
      if (option.required) {
        star = ' *';
      }
      optionElement.textContent = option.title + star;
      optionGroup.appendChild(optionElement);
    });
    document.getElementById('addColumnMapping').appendChild(optionGroup);
  });
  document.getElementById('addColumnModal').style.display = 'block';
  $('#addColumnMapping').selectpicker({
    dropupAuto: false,
    size: 8
  });
  $('#addColumnMapping').selectpicker('refresh');
  setTimeout(() => {
    const $options = $('#addColumnMapping option');
    const $items = $('#addColumnMapping')
      .parent()
      .find('.dropdown-menu li:not(.divider):not(.dropdown-header) a');
    $items.each(function (index) {
      const tooltip = $options.eq(index).data('tooltip');
      if (tooltip) {
        $(this).attr('title', tooltip);
      }
    });
    // Initialize Bootstrap tooltip
    $items.tooltip({ container: 'body' });
  }, 200);
  $('#deleteButtonRow').hide();
  $('#deleteButton').hide();
  document.body.style.cursor = 'default';
  document.getElementById('editableTable').style.cursor = 'default';

}

  let currentTh = null;
async function deleteColumn() {
      // Delete the column
      // closePopup();
      const columnName = currentTh.textContent;
      if(confirm(`Are you sure you want to delete ${columnName}?`)){
        var oldMapping = categorylistLabels[columnName];
        if (oldMapping) {
          oldMapping = oldMapping.key;
        } else {
          oldMapping = '';
        }
        var formData = new FormData();
        formData.append('oldColumnName', columnName);
        formData.append('oldMapping', oldMapping);
        formData.append('version_id', versionId);
        var data = await unifiedSendRequest(CATEGORYLISTDELETECOLUMN, {formData: formData});
        if (data.success) {
          showMessage(data.message, true);
          await fillVersionDropdown();
        } else {
          showMessage(data.message, false);
        }
      }
  }
  
  let deleteColButtonTimer;
  function deleteColumnButton() {
    if (!editMode) {
      return;
     }
      // Your code for the mouseenter event
      clearTimeout(deleteColButtonTimer); // Clear existing timer
      const btn = document.getElementById('deleteButton');
      const thRect = currentTh.getBoundingClientRect();
      btn.style.top = `${thRect.top + window.scrollY - 20}px`; // Adjust as needed
      btn.style.left = `${thRect.left + (thRect.width / 2) - 10}px`; // Adjust as needed
      btn.style.display = 'block';
  }

  let deleteRowButtonTimer;
  function deleteRowButton() {
     if (!editMode) {
        return;
      }
      clearTimeout(deleteRowButtonTimer); // Clear existing timer
      const btn = document.getElementById('deleteButtonRow');
      const thRect = currentRow.getBoundingClientRect();
      btn.style.top = `${thRect.top + window.scrollY + 5}px`; // Adjust as needed
      btn.style.left = `${thRect.left - 20}px`; // Adjust as needed
      btn.style.display = 'block';
  }

  let currentRow = null;
  async function deleteRow() {
    var table = $('#editableTable').DataTable();
      // Delete the column
      // closePopup();
      const columnName = currentRow.textContent;
      clearTimeout(deleteRowButtonTimer);
      if(confirm(`Are you sure you want to delete ${columnName}?`)) {
        var rowNode = $(currentRow).closest('tr');
        var row = table.row(rowNode);
        row.remove();

        // Redraw the table to reflect changes
        table.draw(false);
      }
  }

  async function activateEditMode() {
    document.getElementById('editModeActivated').style.display = 'block';
    document.getElementById('activateEditMode').style.display = 'none';
    if (window.userPermissions['rules'] === false) {
      document.getElementById('addRuleBtn').classList.add('greyed_out_wrapper');
      document.getElementById('addRuleBtn').style.cursor = 'not-allowed';
      document.getElementById('addRuleBtn').style.backgroundColor = '#ddd';
      document.getElementById('addRuleBtn').onclick = null;
    }
    editMode = true;
    toggleSorting(!editMode);
  }

  async function deactivateEditMode() {
    document.getElementById('editModeActivated').style.display = 'none';
    document.getElementById('activateEditMode').style.display = 'flex';
    document.getElementById('deleteButton').style.display = 'none';
    document.getElementById('deleteButtonRow').style.display = 'none';
    editMode = false;
    toggleSorting(!editMode);
  }

  async function activateCategorylistMode() {
    if (window.userPermissions['livedata'] === false) {
      document.getElementById('categorylistfromstore').style.cursor = 'not-allowed';
      document.getElementById('categorylistfromstore').style.backgroundColor = '#ddd';
      document.getElementById('categorylistfromstore').onclick = null;
      document.getElementById('categorylistfromstore').classList.add('greyed_out_wrapper');
    }
    document.getElementById('categoryModeActivated').style.display = 'block';
    document.getElementById('activateCategoryMode').style.display = 'none';
    editMode = true;
    toggleSorting(!editMode);
  }

  async function deactivateCategorylistMode(save) {
    document.getElementById('categoryModeActivated').style.display = 'none';
    document.getElementById('activateCategoryMode').style.display = 'flex';
  }
  
  
  async function saveData() {
    var table = $('#editableTable').DataTable();
    var allData = table.rows().data().toArray();
    var processedData = allData.map(row => {
        let newRow = {};

        // Iterate through each column
        table.columns().every(function(index) {
            var column = this;
            var key = column.dataSrc();

            // Check if the column is visible or in previouslyHiddenColumns set
            if (column.visible() || allColumns.includes(key)) {
                // Use columnNames to get the new key name or use the original key
                let newKey = columnNames[index] || key;
                newRow[newKey] = row[key];
            }
        });
        return newRow;
    });
    try {
        var formData = new FormData();
        formData.append('new_data', `${JSON.stringify(processedData)}`);
        var data = await unifiedSendRequest(SAVECATEGORYLIST, {formData: formData});
        if (data) {
          showMessage(data['status'], true);
          await deactivateEditMode();
        }
      } catch (error) {
        console.error(error);
        showMessage('Failed to save changes ' + error.message, false);
      }
  }

  function openDropdownGuide() {
    // get the 16th td inside the row with id 1
    var row = document.getElementById('1');
    var td = row.querySelectorAll('td')[15];
    td.click();
  }

  function showGuide() {
    startGuide([
        { element: "main", group: "{{ 'software.guide.categorylist.welcome.group' | t }}", title: "{{ 'software.guide.categorylist.welcome.title' | t }}", text: "{{ 'software.guide.categorylist.welcome.text' | t }}", where: 'middle' },
        { element: "#activateCategoryMode", group: "{{ 'software.guide.categorylist.upload.group' | t }}", title: "{{ 'software.guide.categorylist.upload.title' | t }}", text: "{{ 'software.guide.categorylist.upload.text' | t }}", where: 'below' },
        { element: "#editButton", group: "{{ 'software.guide.categorylist.edit.group' | t }}", title: "{{ 'software.guide.categorylist.edit.title' | t }}", text: "{{ 'software.guide.categorylist.edit.text' | t }}", where: 'below', secondElement: '#editModeActivated', runBefore: activateEditMode},
        { element: "#addRowBtn", group: "{{ 'software.guide.categorylist.addRow.group' | t }}", title: "{{ 'software.guide.categorylist.addRow.title' | t }}", text: "{{ 'software.guide.categorylist.addRow.text' | t }}", where: 'below', runBefore: activateEditMode},
        { element: "#addColumnBtn", group: "{{ 'software.guide.categorylist.addColumn.group' | t }}", title: "{{ 'software.guide.categorylist.addColumn.title' | t }}", text: "{{ 'software.guide.categorylist.addColumn.text' | t }}", where: 'below', runBefore: activateEditMode},
        { element: "#addRuleBtn", group: "{{ 'software.guide.categorylist.addRule.group' | t }}", title: "{{ 'software.guide.categorylist.addRule.title' | t }}", text: "{{ 'software.guide.categorylist.addRule.text' | t }}", where: 'below', runBefore: activateEditMode},
        { element: "#deactivateEditModeSave", group: "{{ 'software.guide.categorylist.save.group' | t }}", title: "{{ 'software.guide.categorylist.save.title' | t }}", text: "{{ 'software.guide.categorylist.save.text' | t }}", where: 'below', runBefore: activateEditMode},
        { element: "#tabs-container", group: "{{ 'software.guide.categorylist.tabs.group' | t }}", title: "{{ 'software.guide.categorylist.tabs.title' | t }}", text: "{{ 'software.guide.categorylist.tabs.text' | t }}", where: 'below'},
        { element: "#versionsContainer", group: "{{ 'software.guide.categorylist.versions.group' | t }}", title: "{{ 'software.guide.categorylist.versions.title' | t }}", text: "{{ 'software.guide.categorylist.versions.text' | t }}", where: 'below'},
        { element: "#editableTable", group: "{{ 'software.guide.categorylist.dropdown.group' | t }}", title: "{{ 'software.guide.categorylist.dropdown.title' | t }}", text: "{{ 'software.guide.categorylist.dropdown.text' | t }}", where: 'inside', runBefore: openDropdownGuide},
    ]);
    setCookie('showedGuideCategory', 'true', 300);
}

function showGuideFromButton(element) {
  showGuide();
}

waitForPermission(function() {
  if (window.userPermissions['forsure-categorylist-editor']) {
    document.getElementById('categorylistWrapper').style.display = 'block';
    fillVersionDropdown();
    if(readCookie('showedGuideCategory') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    }
  }
});

  </script>
{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_categorylist.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_categorylist.settings.desktop_image_width.label",
        "info": "t:sections.forsure_categorylist.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_categorylist.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_categorylist.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_categorylist.settings.layout.label",
        "info": "t:sections.forsure_categorylist.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_categorylist.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_categorylist.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_categorylist.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_categorylist.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_categorylist.presets.name"
      }
    ]
  }
{% endschema %}