{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}
{{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    /* border: none !important; */
    border: 0.1rem solid #17161c !important;
  }
  th, td {
    border: 0.1rem solid #17161c!important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 1; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    max-height: 61vh; /* 80% of the viewport height */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }
  #editableTable_wrapper {
    margin: 0.5rem;
  }
  .odd {
    background-color: #f0f0f0!important;
  }

  .align-with-column {
    position: absolute;
    bottom: -50px; /* Adjust as needed */
}
.button {
    z-index: 0;
}
#overlayExitNewCol {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }
  #newColPopup {
    display: none;
    position: fixed;
    top: 40%;
    left: 40%;
    background-color: #fafafa;
    z-index: 3; /* Display in front of other overlay */
    padding: 2rem;
    border-radius: 3rem;
  }

#confirmPopup {
    /* Styling for popup */
    position: fixed;
    /* Other styling as needed */
}
#editableTable_filter {
  margin-bottom: 2rem;
}
.custom-table-wrapper {
    overflow-x: auto;
    width: 100%; /* Ensure the wrapper spans the full width */
}

#deactivateEditModeSave:hover, #savestorecategory:hover {
    color: #fafafa;
}

.button--secondary {
  border: 0.2rem solid #17161c!important;
}

#overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #popup {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fafafa;
    border: #17161c solid 0.2rem;
    border-radius: 2rem;
    z-index: 2; /* Displayed in front of the overlay */
    width: 40%; /* Adjust width as needed */
    max-width: 40%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }
  .disabled {
    pointer-events: none; /* Prevents clicks */
    opacity: 0.8; /* Make it look visually disabled */
}
  .glyphicon-ok:before {
    content: "\2713"
  }

.person-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin: 5px;
    text-align: center;
}

    /* Container for all online people icons */
#onlinePeople {
    display: flex;
    flex-wrap: wrap;
    margin: auto;
    margin-right: 0;
}


#tabs-container {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
}

.tab-button {
    height: 40px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

.tab-button:hover {
    background-color: #eaeaea;
}

.tab-button.active {
    background-color: #2255ff;
    color: #fafafa;
    border-bottom: 2px solid #fff;
    font-weight: bold;
}

#tabs-container .dropdown-toggle {
    width: 10rem;
}
#tabs-container .dropdown {
    width: fit-content!important;
}
{%- endstyle -%}
{% if customer.tags contains 'member' or customer.tags contains 'vendor' %}
  <script src="{{ 'forsure-endpoints.js' | asset_url }}"></script>
  <script src="{{ 'forsure-data-loader.js' | asset_url }}"></script>
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>
  {% render 'forsure-login' %}
  {% render 'forsure-simple-notification' %}
  <link href="https://cdn.datatables.net/v/dt/dt-1.13.7/datatables.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/v/dt/dt-1.13.7/datatables.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" />
  <input
    type="file"
    id="category_list"
    style="display: none">
  <button id="deleteButton" style="position: absolute;display:none;z-index:2" onclick="deleteColumn()">X</button>
  <button id="deleteButtonRow" style="position: absolute;display:none;z-index:2" onclick="deleteRow()">X</button>
  {% render 'forsure-rules' %}
  <div style="padding: 3rem;margin: 3rem;border-radius: 2rem;border:0.2rem solid #17161c">
    <div id="overlay"></div>
    <div id="popup" style="z-index:50;display: none">
      <div id="popupcontent" style="width: 70%; margin: auto">
          <h2 style="text-align: center">Connect to your store</h2>
          <div><h4>Choose from Profiles</h4>
            <select
                id="profileDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
          </div>
          <div>
            <h4>Or add it manually</h4>
            <div>
              <table>
                <tr>
                  <td><label for="storeUrl">Store URL:</label></td>
                  <td><input type="text" id="storeUrl" placeholder="Store URL"/></td>
                </tr>
                <tr>
                  <td><label for="token">Token:</label></td>
                  <td><input type="password" id="token" placeholder="shpat..." /></td>
                </tr>
                <tr>
                  <td><label for="username">Username:</label></td>
                  <td><input type="text" id="username" placeholder="username" /></td>
                </tr>
                <tr>
                  <td><label for="password">Password:</label></td>
                  <td><input type="password" id="password" placeholder="****" /></td>
                </tr>
              </table>
            </div>
          </div>
          <div>
            <div id="progress-container" style="width: 100%; background-color: #f3f3f3; border-radius: 5px; margin-top: 20px;">
                <div id="progress-bar" style="width: 0%; height: 20px; background-color: #4caf50; border-radius: 5px;display: block;"></div>
            </div>
          </div>
          <a id="savestorecategory" onclick="importFromStore()" class="button" style="margin: 1rem;cursor: pointer;">Save</a>
      </div>
    </div>
    <div style="width: 96%;overflow-x: auto;margin-left: 2%;margin-right: 2%;">
      <div id="icons" style="display: flex;justify-content: space-between;">
        <div>
          <div id="addCategoryButton">
              <a id="activateCategoryMode" onclick="activateCategorylistMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Category List</a>
          </div>
          <div id="categoryModeActivated" style="display: none">
              <a id="deactivateCategorylistMode" onclick="deactivateCategorylistMode(false)" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Cancel</a>
              <a onclick="document.getElementById('category_list').click()" style="cursor:pointer;margin: 1rem;"
              class="button button--secondary" id="uploadCategorylistButton">Upload categorylist</a>
              <a id="categorylistfromstore" onclick="openImportFromStorePopup()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add from Store</a>
          </div>
        </div>
        <div id="onlinePeople">
        </div>
        <div id="editButton">
          <a id="activateEditMode" onclick="activateEditMode()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Edit</a>
        </div>
        <div id="editModeActivated" style="display: none">
          <a id="deactivateEditMode" onclick="deactivateEditMode(false)" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Cancel</a>
          <a id="addRowBtn" onclick="addNewRow()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Row</a>
          <a id="addColumnBtn" onclick="addNewColumn()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Column</a>
          <a id="addRuleBtn" onclick="displayRules()" class="button button--secondary" style="margin: 1rem;cursor: pointer;">Add Rule</a>
          <a id="deactivateEditModeSave" onclick="deactivateEditMode(true)" class="button" style="margin: 1rem;cursor: pointer;">Save</a>
        </div>
      </div>
      <div style="display: flex;justify-content: space-between;">
        <div id="tabs-container"></div>
        <select
              id="categorylistVersions"
              class="selectpicker"
              data-live-search="true">
        </select>
      </div>
      <div id="errorsDiv" style="color: red; display: none;text-align: center"></div>
      <table id="editableTable" style="width:100%; overflow-x: auto">
        <thead></thead>
      </table>
    </div>
  </div>
  <script>
    document.getElementById('category_list').addEventListener('change', uploadCategoryList);
    $(document).ready(getCategorylistDetails);

    async function uploadCategoryList() {
      var errorDiv = document.getElementById('errorsDiv');
      errorDiv.style.display = 'none';
      var files = event.target.files;
      if (files.length) {
        try {
          const file = event.target.files[0];
          const formData = new FormData();
          formData.append('category_list', file);

// TODO remove profile
          await unifiedSendRequest(UPLOADCATEGORYLIST + `?profile=1`, {formData: formData});
          // window.location.reload();

        } catch (error) {
          console.error(error);
          errorDiv.style.display = 'block';
          errorDiv.innerText = error;
        }
      }
    }

    function openImportFromStorePopup() {
      document.getElementById('popup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
    function hideModal() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('popup').style.display = 'none';
    }

    document.getElementById('overlay').addEventListener('click', hideModal);

async function selectCountries() {
    const tabsContainer = document.getElementById('tabs-container');
    tabsContainer.innerHTML = '';
    try {
        let data = await unifiedSendRequest(GETCATEGORYLABELS, {method: 'GET'});
        console.log(data);
        const countriesItem = data.find(item => item.key === 'countries');
        if (!countriesItem || !countriesItem.value) {
            console.error('No countries found in response');
            showMessage('Failed to get countries ' + error.message, false);
            return;
        }
        const countries = countriesItem.value;
        const countryCodes = Object.keys(countries);
        // Create buttons for first x countries
        var lenDisplayedCountries = 2;
        countryCodes.slice(0, lenDisplayedCountries).forEach((countryCode, index) => {
            const tabButton = document.createElement('button');
            tabButton.textContent = countryCode;
            tabButton.className = 'tab-button';
            tabButton.style.margin = '5px';
            tabButton.dataset.country = countryCode;

            tabButton.addEventListener('click', () => {
                highlightActiveTab(index);
                showCountryData(countries[countryCode], countryCode, data);
            });

            tabsContainer.appendChild(tabButton);
        });

        // Create dropdown for the remaining countries
        if (countryCodes.length > lenDisplayedCountries) {
            const selectWrapper = document.createElement('div');
            selectWrapper.style.display = 'inline-block';
            selectWrapper.style.margin = '5px';

            const selectElement = document.createElement('select');
            selectElement.id = 'countryDropdownSelect';
            selectElement.className = 'selectpicker';
            selectElement.width = '5rem';
            selectElement.setAttribute('data-live-search', 'true');
            const option = document.createElement('option');
            option.value = 'More';
            option.textContent = 'More';
            option.disabled = true;
            selectElement.appendChild(option);

            countryCodes.slice(lenDisplayedCountries).forEach((countryCode) => {
                const option = document.createElement('option');
                option.value = countryCode;
                option.textContent = countryCode;
                selectElement.appendChild(option);
            });

            selectWrapper.appendChild(selectElement);
            tabsContainer.appendChild(selectWrapper);

            // Refresh the selectpicker UI after adding options
            $('.selectpicker').selectpicker('refresh');
            $('#countryDropdownSelect').selectpicker('val', 'More');
            // Add event listener for selection
            $('#countryDropdownSelect').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                const selectedCountry = $(this).val();
                if (selectedCountry) {
                    // Create a button for the selected country (if not already present)
                    if (!tabsContainer.querySelector(`[data-country="${selectedCountry}"]`)) {
                        const selectedButton = document.createElement('button');
                        selectedButton.textContent = selectedCountry;
                        selectedButton.className = 'tab-button';
                        selectedButton.style.margin = '5px';
                        selectedButton.dataset.country = selectedCountry;

                        selectedButton.addEventListener('click', () => {
                            let index = document.querySelectorAll('.tab-button').length;
                            highlightActiveTab(index-1);
                            showCountryData(countries[selectedCountry], selectedCountry, data);
                        });

                        tabsContainer.insertBefore(selectedButton, selectWrapper);
                    }
                    const allTabButtons = tabsContainer.querySelectorAll('.tab-button');
                    const selectedButton = tabsContainer.querySelector(`[data-country="${selectedCountry}"]`);
                    const index = Array.from(allTabButtons).indexOf(selectedButton);
                    highlightActiveTab(index);

                    // Call showCountryData immediately
                    showCountryData(countries[selectedCountry], selectedCountry, data);

                    // Reset the dropdown to not remain selected
                    $(this).selectpicker('val', 'More');
                }
            });
        }
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get countries ' + error.message, false);
    }
}
selectCountries();

function highlightActiveTab(activeIndex) {
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach((btn, index) => {
        btn.classList.toggle('active', index === activeIndex);
    });
}

let activeCountry = null;
let previouslyHiddenColumns = new Set();
function showCountryData(countryData, countryCode, data) {
    const table = $('#editableTable').DataTable();

    // If the same tab is clicked again -> show all columns
    if (activeCountry === countryCode) {
        highlightActiveTab(-1);  // unselect
        previouslyHiddenColumns.forEach(column => {
            column.visible(true);
        });
        previouslyHiddenColumns.clear();
        activeCountry = null;
        return;
    }
    // Otherwise, filter columns to match that country's labels
    activeCountry = countryCode;
    const countryLabels = getCountryColumnLabels(countryData);
    const generalColumns = getGeneralColumns(data);

    // Loop through datatable columns and show/hide based on country data
    table.columns().every(function () {
        const column = this;
        const headerText = $(column.header()).text().trim();

        if (countryLabels.includes(headerText) || generalColumns.includes(headerText)) {
            column.visible(true);
        } else {
            if (column.visible()) {
                column.visible(false);
                previouslyHiddenColumns.add(column);
            }
        }
    });
}

function getCountryColumnLabels(countryData) {
    let labels = [];
    Object.values(countryData).forEach(category => {
        Object.values(category).forEach(value => {
            if (typeof value === 'string') {
                labels.push(value);
            }
        });
    });
    return labels;
}

function getGeneralColumns(data) {
    return data
        .filter(entry => typeof entry.value === 'string' && entry.key !== 'countries')
        .map(entry => entry.value);
}
var versionId = null;
async function fillVersionDropdown() {
    try {
        let data = await unifiedSendRequest(CATEGORYLISTVERSION, {method: 'GET'});
        console.log(data);
        if (!data || data.length === 0) {
            console.log('No versions found, using mock data');
            data = generateMockVersions();
        }

        const dropdown = document.getElementById('categorylistVersions');
        dropdown.innerHTML = ''; // Clear existing options

        data.forEach(item => {
            const option = document.createElement('option');
            const icon = item.approved ? '✅' : '❌';
            option.value = item.version;
            option.textContent = `${icon} ${item.version}`;
            dropdown.appendChild(option);
        });

        // Refresh Bootstrap selectpicker UI
        $('.selectpicker').selectpicker('refresh');

        dropdown.addEventListener('change', async (event) => {
            versionId = event.target.value;  // single value
            await getCategorylistDetails();
        });

    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get versions ' + error.message, false);
    }
}
fillVersionDropdown();

// Optional mock data generator (last 5 months example)
function generateMockVersions() {
    const mock = [];
    const now = new Date();
    for (let i = 0; i < 5; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const version = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        mock.push({
            version: version,
            approved: Math.random() < 0.8  // random approval for mock
        });
    }
    return mock;
}


async function fillDropdown(dropdownId, filters, key) {
  dropdownId = "profileDropdown", 
  filters = {
      'country': [],
      'start_time': null,
      'end_time': null,
      'profile': [],
      'report_name': [],
      'categories': []
  };
  key = 'profile'
  try {
      const response = await unifiedSendRequest(STATSREPORTS, {formData: JSON.stringify(filters), 
          headerArgs: {'Content-Type': 'application/json'}});
      console.log(response);

      const dropdown = document.getElementById(dropdownId);

      dropdown.innerHTML = "";

      const entries = response[key];
      console.log(`Filling dropdown ${key} with ${entries}`);
      
      entries.forEach(entry => {
          const option = document.createElement("option");
          if(key === 'profile'){
              option.value = entry['profile_id'];
              option.textContent = entry['profile_name'];
          } else {
              option.value = entry;
              option.textContent = entry;
          }
          if (filters[key].includes(entry)) {
              option.selected = true;
          }
          dropdown.appendChild(option);
      });
      $(`#${dropdownId}`).selectpicker('refresh');
      let selectedOptions = $(`#${dropdownId}`).find('option:selected');
      let displayText = selectedOptions.map(function() {
          return $(this).text(); // or $(this).val() if you want to display the value
      }).get().join(', ');
      // Check if there is any selection, otherwise set to default text
      displayText = displayText.length > 0 ? displayText : 'Nothing selected';

      // Update the display text
      $(`#${dropdownId}`).closest('.filter-group').find('.filter-option-inner-inner').text(displayText);
  } catch (error) {
      console.error(error.message);
      TOKEN = false;
  }
}
document.addEventListener('DOMContentLoaded', fillDropdown);
var currentProfile = null;
function updateProfile() {
  const selProfiles = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    console.log(`Selected profiles: ${selProfiles}`);
    currentProfile = selProfiles;
}
document.getElementById('profileDropdown').addEventListener('change', updateProfile);

var importStoreUpdateInterval = null;
async function importFromStore() {
  try {
        var dataToSend = {
          'profile': currentProfile,
          'store_url': document.getElementById('storeUrl').value,
          'token': document.getElementById('token').value,
          'username': document.getElementById('username').value,
          'password': document.getElementById('password').value
        }
        const response = await unifiedSendRequest(UPLOADCATEGORYLISTSTORE, {formData: JSON.stringify(dataToSend), headerArgs: { 'Content-Type': 'application/json'}});
        document.getElementById('popupcontent').classList.add('disabled');
        document.getElementById('popup').style.cursor = 'progress';
    } catch (error) {
        console.error('Error fetching categorylist:', error);
        showMessage('An error occurred while fetching categorylist.' + error, false);
    }
    setTimeout(() => {
        importStoreUpdateInterval = setInterval(importFromStoreUpdates, 1000);
    }, 1000); // Delay of 1 second before starting the interval
}

async function importFromStoreUpdates() {
  try {
        const response = await unifiedSendRequest(UPLOADCATEGORYLISTSTORESTATUS, {method: 'GET'});
        if (response.status == 'success') {
            showMessage('Fetched categorylist successfully', true);
            updateProgressBar(100);
            clearInterval(importStoreUpdateInterval);
            hideModal();
        } else if (response.status == 'in_progress') {
            console.log(response);
            current_element = response.message[0];
            total_elements = response.message[1];
            const progressPercentage = (current_element / total_elements) * 100;
            updateProgressBar(progressPercentage);
            return;
        } else {
            console.error('Error fetching categorylist:', error);
            showMessage('Failed to fetch categorylist. Please try again.', false);
            clearInterval(importStoreUpdateInterval);
        }
    } catch (error) {
        console.error('Error fetching categorylist:', error);
        showMessage('An error occurred while fetching categorylist.' + error, false);
        clearInterval(importStoreUpdateInterval);
    }
    document.getElementById('popupcontent').classList.remove('disabled');
    document.getElementById('popup').style.cursor = 'default';
}

function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = percentage + '%';
}

function getUniqueColor(userid) {
    let hash = 0;
    for (let i = 0; i < userid.length; i++) {
        hash = userid.charCodeAt(i) + ((hash << 5) - hash);
    }
    // Generate color using hash
    const r = (hash >> 24) & 0xFF;
    const g = (hash >> 16) & 0xFF;
    const b = (hash >> 8) & 0xFF;
    return `rgb(${r % 256}, ${g % 256}, ${b % 256})`;
}

async function getToken() {
    if (!TOKEN) {
      data = await requestToken();
      console.log(data);
      TOKEN = data["access_token"];
    }
  }

const ws = new WebSocket(`${websocket_url}/${CATEGORYLISTWEBSOCKET}`);
var userid = '';


ws.onopen = function(event) {
    console.log("WebSocket is connected");
    getToken();
    // You can send an initial message like user information when they connect
    ws.send(JSON.stringify({ type: "join", token: TOKEN}));
};

ws.onmessage = function(event) {
    const message = JSON.parse(event.data);
    console.log("Message from server:", message);
    if (message.message === 'Invalid token') {
      getToken(); // TODO resend previous message
      if (message.previous === 'join') {
        ws.send(JSON.stringify({ type: "join", token: TOKEN}));
      }
    }
    if (message.type === 'user') {
      // server returns the id of this specific user
      userid = message.name;
      updateActiveUsers(message);
    } else if (message.type === 'user_list') {
      updateActiveUsers(message);
    }
    // Update your datatable or UI with the information received
};

ws.onclose = function(event) {
    console.log("WebSocket is closed now.");
};

// Send a message when the user leaves the page
window.onbeforeunload = function() {
    ws.send(JSON.stringify({ type: "leave", user: "User1" }));
};

function updateActiveUsers(message) {
  var peopleIconContainer = document.getElementById('onlinePeople');
      peopleIconContainer.innerHTML = '';
      if (message.users.length == 1) {
        // only the current user is active so no need to show users
        return;
      }
      message.users.forEach(name => {
        console.log(name);
        console.log(getUniqueColor(name));
        const fullName = name.split('_', 1)[0];
        const initials = fullName.split(' ').map(word => word[0]).join('');
        var title = fullName;
        if (name === userid) {
          title = 'You';
        }
        var personIcon = document.createElement('div');
        personIcon.className = 'person-icon';
        personIcon.innerText = initials;
        personIcon.title = title;
        personIcon.style.backgroundColor = getUniqueColor(name);
        peopleIconContainer.appendChild(personIcon);
      })
}


let editMode = false;
var columnNames = {};
async function getCategorylistDetails() {
      let url = GETCATEGORYLISTDETAILS;
      if (versionId !== null) {
        url += `?version_id=${versionId}`;
      }
      var data = await unifiedSendRequest(url, {method: 'GET'});
      data = Object.values(data).map(item => {
          for (let i = 1; i <= 100; i++) {
              item[`HiddenColumn${i}`] = '';
          }
          return item;
      });
      var headers = Object.keys(data[Object.keys(data)[0]]);
      var cols = headers.map(key => {
          return { data: key,
                   visible: !key.startsWith('HiddenColumn')
          };
      });
      cols.forEach((col, index) => {
          columnNames[index] = col.data;
      });
      var idcol = await unifiedSendRequest(GETCATEGORYLISTIDCOL, {method: 'GET'});
      var thead = document.querySelector("#editableTable thead");
      thead.innerHTML = '';

      //var thead = document.createElement('thead');

      // Create and append the tr element
      var tr = document.createElement("tr");


      // Append th elements to the tr
      headers.forEach(function(header) {
        var th = document.createElement("th");
        th.textContent = header;
        th.addEventListener('mouseenter', function() {
            currentTh = this;
            deleteColumnButton();
        });
        th.addEventListener('mouseleave', function() {
          deleteColButtonTimer = setTimeout(function() {
              $('#deleteButton').hide();
          }, 1000);
        });
        tr.appendChild(th);
      });
      thead.appendChild(tr);

      if ( $.fn.DataTable.isDataTable('#editableTable') ) {
            $('#editableTable').DataTable().destroy();
            //$('#editableTable').empty();  // Clear existing DOM content
            highlightActiveTab(-1);
      }

      //document.getElementById('editableTable').appendChild(thead);
      data = Object.values(data);
      var categoryTable = $('#editableTable').DataTable({responsive: true, data: data,
            columns: cols,
            rowCallback: function(row, data, dataIndex) {
              $(row).attr('id', data[idcol]);
              const firstTd = row.querySelector('td');

              if (firstTd) {
                  // Do something with the first td
                  firstTd.addEventListener('mouseenter', function() {
                      currentRow = this;
                      clearTimeout(deleteRowButtonTimer);
                      deleteRowButton();
                  });
                  // row.addEventListener('mouseenter', function() {
                  //   console.log('Row enter');
                  //   clearTimeout(deleteRowButtonTimer);
                  // });
                  firstTd.addEventListener('mouseleave', function() {
                    deleteRowButtonTimer = setTimeout(function() {
                        $('#deleteButtonRow').hide();
                    }, 1000);
                  });
              }
          }});
      $('#deleteButtonRow').mouseenter(function(){
        clearTimeout(deleteRowButtonTimer);
      })
      $('#deleteButton').mouseenter(function(){
        clearTimeout(deleteColButtonTimer);
      })
      $('#editableTable tbody').on('click', 'td', async function() {
        if (!editMode) {
          return;
        }
        // Skip if already editing
        if ($(this).find('input').length > 0) {
          return;
        }
        var cell = categoryTable.cell(this);
        var originalContent = cell.data();

        if (typeof originalContent === 'undefined'){
          return; // skip as it is error message
        }
        var input = $('<input>', {
          type: 'text',
          value: originalContent,
          blur: function(e) {
            var newValue = $(this).val();
            cell.data(newValue).draw(false);
          },
          keyup: function(e) {
            if (e.keyCode === 13) { // Enter key
              $(this).blur();
            }
          }
        });

        $(this).empty().append(input);
        input.focus();
      });

      $('#editableTable').wrap('<div class="custom-table-wrapper"></div>');
}

$('#editableTable thead').on('click', 'th', function(e) {
  if (editMode) {
      // Prevent default sorting when in edit mode


      var currentHeader = $(this);
      var columnIndex = currentHeader.index();
      if (currentHeader.find('input').length === 0) {
        e.stopImmediatePropagation();
        var currentText = currentHeader.text();
        var inputField = $('<input>', {
            type: 'text',
            placeholder: currentText,
            blur: function() {
                if (this.value !== '') {
                  currentHeader.text(this.value);
                  columnNames[columnIndex] = this.value;
                } else {
                  currentHeader.text(currentText);
                }
                $(this).remove();
            },
            keyup: function(e) {
                if (e.which === 13) { // Enter key
                    $(this).blur();
                }
            }
        });

        currentHeader.html(inputField);
        inputField.focus();
      }
  }
});


function toggleSorting(enableSorting) {
    var table = $('#editableTable').DataTable();
    table.columns().every(function () {
        var column = this;
        column.settings()[0].aoColumns[column[0][0]].bSortable = enableSorting;
    });
}

async function addNewRow() {
    var table = $('#editableTable').DataTable();

    // Get the number of columns in the table
    var numberOfColumns = table.columns().count();

    // Initialize an array to hold the new row data
    var newRowData = {};
    var data = await unifiedSendRequest(GETCATEGORYLISTDETAILS, {method: 'GET'});
    var headers = Object.keys(data[Object.keys(data)[0]]);
    var idcol = await unifiedSendRequest(GETCATEGORYLISTIDCOL, {method: 'GET'});
    table.columns().every(function(index) {
        var column = this;
        var header = column.dataSrc();
        if (header === idcol) {
          newRowData[header] = header;
        } else {
          newRowData[header] = null;
        }
    });
    // Add the new row to the DataTable and draw it
    table.row.add(newRowData).draw();

    // Move to the last page where the new row is
    table.page('last').draw('page');
}

function addNewColumn() {
  var table = $('#editableTable').DataTable();

  // Find the first hidden column
  var hiddenColumnIndex = -1;
  for (let i = 0; i < table.columns().nodes().length; i++) {
      if (!table.column(i).visible()) {
          hiddenColumnIndex = i;
          break;
      }
  }

  // If a hidden column is found, make it visible and rename it
  if (hiddenColumnIndex !== -1) {
      // Make the column visible
      table.column(hiddenColumnIndex).visible(true);

      // Rename the column (updating the header in the DOM)
      var header = $(table.column(hiddenColumnIndex).header());
      header.text('New Column'); // If newColumnName is not provided, default to 'New Column'
      columnNames[hiddenColumnIndex] = 'New Column';
      var scrollBody = $(table.table().node()).parent();
      scrollBody.animate({
          scrollLeft: scrollBody.get(0).scrollWidth
      }, 500); // 500ms for smooth scrolling animation
      // Optionally, if the table needs to be redrawn for the changes to take effect
      // table.draw();
  }

}

  let currentTh = null;
  async function deleteColumn() {
      // Delete the column
      // closePopup();
      const columnName = currentTh.textContent;
      if(confirm(`Are you sure you want to delete ${columnName}?`)){
          var table = $('#editableTable').DataTable();
          table.column(currentTh.cellIndex).visible(false);
      }
  }
  
  let deleteColButtonTimer;
  function deleteColumnButton() {
    if (!editMode) {
      return;
     }
      // Your code for the mouseenter event
      clearTimeout(deleteColButtonTimer); // Clear existing timer
      const btn = document.getElementById('deleteButton');
      const thRect = currentTh.getBoundingClientRect();
      btn.style.top = `${thRect.top + window.scrollY - 20}px`; // Adjust as needed
      btn.style.left = `${thRect.left + (thRect.width / 2) - 10}px`; // Adjust as needed
      btn.style.display = 'block';
  }

  let deleteRowButtonTimer;
  function deleteRowButton() {
     if (!editMode) {
        return;
      }
      clearTimeout(deleteRowButtonTimer); // Clear existing timer
      const btn = document.getElementById('deleteButtonRow');
      const thRect = currentRow.getBoundingClientRect();
      btn.style.top = `${thRect.top + window.scrollY + 5}px`; // Adjust as needed
      btn.style.left = `${thRect.left - 20}px`; // Adjust as needed
      btn.style.display = 'block';
  }

  let currentRow = null;
  async function deleteRow() {
    var table = $('#editableTable').DataTable();
      // Delete the column
      // closePopup();
      const columnName = currentRow.textContent;
      clearTimeout(deleteRowButtonTimer);
      if(confirm(`Are you sure you want to delete ${columnName}?`)) {
        var rowNode = $(currentRow).closest('tr');
        var row = table.row(rowNode);
        row.remove();

        // Redraw the table to reflect changes
        table.draw(false);
      }
  }


  function activateEditMode() {
    document.getElementById('editModeActivated').style.display = 'block';
    document.getElementById('activateEditMode').style.display = 'none';
    editMode = true;
    toggleSorting(!editMode);
  }

  async function deactivateEditMode(save) {
    document.getElementById('editModeActivated').style.display = 'none';
    document.getElementById('activateEditMode').style.display = 'flex';
    document.getElementById('deleteButton').style.display = 'none';
    document.getElementById('deleteButtonRow').style.display = 'none';
    editMode = false;
    toggleSorting(!editMode);
    if (save) {
      await saveData();
    }
  }

  function activateCategorylistMode() {
    document.getElementById('categoryModeActivated').style.display = 'block';
    document.getElementById('activateCategoryMode').style.display = 'none';
    editMode = true;
    toggleSorting(!editMode);
  }

  async function deactivateCategorylistMode(save) {
    document.getElementById('categoryModeActivated').style.display = 'none';
    document.getElementById('activateCategoryMode').style.display = 'flex';
  }
  
  
  async function saveData() {
    var table = $('#editableTable').DataTable();
    var allData = table.rows().data().toArray();
    var processedData = allData.map(row => {
        let newRow = {};

        // Iterate through each column
        table.columns().every(function(index) {
            var column = this;
            var key = column.dataSrc();

            // Check if the column is visible
            if (column.visible()) {
                // Use columnNames to get the new key name or use the original key
                let newKey = columnNames[index] || key;
                newRow[newKey] = row[key];
            }
        });
        return newRow;
    });
    try {
        var formData = new FormData();
        formData.append('new_data', `${JSON.stringify(processedData)}`);
        var data = await unifiedSendRequest(SAVECATEGORYLIST, {formData: formData});
        if (data) {
          console.log('Saved successfully');
          showMessage('Saved changes ', true);
        }
      } catch (error) {
        console.error(error);
        showMessage('Failed to save changes ' + error.message, false);
      }
  }

  function showGuide() {
    startGuide([
        { element: "main", group: "{{ 'software.guide.categorylist.welcome.group' | t }}", title: "{{ 'software.guide.categorylist.welcome.title' | t }}", text: "{{ 'software.guide.categorylist.welcome.text' | t }}", where: 'middle' },
        { element: "#uploadCategorylistButton", group: "{{ 'software.guide.categorylist.upload.group' | t }}", title: "{{ 'software.guide.categorylist.upload.title' | t }}", text: "{{ 'software.guide.categorylist.upload.text' | t }}", where: 'below' },
        { element: "#editButton", group: "{{ 'software.guide.categorylist.edit.group' | t }}", title: "{{ 'software.guide.categorylist.edit.title' | t }}", text: "{{ 'software.guide.categorylist.edit.text' | t }}", where: 'below', secondElement: '#editModeActivated' }
    ]);
    setCookie('showedGuideCategory', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
}
document.addEventListener('DOMContentLoaded', function() {
  if(readCookie('showedGuideCategory') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    }
  });

  </script>
{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_categorylist.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_categorylist.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_categorylist.settings.desktop_image_width.label",
        "info": "t:sections.forsure_categorylist.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_categorylist.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_categorylist.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_categorylist.settings.layout.label",
        "info": "t:sections.forsure_categorylist.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_categorylist.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_categorylist.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_categorylist.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_categorylist.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_categorylist.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_categorylist.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_categorylist.presets.name"
      }
    ]
  }
{% endschema %}