{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}


{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
    z-index: 1000;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }
  td {
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
    cursor: pointer;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share,
  .send {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }

.table-header-title {
  overflow: hidden;
  transition: max-height 0.5s ease-out;
}
.table-header-title-hidden {
  max-height: 0;
  overflow: hidden;
}
.svg-arrow {
  transform: rotate(90deg);
  transition: transform 0.3s ease; /* Smooth transition for rotation */
}

.collapsed {
  transform: rotate(0deg); /* Rotate arrow 90 degrees when collapsed */
}

tr {
  border-top: 0.2rem solid #17161c !important;
}

.tabulator-page.active {
    color: #2255FF!important;
  }


  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 100;
}

.modal-content {
    position: absolute;
    border-radius: 25px;
    border-width: 0.2rem;
    border-style: solid;
    border-color: #17161c;
    width: 90%;
    max-width: 450px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.modalContainer {
  border-radius: 3rem;
  overflow: hidden;
}

.tooltipSave {
  position: absolute;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  z-index: 1;
  top: 30%;
  left: 50%;
  margin-left: -60px;
  transform: translate(-50%, -50%);
  transition: opacity 0.3s;
}
  .tabulator-row {
    cursor: default!important;
  }
  .tabulator-group-toggle {
    cursor: pointer!important;
  }
.tabulator-arrow {
    display: block!important;
}

.history-row {
    border-top: 0.2rem solid #17161c; /* Full-width border for each row */
    padding: 2rem 0; /* Vertical padding for spacing */
    width: 100%; /* Ensure the row spans the full container width */
  }

  .folder-row {
    font-weight: bold; /* Highlight folders */
    padding-left: 0; /* Ensure full-width borders */
    text-indent: 2rem; /* Indent text instead of moving the entire row */
    cursor: pointer;
  }

  .file-row {
    padding-left: 0; /* Ensure full-width borders */
    text-indent: 4rem; /* Further indent text for files */
    display: flex;
  }

  #tabs-container {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 1rem;
        overflow-x: auto; /* Handle large numbers of tabs */
    }

    .tab-button {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-bottom: none;
        background-color: #f9f9f9;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
        margin-right: 5px;
        border-radius: 8px 8px 0 0;
    }

    .tab-button:hover {
        background-color: #eaeaea;
    }

    .tab-button.active {
        background-color: #fff;
        border-bottom: 2px solid #fff;
        font-weight: bold;
    }

    #report-table-data-excel {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }

    .filter-group {
      margin: auto;
    }
    .dropdown {
      margin-left: 0!important;
    }
    .glyphicon-ok:before {
      content: "\2713";
    }


    /* Loading spinner */
    #loadingSpinner, #loadingSpinnerCalendar {
        border: 4px solid rgba(34, 85, 255, 0.1);
        border-top: 4px solid #2255ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: auto;
        display: flex;
    }
    #loadingSpinnerContainer, #loadingSpinnerCalendarContainer {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .all-icons {
      margin: auto;
    }
    #downloadAllReports {
      cursor: pointer;
    }
{%- endstyle -%}
{% if customer.tags contains 'member' %}

<div id="newUploadHistory" style="display: none;min-height: 100vh;padding-bottom: 5rem;">

  <!-- Load d3.js -->
  <!-- <script src="https://d3js.org/d3.v4.js"></script> --><script src="https://cdn.jsdelivr.net/npm/d3@7"> </script>
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <script src="{{ 'forsure-endpoints.js' | asset_url }}"></script>
  <script src="{{ 'forsure-data-loader.js' | asset_url }}"></script>
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>


  {{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>-->
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" />
  {% render 'forsure-simple-notification' %}
  <div id="tooltipWarn" class="tooltip" style="display: none;">Tooltip content</div>
  <div id='tooltip' class="tooltipSave"></div>
  <div class="configbox page-width border" style="padding: 0;border-radius:1rem">
    <div>
      <div style="display: flex;background-color: #fafafa;position: relative;" id="filterContainer">
          <h2 class="flex-header" style="margin-left: 2rem">
            <span id="historyheader" class="table-header" style="cursor: default">
              Report History
            </span>
          </h2>
          <div class="filter-group" id="profile-filter-guide" style="margin-left: 4rem">
            <div class="filter-group-heading">Country</div>
            <select
              id="countryDropdown"
              class="selectpicker"
              multiple
              data-live-search="true"></select>
          </div>
          <div class="filter-group">
            <div class="filter-group-heading">Report Type</div>
            <select
              id="reporttypeDropdown"
              class="selectpicker"
              multiple
              data-live-search="true"></select>
          </div>
          <div class="filter-group">
            <div class="filter-group-heading">Reporting Period</div>
            <select
              id="periodDropdown"
              class="selectpicker"
              multiple
              data-live-search="true"></select>
          </div>
          <div class="filter-group" id="receiptsContainer" style="background-color: #fafafa;position: relative;">
            <div class="filter-group-heading">Receipts only</div>
            <select
              id="receiptsDropdown"
              class="selectpicker"
              data-live-search="true"></select>
          </div>
          <div class="filter-group" id="searchContainer" style="background-color: #fafafa;position: relative;">
            <div class="filter-group-heading" style="width: 12rem">Search</div>
            <input type="text" id="companySearch" class="form-control" placeholder="Search"  style="width: 12rem"/>
        </div>
          <span class="all-icons" style="margin-right: 3rem;background-color: #fafafa;position: relative;padding: 1rem;" id="allIconsContainer">
            <!-- <i id="filter" class="icon-1"><img width="20px" src="{{ section.settings.filter | image_url }}" alt="{{ section.settings.filter.alt | escape }}" loading="lazy"></i> -->
            <i id="downloadAllReports" class="icon-2" style="background-color: #fafafa;position: relative;"><img
                width="30px"
                src="{{ section.settings.download | image_url }}"
                alt="{{ section.settings.download.alt | escape }}"
                loading="lazy"></i>
          </span>
      </div>
      <div id="reportshistory" class="table-header-title" style="min-height: 65px"></div>
    </div>
  </div>
  <div id="imageModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2);">
    <span id="closeModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
    <img id="modalImage" src="" alt="Image Preview" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">
</div>
<div id="modalOverlayImage" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;"></div>

<div id="excelModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:1000;">
    <div id="tabs-container" style="display: flex; margin-bottom: 1rem; border-bottom: 1px solid #ddd;"></div>
    <div id="report-table-data-excel"></div>
    <span id="closeExcelModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
</div>
<div id="modalOverlayExcel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;"></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf_viewer.min.css" />
<div id="pdfModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:1000;">
    <canvas id="pdfCanvas" style="border: 1px solid #ddd; margin: 0 auto; display: block;"></canvas>
    <div style="text-align: center; margin-top: 10px;">
        <button id="prevPage">Previous Page</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next Page</button>
    </div>
    <span id="closePdfModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
</div>
<div id="modalOverlayPdf" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;"></div>


  {% render 'forsure-login' %}
  <script>
async function checkHistoryVersion() {
    try {
        let data = await unifiedSendRequest(GETREPORTHISTORYVERSION, {method: 'GET'});
        console.log(data);
        if (data) {
            document.getElementById('newUploadHistory').style.display = 'block';
            document.getElementById('classicalHistory').style.display = 'none';
        } else {
            document.getElementById('newUploadHistory').style.display = 'none';
            document.getElementById('classicalHistory').style.display = 'block';
        }
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get history ' + error.message, false);
    }
}
checkHistoryVersion();

function buildHierarchy(paths) {
  const hierarchy = {};

  paths.forEach(path => {
    const parts = path.split('/');
    let currentLevel = hierarchy;

    parts.forEach((part, index) => {
      if (index === parts.length - 1) {
        // It's a file, store it in an array at the current level
        if (!Array.isArray(currentLevel.files)) currentLevel.files = [];
        currentLevel.files.push(part);
      } else {
        // It's a folder, create a nested object if it doesn't exist
        if (!currentLevel[part]) currentLevel[part] = {};
        currentLevel = currentLevel[part];
      }
    });
  });

  return hierarchy;
}

function createFolderStructure(configDiv, hierarchy, currentPath = '') {
  configDiv.innerHTML = ''; // Clear existing content

  // Recursive function to create the structure
  function renderLevel(level, parentElement, path, depth = 0) {
    Object.keys(level).forEach(key => {
      if (key === 'files') {
        // Render files
        level[key].forEach(file => {
            const fullPath = `${path}/${file}`; // Construct full path
            const fileRow = document.createElement('div');
            fileRow.className = 'history-row file-row'; // Add CSS class for consistent styling
            fileRow.style.paddingLeft = `${depth * 2}rem`; // Offset based on depth
            fileRow.textContent = file;
            
            fileRow.style.justifyContent = 'space-between';
            fileRow.style.alignItems = 'center'; // Vertically center items          
            
            const icons = document.createElement('div');
            icons.style.marginRight = '5rem';
            icons.style.display = 'flex';
            // Add icons
            const openCol = addOpenIconReport(file, fullPath);
            const downloadCol = addDownloadIcon(file, fullPath);

            icons.appendChild(openCol);
            icons.appendChild(downloadCol);
            fileRow.appendChild(icons);
            parentElement.appendChild(fileRow);
        });
      } else {
        // Render folder
        const folderRow = document.createElement('div');
        folderRow.className = 'history-row folder-row'; // Add CSS class for consistent styling
        folderRow.style.paddingLeft = `${depth * 2}rem`; // Offset text for hierarchy

        // Add the SVG arrow
        const svg = `<svg class="svg-arrow collapsed" style="margin-right: 1rem; vertical-align: middle;" width="20.593" height="22.88" viewBox="0 0 80.593 122.88">
                      <polygon style="fill:#17161c;" points="0,0 30.82,0 80.593,61.44 30.82,122.88 0,122.88 49.772,61.44 0,0"></polygon>
                    </svg>`;

        folderRow.innerHTML = `${svg}<span>${key}</span>`;

        const folderContent = document.createElement('div');
        folderContent.style.display = 'none'; // Initially hidden

        // Add click event to toggle visibility and arrow direction
        folderRow.addEventListener('click', () => {
          folderContent.style.display = folderContent.style.display === 'none' ? 'block' : 'none';
          const arrow = folderRow.querySelector('.svg-arrow');
          arrow.classList.toggle('collapsed');
        });

        parentElement.appendChild(folderRow);
        parentElement.appendChild(folderContent);

        // Recurse into the next level
        renderLevel(level[key], folderContent, `${path}/${key}`, depth + 1);
      }
    });
  }

  renderLevel(hierarchy, configDiv, '', 0);
}


function createColReport(content, title = '', alignRight = false) {
    const col = document.createElement('div');
    col.innerHTML = content;
    return col;
}

function addOpenIconReport(fileName, fullPath) {
    const openCol = createColReport(
        '<i class="open"><img width="20px" src="{{ section.settings.open | image_url }}" alt="{{ section.settings.open.alt | escape }}" loading="lazy"></i>',
        'Open report'
    );
    openCol.addEventListener('click', async () => {
        try {
            document.body.style.cursor = 'wait';
            // Apply the 'wait' cursor to each element
            document.querySelectorAll('.folder-row').forEach(row => {
                row.style.cursor = 'wait';
            });
            const formData = new FormData();
            formData.append('filepath', fullPath);
            formData.append('display', true);

            const extension = fileName.split('.').pop().toLowerCase();
            if (extension === 'png' || extension === 'jpg' || extension === 'jpeg') {
                const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
                // Open image in modal
                const imageUrl = URL.createObjectURL(blob);
                const modal = document.getElementById('imageModal');
                const modalOverlay = document.getElementById('modalOverlayImage');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = imageUrl;
                modal.style.display = 'block';
                modalOverlay.style.display = 'block';
            } else if (extension === 'xlsx' || extension === 'csv') {
                const data = await unifiedSendRequest(GETREPORTDETAILS, {method: 'POST', formData: formData});
                console.log(data);
                displayExcelReport(data);
            } else if (extension === 'pdf') {
                const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
                const arrayBuffer = await blob.arrayBuffer();
                displayPdfInModal(new Uint8Array(arrayBuffer));
            }
            else {
                console.error('Filetype is not yet supported, please download it to look at the content');
                showMessage('Filetype is not yet supported, please download it to look at the content', false);
            }
            
        } catch (error) {
            console.error(error.message);
            showMessage('Failed to open report ' + error.message, false);
        }
        document.body.style.cursor = 'default';
        // Apply the 'wait' cursor to each element
        document.querySelectorAll('.folder-row').forEach(row => {
            row.style.cursor = 'pointer';
        });
    });
    return openCol;
}

// Download Icon
function addDownloadIcon(fileName, fullPath) {
    const downloadCol = createColReport(
        '<i class="download"><img width="20px" src="{{ section.settings.download | image_url }}" alt="{{ section.settings.download | image_url }}" loading="lazy"></i>',
        'Download report'
    );
    downloadCol.addEventListener('click', async () => {
        try {
            const formData = new FormData();
            formData.append('filepath', fullPath);
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            const bloburl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = bloburl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(bloburl);
        } catch (error) {
            console.error(error.message);
            showMessage('Failed to download file ' + error.message, false);
        }
    });
    return downloadCol;
}

function displayExcelReport(data) {
    const modalOverlay = document.getElementById('modalOverlayExcel');
    const modal = document.getElementById('excelModal');
    const tabsContainer = document.getElementById('tabs-container');
    const tableContainer = document.getElementById('report-table-data-excel');

    // Reset modal content
    tabsContainer.innerHTML = '';
    tableContainer.innerHTML = '';

    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; // Alphabet for column headers

    // Generate Tabs for each sheet
    const sheets = Object.keys(data); // Each key represents a sheet
    sheets.forEach((sheetName, sheetIndex) => {
        // Create Tab Button
        const tabButton = document.createElement('button');
        tabButton.textContent = sheetName;
        tabButton.className = 'tab-button';
        tabButton.style.margin = '5px';
        tabButton.dataset.sheet = sheetName;

        tabButton.addEventListener('click', () => {
            // Clear the table container
            tableContainer.innerHTML = '';
            highlightActiveTab(sheetIndex);
            renderSheet(data[sheetName]); // Render the clicked sheet
        });

        tabsContainer.appendChild(tabButton);
    });

    // Helper function to highlight active tab
    function highlightActiveTab(activeIndex) {
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach((btn, index) => {
            btn.classList.toggle('active', index === activeIndex);
        });
    }


    // Function to render a single sheet
    function renderSheet(sheetData) {
        const columns = Object.keys(sheetData[0]).map((key, idx) => {
            return {
                title: alphabet[idx] || `Column ${idx + 1}`, // Use alphabet for headers
                field: key,
                headerSort: false, // Disable sorting
                formatter: "plaintext", // Ensure raw text is displayed
                cellMouseOver: (e, cell) => {
                    // Add tooltip on hover for full entry
                    const tooltip = document.createElement('div');
                    tooltip.id = 'hover-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.padding = '8px';
                    tooltip.style.background = '#333';
                    tooltip.style.color = '#fff';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.zIndex = '9999';
                    tooltip.textContent = cell.getValue();

                    document.body.appendChild(tooltip);
                    document.body.addEventListener('mousemove', moveTooltip);

                    function moveTooltip(event) {
                        tooltip.style.left = `${event.pageX + 10}px`;
                        tooltip.style.top = `${event.pageY + 10}px`;
                    }

                    cell.getElement().addEventListener('mouseout', () => {
                        document.body.removeEventListener('mousemove', moveTooltip);
                        document.body.removeChild(tooltip);
                    });
                },
            };
        });

        // Initialize Tabulator for the sheet
        new Tabulator("#report-table-data-excel", {
            data: sheetData,
            layout: columns.length > 20 ? "fitDataFill" : "fitColumns",
            pagination: sheetData.length > 50, // Enable pagination for large sheets
            paginationCounter: "rows",
            paginationSize: 50,
            columns: columns,
        });
    }

    // Render the first sheet by default
    if (sheets.length > 0) {
        renderSheet(data[sheets[0]]);
        highlightActiveTab(0);
    }

    // Show the modal
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
}

function displayPdfInModal(pdfBlob) {
    const modal = document.getElementById('pdfModal');
    const modalOverlay = document.getElementById('modalOverlayPdf');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const ctx = pdfCanvas.getContext('2d');

    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;

    const renderPage = (num) => {
        pageRendering = true;
        pdfDoc.getPage(num).then((page) => {
            const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale for better rendering
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;

            // Render the page
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport,
            };
            const renderTask = page.render(renderContext);

            renderTask.promise.then(() => {
                pageRendering = false;

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });

        // Update page info
        document.getElementById('pageInfo').textContent = `Page ${num} of ${pdfDoc.numPages}`;
    };

    const queueRenderPage = (num) => {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    };

    const onPrevPage = () => {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    };

    const onNextPage = () => {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    };

    document.getElementById('prevPage').addEventListener('click', onPrevPage);
    document.getElementById('nextPage').addEventListener('click', onNextPage);

    // Load the PDF
    const loadingTask = pdfjsLib.getDocument({ data: pdfBlob });
    loadingTask.promise.then((pdf) => {
        pdfDoc = pdf;
        renderPage(pageNum);
    });

    // Show the modal
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
}

var reportFilters = {
  'countries': [],
  'report_types': [],
  'reporting_periods': [],
  'search_filter': [],
  'receipt_only': '',
}
search_filter = [];

var totalPossibleCompanies = new Set();
var totalPossibleCountries = new Set();
var totalPossibleReportTypes = new Set();
var totalPossiblePeriods = new Set();
var totalPossibleReceipts = ['All', 'Receipts only', 'Reports only'];
var allReports = [];
async function getReports(init=true) {
    try {
    const configDiv = document.getElementById("reportshistory");
    configDiv.innerHTML = '';
    var loadingSpinnerContainer = document.createElement('div');
    loadingSpinnerContainer.id = 'loadingSpinnerContainer';
    var loadingSpinner = document.createElement('div');
    loadingSpinner.id = 'loadingSpinner';
    loadingSpinnerContainer.appendChild(loadingSpinner);
    configDiv.appendChild(loadingSpinnerContainer);
    let data = await unifiedSendRequest(GETREPORTSONEDRIVE, {method: 'POST', formData: JSON.stringify(reportFilters), 
                                        headerArgs: {'Content-Type': 'application/json'}});
    console.log(data);
    allReports = data;
    filterCompanySearch(document.getElementById("companySearch").value, init);
    // createOverview(data, init);
    } catch (error) {
    console.error(error.message);
    TOKEN = false;
    }
}

function createOverview(data, init) {
    const configDiv = document.getElementById("reportshistory");
    const hierarchy = buildHierarchy(data);
    console.log(hierarchy);

    var possibleCompanies = new Set();
    var possibleCountries = new Set();
    var possibleReportTypes = new Set();
    var possiblePeriods = new Set();
    for (let filename of data) { // Corrected loop
          let filename_split = filename.split('/');

          possibleCompanies.add(filename_split[0]);
          possibleCountries.add(filename_split[1]);
          possibleReportTypes.add(filename_split[2]);

          let possiblePeriod = filename_split[3];
          if (filename_split.length > 5) {
              possiblePeriod += ` ${filename_split[4]}`;
          }
          possiblePeriods.add(possiblePeriod);
      }
    if (init) {
      totalPossibleCompanies = possibleCompanies;
      totalPossibleCountries = possibleCountries;
      totalPossibleReportTypes = possibleReportTypes;
      totalPossiblePeriods = possiblePeriods;
      
      // TODO do this smart when selecting e.g. a country
      fillDropdowns('countryDropdown', possibleCountries, 'countries');
      fillDropdowns('reporttypeDropdown', possibleReportTypes, 'report_types');
      fillDropdowns('receiptsDropdown', totalPossibleReceipts, 'receipt_only');
    }
    fillDropdowns('periodDropdown', possiblePeriods, 'reporting_periods');  // only reporting period currently really variable
    createFolderStructure(configDiv, hierarchy);
}

document.getElementById("companySearch").addEventListener("input", function () {
    filterCompanySearch(this.value, false);
});

function filterCompanySearch(searchQuery, init) {
  searchQuery = searchQuery.toLowerCase().trim().replace(' ', '_').replace('.', '_').replace(',', '_').replace('/', '_'); // Get input and normalize case

  let filteredData;

  if (searchQuery === '') {
      filteredData = allReports; // If empty input, show all reports
  } else {
      filteredData = allReports.filter(filename => 
          filename.toLowerCase().includes(searchQuery) 
      );
  }
  search_filter = filteredData;
  createOverview(filteredData, init); // Refresh the overview
}



function fillDropdowns(dropdownId, entries, key) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = "";
    console.log(`Filling dropdown ${key} with ${entries}`);

    [...entries].sort().forEach(entry => {
        const option = document.createElement("option");
        option.value = entry;
        option.textContent = entry;
        if (reportFilters[key].includes(entry)) {
            option.selected = true;
        }
        dropdown.appendChild(option);
    });
    $(`#${dropdownId}`).selectpicker('refresh');
    let selectedOptions = $(`#${dropdownId}`).find('option:selected');
    let displayText = selectedOptions.map(function() {
        return $(this).text(); // or $(this).val() if you want to display the value
    }).get().join(', ');
    // Check if there is any selection, otherwise set to default text
    displayText = displayText.length > 0 ? displayText : 'Nothing selected';

    // Update the display text
    $(`#${dropdownId}`).closest('.filter-group').find('.filter-option-inner-inner').text(displayText);
}
document.getElementById('countryDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    console.log(`Selected countries: ${selCountries}`);
    reportFilters['countries'] = selCountries;
    getReports(false);
});

document.getElementById('reporttypeDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    console.log(`Selected report_types: ${selCountries}`);
    reportFilters['report_types'] = selCountries;
    getReports(false);
});

document.getElementById('periodDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    console.log(`Selected reporting_periods: ${selCountries}`);
    reportFilters['reporting_periods'] = selCountries;
    getReports(false);
});

document.getElementById('receiptsDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    console.log(`Selected receipt_only: ${selCountries}`);
    reportFilters['receipt_only'] = selCountries[0];
    getReports(false);
});

document.getElementById('downloadAllReports').addEventListener('click', async function() {
  try {
    var reportFiltersDownload = reportFilters;
    reportFiltersDownload['search_filter'] = search_filter;
    this.style.cursor = 'not-allowed';
    this.title = 'In Progress, this can take 1-2mins, please wait';
    const data = await unifiedSendRequest(GETREPORTSDOWNLOADALL, {method: 'POST', formData: JSON.stringify(reportFiltersDownload), 
                                          headerArgs: {'Content-Type': 'application/json'}});
    console.log(data);
    this.style.cursor = 'pointer';
    this.title = '';
  } catch (error) {
    console.error(error.message);
    TOKEN = false;
  }
});


function hideImageModal() {
    document.getElementById('imageModal').style.display = 'none';
    document.getElementById('modalOverlayImage').style.display = 'none';
}

function hideExcelModal() {
    document.getElementById('excelModal').style.display = 'none';
    document.getElementById('modalOverlayExcel').style.display = 'none';
}

function hidePdfModal() {
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('modalOverlayPdf').style.display = 'none';
}

document.getElementById('modalOverlayImage').addEventListener('click', hideImageModal);
document.getElementById('closeModal').addEventListener('click', hideImageModal);

document.getElementById('closeExcelModal').addEventListener('click', hideExcelModal);
document.getElementById('modalOverlayExcel').addEventListener('click', hideExcelModal);

document.getElementById('closePdfModal').addEventListener('click', hidePdfModal);
document.getElementById('modalOverlayPdf').addEventListener('click', hidePdfModal);

getReports();



function showGuide() {
    startGuide([
        { element: "main", group: "Introduction", title: "Welcome", text: "Welcome to the report history page. All reports that were created or that you submitted are shown here as well as the confirmations if they were sent to the corresponding authority.", where: 'middle' },
        { element: "#filterContainer", group: "Filters", title: "Filters", text: "Here you can filter the results shown below by the country, type of report and time.", where: 'below' },
        { element: "#receiptsContainer", group: "Filters", title: "Receipts Only", text: "If you only want to see the report confirmations, you can select that here.", where: 'below' },
        { element: "#searchContainer", group: "Filters", title: "Search", text: "Search for any company, report name or country using this search. The results are updated immediately.", where: 'below' },
        { element: "#allIconsContainer", group: "Download", title: "Download", text: "To download all reports shown below (applying the filters that you've chosen), click this button. \n\nNote: This might take 1-2mins to get the zip file ready.", where: 'left'}
    ]);
    setCookie('showedGuideHistory', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
}


document.addEventListener('DOMContentLoaded', function() {
  if(readCookie('showedGuideHistory') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    }
  });

  </script>
</div>
{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_download_new.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_download.settings.desktop_image_width.label",
        "info": "t:sections.forsure_download.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_download.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_download.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_download.settings.layout.label",
        "info": "t:sections.forsure_download.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_download.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_download.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "image_picker",
        "id": "send_report",
        "label": "Send Report"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_download_new.presets.name"
      }
    ]
  }
{% endschema %}