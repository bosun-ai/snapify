{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}


{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
    z-index: 1000;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
  
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }
  td {
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
    cursor: pointer;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share,
  .send {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }

.table-header-title {
  overflow: hidden;
  transition: max-height 0.5s ease-out;
}
.table-header-title-hidden {
  max-height: 0;
  overflow: hidden;
}
.svg-arrow {
  transform: rotate(360deg);
  transition: transform 0.3s ease; /* Smooth transition for rotation */
}

.collapsed {
  transform: rotate(270deg); /* Rotate arrow 90 degrees when collapsed */
}

tr {
  border-top: 0.2rem solid #17161c !important;
}

.tabulator-page.active {
    color: #2255FF!important;
  }


  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 100;
}

.modal-content {
    position: absolute;
    border-radius: 25px;
    border-width: 0.2rem;
    border-style: solid;
    border-color: #17161c;
    width: 90%;
    max-width: 450px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.modalContainer {
  border-radius: 3rem;
  overflow: hidden;
}

.tooltipSave {
  position: absolute;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  z-index: 1;
  top: 30%;
  left: 50%;
  margin-left: -60px;
  transform: translate(-50%, -50%);
  transition: opacity 0.3s;
}
  .tabulator-row {
    cursor: default!important;
  }
  .tabulator-group-toggle {
    cursor: pointer!important;
  }
.tabulator-arrow {
    display: block!important;
}

.history-row {
    border-top: 0.2rem solid #17161c; /* Full-width border for each row */
    padding: 2rem 0; /* Vertical padding for spacing */
    width: 100%; /* Ensure the row spans the full container width */
  }

  .folder-row {
    font-weight: bold; /* Highlight folders */
    padding-left: 0; /* Ensure full-width borders */
    text-indent: 2rem; /* Indent text instead of moving the entire row */
    cursor: pointer;
  }

  .file-row {
    padding-left: 0; /* Ensure full-width borders */
    text-indent: 4rem; /* Further indent text for files */
    display: flex;
  }

  #tabs-container {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 1rem;
        overflow-x: auto; /* Handle large numbers of tabs */
    }

    .tab-button {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-bottom: none;
        background-color: #f9f9f9;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
        margin-right: 5px;
        border-radius: 8px 8px 0 0;
        flex: 0 0 auto;
    }

    .tab-button:hover {
        background-color: #eaeaea;
    }

    .tab-button.active {
        border-bottom: 2px solid #fff;
        font-weight: bold;
        color: #fafafa;
    }

    #report-table-data-excel {
        border: 1px solid #ddd;
        margin-top: 3rem;
        border-radius: 8px;
        overflow: hidden;
    }

    .filter-group {
      margin: auto;
    }
    .dropdown {
      margin-left: 0!important;
      width: 15rem!important;
    }
    .glyphicon-ok:before {
      content: "\2713";
    }


    /* Loading spinner */
    #loadingSpinner, #loadingSpinnerCalendar {
        border: 4px solid rgba(34, 85, 255, 0.1);
        border-top: 4px solid #2255ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: auto;
        display: flex;
    }
    #loadingSpinnerContainer, #loadingSpinnerCalendarContainer {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .all-icons {
      margin: auto;
    }
    #downloadAllReports {
      cursor: pointer;
    }

.folderArrow svg {
  width: 30px!important;
  height: 30px!important;
}

.emptyCol {
  display: block!important;
  width: 60px;
}

.no-reports-found {
  text-align: center;
  font-size: 1.5rem;
  font-weight: bold;
  padding: 2rem;
  border-top: 0.2rem solid #17161c;
}

{%- endstyle -%}
{% if customer.tags contains 'member' %}
<div class="section-{{ section.id }}-padding">
  <div id="newUploadHistory" style="display: none;min-height: 100vh;padding-bottom: 5rem;">

    <!-- Load d3.js -->
    <!-- <script src="https://d3js.org/d3.v4.js"></script> --><script src="https://cdn.jsdelivr.net/npm/d3@7"> </script>
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

    <script src="{{ 'cookie-handler.js' | asset_url }}"></script>


    {% comment %} {{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }} {% endcomment %}
    {% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> {% endcomment %}
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>-->
  {% comment %} <script src="https://code.jquery.com/jquery-3.6.0.js"></script> {% endcomment %}
  {% comment %} <script
    src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script> {% endcomment %}
  {% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> {% endcomment %}
  {% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script> {% endcomment %}
  {% comment %} <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" /> {% endcomment %}
    {% render 'forsure-simple-notification' %}
    <div id="tooltipWarn" class="tooltip" style="display: none;">Tooltip content</div>
    <div id='tooltip' class="tooltipSave"></div>
    <div id="reportcontainer" class="configbox page-width border" style="padding: 0;border-radius:1rem;display: none;">
      <div>
        <div style="display: flex;background-color: #fafafa;position: relative;border-radius: 1rem;" id="filterContainer">
            <h2 class="flex-header" style="margin-left: 2rem">
              <span id="historyheader" class="table-header" style="cursor: default">
                Report History
              </span>
            </h2>
            <div class="filter-group" id="profile-filter-guide" style="margin-left: 4rem">
              <div class="filter-group-heading">Country</div>
              <select
                id="countryDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
            </div>
            <div class="filter-group">
              <div class="filter-group-heading">Report Type</div>
              <select
                id="reporttypeDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
            </div>
            <div class="filter-group">
              <div class="filter-group-heading">Reporting Period</div>
              <select
                id="periodDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
            </div>
            <div class="filter-group" id="receiptsContainer" style="background-color: #fafafa;position: relative;">
              <div class="filter-group-heading">Additional filters</div>
              <select
                id="receiptsDropdown"
                class="selectpicker"
                multiple
                data-live-search="true"></select>
            </div>
            <div class="filter-group" id="searchContainer" style="background-color: #fafafa;position: relative;" title="Search by report information or date of update, e.g. yesterday, last month,15.06.2025">
              <div class="filter-group-heading" style="width: 12rem">Search</div>
              <input type="text" id="companySearch" class="form-control" placeholder="Search"  style="width: 12rem"/>
          </div>
            <span class="all-icons" style="margin-right: 3rem;background-color: #fafafa;position: relative;padding: 1rem;" id="allIconsContainer">
              <!-- <i id="filter" class="icon-1"><img width="20px" src="{{ section.settings.filter | image_url }}" alt="{{ section.settings.filter.alt | escape }}" loading="lazy"></i> -->
              <i id="downloadAllReports" class="icon-2" style="background-color: #fafafa;position: relative;"><img
                  width="30px"
                  src="{{ section.settings.download | image_url }}"
                  alt="{{ section.settings.download.alt | escape }}"
                  loading="lazy"></i>
            </span>
        </div>
        <div id="reportStatusContainer" class="table-header-title history-row" style="justify-content: space-between;display: none;">
          <h3 style="margin: 0 0 0 3rem;">Overview</h3>
          <div id="reportStatus" style="display: flex;gap: 1rem;margin: auto 4rem auto 2rem;position: relative;width: fit-content;background-color: #fafafa;height: fit-content;align-items: center;"></div>
          {% comment %} <div id="loadingAllReports" style="margin: 2rem;margin-left: auto;">Loading all reports...</div> {% endcomment %}
        </div>
        <div id="reportshistory" class="table-header-title" style="min-height: 65px"></div>
      </div>
    </div>
    <div id="imageModal" class="losensitive" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:100; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2);">
      <span id="closeModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
      <img id="modalImage" src="" alt="Image Preview" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">
  </div>
  <div id="modalOverlayImage" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;"></div>

  <div id="excelModal" class="losensitive" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height: fit-content;max-height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:100;">
      <div id="tabs-container" style="display: none; margin-bottom: 1rem; border-bottom: 1px solid #ddd;"></div>
      <div id="report-table-data-excel"></div>
      <span id="closeExcelModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;transform: translateX(-50%);">&times;</span>
      <button class="button" id="send-report" style="margin-top: 1rem;margin-left: auto;">File report</button>
  </div>
  <div id="modalOverlayExcel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;"></div>

  <div id="validateModal" class="losensitive modal isolate" style="display: none;">
    <div class="modal-content modalContainer" style="background: #fafafa;">
          <div id="title" style="background: #2255ff; padding: 2rem">
            <h2 style="color:#fafafa;text-align:center;">Are you sure?</h2>
          </div>
      <div class="rich-text__wrapper modal-content-text rich-text__wrapper--center page-width">
        <div class="rich-text__blocks center"><div class="rich-text__text textblock rte" style="color: #17161c; width: 88%; margin: 0 auto;margin-top:4rem;text-align: justify;text-align-last: left;">
          Make sure you double check the data before continuing.
          <br>
          <p style="color:#a80000;padding: 2rem 0;text-align: justify;text-align-last: left;">Important: After you press send, the report data will be automatically sent to the corresponding institution.</p>
        </div>
          <div style="margin-top: 0;margin-bottom: 2rem;">
            <button class="button" style="background-color: #17161c;margin-right: 2rem;" onclick="closeModal()">Close</button>
            <button class="button" id="validated-report-send">File Report</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf_viewer.min.css" />
  <div id="pdfModal" class="losensitive" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:1000;">
      <canvas id="pdfCanvas" style="border: 1px solid #ddd; margin: 0 auto; display: block;"></canvas>
      <div style="text-align: center; margin-top: 10px;">
          <button id="prevPage">Previous Page</button>
          <span id="pageInfo"></span>
          <button id="nextPage">Next Page</button>
      </div>
      <span id="closePdfModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
  </div>
  <div id="modalOverlayPdf" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;"></div>
</div>
</div>
  <script>
async function checkHistoryVersion() {
    try {
        {% comment %} let data = await unifiedSendRequest(GETREPORTHISTORYVERSION, {method: 'GET'});
        {% endcomment %}
        document.getElementById('newUploadHistory').style.display = 'block';

        {% comment %} if (data) {
            document.getElementById('newUploadHistory').style.display = 'block';
            {% comment %} document.getElementById('classicalHistory').style.display = 'none'; {% endcomment %}
        } else {
            document.getElementById('newUploadHistory').style.display = 'none';
            document.getElementById('classicalHistory').style.display = 'block';
        } {% endcomment %}
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get history ' + error.message, false);
    }
}

function extractBaseFilename(filename) {
  // Remove known prefixes
  const base = filename.replace(/^(Debugger_|Excluded_data_|Audit_Trail_)/, '');
  return base;
}

function createFolderStructure(configDiv, data) {
  configDiv.innerHTML = ''; // Clear existing content

  // Recursive function to create the structure
  function renderLevel(level, parentElement, path, depth = 0) {
    Object.keys(level).forEach(key => {
      if (key === 'files') {
        // Render files
        renderFileLevel(level, parentElement, path, depth, key);
      } else {
        tag_key_wanted = `${path}/${key}`.slice(1);  // Remove first /

        relevantTags = [];
        Object.entries(tags).forEach(([tag_key, tag_value]) => {
          if (tag_key.includes(tag_key_wanted)) {
            relevantTags = tag_value;
          }
        });
        // Render folder
        const folderRow = document.createElement('div');
        folderRow.className = 'history-row folder-row'; // Add CSS class for consistent styling
        folderRow.id = `folderRow-${path}/${key}`;
        folderRow.style.paddingLeft = `${depth * 2}rem`; // Offset text for hierarchy
        folderRow.style.display = 'inline-flex';
        folderRow.style.alignItems = 'center';

        // Add the SVG arrow
        const svg = `<svg class="svg-arrow collapsed" style="margin-left: 2rem;margin-right: 1rem; vertical-align: middle;" width="20.593" height="22.88" version="1.1" fill="2255ff" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 66.91" style="margin: auto;height: 100%;display: flex;width: 100%;" xml:space="preserve">
                        <g><path fill="#2255ff" d="M11.68,1.95C8.95-0.7,4.6-0.64,1.95,2.08c-2.65,2.72-2.59,7.08,0.13,9.73l54.79,53.13l4.8-4.93l-4.8,4.95 c2.74,2.65,7.1,2.58,9.75-0.15c0.08-0.08,0.15-0.16,0.22-0.24l53.95-52.76c2.73-2.65,2.79-7.01,0.14-9.73 c-2.65-2.72-7.01-2.79-9.73-0.13L61.65,50.41L11.68,1.95L11.68,1.95z"/></g>
                    </svg>`;
        folderRow.innerHTML = `${svg}`;
        const folderName = document.createElement('div');
        folderName.style.cssText = 'text-indent: 0 !important;';
        folderName.style.display = 'flex';

        const folderNameSpan = document.createElement('span');
        folderNameSpan.innerHTML = key;

        const tagsDiv = document.createElement('div');
        tagsDiv.id = `tagsDiv-${path}/${key}`;
        tagsDiv.style.marginRight = '5rem';
        tagsDiv.style.marginLeft = '1rem';
        tagsDiv.style.textIndent = 0;
        if (relevantTags.includes('new') && (Object.keys(level).length !== 1 || path === '')) {
            // Only show new tag if it's the root folder or if there are multiple subfolders
            tagsDiv.appendChild(addNewTag());
        }
        folderName.appendChild(folderNameSpan);
        folderRow.appendChild(folderName);
        folderRow.appendChild(tagsDiv);
        const folderContent = document.createElement('div');
        folderContent.style.display = 'none'; // Initially hidden

        // Add click event to toggle visibility and arrow direction
        folderRow.addEventListener('click', () => {
          folderContent.style.display = folderContent.style.display === 'none' ? 'block' : 'none';
          const arrow = folderRow.querySelector('.svg-arrow');
          arrow.classList.toggle('collapsed');
        });
        if (Object.keys(level).length === 1) {
            folderRow.click();
        }

        parentElement.appendChild(folderRow);
        parentElement.appendChild(folderContent);

        // Recurse into the next level
        renderLevel(level[key], folderContent, `${path}/${key}`, depth + 1);
      }
    });
  }

  renderLevel(hierarchy, configDiv, '', 0);
}

function renderFileLevel(level, parentElement, path, depth, key) {
  level[key].forEach(file => {
    if (file.type === 'group' && file.children.length > 0) {
      // Grouped file rendering
      const fileRow = document.createElement('div');
      fileRow.className = 'history-row folder-row';
      fileRow.id = `fileRow-${path}/${file.part}`;
      fileRow.style.paddingLeft = `${(depth + 1) * 2}rem`;
      fileRow.style.display = 'inline-flex';
      fileRow.style.alignItems = 'center';

      const arrowSvg = `<svg class="svg-arrow collapsed" style="margin-right: 1rem; vertical-align: middle;" width="20.593" height="22.88" version="1.1" fill="2255ff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 66.91"><g><path fill="#2255ff" d="M11.68,1.95C8.95-0.7,4.6-0.64,1.95,2.08c-2.65,2.72-2.59,7.08,0.13,9.73l54.79,53.13l4.8-4.93l-4.8,4.95 c2.74,2.65,7.1,2.58,9.75-0.15c0.08-0.08,0.15-0.16,0.22-0.24l53.95-52.76c2.73-2.65,2.79-7.01,0.14-9.73 c-2.65-2.72-7.01-2.79-9.73-0.13L61.65,50.41L11.68,1.95L11.68,1.95z"/></g></svg>`;
      fileRow.innerHTML = `${arrowSvg}`;
      fileRow.style.cursor = 'pointer';

      const fileName = document.createElement('div');
      fileName.style.cssText = 'text-indent: 0 !important;';
      fileName.className = 'report-group';

      const fileNameSpan = document.createElement('span');
      fileNameSpan.innerHTML = file.part;
      fileName.appendChild(fileNameSpan);

      const tagsDiv = document.createElement('div');
      tagsDiv.id = `tagsDiv-${path}/${file.part}`;
      tagsDiv.style.marginRight = '5rem';
      tagsDiv.style.marginLeft = '1rem';
      tagsDiv.style.textIndent = 0;

      // Optional: tag style wrapper
      if (file.part.toLowerCase().includes('inprogress')) {
        const inprogressTag = createColReport(`<svg height="12px" fill="#fafafa" title="In Progress" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M32 0C14.3 0 0 14.3 0 32S14.3 64 32 64l0 11c0 42.4 16.9 83.1 46.9 113.1L146.7 256 78.9 323.9C48.9 353.9 32 394.6 32 437l0 11c-17.7 0-32 14.3-32 32s14.3 32 32 32l32 0 256 0 32 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l0-11c0-42.4-16.9-83.1-46.9-113.1L237.3 256l67.9-67.9c30-30 46.9-70.7 46.9-113.1l0-11c17.7 0 32-14.3 32-32s-14.3-32-32-32L320 0 64 0 32 0zM96 75l0-11 192 0 0 11c0 19-5.6 37.4-16 53L112 128c-10.3-15.6-16-34-16-53zm16 309c3.5-5.3 7.6-10.3 12.1-14.9L192 301.3l67.9 67.9c4.6 4.6 8.6 9.6 12.1 14.9L112 384z"/></svg>`);
        inprogressTag.style.background = '#2255ff';
        inprogressTag.style.margin = 0;
        inprogressTag.style.padding = '0.4rem 1rem';
        inprogressTag.style.justifyContent = 'center';
        inprogressTag.style.display = 'flex';
        inprogressTag.style.borderRadius = '1rem';
        inprogressTag.title = 'Inprogress';
        tagsDiv.appendChild(inprogressTag);
      }
      if (file.tags.includes('new')) {
        // Only show new tag if it's the root folder or if there are multiple subfolders
        tagsDiv.appendChild(addNewTag());
    }

      fileRow.appendChild(fileName); // ← Filename block
      fileRow.appendChild(tagsDiv);     // ← Tag rendered next to it, not inside


      const groupContainer = document.createElement('div');
      groupContainer.style.display = 'none';

      fileRow.addEventListener('click', () => {
        groupContainer.style.display = groupContainer.style.display === 'none' ? 'block' : 'none';
        groupContainer.classList.add('history-group-container');
        fileRow.querySelector('.svg-arrow').classList.toggle('collapsed');
      });

      file.children.forEach(child => {
        let childPath = child.filename;
        let childFileName = childPath.split('/').pop();
        let isSubmission = false;
        let reportId = child.report_id;
        if (child.report_submission_name) {
          childFileName = child.report_submission_name;
          childPath = child.report_submission_name;
          isSubmission = true;
          reportId = child.submission_id;
        }
        const childRow = document.createElement('div');
        childRow.className = 'history-row file-row';
        childRow.id = `childRow-${path}/${childPath}`;
        childRow.style.paddingLeft = `${(depth + 1) * 2}rem`;
        {% comment %} padding-left: 12rem;justify-content: space-between;align-items: center;padding-right: 5rem; {% endcomment %}
        childRow.style.justifyContent = 'space-between';
        childRow.style.alignItems = 'center';
        childRow.style.paddingRight = '5rem';

        const fileNameDiv = document.createElement('div');
        fileNameDiv.textContent = childFileName;

        const tagsDiv = document.createElement('div');
        tagsDiv.style.marginRight = '5rem';
        tagsDiv.style.marginLeft = '1rem';
        tagsDiv.style.textIndent = 0;
        var statusMatch = statusMapping(child.status);
        if (!isSubmission) {
            const statusTag = createColReport('');
            if (statusMatch.status == 'Deleted') {
              childRow.style.textDecoration = 'line-through';
            }
            // Create the dot
            const dot = document.createElement('span');
            dot.style.width = '0.8em';
            dot.style.height = '0.8em';
            dot.style.borderRadius = '50%';
            dot.style.background = statusMatch.color;
            dot.style.marginRight = '0.6rem';
          
            // Create the text span
            const text = document.createElement('span');
            text.textContent = `${statusMatch.status}`;
            
            // Compose the full container
            statusTag.appendChild(dot);
            statusTag.appendChild(text);
          
            statusTag.style.cursor = 'pointer';
            statusTag.onclick = function () {
              if (activeStatus === status[0]) {
                filterReportHistory();
                activeStatus = '';
              } else {
                filterReportHistory(status[0]);
                activeStatus = status[0];
              }
            };
            title = statusMatch.description;
            if (child.position != null) {
              title += `\nPosition in queue: ${child.position}`;
            }
            title += `\nLast updated: ${new Date(child.updated_at).toLocaleString('DE')}`;  // TODO: change to user's timezone
            statusTag.title = title;
          
            statusTag.style.padding = '0.4rem 1rem';
            statusTag.style.justifyContent = 'center';
            statusTag.style.display = 'flex';
            statusTag.style.alignItems = 'center';
            statusTag.style.borderRadius = '1rem';
            tagsDiv.appendChild(statusTag);
        }
        const icons = document.createElement('div');
        icons.style.display = 'flex';
        if (statusMatch.position >= 3 && !isSubmission) {  // data was extracted
          icons.appendChild(addOpenIconExtracted(reportId));
        }
        icons.appendChild(addOpenIconReport(childFileName, childPath, isSubmission, reportId));
        icons.appendChild(addDownloadIcon(childFileName, childPath, isSubmission, reportId));
        if (window.userPermissions['sharereport'] === true) {
          icons.appendChild(addShareCol(childFileName, childPath, isSubmission, reportId));
        }
        if (window.userPermissions['deletereport'] === true) {
          icons.appendChild(child.can_delete ? addTrashIcon(childFileName, child) : emptyCol());
        }
        if (child.can_submit) {
          icon = sendReportIcon(childFileName, childPath, window.userPermissions['filereport'], child.no_submit_reason);
          if (child.no_submit_reason) {
            icon.title = child.no_submit_reason;
            icon.style.opacity = '0.5';
            icon.onclick = () => {
              showMessage(child.no_submit_reason, false);
            };
          }
        } else {
          icon = emptyCol();
        }
        icons.appendChild(icon);

        childRow.appendChild(fileNameDiv);
        childRow.appendChild(tagsDiv);
        childRow.appendChild(icons);
        groupContainer.appendChild(childRow);
      });

      parentElement.appendChild(fileRow);
      parentElement.appendChild(groupContainer);
    }
  });
}

function addNewTag() {
  const newTag = createColReport(`New`);
  newTag.classList.add('newTag');
  newTag.style.background = '#2255ff';
  newTag.style.color = '#fafafa';
  newTag.style.margin = 0;
  newTag.style.padding = '0.4rem 1rem';
  newTag.style.justifyContent = 'center';
  newTag.style.display = 'flex';
  newTag.style.borderRadius = '1rem';
  newTag.title = 'Report was recently updated';
  return newTag;
}

function statusMapping(status) {
  switch (status) {
    case 'error':
      return {'status': 'Error', 'color': '#E63C6B', 'description': 'Report had an error, please check the notifications.', 'position': -2};
    case 'waiting':
      return {'status': 'Input Required', 'color': '#E6B83C', 'description': 'Report is waiting for user input, please check the notifications.', 'position': -1};
    case 'created':
      return {'status': 'Uploaded', 'color': '#2255ff', 'description': 'Report was uploaded, will now be sorted', 'position': 0};
    case 'in_progress':
      return {'status': 'In Progress', 'color': '#2255ff', 'description': 'Report is being processed', 'position': 1};
    case 'metadata_extracted':
      return {'status': 'Sorted', 'color': '#2255ff', 'description': 'Report was sorted, data will now be extracted', 'position': 2};
    case 'data_extracted':
      return {'status': 'Data Extracted', 'color': '#2255ff', 'description': 'Data was extracted, will now be submitted', 'position': 3};
    case 'submitted':
      return {'status': 'Submitted', 'color': '#2255ff', 'description': 'Report was submitted, will now be validated', 'position': 4};
    case 'validated':
      return {'status': 'Validated', 'color': '#21FF3D', 'description': 'Report was validated', 'position': 5};
    case 'done':
      return {'status': 'Completed', 'color': '#21FF3D', 'description': 'Report is completed', 'position': 6};
    case 'deferred':
      return {'status': 'Deleted', 'color': '#4E5366', 'description': 'Report was deleted', 'position': 7};
    default:
      return {'status': 'Unknown', 'color': '#4E5366', 'description': 'Status is unknown', 'position': -3};
  }
}

function createColReport(content, title = '', alignRight = false) {
    const col = document.createElement('div');
    col.innerHTML = content;
    return col;
}

function emptyCol() {
  const col = document.createElement('div');
  col.className = 'emptyCol';
  col.classList.add('file-row');
  return col;
}

function addOpenIconExtracted(report_id) {
  const openCol = createColReport(
      `<i class="open">{% render "icon-extracted" %}</i>`,
      'Show extracted data'
  );
  // TODO: remove this
  if (true) {
    openCol.style.opacity = '0.5';
    openCol.title = 'Extracted data is not yet available.';
    openCol.querySelector('i').style.cursor = 'not-allowed';
    return openCol;
  }      
  openCol.addEventListener('click', async function() {
    try {
      document.body.style.cursor = 'wait';
        // Apply the 'wait' cursor to each element
        document.querySelectorAll('.folder-row').forEach(row => {
            row.style.cursor = 'wait';
        });
        const formData = new FormData();
        formData.append('report_id', report_id);

        const data = await unifiedSendRequest(GETREPORTDETAILSEXTRACTED, {method: 'POST', formData: formData});
        console.log(data);
        displayExcelReport(data, false, report_id, 'extracted', {'Extracted Data': 'Zero Declaration found, no data to show'});
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to open report ' + error.message, false);
    }
    document.body.style.cursor = 'default';
    // Apply the 'wait' cursor to each element
    document.querySelectorAll('.folder-row').forEach(row => {
        row.style.cursor = 'pointer';
    });
  });
  return openCol;
}


function addOpenIconReport(fileName, fullPath, isSubmission, report_id) {
    const openCol = createColReport(
        '<i class="open"><img width="20px" src="{{ section.settings.open | image_url }}" alt="{{ section.settings.open.alt | escape }}" loading="lazy"></i>',
        'Open report'
    );
    openCol.addEventListener('click', async function() {

      await displayReport(fileName, fullPath, false, isSubmission, report_id);
    });
    return openCol;
}

async function displayReport(fileName, fullPath, submit, isSubmission, report_id=null) {
    try {
        document.body.style.cursor = 'wait';
        // Apply the 'wait' cursor to each element
        document.querySelectorAll('.folder-row').forEach(row => {
            row.style.cursor = 'wait';
        });
        const formData = new FormData();
        formData.append('filepath', fullPath);
        formData.append('display', true);
        if (isSubmission) {
          formData.append('submission_id', report_id);
        } else if (report_id != null) {
          formData.append('report_id', report_id);
        }

        const extension = fileName.split('.').pop().toLowerCase();
        if (extension === 'png' || extension === 'jpg' || extension === 'jpeg') {
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            // Open image in modal
            const imageUrl = URL.createObjectURL(blob);
            const modal = document.getElementById('imageModal');
            const modalOverlay = document.getElementById('modalOverlayImage');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageUrl;
            modal.style.display = 'block';
            modalOverlay.style.display = 'block';
        } else if (extension === 'xlsx' || extension === 'csv') {
            const data = await unifiedSendRequest(GETREPORTDETAILS, {method: 'POST', formData: formData});
            displayExcelReport(data, submit, fileName, fullPath);
        } else if (extension === 'pdf') {
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            const arrayBuffer = await blob.arrayBuffer();
            displayPdfInModal(new Uint8Array(arrayBuffer));
        }
        else {
            console.error('Filetype is not yet supported, please download it to look at the content');
            showMessage('Filetype is not yet supported, please download it to look at the content', false);
        }
        
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to open report ' + error.message, false);
    }
    document.body.style.cursor = 'default';
    // Apply the 'wait' cursor to each element
    document.querySelectorAll('.folder-row').forEach(row => {
        row.style.cursor = 'pointer';
    });
}

// Download Icon
function addDownloadIcon(fileName, fullPath, isSubmission, report_id=null) {
    const downloadCol = createColReport(
        '<i class="download"><img width="20px" src="{{ section.settings.download | image_url }}" alt="{{ section.settings.download | image_url }}" loading="lazy"></i>',
        'Download report'
    );
    downloadCol.addEventListener('click', async () => {
        try {
            const formData = new FormData();
            formData.append('filepath', fullPath);
            if (isSubmission) {
              formData.append('submission_id', report_id);
            } else if (report_id != null) {
              formData.append('report_id', report_id);
            }
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            const bloburl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = bloburl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(bloburl);
        } catch (error) {
            console.error(error.message);
            showMessage('Failed to download file ' + error.message, false);
        }
    });
    return downloadCol;
}


function sendReportIcon(fileName, fullPath, submit, no_submit_reason) {
  const openCol = createColReport('<i class="send"><img width="20px" src="{{ section.settings.send_report | image_url }} " alt="{{ section.settings.send_report.alt | escape }}" loading="lazy"></i>', "Send report"); // Placeholder icon
  if (submit) {
    if (!no_submit_reason) {
      openCol.addEventListener('click', async function() {
        await displayReport(fileName, fullPath, true, false);
      });
    }
  } else {
    openCol.style.position = 'relative';
    const tooltip = document.createElement('div');  
    tooltip.innerHTML = 'Please upgrade to the full version to send reports';
    tooltip.style.right = '0px';
    tooltip.style.width = 'fit-content';
    tooltip.style.textIndent = '0';
    tooltip.style.transform = 'translateX(20%)';
    tooltip.classList.add('greyedout-tooltip');
    openCol.appendChild(tooltip);
    openCol.addEventListener('mouseover', async function() {
      tooltip.style.display = 'block';
    });
    openCol.addEventListener('mouseout', async function() {
      tooltip.style.display = 'none';
    });
  }
  return openCol;
}


function addShareCol(fileName, fullPath, isSubmission, report_id) {
  const shareCol = createColReport('<i class="share"><img width="20px" src="                         {{ section.settings.share | image_url }} " alt="                         {{ section.settings.share.alt | escape }}" loading="lazy"></i>', "Share report"); // Placeholder icon
  if (true) { // TODO: remove this
    shareCol.style.opacity = '0.5';
    shareCol.title = 'Sharing reports is not available at the moment';
    shareCol.querySelector('i').style.cursor = 'not-allowed';
    return shareCol;
  }
  shareCol.addEventListener('click', async function() {
          try {
            const reportData = new FormData();
            reportData.append("file_name", fileName);
            reportData.append("full_path", fullPath);
            if (isSubmission) {
              reportData.append("submission_id", report_id);
            } else if (report_id != null) {
              reportData.append("report_id", report_id);
            }
            const downloadData = await unifiedSendRequest(CREATEDOWNLOADLINK, {formData: reportData});
            const subject = encodeURIComponent("Here is the EPR report " + downloadData.reportname);
            const body = encodeURIComponent("\n\nHere is the link to download the report: " + server_url + downloadData.link + "\nUsername: " + downloadData.username + "\nPassword: " + downloadData.password + "\n\n");
            // Open the default mail client
            window.location.href = "mailto:?subject=" + subject + "&body=" + body;

          } catch (error) {
            console.error(error.message);
            TOKEN = false;
          }
        });
  return shareCol;
}

function addTrashIcon(fileName, child) {
  const trashcanCol = createColReport('<i class="trashcan"><img width="20px" src="{{ section.settings.trashcan | image_url }} " alt="{{ section.settings.trashcan.alt | escape }}" loading="lazy"></i>', "Delete report"); // Placeholder icon
  statusMapped = statusMapping(child.status);
  if (statusMapped.position >= 4) {
    trashcanCol.style.opacity = '0.5';
    trashcanCol.title = 'Report is already submitted, cannot be deleted';
    trashcanCol.querySelector('i').style.cursor = 'not-allowed';
    return trashcanCol;
  }      
  trashcanCol.addEventListener('click', async function() {
          try {
            const reportData = new FormData();
            reportData.append("file_name", fileName)
            reportData.append("report_id", child.report_id);
            const deleteData = await unifiedSendRequest(DELETEREPORT, {formData: reportData});
            if (deleteData.hide) {
              var entries = trashcanCol.closest('.history-group-container').querySelectorAll('.history-row');
              var numEntries = 0;
              entries.forEach(entry => {
                if (entry.getAttribute('disabled') != 'disabled') {
                  numEntries++;
                }
              });
              if (numEntries == 1) {
                getReports();
              } else {
                trashcanCol.closest('.history-row').style.display = 'none';
                trashcanCol.closest('.history-row').setAttribute('disabled', 'disabled');
              }
            }
            if (deleteData.status_code == 200) {
              showMessage("Successfully deleted report", true);
            } else {
              showMessage(deleteData.message, false);
            }
          } catch (error) {
            console.error(error.message);
            TOKEN = false;
            showMessage("Failed to delete report, please try again", false);
          }
        });
  return trashcanCol;
}

function addCheckboxCol(fileName, fullPath) {
  const checkboxCol = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = data;
        checkbox.className = 'rowCheckbox';
        checkbox.addEventListener('change', function() {
          const allChecked = [...document.querySelectorAll('input[type="checkbox"].rowCheckbox')].every(ch => ch.checked);
          const allUnchecked = [...document.querySelectorAll('input[type="checkbox"].rowCheckbox')].every(ch => !ch.checked);

          if (allChecked) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else if (allUnchecked) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true; // This sets the checkbox to its "indeterminate" state
          }
        });
        checkboxCol.appendChild(checkbox);
  return checkboxCol;
}

renames = {
  'amount_total': 'Amount Total',
  'amount_b2b': 'Amount B2B',
  'amount_b2c': 'Amount B2C',
  'weight_total': 'Weight Total (kg)',
  'weight_b2b': 'Weight B2B (kg)',
  'weight_b2c': 'Weight B2C (kg)',
  'sku': 'SKU',
  'orderid': 'OrderID',
  'b2b': 'B2B',
  'Column A': 'Index'
};
function displayExcelReport(data, submit, fileName, fullPath, emptyData=null) {
    if (emptyData == null) {
      emptyData = {'Data': 'No data to show'};
    }
    const modalOverlay = document.getElementById('modalOverlayExcel');
    const modal = document.getElementById('excelModal');
    const tabsContainer = document.getElementById('tabs-container');
    const tableContainer = document.getElementById('report-table-data-excel');

    // Reset modal content
    tabsContainer.innerHTML = '';
    tableContainer.innerHTML = '';

    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; // Alphabet for column headers
    let sheets = Object.keys(data);
    let groupedSheets = {};
    const groupLabels = {};
    var use_tabs = false;

    if (!use_tabs) {
        const groups = {};
        sheets.forEach((sheetName) => {
            const rows = data[sheetName];
            if (!rows || rows.length === 0) {
              console.log('empty data', emptyData);
              groups['Empty Data'] = [{...emptyData, 'Category': sheetName}];
              groupLabels['Empty Data'] = [sheetName];
              return;
            }

            const columnSignature = JSON.stringify(Object.keys(rows[0]).sort());
            if (!groups[columnSignature]) {
                groups[columnSignature] = [];
                groupLabels[columnSignature] = [];
            }

            const taggedRows = rows.map(row => ({
                ...row,
                Category: sheetName
            }));

            groups[columnSignature].push(...taggedRows);
            groupLabels[columnSignature].push(sheetName);
        });

        groupedSheets = groups;
    } else {
        // Use original structure (each sheet separate)
        groupedSheets = Object.fromEntries(sheets.map(s => [s, data[s]]));
    }

    const groupNames = Object.keys(groupedSheets);
    console.log('groupedSheets', groupedSheets);
    console.log('groupLabels', groupLabels);
    console.log('groupNames', groupNames);
    if (groupNames.length > 1) {
        // Generate Tabs only if more than 1 group
        groupNames.forEach((groupName, index) => {
            const tabButton = document.createElement('button');
            tabButton.textContent = groupLabels[groupName][0];
            tabButton.className = 'tab-button';
            tabButton.style.margin = '5px';
            tabButton.dataset.sheet = groupName;

            tabButton.addEventListener('click', () => {
                tableContainer.innerHTML = '';
                highlightActiveTab(index);
                renderSheet(groupedSheets[groupName]);
            });

            tabsContainer.appendChild(tabButton);
            tabsContainer.style.display = 'flex';
        });

        // Render the first one initially
        renderSheet(groupedSheets[groupNames[0]]);
        highlightActiveTab(0);
    } else if (groupNames.length == 1) {
        // Only one group, render directly without tabs
        renderSheet(groupedSheets[groupNames[0]]);
    }


    // Helper function to highlight active tab
    function highlightActiveTab(activeIndex) {
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach((btn, index) => {
            btn.classList.toggle('active', index === activeIndex);
        });
    }


    // Function to render a single sheet
    function renderSheet(sheetData) {
      console.log('sheetData', sheetData);
        const columns = Object.keys(sheetData[0]).map((key, idx) => {
          console.log('key', key);
            const key_text = key in renames ? renames[key] : key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            console.log('key_text', key_text);
            display_col = true;
            if (key == 'Category') {
              display_col = false;
            }
            return {
                title: key_text, // Use alphabet for headers
                field: key,
                headerSort: true, // Enable sorting
                formatter: "plaintext", // Ensure raw text is displayed
                visible: display_col,
                cellMouseOver: (e, cell) => {
                    // Add tooltip on hover for full entry
                    const tooltip = document.createElement('div');
                    tooltip.id = 'hover-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.padding = '8px';
                    tooltip.style.background = '#333';
                    tooltip.style.color = '#fff';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.zIndex = '9999';
                    tooltip.textContent = cell.getValue();

                    document.body.appendChild(tooltip);
                    document.body.addEventListener('mousemove', moveTooltip);

                    function moveTooltip(event) {
                        tooltip.style.left = `${event.pageX + 10}px`;
                        tooltip.style.top = `${event.pageY + 10}px`;
                    }

                    cell.getElement().addEventListener('mouseout', () => {
                        document.body.removeEventListener('mousemove', moveTooltip);
                        document.body.removeChild(tooltip);
                    });
                },
            };
        });

        const tableOptions = {
          data: sheetData,
          layout: columns.length > 10 ? "fitDataFill" : "fitColumns",
          pagination: sheetData.length > 50,
          paginationCounter: "rows",
          paginationSize: 50,
          columns: columns,
      };
      // Only add groupBy when not using tabs
      if (!use_tabs) {
          tableOptions.groupBy = "Category";
          tableOptions.groupHeader = function (value, count, data, group) {
              return value;
          };
      }


        // Initialize Tabulator for the sheet
        new Tabulator("#report-table-data-excel", tableOptions);
    }

    // Render the first sheet by default
    if (use_tabs && sheets.length > 0) {
        renderSheet(data[sheets[0]]);
        highlightActiveTab(0);
    }
    if (submit) {
      document.getElementById('send-report').style.display = 'block';
      document.getElementById('send-report').onclick = function() {
        sendReport(fileName, fullPath);
      };
    } else {
      document.getElementById('send-report').style.display = 'none';
    }
    // Show the modal
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
}


function sendReport(fileName, fullPath) {
  document.getElementById('validateModal').style.display = 'block';
  document.getElementById('validated-report-send').onclick = async function() {
    sendReportGov(fileName, fullPath);
  }
}

async function sendReportGov(fileName, fullPath) {
    try {
      const reportData = new FormData();
      reportData.append("file_name", fileName);
      reportData.append("full_path", fullPath);
      closeModal();
      hideExcelModal();
      const data = await unifiedSendRequest(SENDREPORT, {formData: reportData});
      showMessage("Report sent successfully", true);
    } catch (error) {
      console.error(error);
      TOKEN = false;
      showMessage("Failed to send report", false);
    }
}

function closeModal() {
  document.getElementById('validateModal').style.display = 'none';
}

function showModal() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('report-table').style.display = 'block';
}

function hideModal() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('report-table').style.display = 'none';
}

function displayPdfInModal(pdfBlob) {
    const modal = document.getElementById('pdfModal');
    const modalOverlay = document.getElementById('modalOverlayPdf');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const ctx = pdfCanvas.getContext('2d');

    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;

    const renderPage = (num) => {
        pageRendering = true;
        pdfDoc.getPage(num).then((page) => {
            const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale for better rendering
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;

            // Render the page
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport,
            };
            const renderTask = page.render(renderContext);

            renderTask.promise.then(() => {
                pageRendering = false;

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });

        // Update page info
        document.getElementById('pageInfo').textContent = `Page ${num} of ${pdfDoc.numPages}`;
    };

    const queueRenderPage = (num) => {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    };

    const onPrevPage = () => {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    };

    const onNextPage = () => {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    };

    document.getElementById('prevPage').addEventListener('click', onPrevPage);
    document.getElementById('nextPage').addEventListener('click', onNextPage);

    // Load the PDF
    const loadingTask = pdfjsLib.getDocument({ data: pdfBlob });
    loadingTask.promise.then((pdf) => {
        pdfDoc = pdf;
        renderPage(pageNum);
    });

    // Show the modal
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
}


var allReports = [];
var lastUpdated = null;
async function getReports(init=true) { // gets only the reports for that user to reduce load time
    try {
        const configDiv = document.getElementById("reportshistory");
        configDiv.innerHTML = '';
        var loadingSpinnerContainer = document.createElement('div');
        loadingSpinnerContainer.id = 'loadingSpinnerContainer';
        var loadingSpinner = document.createElement('div');
        loadingSpinner.id = 'loadingSpinner';
        loadingSpinnerContainer.appendChild(loadingSpinner);
        configDiv.appendChild(loadingSpinnerContainer);
        let data = await unifiedSendRequest(GETREPORTSOVERVIEW + '?only_user_reports=true', {method: 'GET', headerArgs: {'Content-Type': 'application/json'}});
        lastUpdated = data['last_updated'];
        console.log(data);
        updateReportStatusOverview(data['status_overview']);
        createFolderStructureOverview(configDiv, data['reports']);
        createOverview(data['reports'], true);
    } catch (error) {
        console.error(error.message);
        showMessage("Failed to get reports", false);
        document.getElementById('loadingSpinnerContainer').style.display = 'none';
        TOKEN = false;
    }
}

async function getReportsDetails(company, country, reportType) { // gets only the reports for the given company, country, report type
  try {
    console.log('company', company);
    console.log('country', country);
    console.log('reportType', reportType);
      let repsFound = allReports.filter(report => {
        if (company) {
          if (report['company'] != company) {
            return false;
          }
        }
        if (country) {
          if (report['country'] != country) {
            return false;
          }
        }
        if (reportType) {
          if (report['report_type'] != reportType) {
            return false;
          }
        }
        return true;
      })
      if (repsFound.length > 0) {
        console.log('report already loaded', repsFound);
        return repsFound;
      }
      const receiptsSelected = Array
      .from(document.getElementById('receiptsDropdown').options)
      .filter(option => option.selected)
      .map(option => option.value);
      params = {
        only_user_reports: receiptsSelected.includes('My Reports'),
      }
      if (company) {
        params['company'] = company;
      }
      if (country) {
        params['country'] = country;
      }
      if (reportType) {
        params['report_type'] = reportType;
      }
      let data = await unifiedSendRequest(GETREPORTSONEDRIVE + '?' + new URLSearchParams(params).toString(), {method: 'GET', headerArgs: {'Content-Type': 'application/json'}});
      console.log('data', data);
      for (let report of data['data']) {
        if (allReports.find(r => (r['report_id'] && r['report_id'] == report['report_id']) || (r['submission_id'] && r['submission_id'] == report['submission_id']))) {
          console.log('report already loaded', report);
          continue;
        }
        allReports.push(report);
      }
      return data['data'];
  } catch (error) {
      console.error(error.message);
      showMessage("Failed to get reports", false);
      document.getElementById('loadingSpinnerContainer').style.display = 'none';
      TOKEN = false;
  }
}

async function getReportsAll() {
  {% comment %} try {
  let data = await unifiedSendRequest(GETREPORTSONEDRIVE, {method: 'GET', headerArgs: {'Content-Type': 'application/json'}});
  allReports = data['data'];
  lastUpdated = data['last_updated'];
  filterReportHistory('', false);
  {% comment %} document.getElementById('loadingAllReports').style.display = 'none'; {% endcomment %}
  } catch (error) {
  console.error(error.message);
  TOKEN = false;
  } {% endcomment %}
}

async function getReportUpdates() {
  try {
  let data = await unifiedSendRequest(GETREPORTSONEDRIVEUPDATES+ '?previous_time=' + lastUpdated, {method: 'GET', headerArgs: {'Content-Type': 'application/json'}});
  lastUpdated = data['last_updated'];
  console.log(data);
  if (data['data'].length > 0) {
    for (let report of data['data']) {
      {% comment %} showReportUpdateNew(report); {% endcomment %}
    }
  }
  } catch (error) {
  console.error(error.message);
  TOKEN = false;
  }
}

function createFolderStructureOverview(configDiv, data) {
  configDiv.innerHTML = '';

  const companies = Object.keys(data).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

  for (let company of companies) {
    const companyDiv = document.createElement('div');
    companyDiv.id = `companyDiv-${company}`;
    companyDiv.classList.add('company-div');
    fillFolderRow(companyDiv, company, 0);
    configDiv.appendChild(companyDiv);
    country_selected_div = null;
    companyDiv.addEventListener('click', async () => {
      const countries = Object.keys(data[company]);
      toggleSubItems(
        companyDiv,
        countries,
        `countryDiv-${company}`,
        data[company],
        1,
        (countryDiv, country, depth) => {
          fillFolderRow(countryDiv, country, depth);
          country_selected_div = countryDiv;

          // attach report toggle to each country row now
          countryDiv.addEventListener('click', async (e) => {
            e.stopPropagation(); // avoid bubbling
            const reportTypes = Object.keys(data[company][country]);
            reportType_selected = null;
            if (reportTypes.length == 1) {
              reportType_selected = reportTypes[0];
            }
            getReportsDetails(company, country, reportType_selected);
            toggleSubItems(
              countryDiv,
              reportTypes,
              `reportTypeDiv-${company}-${country}`,
              data[company][country],
              2,
              (reportDiv, reportType, depth2) => {
                fillFolderRow(reportDiv, reportType, depth2);
                reportDiv.addEventListener('click', async (e) => {
                  e.stopPropagation(); // avoid bubbling
                  let reports = allReports.filter(r => r['company'] == company && r['country'] == country && r['report_type'] == reportType);
                  if (reports.length == 0) {
                    reports = await getReportsDetails(company, country, reportType);
                  }
                  createFolderStructureDetails(reportDiv, reports, company, country, reportType);
                });
              }
            );
          });
        }
      );
      country_selected = null;
      if (countries.length == 1) {
        country_selected = countries[0];
        country_selected_div.click();
      }
      getReportsDetails(company, country_selected, null);
    });
  }
}


function createFolderStructureDetails(reportDiv, reports, company, country, reportType) {
  const years = [...new Set(reports.map(r => r['year']))].sort();

  var year_selected_div = null;
  toggleSubItems(
    reportDiv,
    years,
    `yearDiv-${reportDiv.id}`,
    groupBy(reports, 'year'),
    3,
    (yearDiv, year, depth) => {
      fillFolderRow(yearDiv, year, depth);
      year_selected_div = yearDiv;
      yearDiv.addEventListener('click', (e) => {
        const reportsInYear = groupBy(reports, 'year')[year];
      
        const withTimeframe = reportsInYear.filter(r => r['timeframe'] && r['timeframe'].trim() !== '');
        const withoutTimeframe = reportsInYear.filter(r => !r['timeframe'] || r['timeframe'].trim() === '');
      
        const timeframes = [...new Set(withTimeframe.map(r => r['timeframe']))].sort();
      
        timeframe_selected_div = null;
        // ✅ Create timeframe subfolders
        toggleSubItems(
          yearDiv,
          timeframes,
          `timeframeDiv-${reportDiv.id}-${year}`,
          groupBy(withTimeframe, 'timeframe'),
          depth + 1,
          (timeframeDiv, timeframe, depth2) => {
            fillFolderRow(timeframeDiv, timeframe, depth2);
            timeframe_selected_div = timeframeDiv;
            timeframeDiv.addEventListener('click', (e) => {
              e.stopPropagation();
              const reportsInTimeframe = groupBy(withTimeframe, 'timeframe')[timeframe];
              const filenames = [...new Set(reportsInTimeframe.map(r => r['filename']))].sort();
      
              toggleSubItems(
                timeframeDiv,
                filenames,
                `fileDiv-${reportDiv.id}-${year}-${timeframe}`,
                groupBy(reportsInTimeframe, 'filename'),
                depth2 + 1,
                (fileDiv, filename, depth3) => {
                  fillFolderRow(fileDiv, filename, depth3);
                  fileDiv.addEventListener('click', e => {
                    e.stopPropagation();
                    console.log('File clicked:', filename);
                    const matchingReports = reports.filter(r => r['filename'] === filename);
                    displayReportDetails(matchingReports, fileDiv, depth3, `${company}/${country}/${reportType}`);
                  });
                }
              );
            });
          }
        );
      
        // ✅ Also directly show filenames under the year (skipping timeframe) for empty timeframe
        if (withoutTimeframe.length > 0) {
          const filenames = [...new Set(withoutTimeframe.map(r => r['filename']))].sort();
      
          toggleSubItems(
            yearDiv,
            filenames,
            `fileDiv-${reportDiv.id}-${year}-notimeframe`,
            groupBy(withoutTimeframe, 'filename'),
            depth + 1, // one level deeper than year
            (fileDiv, filename, depth2) => {
              fillFolderRow(fileDiv, filename, depth2);
              fileDiv.addEventListener('click', e => {
                e.stopPropagation();
                console.log('File clicked:', filename);
                const matchingReports = reports.filter(r => r['filename'] === filename);
                displayReportDetails(matchingReports, fileDiv, depth2, `${company}/${country}/${reportType}`);
              });
            }
          );
        }
        if (timeframes.length == 1) {
          timeframe_selected_div.click();
        }
      });
    }
  );
  if (years.length == 1) {
    year_selected_div.click();
  }
}

function groupBy(arr, key) {
  return arr.reduce((acc, item) => {
    const k = item[key];
    if (!acc[k]) acc[k] = [];
    acc[k].push(item);
    return acc;
  }, {});
}


function toggleSubItems(triggerDiv, keys, idPrefix, dataMap, level, renderFn) {
  const parent = triggerDiv.parentNode;
  const baseId = triggerDiv.id;
  const markerId = `${baseId}-marker-${idPrefix}`;
  const existingMarker = document.getElementById(markerId);

  const arrow = triggerDiv.querySelector('.svg-arrow');
  const isOpen = triggerDiv.classList.contains('open');

  if (existingMarker) {
    // Remove subitems
    let next = triggerDiv.nextElementSibling;
    while (next && next !== existingMarker) {
      const toRemove = next;
      next = next.nextElementSibling;
      parent.removeChild(toRemove);
    }
    parent.removeChild(existingMarker);

    // Collapse arrow and folder row state
    arrow?.classList.add('collapsed');
    triggerDiv.classList.remove('open');
    return;
  }

  // Expand logic
  const fragment = document.createDocumentFragment();
  for (const key of keys) {
    const div = document.createElement('div');
    div.id = `${idPrefix}-${key}`;
    div.classList.add(`${idPrefix}-div`);
    renderFn(div, key, level);
    fragment.appendChild(div);
  }

  const marker = document.createElement('div');
  marker.id = markerId;
  marker.style.display = 'none';
  fragment.appendChild(marker);

  // Insert before next top-level element (or end)
  let nextSibling = triggerDiv.nextElementSibling;

  parent.insertBefore(fragment, nextSibling);

  // Update visual state
  arrow?.classList.remove('collapsed');
  triggerDiv.classList.add('open');
}

function fillFolderRow(folderRow, text, depth) {
  folderRow.className = 'history-row folder-row'; // mark as collapsed initially
  folderRow.style.paddingLeft = `${depth * 2}rem`;
  folderRow.style.display = 'inline-flex';
  folderRow.style.alignItems = 'center';

  const svg = `<svg class="svg-arrow collapsed" style="margin-left: 2rem;margin-right: 1rem;" width="20.593" height="22.88" fill="2255ff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 66.91">
                <g><path fill="#2255ff" d="M11.68,1.95C8.95-0.7,4.6-0.64,1.95,2.08c-2.65,2.72-2.59,7.08,0.13,9.73l54.79,53.13l4.8-4.93l-4.8,4.95 c2.74,2.65,7.1,2.58,9.75-0.15c0.08-0.08,0.15-0.16,0.22-0.24l53.95-52.76c2.73-2.65,2.79-7.01,0.14-9.73 c-2.65-2.72-7.01-2.79-9.73-0.13L61.65,50.41L11.68,1.95L11.68,1.95z"/></g>
              </svg>`;
  folderRow.innerHTML = svg;

  const folderName = document.createElement('div');
  folderName.style.display = 'flex';
  folderName.style.cssText = 'text-indent: 0 !important;';
  const folderNameSpan = document.createElement('span');
  folderNameSpan.innerHTML = text;

  const tagsDiv = document.createElement('div');
  tagsDiv.id = `tagsDiv-${folderRow.id}`;
  tagsDiv.style.marginRight = '5rem';
  tagsDiv.style.marginLeft = '1rem';

  folderName.appendChild(folderNameSpan);
  folderRow.appendChild(folderName);
  folderRow.appendChild(tagsDiv);
}

function displayReportDetails(reports, containerDiv, depth = 4, path = '') {
  // Clear old entries
  const markerId = `${containerDiv.id}-report-detail-marker`;
  const parent = containerDiv.parentNode;
  const existingMarker = document.getElementById(markerId);
  const arrow = containerDiv.querySelector('.svg-arrow');
  arrow?.classList.add('collapsed');

  if (existingMarker) {
    let next = containerDiv.nextElementSibling;
    while (next && next !== existingMarker) {
      const toRemove = next;
      next = next.nextElementSibling;
      parent.removeChild(toRemove);
    }
    parent.removeChild(existingMarker);
    return;
  }

  const fragment = document.createDocumentFragment();
  for (const child of reports) {
    let childPath = child.filename;
    let childFileName = childPath.split('/').pop();
    let isSubmission = false;
    let reportId = child.report_id;

    if (child.report_submission_name) {
      childFileName = child.report_submission_name;
      childPath = child.report_submission_name;
      isSubmission = true;
      reportId = child.submission_id;
    }

    const childRow = document.createElement('div');
    childRow.className = 'history-row file-row';
    childRow.id = `childRow-${path}/${childPath}`;
    childRow.style.paddingLeft = `${(depth + 1) * 2}rem`;
    childRow.style.justifyContent = 'space-between';
    childRow.style.alignItems = 'center';
    childRow.style.paddingRight = '5rem';

    const fileNameDiv = document.createElement('div');
    fileNameDiv.textContent = childFileName;

    const tagsDiv = document.createElement('div');
    tagsDiv.style.marginRight = '5rem';
    tagsDiv.style.marginLeft = '1rem';
    tagsDiv.style.textIndent = 0;

    const statusMatch = statusMapping(child.status);
    if (!isSubmission) {
      const statusTag = createColReport('');
      if (statusMatch.status === 'Deleted') {
        childRow.style.textDecoration = 'line-through';
      }

      const dot = document.createElement('span');
      dot.style.width = '0.8em';
      dot.style.height = '0.8em';
      dot.style.borderRadius = '50%';
      dot.style.background = statusMatch.color;
      dot.style.marginRight = '0.6rem';

      const text = document.createElement('span');
      text.textContent = `${statusMatch.status}`;

      statusTag.appendChild(dot);
      statusTag.appendChild(text);
      statusTag.style.cursor = 'pointer';
      statusTag.onclick = () => {
        if (activeStatus === status[0]) {
          filterReportHistory();
          activeStatus = '';
        } else {
          filterReportHistory(status[0]);
          activeStatus = status[0];
        }
      };

      let title = statusMatch.description;
      if (child.position != null) {
        title += `\nPosition in queue: ${child.position}`;
      }
      title += `\nLast updated: ${new Date(child.updated_at).toLocaleString('DE')}`;
      statusTag.title = title;

      statusTag.style.padding = '0.4rem 1rem';
      statusTag.style.justifyContent = 'center';
      statusTag.style.display = 'flex';
      statusTag.style.alignItems = 'center';
      statusTag.style.borderRadius = '1rem';

      tagsDiv.appendChild(statusTag);
    }

    const icons = document.createElement('div');
    icons.style.display = 'flex';

    if (statusMatch.position >= 3 && !isSubmission) {
      icons.appendChild(addOpenIconExtracted(reportId));
    }

    icons.appendChild(addOpenIconReport(childFileName, childPath, isSubmission, reportId));
    icons.appendChild(addDownloadIcon(childFileName, childPath, isSubmission, reportId));

    if (window.userPermissions['sharereport'] === true) {
      icons.appendChild(addShareCol(childFileName, childPath, isSubmission, reportId));
    }

    if (window.userPermissions['deletereport'] === true) {
      icons.appendChild(child.can_delete ? addTrashIcon(childFileName, child) : emptyCol());
    }

    let icon;
    if (child.can_submit) {
      icon = sendReportIcon(childFileName, childPath, window.userPermissions['filereport'], child.no_submit_reason);
      if (child.no_submit_reason) {
        icon.title = child.no_submit_reason;
        icon.style.opacity = '0.5';
        icon.onclick = () => {
          showMessage(child.no_submit_reason, false);
        };
      }
    } else {
      icon = emptyCol();
    }

    icons.appendChild(icon);

    childRow.appendChild(fileNameDiv);
    childRow.appendChild(tagsDiv);
    childRow.appendChild(icons);

    fragment.appendChild(childRow);
  }
  const marker = document.createElement('div');
  marker.id = markerId;
  marker.style.display = 'none';
  fragment.appendChild(marker);

  // then insert
  parent.insertBefore(fragment, containerDiv.nextSibling);

  // finally toggle arrow open
  arrow?.classList.remove('collapsed');
  containerDiv.classList.add('open');

  // Always insert immediately after the clicked row:
  parent.insertBefore(fragment, containerDiv.nextSibling);
}




function showReportUpdateNew(report) {
  folders = [report['company'], report['country'], report['report_type'], report['year']];
  if (report['timeframe'] != '') {
    folders.push(report['timeframe']);
  }
  folders.push(report['filename']);
  id_key = '';
  for (let index = 0; index < folders.length; index++) {
    const folder = folders[index];
    id_key += '/' + folder;
    const fileRow = document.getElementById(`fileRow-${id_key}`);
    const folderRow = document.getElementById(`folderRow-${id_key}`);
    if (!fileRow && !folderRow) {
      console.log('fileRow or folderRow not found', id_key); // TODO show button to refresh
      continue;
    }
    
    const tagsDiv = document.getElementById(`tagsDiv-${id_key}`);
    let hasSiblings = false;
    if (folderRow) {
      hasSiblings = countFileRowSiblings(folderRow) > 0;
    }
    if (tagsDiv.querySelector('.newTag') == null && (index == folders.length - 1 || index == 0 || hasSiblings)) {
      tagsDiv.appendChild(addNewTag());
    }
  }
}

function countFileRowSiblings(element) {
  let count = 0;

  // Check previous siblings
  let prev = element.previousElementSibling;
  while (prev) {
    if (prev.classList.contains('folder-row')) count++;
    prev = prev.previousElementSibling;
  }

  // Check next siblings
  let next = element.nextElementSibling;
  while (next) {
    if (next.classList.contains('folder-row')) count++;
    next = next.nextElementSibling;
  }

  return count;
}

var activeStatus = '';

function updateReportStatusOverview(status_overview) {
  const reportStatusContainer = document.getElementById('reportStatusContainer');
  reportStatusContainer.style.display = 'flex';
  const reportStatus = document.getElementById('reportStatus');
  reportStatus.style.display = 'flex';
  reportStatus.innerHTML = '';

  const statusCountsSorted = Object.entries(status_overview).sort(
        (a, b) => statusMapping(a[0]).position - statusMapping(b[0]).position);
  for (let status of statusCountsSorted) {
    if (status[0] == 'deferred') {
      continue;
    }
    const col = document.createElement('div');
    const statusMatch = statusMapping(status[0]);
  
    // Create the dot
    const dot = document.createElement('span');
    dot.style.width = '0.8em';
    dot.style.height = '0.8em';
    dot.style.borderRadius = '50%';
    dot.style.background = statusMatch.color;
    dot.style.marginRight = '0.6rem';
  
    // Create the text span
    const text = document.createElement('span');
    text.textContent = `${statusMatch.status}: ${status[1]}`;
  
    // Compose the full container
    col.appendChild(dot);
    col.appendChild(text);
  
    col.style.cursor = 'pointer';
    col.title = `${statusMatch.description} (${status[1]} reports)`;
    col.onclick = function () {
      if (activeStatus === status[0]) {
        filterReportHistory();
        activeStatus = '';
      } else {
        filterReportHistory(status[0]);
        activeStatus = status[0];
      }
    };
  
    // Styling the container
    col.style.margin = 0;
    col.style.display = 'flex';
    col.style.alignItems = 'center';
    col.style.borderRadius = '1rem';
  
    reportStatus.appendChild(col);
  }
}

function createOverview(data, init) {
    const configDiv = document.getElementById("reportshistory");

    var possibleCountries = new Set();
    var possibleReportTypes = new Set();
    var possiblePeriods = new Set(); // TODO
    var possibleReceipts = new Set(['My Reports', 'New Reports', 'Receipts Only', 'Reports Only']);
    if (Object.keys(data).length == 0) {
      configDiv.innerHTML = 'No reports found';
      configDiv.classList.add('no-reports-found');
      return;
    } else {
      configDiv.classList.remove('no-reports-found');
    }
    console.log(data);
    for (let company of Object.keys(data)) {
      for (let country of Object.keys(data[company])) {
        possibleCountries.add(country);
        for (let reportType of Object.keys(data[company][country])) {
          possibleReportTypes.add(reportType);
        }
      }
    }
    possibleCountries = Array.from(possibleCountries).sort();
    possibleReportTypes = Array.from(possibleReportTypes).sort();
    possiblePeriods = Array.from(possiblePeriods).sort();
    fillDropdowns('countryDropdown', possibleCountries, 'countries');
    fillDropdowns('reporttypeDropdown', possibleReportTypes, 'report_types');
    fillDropdowns('periodDropdown', possiblePeriods, 'reporting_periods');
    fillDropdowns('receiptsDropdown', possibleReceipts, 'receipt_only');
    if (init) {
      document.getElementById('receiptsDropdown').value = 'My Reports';
      $('.selectpicker').selectpicker('refresh');
    }
}

function debounce(func, delay) {  // only update when user stops typing
  let timeoutId;
  return function (...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func.apply(this, args), delay);
  };
}

function runFilter() {
  filterReportHistory();
  filterReportHistory();
}

// Attach debounced listener
const debouncedFilter = debounce(runFilter, 400);  // 400ms after user stops typing


document.getElementById("companySearch").addEventListener("input", debouncedFilter);

function normalizeString(str) {
  return str.toLowerCase().trim().replaceAll('_', ' ').replaceAll('.', ' ').replaceAll(',', ' ').replaceAll('/', ' ');
}

var filteredData = [];
function filterReportHistory(status = '', updateTree = true, init = false) {
  const searchQuery = document.getElementById("companySearch").value;
  const searchQueryNormalized = normalizeString(searchQuery);
  const countriesSelected = Array
        .from(document.getElementById('countryDropdown').options)
        .filter(option => option.selected)
        .map(option => option.value);
  const reportTypesSelected = Array
        .from(document.getElementById('reporttypeDropdown').options)
        .filter(option => option.selected)
        .map(option => option.value);
  const periodsSelected = Array
        .from(document.getElementById('periodDropdown').options)
        .filter(option => option.selected)
        .map(option => option.value);
  const receiptsSelected = Array
        .from(document.getElementById('receiptsDropdown').options)
        .filter(option => option.selected)
        .map(option => option.value);
  filteredData = allReports.filter(file => {
    if (countriesSelected.length > 0 && !countriesSelected.includes(file['country'])) {
      console.log('country not selected', file['country']);
      return false;
    }
    if (reportTypesSelected.length > 0 && !reportTypesSelected.includes(file['report_type'])) {
      console.log('report type not selected', file['report_type']);
      return false;
    }
    timeframeYear = file['timeframe'] != '' ? `${file['timeframe']} ${file['year']}` : `${file['year']}`;
    if (periodsSelected.length > 0 && !periodsSelected.includes(timeframeYear)) {
      console.log('period not selected', timeframeYear);
      return false;
    }
    if (status != '' && file['status'] != status) {
      console.log('status not selected', file['status']);
      return false;
    }
    if (receiptsSelected.length > 0) {
      if (receiptsSelected.includes('My Reports') && file['my_reports'] == false) {
        console.log('mine not selected', file['my_reports']);
        return false;
      }
      if (receiptsSelected.includes('New Reports') && file['new'] == false) {
        console.log('new not selected', file['new']);
        return false;
      }
      if (receiptsSelected.includes('Receipts Only') && file['receipt'] == false) {
        console.log('receipts not selected', file['receipt']);
        return false;
      }
      if (receiptsSelected.includes('Reports Only') && file['receipt'] == true) {
        console.log('reports not selected', file['receipt']);
        return false;
      }
    }
    field_to_search = ['company', 'country', 'brand', 'report_type', 'pro', 'timeframe', 'year', 'filename', 'updated_at'];
    for (let field of field_to_search) {
      if (normalizeString(`${file[field]}`).includes(searchQueryNormalized)) {
        return true;
      }
    }
    if (normalizeString(`${file['timeframe']} ${file['year']}`).includes(searchQueryNormalized)) {
      return true;
    }
    if (formatDate(file['updated_at']).dot.includes(searchQueryNormalized)) {
      return true;
    }
    if (formatDate(file['updated_at']).slash.includes(searchQueryNormalized)) {
      return true;
    }
    {% comment %} if (searchQueryNormalized == 'today') {
      const today = new Date();
      const todayString = today.toISOString().split('T')[0];
      if (file['updated_at'].includes(todayString)) {
        return true;
      }
    } {% endcomment %}
    if (matchesSearchQuery(file, searchQueryNormalized)) {
      return true;
    }
    return false;
  });
  filteredData.sort((a, b) => {
    return a['company'].localeCompare(b['company']);
  });
  {% comment %} updateReportStatusOverview(filteredData); {% endcomment %}
  if (updateTree) {
    createOverview(filteredData, init);
  }
}

function formatDate(date) {
  const dObj = new Date(date);
  const day = String(dObj.getDate()).padStart(2, '0');
  const month = String(dObj.getMonth() + 1).padStart(2, '0'); // months are 0-based
  const year = dObj.getFullYear();

  return {
    dot: `${day}.${month}.${year}`,
    slash: `${day}/${month}/${year}`
  };
}

function matchesSearchQuery(file, searchQueryNormalized) {
  const updatedAt = file['updated_at']; // ISO string
  const updatedDate = new Date(updatedAt);
  const today = new Date();

  // Helper to get midnight and end-of-day
  const startOfDay = (d) => new Date(d.setHours(0, 0, 0, 0));
  const endOfDay = (d) => new Date(d.setHours(23, 59, 59, 999));

  switch (searchQueryNormalized) {
    case 'today': {
      const start = startOfDay(new Date(today));
      const end = endOfDay(new Date(today));
      return updatedDate >= start && updatedDate <= end;
    }

    case 'yesterday': {
      const d = new Date(today);
      d.setDate(d.getDate() - 1);
      const start = startOfDay(new Date(d));
      const end = endOfDay(new Date(d));
      return updatedDate >= start && updatedDate <= end;
    }

    case 'this week': {
      const start = new Date(today);
      const day = start.getDay(); // 0 (Sun) to 6 (Sat)
      const diffToMonday = (day + 6) % 7; // if Monday = 0
      start.setDate(today.getDate() - diffToMonday);
      const end = new Date(); // today
      return updatedDate >= startOfDay(start) && updatedDate <= endOfDay(end);
    }

    case 'last week': {
      const start = new Date(today);
      const day = start.getDay();
      const diffToLastMonday = (day + 6) % 7 + 7;
      start.setDate(today.getDate() - diffToLastMonday);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      return updatedDate >= startOfDay(start) && updatedDate <= endOfDay(end);
    }

    case 'this month': {
      const start = new Date(today.getFullYear(), today.getMonth(), 1);
      const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      return updatedDate >= startOfDay(start) && updatedDate <= endOfDay(end);
    }

    case 'last month': {
      const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      const end = new Date(today.getFullYear(), today.getMonth(), 0);
      return updatedDate >= startOfDay(start) && updatedDate <= endOfDay(end);
    }

    default:
      return false;
  }
}


function fillDropdowns(dropdownId, entries, key) {
    const dropdown = document.getElementById(dropdownId);
    const selected = Array
        .from(dropdown.options)
        .filter(option => option.selected)
        .map(option => option.value);
    dropdown.innerHTML = "";

    [...entries].sort().forEach(entry => {
        const option = document.createElement("option");
        option.value = entry;
        option.textContent = entry;
        if (selected.includes(entry)) {
            option.selected = true;
        }
        dropdown.appendChild(option);
    });
    $(`#${dropdownId}`).selectpicker('refresh');
    let selectedOptions = $(`#${dropdownId}`).find('option:selected');
    let displayText = selectedOptions.map(function() {
        return $(this).text(); // or $(this).val() if you want to display the value
    }).get().join(', ');
    // Check if there is any selection, otherwise set to default text
    displayText = displayText.length > 0 ? displayText : 'Nothing selected';

    // Update the display text
    $(`#${dropdownId}`).closest('.filter-group').find('.filter-option-inner-inner').text(displayText);
}
document.getElementById('countryDropdown').addEventListener('change', function() {
  filterReportHistory(); // do it twice, first we reset the filters, then we apply them
  filterReportHistory();
});

document.getElementById('reporttypeDropdown').addEventListener('change', function() {
  filterReportHistory(); // do it twice, first we reset the filters, then we apply them
  filterReportHistory();
});

document.getElementById('periodDropdown').addEventListener('change', function() {
  filterReportHistory(); // do it twice, first we reset the filters, then we apply them
  filterReportHistory();
});

document.getElementById('receiptsDropdown').addEventListener('change', function() {
  filterReportHistory(); // do it twice, first we reset the filters, then we apply them
  filterReportHistory();
});

document.getElementById('downloadAllReports').addEventListener('click', async function() {
  try {
    var downloadData = filteredData.map(file => {
      if (file['report_id'] != null) {
        return {
          'filepath': file['filename'],
          'report_id': file['report_id'],
          'type': 'report'
        }
      } else if (file['submission_id'] != null) {
        return {
          'filepath': file['report_submission_name'],
          'report_id': file['submission_id'],
          'type': 'submission'
        }
      }
    });
    this.style.cursor = 'not-allowed';
    this.title = 'In Progress, this can take 1-2mins, please wait';
    const data = await unifiedSendRequest(GETREPORTSDOWNLOADALL, {method: 'POST', formData: JSON.stringify(downloadData), 
                                          headerArgs: {'Content-Type': 'application/json'}});
    this.style.cursor = 'pointer';
    this.title = '';
  } catch (error) {
    console.error(error.message);
    TOKEN = false;
  }
});


function hideImageModal() {
    document.getElementById('imageModal').style.display = 'none';
    document.getElementById('modalOverlayImage').style.display = 'none';
}

function hideExcelModal() {
    document.getElementById('excelModal').style.display = 'none';
    document.getElementById('modalOverlayExcel').style.display = 'none';
}

function hidePdfModal() {
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('modalOverlayPdf').style.display = 'none';
}

document.getElementById('modalOverlayImage').addEventListener('click', hideImageModal);
document.getElementById('closeModal').addEventListener('click', hideImageModal);

document.getElementById('closeExcelModal').addEventListener('click', hideExcelModal);
document.getElementById('modalOverlayExcel').addEventListener('click', hideExcelModal);

document.getElementById('closePdfModal').addEventListener('click', hidePdfModal);
document.getElementById('modalOverlayPdf').addEventListener('click', hidePdfModal);




function showGuide() {
    startGuide([
        { element: "main", group: "{{ 'software.guide.history.welcome.group' | t }}", title: "{{ 'software.guide.history.welcome.title' | t }}", text: "{{ 'software.guide.history.welcome.text' | t }}", where: 'middle' },
        { element: "#filterContainer", group: "{{ 'software.guide.history.filters.group' | t }}", title: "{{ 'software.guide.history.filters.title' | t }}", text: "{{ 'software.guide.history.filters.text' | t }}", where: 'below' },
        { element: "#receiptsContainer", group: "{{ 'software.guide.history.receipts.group' | t }}", title: "{{ 'software.guide.history.receipts.title' | t }}", text: "{{ 'software.guide.history.receipts.text' | t }}", where: 'below' },
        { element: "#searchContainer", group: "{{ 'software.guide.history.search.group' | t }}", title: "{{ 'software.guide.history.search.title' | t }}", text: "{{ 'software.guide.history.search.text' | t }}", where: 'below' },
        { element: "#allIconsContainer", group: "{{ 'software.guide.history.download.group' | t }}", title: "{{ 'software.guide.history.download.title' | t }}", text: "{{ 'software.guide.history.download.text' | t }}", where: 'left'}
    ]);
    setCookie('showedGuideHistory', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
}

function showGuideUpdates() {
  startGuide([
    { element: "#filterContainer", group: "{{ 'software.guide.historyUpdates.filters.group' | t }}", title: "{{ 'software.guide.historyUpdates.filters.title' | t }}", text: "{{ 'software.guide.historyUpdates.filters.text' | t }}", where: 'below' },
    { element: "#receiptsContainer", group: "{{ 'software.guide.historyUpdates.receipts.group' | t }}", title: "{{ 'software.guide.historyUpdates.receipts.title' | t }}", text: "{{ 'software.guide.historyUpdates.receipts.text' | t }}", where: 'below' },
    { element: "#searchContainer", group: "{{ 'software.guide.historyUpdates.search.group' | t }}", title: "{{ 'software.guide.historyUpdates.search.title' | t }}", text: "{{ 'software.guide.historyUpdates.search.text' | t }}", where: 'below' },
    { element: "#reportStatus", group: "{{ 'software.guide.historyUpdates.status.group' | t }}", title: "{{ 'software.guide.historyUpdates.status.title' | t }}", text: "{{ 'software.guide.historyUpdates.status.text' | t }}", where: 'below' },
  ]);
  setCookie('showedGuideHistoryUpdates', 'true', 300);
}

async function startPage() {
  if (window.userPermissions['forsure-downloads'] === true) {
    document.getElementById('reportcontainer').style.display = 'block';
    checkHistoryVersion();
    await getReports();
    getReportsAll();  // dont wait for it, it will update the tree when user selects a different filter
    setInterval(getReportUpdates, 10000); // check for updates every 10 seconds

    if(readCookie('showedGuideHistory') === null) {
        setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    } else if (readCookie('showedGuideHistoryUpdates') === null) {
      setTimeout(showGuideUpdates, 1000);
    }

  }
}

waitForPermission(function() {
  startPage();
});


  </script>
{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_download_new.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_download.settings.desktop_image_width.label",
        "info": "t:sections.forsure_download.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_download.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_download.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_download.settings.layout.label",
        "info": "t:sections.forsure_download.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_download.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_download.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "image_picker",
        "id": "send_report",
        "label": "Send Report"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_download_new.presets.name"
      }
    ]
  }
{% endschema %}