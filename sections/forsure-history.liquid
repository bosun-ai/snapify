{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}


{%- style -%}
  .tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
    z-index: 1000;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }
  td {
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    margin-left: 10px;
    cursor: pointer;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 2rem;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info,
  .open,
  .download,
  .share,
  .send {
    cursor: pointer;
  }

  /* Overlay style */
  #overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Black with 50% opacity */
    z-index: 2; /* Displayed behind the modal */
  }

  /* Modal style */
  #report-table {
    /* display: none; */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the modal */
    padding: 20px;
    background-color: #fff;
    z-index: 2; /* Displayed in front of the overlay */
    width: 80%; /* Adjust width as needed */
    max-width: 80%; /* Adjust max width as needed */
    /* overflow-y: auto; /* Make it scrollable if the content is too big */
    */ border-radius: 8px; /* Rounded corners */
  }

.table-header-title {
  overflow: hidden;
  transition: max-height 0.5s ease-out;
}
.table-header-title-hidden {
  max-height: 0;
  overflow: hidden;
}
.svg-arrow {
  transform: rotate(360deg);
  transition: transform 0.3s ease; /* Smooth transition for rotation */
}

.collapsed {
  transform: rotate(270deg); /* Rotate arrow 90 degrees when collapsed */
}

tr {
  border-top: 0.2rem solid #17161c !important;
}

.tabulator-page.active {
    color: #2255FF!important;
  }


  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 100;
}

.modal-content {
    position: absolute;
    border-radius: 25px;
    border-width: 0.2rem;
    border-style: solid;
    border-color: #17161c;
    width: 90%;
    max-width: 450px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.modalContainer {
  border-radius: 3rem;
  overflow: hidden;
}

.tooltipSave {
  position: absolute;
  background-color: #555;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 8px 0;
  z-index: 1;
  top: 30%;
  left: 50%;
  margin-left: -60px;
  transform: translate(-50%, -50%);
  transition: opacity 0.3s;
}
  .tabulator-row {
    cursor: default!important;
  }
  .tabulator-group-toggle {
    cursor: pointer!important;
  }
.tabulator-arrow {
    display: block!important;
}

.history-row {
    border-top: 0.2rem solid #17161c; /* Full-width border for each row */
    padding: 2rem 0; /* Vertical padding for spacing */
    width: 100%; /* Ensure the row spans the full container width */
  }

  .folder-row {
    font-weight: bold; /* Highlight folders */
    padding-left: 0; /* Ensure full-width borders */
    text-indent: 2rem; /* Indent text instead of moving the entire row */
    cursor: pointer;
  }

  .file-row {
    padding-left: 0; /* Ensure full-width borders */
    text-indent: 4rem; /* Further indent text for files */
    display: flex;
  }

  #tabs-container {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 1rem;
        overflow-x: auto; /* Handle large numbers of tabs */
    }

    .tab-button {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-bottom: none;
        background-color: #f9f9f9;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
        margin-right: 5px;
        border-radius: 8px 8px 0 0;
        flex: 0 0 auto;
    }

    .tab-button:hover {
        background-color: #eaeaea;
    }

    .tab-button.active {
        border-bottom: 2px solid #fff;
        font-weight: bold;
        color: #fafafa;
    }

    #report-table-data-excel {
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }

    .filter-group {
      margin: auto;
    }
    .dropdown {
      margin-left: 0!important;
      width: 15rem!important;
    }
    .glyphicon-ok:before {
      content: "\2713";
    }


    /* Loading spinner */
    #loadingSpinner, #loadingSpinnerCalendar {
        border: 4px solid rgba(34, 85, 255, 0.1);
        border-top: 4px solid #2255ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: auto;
        display: flex;
    }
    #loadingSpinnerContainer, #loadingSpinnerCalendarContainer {
        position: absolute;
        top: 60%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .all-icons {
      margin: auto;
    }
    #downloadAllReports {
      cursor: pointer;
    }

.folderArrow svg {
  width: 30px!important;
  height: 30px!important;
}

.emptyCol {
  display: block!important;
  width: 60px;
}
{%- endstyle -%}
{% if customer.tags contains 'member' %}

<div id="newUploadHistory" style="display: none;min-height: 100vh;padding-bottom: 5rem;">

  <!-- Load d3.js -->
  <!-- <script src="https://d3js.org/d3.v4.js"></script> --><script src="https://cdn.jsdelivr.net/npm/d3@7"> </script>
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  <script src="{{ 'forsure-endpoints.js' | asset_url }}"></script>
  <script src="{{ 'forsure-data-loader.js' | asset_url }}"></script>
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>


  {{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>-->
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" />
  {% render 'forsure-simple-notification' %}
  <div id="tooltipWarn" class="tooltip" style="display: none;">Tooltip content</div>
  <div id='tooltip' class="tooltipSave"></div>
  <div class="configbox page-width border" style="padding: 0;border-radius:1rem">
    <div>
      <div style="display: flex;background-color: #fafafa;position: relative;border-radius: 1rem;" id="filterContainer">
          <h2 class="flex-header" style="margin-left: 2rem">
            <span id="historyheader" class="table-header" style="cursor: default">
              Report History
            </span>
          </h2>
          <div class="filter-group" id="profile-filter-guide" style="margin-left: 4rem">
            <div class="filter-group-heading">Country</div>
            <select
              id="countryDropdown"
              class="selectpicker"
              multiple
              data-live-search="true"></select>
          </div>
          <div class="filter-group">
            <div class="filter-group-heading">Report Type</div>
            <select
              id="reporttypeDropdown"
              class="selectpicker"
              multiple
              data-live-search="true"></select>
          </div>
          <div class="filter-group">
            <div class="filter-group-heading">Reporting Period</div>
            <select
              id="periodDropdown"
              class="selectpicker"
              multiple
              data-live-search="true"></select>
          </div>
          <div class="filter-group" id="receiptsContainer" style="background-color: #fafafa;position: relative;">
            <div class="filter-group-heading">Receipts only</div>
            <select
              id="receiptsDropdown"
              class="selectpicker"
              data-live-search="true"></select>
          </div>
          <div class="filter-group" id="searchContainer" style="background-color: #fafafa;position: relative;">
            <div class="filter-group-heading" style="width: 12rem">Search</div>
            <input type="text" id="companySearch" class="form-control" placeholder="Search"  style="width: 12rem"/>
        </div>
          <span class="all-icons" style="margin-right: 3rem;background-color: #fafafa;position: relative;padding: 1rem;" id="allIconsContainer">
            <!-- <i id="filter" class="icon-1"><img width="20px" src="{{ section.settings.filter | image_url }}" alt="{{ section.settings.filter.alt | escape }}" loading="lazy"></i> -->
            <i id="downloadAllReports" class="icon-2" style="background-color: #fafafa;position: relative;"><img
                width="30px"
                src="{{ section.settings.download | image_url }}"
                alt="{{ section.settings.download.alt | escape }}"
                loading="lazy"></i>
          </span>
      </div>
      <div id="reportshistory" class="table-header-title" style="min-height: 65px"></div>
    </div>
  </div>
  <div id="imageModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:100; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2);">
    <span id="closeModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
    <img id="modalImage" src="" alt="Image Preview" style="max-width:100%; max-height:80vh; display:block; margin:0 auto;">
</div>
<div id="modalOverlayImage" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;"></div>

<div id="excelModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:100;">
    <div id="tabs-container" style="display: flex; margin-bottom: 1rem; border-bottom: 1px solid #ddd;"></div>
    <div id="report-table-data-excel"></div>
    <span id="closeExcelModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
    <button class="button" id="send-report" style="margin-top: 1rem;margin-left: auto;">File report</button>
</div>
<div id="modalOverlayExcel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;"></div>

<div id="validateModal" class="modal isolate" style="display: none;">
  <div class="modal-content modalContainer" style="background: #fafafa;">
        <div id="title" style="background: #2255ff; padding: 2rem">
           <h2 style="color:#fafafa;text-align:center;">Are you sure?</h2>
         </div>
     <div class="rich-text__wrapper modal-content-text rich-text__wrapper--center page-width">
       <div class="rich-text__blocks center"><div class="rich-text__text textblock rte" style="color: #17161c; width: 88%; margin: 0 auto;margin-top:4rem;text-align: justify;text-align-last: left;">
         Make sure you double check the data before continuing.
         <br>
         <p style="color:#a80000;padding: 2rem 0;text-align: justify;text-align-last: left;">Important: After you press send, the report data will be automatically sent to the corresponding institution.</p>
       </div>
         <div style="margin-top: 0;margin-bottom: 2rem;">
           <button class="button" style="background-color: #17161c;margin-right: 2rem;" onclick="closeModal()">Close</button>
           <button class="button" id="validated-report-send">File Report</button>
         </div>
       </div>
     </div>
   </div>
 </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf_viewer.min.css" />
<div id="pdfModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:1000;">
    <canvas id="pdfCanvas" style="border: 1px solid #ddd; margin: 0 auto; display: block;"></canvas>
    <div style="text-align: center; margin-top: 10px;">
        <button id="prevPage">Previous Page</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next Page</button>
    </div>
    <span id="closePdfModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:20px;">&times;</span>
</div>
<div id="modalOverlayPdf" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:999;"></div>


  {% render 'forsure-login' %}
  <script>
async function checkHistoryVersion() {
    try {
        {% comment %} let data = await unifiedSendRequest(GETREPORTHISTORYVERSION, {method: 'GET'});
        {% endcomment %}
        document.getElementById('newUploadHistory').style.display = 'block';

        {% comment %} if (data) {
            document.getElementById('newUploadHistory').style.display = 'block';
            {% comment %} document.getElementById('classicalHistory').style.display = 'none'; {% endcomment %}
        } else {
            document.getElementById('newUploadHistory').style.display = 'none';
            document.getElementById('classicalHistory').style.display = 'block';
        } {% endcomment %}
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get history ' + error.message, false);
    }
}
checkHistoryVersion();

function extractBaseFilename(filename) {
  const parts = filename.split('/');
  const fullName = parts[parts.length - 1];

  // Remove known prefixes
  const base = fullName.replace(/^(Debugger_|Excluded_data_|Audit_Trail_)/, '');
  return base;
}

function buildHierarchy(paths) {
  const hierarchy = {};

  const groupMap = {}; // baseFilename -> array of file entries

  paths.forEach(file => {
    const path = file['filename'];
    const parts = path.split('/');
    const baseName = extractBaseFilename(path);

    const key = parts.slice(0, -1).join('/') + '/' + baseName;
    if (!groupMap[key]) groupMap[key] = [];
    groupMap[key].push(file);
  });

  Object.entries(groupMap).forEach(([basePath, groupFiles]) => {
    const baseParts = basePath.split('/');
    let currentLevel = hierarchy;

    baseParts.forEach((part, index) => {
      if (index === baseParts.length - 1) {
        if (!Array.isArray(currentLevel.files)) currentLevel.files = [];
        currentLevel.files.push({
          type: 'group',
          part: part,
          children: groupFiles,
        });
      } else {
        if (!currentLevel[part]) currentLevel[part] = {};
        currentLevel = currentLevel[part];
      }
    });
  });

  return hierarchy;
}

function createFolderStructure(configDiv, hierarchy, accessControl, currentPath = '') {
  configDiv.innerHTML = ''; // Clear existing content

  // Recursive function to create the structure
  function renderLevel(level, parentElement, path, depth = 0) {
    Object.keys(level).forEach(key => {
      if (key === 'files') {
        // Render files
        level[key].forEach(file => {
          if (file.type === 'group' && file.children.length > 1) {
            // Grouped file rendering
            const fileRow = document.createElement('div');
            fileRow.className = 'history-row folder-row';
            fileRow.style.paddingLeft = `${(depth + 1) * 2}rem`;
            fileRow.style.display = 'inline-flex';
      
            const arrowSvg = `<svg class="svg-arrow collapsed" style="margin-right: 1rem; vertical-align: middle;" width="20.593" height="22.88" version="1.1" fill="2255ff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 66.91"><g><path fill="#2255ff" d="M11.68,1.95C8.95-0.7,4.6-0.64,1.95,2.08c-2.65,2.72-2.59,7.08,0.13,9.73l54.79,53.13l4.8-4.93l-4.8,4.95 c2.74,2.65,7.1,2.58,9.75-0.15c0.08-0.08,0.15-0.16,0.22-0.24l53.95-52.76c2.73-2.65,2.79-7.01,0.14-9.73 c-2.65-2.72-7.01-2.79-9.73-0.13L61.65,50.41L11.68,1.95L11.68,1.95z"/></g></svg>`;
            fileRow.innerHTML = `${arrowSvg}`;
            fileRow.style.cursor = 'pointer';

            const fileName = document.createElement('div');
            fileName.style.cssText = 'text-indent: 0 !important;';
            fileName.className = 'report-group';

            const fileNameSpan = document.createElement('span');
            fileNameSpan.innerHTML = file.part;
            fileName.appendChild(fileNameSpan);

            const tags = document.createElement('div');
            tags.style.marginRight = '5rem';
            tags.style.marginLeft = '1rem';
            tags.style.textIndent = 0;

            // Optional: tag style wrapper
            if (file.part.toLowerCase().includes('inprogress')) {
              const inprogressTag = createColReport(`<svg height="12px" fill="#fafafa" title="In Progress" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M32 0C14.3 0 0 14.3 0 32S14.3 64 32 64l0 11c0 42.4 16.9 83.1 46.9 113.1L146.7 256 78.9 323.9C48.9 353.9 32 394.6 32 437l0 11c-17.7 0-32 14.3-32 32s14.3 32 32 32l32 0 256 0 32 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l0-11c0-42.4-16.9-83.1-46.9-113.1L237.3 256l67.9-67.9c30-30 46.9-70.7 46.9-113.1l0-11c17.7 0 32-14.3 32-32s-14.3-32-32-32L320 0 64 0 32 0zM96 75l0-11 192 0 0 11c0 19-5.6 37.4-16 53L112 128c-10.3-15.6-16-34-16-53zm16 309c3.5-5.3 7.6-10.3 12.1-14.9L192 301.3l67.9 67.9c4.6 4.6 8.6 9.6 12.1 14.9L112 384z"/></svg>`);
              inprogressTag.style.background = '#2255ff';
              inprogressTag.style.margin = 0;
              inprogressTag.style.padding = '0.4rem 1rem';
              inprogressTag.style.justifyContent = 'center';
              inprogressTag.style.display = 'flex';
              inprogressTag.style.borderRadius = '1rem';
              inprogressTag.title = 'Inprogress';
              tags.appendChild(inprogressTag);
            }

            fileRow.appendChild(fileName); // ← Filename block
            fileRow.appendChild(tags);     // ← Tag rendered next to it, not inside

      
            const groupContainer = document.createElement('div');
            groupContainer.style.display = 'none';
      
            fileRow.addEventListener('click', () => {
              groupContainer.style.display = groupContainer.style.display === 'none' ? 'block' : 'none';
              fileRow.querySelector('.svg-arrow').classList.toggle('collapsed');
            });
      
            file.children.forEach(child => {
              const childPath = child.filename;
              const childFileName = childPath.split('/').pop();
              const childRow = document.createElement('div');
              childRow.className = 'history-row file-row';
              childRow.style.paddingLeft = `${(depth + 1) * 2}rem`;
              {% comment %} padding-left: 12rem;justify-content: space-between;align-items: center;padding-right: 5rem; {% endcomment %}
              childRow.style.justifyContent = 'space-between';
              childRow.style.alignItems = 'center';
              childRow.style.paddingRight = '5rem';
      
              const fileNameDiv = document.createElement('div');
              fileNameDiv.textContent = childFileName;
      
              const icons = document.createElement('div');
              icons.style.display = 'flex';
              icons.appendChild(addOpenIconReport(childFileName, childPath));
              icons.appendChild(addDownloadIcon(childFileName, childPath));
              if (accessControl.sharereport) {
                icons.appendChild(addShareCol(childFileName, childPath));
              }
              if (accessControl.deletereport) {
                icons.appendChild(child.can_delete ? addTrashIcon(childFileName) : emptyCol());
              }
              if (accessControl.filereport) {
                icons.appendChild(child.can_submit ? sendReportIcon(childFileName, childPath) : emptyCol());
              }
      
              childRow.appendChild(fileNameDiv);
              childRow.appendChild(icons);
              groupContainer.appendChild(childRow);
            });
      
            parentElement.appendChild(fileRow);
            parentElement.appendChild(groupContainer);
      
          } else {
            filename = file['part'];
            const fullPath = `${path}/${filename}`; // Construct full path
            const fileRow = document.createElement('div');
            fileRow.className = 'history-row file-row'; // Add CSS class for consistent styling
            fileRow.style.paddingLeft = `${depth * 2}rem`; // Offset based on depth

            //fileRow.textContent = filename;
            const fileNameDiv = document.createElement('div');
            fileNameDiv.textContent = filename;
            fileNameDiv.style.display = 'flex';

            const tags = document.createElement('div');
            tags.style.marginRight = '5rem';
            tags.style.marginLeft = '1rem';
            tags.style.textIndent = 0;
            if (file["inprogress"]) {
                const inprogressTag = createColReport(`<svg height="12px" fill="#fafafa" title="In Progress" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M32 0C14.3 0 0 14.3 0 32S14.3 64 32 64l0 11c0 42.4 16.9 83.1 46.9 113.1L146.7 256 78.9 323.9C48.9 353.9 32 394.6 32 437l0 11c-17.7 0-32 14.3-32 32s14.3 32 32 32l32 0 256 0 32 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l0-11c0-42.4-16.9-83.1-46.9-113.1L237.3 256l67.9-67.9c30-30 46.9-70.7 46.9-113.1l0-11c17.7 0 32-14.3 32-32s-14.3-32-32-32L320 0 64 0 32 0zM96 75l0-11 192 0 0 11c0 19-5.6 37.4-16 53L112 128c-10.3-15.6-16-34-16-53zm16 309c3.5-5.3 7.6-10.3 12.1-14.9L192 301.3l67.9 67.9c4.6 4.6 8.6 9.6 12.1 14.9L112 384z"/></svg>`);
                inprogressTag.style.background = '#2255ff';
                inprogressTag.style.margin = 0;
                inprogressTag.style.padding = '0.4rem 1rem';
                inprogressTag.style.justifyContent = 'center';
                inprogressTag.style.display = 'flex';
                inprogressTag.style.borderRadius = '1rem';
                inprogressTag.title = 'Inprogress';
                tags.appendChild(inprogressTag);
            }
            fileNameDiv.appendChild(tags);
            
            fileRow.style.justifyContent = 'space-between';
            fileRow.style.alignItems = 'center'; // Vertically center items          
            
            const icons = document.createElement('div');
            icons.style.marginRight = '5rem';
            icons.style.display = 'flex';
            // Add icons
            const openCol = addOpenIconReport(filename, fullPath);
            const downloadCol = addDownloadIcon(filename, fullPath);

            var shareCol = addShareCol(filename, fullPath);

            var trashCol = null;
            if (file["can_delete"]) {
                trashCol = addTrashIcon(filename);
            } else {
                trashCol = emptyCol();
            }
            var submitCol = null;
            if (file["can_submit"]) {
              submitCol = sendReportIcon(filename, fullPath);
            } else {
              submitCol = emptyCol();
            }
            {% comment %} var checkboxCol = addCheckboxCol(fullPath); {% endcomment %}
    
            icons.appendChild(openCol);
            icons.appendChild(downloadCol);
            icons.appendChild(shareCol);
            icons.appendChild(trashCol);
            icons.appendChild(submitCol);
            {% comment %} icons.appendChild(checkboxCol); {% endcomment %}
            fileRow.appendChild(fileNameDiv);
            fileRow.appendChild(icons);
            parentElement.appendChild(fileRow);
          }
        });
      } else {
        // Render folder
        const folderRow = document.createElement('div');
        folderRow.className = 'history-row folder-row'; // Add CSS class for consistent styling
        folderRow.style.paddingLeft = `${depth * 2}rem`; // Offset text for hierarchy

        // Add the SVG arrow
        const svg = `<svg class="svg-arrow collapsed" style="margin-right: 1rem; vertical-align: middle;" width="20.593" height="22.88" version="1.1" fill="2255ff" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 66.91" style="margin: auto;height: 100%;display: flex;width: 100%;" xml:space="preserve">
                        <g><path fill="#2255ff" d="M11.68,1.95C8.95-0.7,4.6-0.64,1.95,2.08c-2.65,2.72-2.59,7.08,0.13,9.73l54.79,53.13l4.8-4.93l-4.8,4.95 c2.74,2.65,7.1,2.58,9.75-0.15c0.08-0.08,0.15-0.16,0.22-0.24l53.95-52.76c2.73-2.65,2.79-7.01,0.14-9.73 c-2.65-2.72-7.01-2.79-9.73-0.13L61.65,50.41L11.68,1.95L11.68,1.95z"/></g>
                    </svg>`;

        folderRow.innerHTML = `${svg}<span>${key}</span>`;

        const folderContent = document.createElement('div');
        folderContent.style.display = 'none'; // Initially hidden

        // Add click event to toggle visibility and arrow direction
        folderRow.addEventListener('click', () => {
          folderContent.style.display = folderContent.style.display === 'none' ? 'block' : 'none';
          const arrow = folderRow.querySelector('.svg-arrow');
          arrow.classList.toggle('collapsed');
        });
        if (Object.keys(level).length === 1) {
            folderRow.click();
        }

        parentElement.appendChild(folderRow);
        parentElement.appendChild(folderContent);

        // Recurse into the next level
        renderLevel(level[key], folderContent, `${path}/${key}`, depth + 1);
      }
    });
  }

  renderLevel(hierarchy, configDiv, '', 0);
}


function createColReport(content, title = '', alignRight = false) {
    const col = document.createElement('div');
    col.innerHTML = content;
    return col;
}

function emptyCol() {
  const col = document.createElement('div');
  col.className = 'emptyCol';
  col.classList.add('file-row');
  return col;
}

function addOpenIconReport(fileName, fullPath) {
    const openCol = createColReport(
        '<i class="open"><img width="20px" src="{{ section.settings.open | image_url }}" alt="{{ section.settings.open.alt | escape }}" loading="lazy"></i>',
        'Open report'
    );
    openCol.addEventListener('click', async function() {
      await displayReport(fileName, fullPath, false);
    });
    return openCol;
}

async function displayReport(fileName, fullPath, submit) {
    try {
        document.body.style.cursor = 'wait';
        // Apply the 'wait' cursor to each element
        document.querySelectorAll('.folder-row').forEach(row => {
            row.style.cursor = 'wait';
        });
        const formData = new FormData();
        formData.append('filepath', fullPath);
        formData.append('display', true);

        const extension = fileName.split('.').pop().toLowerCase();
        if (extension === 'png' || extension === 'jpg' || extension === 'jpeg') {
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            // Open image in modal
            const imageUrl = URL.createObjectURL(blob);
            const modal = document.getElementById('imageModal');
            const modalOverlay = document.getElementById('modalOverlayImage');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageUrl;
            modal.style.display = 'block';
            modalOverlay.style.display = 'block';
        } else if (extension === 'xlsx' || extension === 'csv') {
            const data = await unifiedSendRequest(GETREPORTDETAILS, {method: 'POST', formData: formData});
            displayExcelReport(data, submit, fileName, fullPath);
        } else if (extension === 'pdf') {
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            const arrayBuffer = await blob.arrayBuffer();
            displayPdfInModal(new Uint8Array(arrayBuffer));
        }
        else {
            console.error('Filetype is not yet supported, please download it to look at the content');
            showMessage('Filetype is not yet supported, please download it to look at the content', false);
        }
        
    } catch (error) {
        console.error(error.message);
        showMessage('Failed to open report ' + error.message, false);
    }
    document.body.style.cursor = 'default';
    // Apply the 'wait' cursor to each element
    document.querySelectorAll('.folder-row').forEach(row => {
        row.style.cursor = 'pointer';
    });
}

// Download Icon
function addDownloadIcon(fileName, fullPath) {
    const downloadCol = createColReport(
        '<i class="download"><img width="20px" src="{{ section.settings.download | image_url }}" alt="{{ section.settings.download | image_url }}" loading="lazy"></i>',
        'Download report'
    );
    downloadCol.addEventListener('click', async () => {
        try {
            const formData = new FormData();
            formData.append('filepath', fullPath);
            const blob = await unifiedSendRequestBlob(GETREPORTDETAILS, {method: 'POST', formData: formData});
            const bloburl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = bloburl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(bloburl);
        } catch (error) {
            console.error(error.message);
            showMessage('Failed to download file ' + error.message, false);
        }
    });
    return downloadCol;
}


function sendReportIcon(fileName, fullPath) {
  const openCol = createColReport('<i class="send"><img width="20px" src="{{ section.settings.send_report | image_url }} " alt="{{ section.settings.send_report.alt | escape }}" loading="lazy"></i>', "Send report"); // Placeholder icon
  openCol.addEventListener('click', async function() {
    await displayReport(fileName, fullPath, true);
  });
  return openCol;
}


function addShareCol(fileName, fullPath) {
  const shareCol = createColReport('<i class="share"><img width="20px" src="                         {{ section.settings.share | image_url }} " alt="                         {{ section.settings.share.alt | escape }}" loading="lazy"></i>', "Share report"); // Placeholder icon
        shareCol.addEventListener('click', async function() {
          try {
            const reportData = new FormData();
            reportData.append("file_name", fileName);
            reportData.append("full_path", fullPath);
            const downloadData = await unifiedSendRequest(CREATEDOWNLOADLINK, {formData: reportData});
            const subject = encodeURIComponent("Here is the EPR report " + downloadData.reportname);
            const body = encodeURIComponent("\n\nHere is the link to download the report: " + server_url + downloadData.link + "\nUsername: " + downloadData.username + "\nPassword: " + downloadData.password + "\n\n");
            // Open the default mail client
            window.location.href = "mailto:?subject=" + subject + "&body=" + body;

          } catch (error) {
            console.error(error.message);
            TOKEN = false;
          }
        });
  return shareCol;
}

function addTrashIcon(fileName) {
  const trashcanCol = createColReport('<i class="trashcan"><img width="20px" src="{{ section.settings.trashcan | image_url }} " alt="{{ section.settings.trashcan.alt | escape }}" loading="lazy"></i>', "Delete report"); // Placeholder icon
        trashcanCol.addEventListener('click', async function() {
          try {
            const reportData = new FormData();
            reportData.append("file_name", fileName);
            const deleteData = await unifiedSendRequest(DELETEREPORT, {formData: reportData});
            getDownloads();
            showMessage("Successfully deleted report", true);
            getReports();
          } catch (error) {
            console.error(error.message);
            TOKEN = false;
            showMessage("Failed to delete report, please try again", false);
          }
        });
  return trashcanCol;
}

function addCheckboxCol(fileName, fullPath) {
  const checkboxCol = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = data;
        checkbox.className = 'rowCheckbox';
        checkbox.addEventListener('change', function() {
          const allChecked = [...document.querySelectorAll('input[type="checkbox"].rowCheckbox')].every(ch => ch.checked);
          const allUnchecked = [...document.querySelectorAll('input[type="checkbox"].rowCheckbox')].every(ch => !ch.checked);

          if (allChecked) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else if (allUnchecked) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true; // This sets the checkbox to its "indeterminate" state
          }
        });
        checkboxCol.appendChild(checkbox);
  return checkboxCol;
}

renames = {
  'amount_total': 'Amount Total',
  'amount_b2b': 'Amount B2B',
  'amount_b2c': 'Amount B2C',
  'weight_total': 'Weight Total (kg)',
  'weight_b2b': 'Weight B2B (kg)',
  'weight_b2c': 'Weight B2C (kg)',
  'sku': 'SKU',
  'orderid': 'OrderID',
  'b2b': 'B2B',
  'Column A': 'Index'
};
function displayExcelReport(data, submit, fileName, fullPath) {
    const modalOverlay = document.getElementById('modalOverlayExcel');
    const modal = document.getElementById('excelModal');
    const tabsContainer = document.getElementById('tabs-container');
    const tableContainer = document.getElementById('report-table-data-excel');

    // Reset modal content
    tabsContainer.innerHTML = '';
    tableContainer.innerHTML = '';

    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'; // Alphabet for column headers
    let sheets = Object.keys(data);
    let groupedSheets = {};
    const groupLabels = {};
    var use_tabs = false;

    if (!use_tabs) {
        const groups = {};
        sheets.forEach((sheetName) => {
            const rows = data[sheetName];
            if (!rows || rows.length === 0) return;

            const columnSignature = JSON.stringify(Object.keys(rows[0]).sort());
            if (!groups[columnSignature]) {
                groups[columnSignature] = [];
                groupLabels[columnSignature] = [];
            }

            const taggedRows = rows.map(row => ({
                ...row,
                Category: sheetName
            }));

            groups[columnSignature].push(...taggedRows);
            groupLabels[columnSignature].push(sheetName);
        });

        groupedSheets = groups;
    } else {
        // Use original structure (each sheet separate)
        groupedSheets = Object.fromEntries(sheets.map(s => [s, data[s]]));
    }

    const groupNames = Object.keys(groupedSheets);

    if (groupNames.length > 1) {
        // Generate Tabs only if more than 1 group
        groupNames.forEach((groupName, index) => {
            const tabButton = document.createElement('button');
            tabButton.textContent = groupLabels[groupName][0];
            tabButton.className = 'tab-button';
            tabButton.style.margin = '5px';
            tabButton.dataset.sheet = groupName;

            tabButton.addEventListener('click', () => {
                tableContainer.innerHTML = '';
                highlightActiveTab(index);
                renderSheet(groupedSheets[groupName]);
            });

            tabsContainer.appendChild(tabButton);
        });

        // Render the first one initially
        renderSheet(groupedSheets[groupNames[0]]);
        highlightActiveTab(0);
    } else {
        // Only one group, render directly without tabs
        renderSheet(groupedSheets[groupNames[0]]);
    }


    // Helper function to highlight active tab
    function highlightActiveTab(activeIndex) {
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach((btn, index) => {
            btn.classList.toggle('active', index === activeIndex);
        });
    }


    // Function to render a single sheet
    function renderSheet(sheetData) {
        const columns = Object.keys(sheetData[0]).map((key, idx) => {
            const key_text = key in renames ? renames[key] : key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            return {
                title: key_text, // Use alphabet for headers
                field: key,
                headerSort: true, // Disable sorting
                formatter: "plaintext", // Ensure raw text is displayed
                cellMouseOver: (e, cell) => {
                    // Add tooltip on hover for full entry
                    const tooltip = document.createElement('div');
                    tooltip.id = 'hover-tooltip';
                    tooltip.style.position = 'absolute';
                    tooltip.style.padding = '8px';
                    tooltip.style.background = '#333';
                    tooltip.style.color = '#fff';
                    tooltip.style.borderRadius = '4px';
                    tooltip.style.pointerEvents = 'none';
                    tooltip.style.zIndex = '9999';
                    tooltip.textContent = cell.getValue();

                    document.body.appendChild(tooltip);
                    document.body.addEventListener('mousemove', moveTooltip);

                    function moveTooltip(event) {
                        tooltip.style.left = `${event.pageX + 10}px`;
                        tooltip.style.top = `${event.pageY + 10}px`;
                    }

                    cell.getElement().addEventListener('mouseout', () => {
                        document.body.removeEventListener('mousemove', moveTooltip);
                        document.body.removeChild(tooltip);
                    });
                },
            };
        });

        const tableOptions = {
          data: sheetData,
          layout: columns.length > 10 ? "fitDataFill" : "fitColumns",
          pagination: sheetData.length > 50,
          paginationCounter: "rows",
          paginationSize: 50,
          columns: columns,
      };
      // Only add groupBy when not using tabs
      if (!use_tabs) {
          tableOptions.groupBy = "Category";
          tableOptions.groupHeader = function (value, count, data, group) {
              return value;
          };
      }


        // Initialize Tabulator for the sheet
        new Tabulator("#report-table-data-excel", tableOptions);
    }

    // Render the first sheet by default
    if (use_tabs && sheets.length > 0) {
        renderSheet(data[sheets[0]]);
        highlightActiveTab(0);
    }
    if (submit) {
      document.getElementById('send-report').style.display = 'block';
      document.getElementById('send-report').onclick = function() {
        sendReport(fileName, fullPath);
      };
    } else {
      document.getElementById('send-report').style.display = 'none';
    }
    // Show the modal
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
}


function sendReport(fileName, fullPath) {
  document.getElementById('validateModal').style.display = 'block';
  document.getElementById('validated-report-send').onclick = async function() {
    sendReportGov(fileName, fullPath);
  }
}

async function sendReportGov(fileName, fullPath) {
    try {
      const reportData = new FormData();
      reportData.append("file_name", fileName);
      reportData.append("full_path", fullPath);
      closeModal();
      hideExcelModal();
      const data = await unifiedSendRequest(SENDREPORT, {formData: reportData});
      showMessage("Report sent successfully", true);
    } catch (error) {
      console.error(error);
      TOKEN = false;
      showMessage("Failed to send report", false);
    }
}

function closeModal() {
  document.getElementById('validateModal').style.display = 'none';
}

function showModal() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('report-table').style.display = 'block';
}

function hideModal() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('report-table').style.display = 'none';
}

function displayPdfInModal(pdfBlob) {
    const modal = document.getElementById('pdfModal');
    const modalOverlay = document.getElementById('modalOverlayPdf');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const ctx = pdfCanvas.getContext('2d');

    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;

    const renderPage = (num) => {
        pageRendering = true;
        pdfDoc.getPage(num).then((page) => {
            const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale for better rendering
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;

            // Render the page
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport,
            };
            const renderTask = page.render(renderContext);

            renderTask.promise.then(() => {
                pageRendering = false;

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });
        });

        // Update page info
        document.getElementById('pageInfo').textContent = `Page ${num} of ${pdfDoc.numPages}`;
    };

    const queueRenderPage = (num) => {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    };

    const onPrevPage = () => {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    };

    const onNextPage = () => {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    };

    document.getElementById('prevPage').addEventListener('click', onPrevPage);
    document.getElementById('nextPage').addEventListener('click', onNextPage);

    // Load the PDF
    const loadingTask = pdfjsLib.getDocument({ data: pdfBlob });
    loadingTask.promise.then((pdf) => {
        pdfDoc = pdf;
        renderPage(pageNum);
    });

    // Show the modal
    modal.style.display = 'block';
    modalOverlay.style.display = 'block';
}

var reportFilters = {
  'countries': [],
  'report_types': [],
  'reporting_periods': [],
  'search_filter': [],
  'receipt_only': '',
}
search_filter = [];

var totalPossibleCompanies = new Set();
var totalPossibleCountries = new Set();
var totalPossibleReportTypes = new Set();
var totalPossiblePeriods = new Set();
var totalPossibleReceipts = ['All', 'Receipts only', 'Reports only'];
var allReports = [];
async function getReports(init=true) {
    try {
    const configDiv = document.getElementById("reportshistory");
    configDiv.innerHTML = '';
    var loadingSpinnerContainer = document.createElement('div');
    loadingSpinnerContainer.id = 'loadingSpinnerContainer';
    var loadingSpinner = document.createElement('div');
    loadingSpinner.id = 'loadingSpinner';
    loadingSpinnerContainer.appendChild(loadingSpinner);
    configDiv.appendChild(loadingSpinnerContainer);
    let data = await unifiedSendRequest(GETREPORTSONEDRIVE, {method: 'POST', formData: JSON.stringify(reportFilters), 
                                        headerArgs: {'Content-Type': 'application/json'}});
    allReports = data;
    await filterCompanySearch(document.getElementById("companySearch").value, init);
    // createOverview(data, init);
    } catch (error) {
    console.error(error.message);
    TOKEN = false;
    }
}

function createOverview(data, init, accessControl) {
    const configDiv = document.getElementById("reportshistory");
    const hierarchy = buildHierarchy(data);

    var possibleCompanies = new Set();
    var possibleCountries = new Set();
    var possibleReportTypes = new Set();
    var possiblePeriods = new Set();
    for (let file of data) { // Corrected loop
          filename = file['filename'];
          let filename_split = filename.split('/');

          possibleCompanies.add(filename_split[0]);
          possibleCountries.add(filename_split[1]);
          possibleReportTypes.add(filename_split[2]);

          let possiblePeriod = filename_split[3];
          if (filename_split.length > 5) {
              possiblePeriod += ` ${filename_split[4]}`;
          }
          possiblePeriods.add(possiblePeriod);
      }
    if (init) {
      totalPossibleCompanies = possibleCompanies;
      totalPossibleCountries = possibleCountries;
      totalPossibleReportTypes = possibleReportTypes;
      totalPossiblePeriods = possiblePeriods;
      
      // TODO do this smart when selecting e.g. a country
      fillDropdowns('countryDropdown', possibleCountries, 'countries');
      fillDropdowns('reporttypeDropdown', possibleReportTypes, 'report_types');
      fillDropdowns('receiptsDropdown', totalPossibleReceipts, 'receipt_only');
    }
    fillDropdowns('periodDropdown', possiblePeriods, 'reporting_periods');  // only reporting period currently really variable
    createFolderStructure(configDiv, hierarchy, accessControl);
}

document.getElementById("companySearch").addEventListener("input", async function () {
    await filterCompanySearch(this.value, false);
});

async function filterCompanySearch(searchQuery, init) {
  var accessControl = await unifiedSendRequest(GETACCESSREPORTS, {method: 'GET'});
  searchQuery = searchQuery.toLowerCase().trim().replace(' ', '_').replace('.', '_').replace(',', '_').replace('/', '_'); // Get input and normalize case

  let filteredData;

  if (searchQuery === '') {
      filteredData = allReports; // If empty input, show all reports
  } else {
      filteredData = allReports.filter(file =>
          file.filename.toLowerCase().includes(searchQuery)
      );
  }
  search_filter = filteredData;
  createOverview(filteredData, init, accessControl); // Refresh the overview
}



function fillDropdowns(dropdownId, entries, key) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = "";

    [...entries].sort().forEach(entry => {
        const option = document.createElement("option");
        option.value = entry;
        option.textContent = entry;
        if (reportFilters[key].includes(entry)) {
            option.selected = true;
        }
        dropdown.appendChild(option);
    });
    $(`#${dropdownId}`).selectpicker('refresh');
    let selectedOptions = $(`#${dropdownId}`).find('option:selected');
    let displayText = selectedOptions.map(function() {
        return $(this).text(); // or $(this).val() if you want to display the value
    }).get().join(', ');
    // Check if there is any selection, otherwise set to default text
    displayText = displayText.length > 0 ? displayText : 'Nothing selected';

    // Update the display text
    $(`#${dropdownId}`).closest('.filter-group').find('.filter-option-inner-inner').text(displayText);
}
document.getElementById('countryDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    reportFilters['countries'] = selCountries;
    getReports(false);
});

document.getElementById('reporttypeDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    reportFilters['report_types'] = selCountries;
    getReports(false);
});

document.getElementById('periodDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    reportFilters['reporting_periods'] = selCountries;
    getReports(false);
});

document.getElementById('receiptsDropdown').addEventListener('change', function() {
  const selCountries = Array
        .from(this.options)
        .filter(option => option.selected)
        .map(option => option.value);
    reportFilters['receipt_only'] = selCountries[0];
    getReports(false);
});

document.getElementById('downloadAllReports').addEventListener('click', async function() {
  try {
    var reportFiltersDownload = reportFilters;
    reportFiltersDownload['search_filter'] = search_filter;
    this.style.cursor = 'not-allowed';
    this.title = 'In Progress, this can take 1-2mins, please wait';
    const data = await unifiedSendRequest(GETREPORTSDOWNLOADALL, {method: 'POST', formData: JSON.stringify(reportFiltersDownload), 
                                          headerArgs: {'Content-Type': 'application/json'}});
    this.style.cursor = 'pointer';
    this.title = '';
  } catch (error) {
    console.error(error.message);
    TOKEN = false;
  }
});


function hideImageModal() {
    document.getElementById('imageModal').style.display = 'none';
    document.getElementById('modalOverlayImage').style.display = 'none';
}

function hideExcelModal() {
    document.getElementById('excelModal').style.display = 'none';
    document.getElementById('modalOverlayExcel').style.display = 'none';
}

function hidePdfModal() {
    document.getElementById('pdfModal').style.display = 'none';
    document.getElementById('modalOverlayPdf').style.display = 'none';
}

document.getElementById('modalOverlayImage').addEventListener('click', hideImageModal);
document.getElementById('closeModal').addEventListener('click', hideImageModal);

document.getElementById('closeExcelModal').addEventListener('click', hideExcelModal);
document.getElementById('modalOverlayExcel').addEventListener('click', hideExcelModal);

document.getElementById('closePdfModal').addEventListener('click', hidePdfModal);
document.getElementById('modalOverlayPdf').addEventListener('click', hidePdfModal);

getReports();



function showGuide() {
    startGuide([
        { element: "main", group: "Introduction", title: "Welcome", text: "Welcome to the report history page. All reports that were created or that you submitted are shown here as well as the confirmations if they were sent to the corresponding authority.", where: 'middle' },
        { element: "#filterContainer", group: "Filters", title: "Filters", text: "Here you can filter the results shown below by the country, type of report and time.", where: 'below' },
        { element: "#receiptsContainer", group: "Filters", title: "Receipts Only", text: "If you only want to see the report confirmations, you can select that here.", where: 'below' },
        { element: "#searchContainer", group: "Filters", title: "Search", text: "Search for any company, report name or country using this search. The results are updated immediately.", where: 'below' },
        { element: "#allIconsContainer", group: "Download", title: "Download", text: "To download all reports shown below (applying the filters that you've chosen), click this button. \n\nNote: This might take 1-2mins to get the zip file ready.", where: 'left'}
    ]);
    setCookie('showedGuideHistory', 'true', 300);
}
function showGuideFromButton(element) {
  showGuide();
}


document.addEventListener('DOMContentLoaded', function() {
  if(readCookie('showedGuideHistory') === null) {
      //setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    }
  });

  </script>
</div>
{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
    <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_download_new.name",
    "class": "section",
    "settings": [

      {
        "type": "select",
        "id": "desktop_image_width",
        "options": [
          {
            "value": "small",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__1.label"
          }, {
            "value": "medium",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__2.label"
          }, {
            "value": "large",
            "label": "t:sections.forsure_download.settings.desktop_image_width.options__3.label"
          }
        ],
        "default": "medium",
        "label": "t:sections.forsure_download.settings.desktop_image_width.label",
        "info": "t:sections.forsure_download.settings.desktop_image_width.info"
      },
      {
        "type": "select",
        "id": "layout",
        "options": [
          {
            "value": "image_first",
            "label": "t:sections.forsure_download.settings.layout.options__1.label"
          }, {
            "value": "text_first",
            "label": "t:sections.forsure_download.settings.layout.options__2.label"
          }
        ],
        "default": "image_first",
        "label": "t:sections.forsure_download.settings.layout.label",
        "info": "t:sections.forsure_download.settings.layout.info"
      },
      {
        "type": "select",
        "id": "desktop_content_position",
        "options": [
          {
            "value": "top",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__1.label"
          }, {
            "value": "middle",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__2.label"
          }, {
            "value": "bottom",
            "label": "t:sections.forsure_download.settings.desktop_content_position.options__3.label"
          }
        ],
        "default": "top",
        "label": "t:sections.forsure_download.settings.desktop_content_position.label"
      },
      {
        "type": "select",
        "id": "desktop_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.desktop_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.desktop_content_alignment.label"
      }, {
        "type": "select",
        "id": "content_layout",
        "options": [
          {
            "value": "no-overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__1.label"
          }, {
            "value": "overlap",
            "label": "t:sections.forsure_download.settings.content_layout.options__2.label"
          }
        ],
        "default": "no-overlap",
        "label": "t:sections.forsure_download.settings.content_layout.label"
      }, {
        "type": "select",
        "id": "color_scheme",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "select",
        "id": "color_scheme2",
        "options": [
          {
            "value": "accent-1",
            "label": "t:sections.all.colors.accent_1.label"
          },
          {
            "value": "accent-2",
            "label": "t:sections.all.colors.accent_2.label"
          },
          {
            "value": "background-1",
            "label": "t:sections.all.colors.background_1.label"
          },
          {
            "value": "background-2",
            "label": "t:sections.all.colors.background_2.label"
          }, {
            "value": "inverse",
            "label": "t:sections.all.colors.inverse.label"
          }
        ],
        "default": "background-1",
        "label": "t:sections.all.colors.label"
      }, {
        "type": "header",
        "content": "Mobile layout"
      }, {
        "type": "select",
        "id": "mobile_content_alignment",
        "options": [
          {
            "value": "left",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__1.label"
          }, {
            "value": "center",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__2.label"
          }, {
            "value": "right",
            "label": "t:sections.forsure_download.settings.mobile_content_alignment.options__3.label"
          }
        ],
        "default": "left",
        "label": "t:sections.forsure_download.settings.mobile_content_alignment.label"
      }, {
        "type": "header",
        "content": "t:sections.all.padding.section_padding_heading"
      }, {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      }, {
        "type": "image_picker",
        "id": "open",
        "label": "Open"
      }, {
        "type": "image_picker",
        "id": "download",
        "label": "Download"
      }, {
        "type": "image_picker",
        "id": "share",
        "label": "Share"
      }, {
        "type": "image_picker",
        "id": "filter",
        "label": "Filter"
      }, {
        "type": "image_picker",
        "id": "send_report",
        "label": "Send Report"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_download_new.presets.name"
      }
    ]
  }
{% endschema %}