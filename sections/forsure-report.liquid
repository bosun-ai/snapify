{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}
{{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}

{%- style -%}
.tooltip {
  position: absolute;
  text-align: center;
  width: 120px;
  height: 45px;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}

.section-{{ section.id }}-padding {
  padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
  padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
}


@media screen and (min-width: 750px) {
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }
}
.image-with-text p {
  text-align: left;
  hyphens: auto;
  -webkit-hyphens: auto;
}
.border-uploads {
  border: 0.2rem solid #17161c;
}
.dropZone {
    display: flex;
    justify-content: center;
    border: 2px dashed #17161c;
    gap: 2rem;
    padding: 20px;
    width: 70%;
    height: 350px;
    margin: auto;
    text-align: center;
    transition: background-color 0.3s ease;
    cursor: pointer;
    scroll-behavior: smooth;
}
.dropZone.error {
    border-color: var(--forsure-main-red);
}

#uploadSteps {
    position: relative;
    min-height: 680px;
}
.navButtons {
    position: absolute;
    bottom: 3rem;  /* Adjust as needed for distance from the bottom */
    left: 50%;  /* Center the navButtons */
    transform: translateX(-50%); /* This ensures the centering works correctly */
}
.heading {
  text-align: center;
}
/* .wrapper {
    display: flex;
}
.left, .right {
    flex: 1;  /* Each div will take up half the width of the parent container */

.button--secondary {
    border: 0.2rem solid #17161c !important;
}

.fileList {
  height: auto;
  width: 100%;
  /* If you want a maximum height with a scrollbar appearing after reaching it */
  /* max-height: 200px; */
  /* overflow-y: auto; */

  position: relative;

  margin-bottom: 20px;
  margin-left: auto;
  margin-right: auto;
}

.fileList {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Dynamic grid columns */
    gap: 1rem; /* Space between grid items */
    padding: 1rem;
    align-items: start;
}
.fileList .file-row {
    display: flex;
    justify-content: space-between;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 0.5rem;
    background: #f9f9f9;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.7); /* White background with 70% opacity */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10; /* Ensures the overlay is on top */
}

.loading-overlay::before {
    content: '';
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db; /* Blue color */
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
td {
  padding: 3px;
  text-align: left;
}
.deletebtn {
  background-color: #fafafa;
  border-radius: 25%;
  border: none;
}
.deletebtn:hover {
  background-color: #f0f0f0;
}

/* .trConfirm {
  display: flex;
}
.tdConfirm {
  flex: 1;
} */
.wrapper {
    margin: auto;
    width: 0%; /* You can adjust this width as needed */
}
.wrapper1 {
  margin: auto;
  width: 50%;
}
.tdConfirm {
  padding-top: 2rem;
}
.tdConfirm:first-child {
    text-align: right;
    padding-right: 10px; /* Optional: Adds some space between the columns */
    font-weight: bold;
}
.tdConfirm:last-child {
    text-align: left;
}
#btnOverview:hover {
  color: #fafafa;
}
#btnShowReports:hover {
  color: #fafafa;
}


.toggle-container {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
    /* margin-left: 10px; */
    vertical-align: middle;
    margin: auto;
    flex-shrink: 0;
}

.toggle-container input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #2255ff;
}

input:focus + .toggle-slider {
    box-shadow: 0 0 1px #2255ff;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}
.toggle-options {
  align-items: center;
  display: flex;
}
div.display-flex {
    display: flex;
    align-items: center; /* Align items vertically in the middle */
    justify-content: flex-start; /* Align items to the start of the container */
    gap: 10px; /* Adjust as needed, adds space between children */
}
.option-card {
    border: 0.2rem solid #17161c;
    padding: 1rem;
    width: 500px;
    height: 500px;
    border-radius: 1rem;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.option-card:hover {
    background-color: #f0f0f0;
}

.file-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    border-bottom: 1px solid #ddd;
}
#clientsTable thead th {
        position: sticky;
        top: 0;
        background-color: white; /* Background color to ensure readability */
        z-index: 10; /* Ensure it stays above the table body content */
        border-bottom: 2px solid #ddd; /* Keep the header visually separated */
}
#clientsDatatableContainer div {
    overflow-y: auto; /* Enable vertical scrolling */
}

.tabulator-col-sorter .tabulator-arrow {
    display: block;
}

.greyed_out {
    cursor: not-allowed;
    background-color: grey!important;
    opacity: 0.5;
    position: relative; /* Needed for positioning the tooltip */
    pointer-events: none; /* Disable clicks on links */
    color: inherit; /* Ensure the link text doesn't look like a link */
    text-decoration: none; /* Remove underline or other link styles */
}

.greyed_out_wrapper:hover .greyedout-tooltip-feature {
    display: block; /* Show the tooltip on hover */
}

.greyedout-tooltip-feature {
    display: none; /* Hide the tooltip by default */
    position: absolute;
    top: 50%; /* Position above the element */
    left: 50%;
    transform: translateX(-50%);
    background: var(--forsure-main-red);
    color: white;
    padding: 0.5rem;
    font-size: 0.9rem;
    border-radius: 5px;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}
.blurred {
  filter: blur(5px);
}

.blurred:hover {
  filter: none;
}


#tabs-container {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
    overflow-x: auto;
}

.tab-button {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

.tab-button:hover {
    background-color: #eaeaea;
}

.tab-button.active {
    background-color: #2255ff;
    color: #fafafa;
    border-bottom: 2px solid #fff;
    font-weight: bold;
}

#clientsDatatableContainer {
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
}
.tabulator .tabulator-footer .tabulator-page.active {
  color: #fafafa!important;
}

.glyphicon-ok:before {
content: "\2713"
}




#step1 .container, #step2 .container {
  max-width: 1000px;
  margin: auto;
  margin-bottom: 4rem;
  padding: 30px;
  background: #fafafa;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,0.05);
}

#step1 h2.heading, #step2 h2.heading{
  font-size: 28px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 30px;
}

#step1 label.form-label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #17161c;
}

#step1 .form-control,
#step1 .selectpicker,
#step1 select.form-select {
  border-radius: 8px !important;
  padding: 8px 12px !important;
  height: auto !important;
  border-color: #ccc;
  background-color: #fff !important;
}

#step1 .small-date-input {
  min-width: 220px;
  max-width: 100%;
  cursor: pointer;
}

#step1 .wide-select .dropdown-toggle {
  white-space: normal !important;
  text-align: left !important;
  width: 100% !important;
}

#step1 .bootstrap-select > .dropdown-toggle {
  width: 100% !important;
  border-radius: 8px !important;
}

#step1 .bootstrap-select .dropdown-menu {
  border-radius: 8px;
  box-shadow: 0px 5px 20px rgba(0,0,0,0.08);
  max-width: 100%;
  overflow-x: auto;
}

#step1 input[type="checkbox"] {
  transform: scale(1.3);
  margin-right: 8px;
}

#step1 .form-check-label {
  font-weight: 500;
  color: #333;
}

#step1 .row > div {
  margin-bottom: 20px;
}

.row {
    margin: auto;
    width: fit-content;
    display: flex;
    gap: 10rem;
}

@media (max-width: 767px) {
  #step1 .row > div {
    margin-bottom: 20px;
  }
  #step1 .container {
    padding: 20px;
  }
}

#step4 h5 {
    width: 20rem;
    margin-top: 1rem;
}

.card {
  border: 0.2rem solid #17161c;
  border-radius: 0.5rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
  background-color: #fafafa;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.card-body {
  padding: 1rem;
}

.card-title {
  font-size: 1.5rem;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.list-group-item {
  border-radius: 0.5rem;
  margin-bottom: 0.5rem;
  padding: 0.75rem;
  background-color: #fafafa;
  transition: background-color 0.2s;
}

.list-group-item:last-child {
  margin-bottom: 0;
}
.separator {
  border-top: 1px solid #17161c;
  display: block!important;
  margin-bottom: 1rem;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    top: 1.5rem;
    position: absolute;
    right: 1.5rem;
  }
  .closeError, .closePreview {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    top: 0.5rem;
  }
  .close:hover,
  .close:focus, .closeError:hover, .closeError:focus, .closePreview:hover, .closePreview:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .exclude {
    text-decoration: line-through;
  }


  .modal-content {
  background-color: #fefefe;
  padding: 1rem 2rem;
  border: 1px solid #888;
  width: fit-content;
  max-width: 80vw;
  margin: 15% auto;
  box-sizing: border-box;
}

.profile-wrapper {
  display: inline-block;
  max-width: 100%;
  padding: 2rem;
  padding-top: 0;
}

#profileTable {
  width: 100%;
  table-layout: auto;
}

#profileTable th, #profileTable td {
  white-space: nowrap;
  padding: 0.5rem;
}
#resolutionSelect {
  padding: 1rem;
}
.disableclicks {
  pointer-events: none;
}


#returnListDropZone {
  margin-top: 9.55rem;
}
/* Loading spinner */
#loadingSpinner, #loadingSpinnerCalendar {
  border: 4px solid rgba(34, 85, 255, 0.1);
  border-top: 4px solid #2255ff;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: auto;
  display: flex;
}
#loadingSpinnerContainer, #loadingSpinnerCalendarContainer {
  position: absolute;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.previewActive svg {
  border-radius: 1rem;
  background-color: #2255FF;

  fill: #fafafa!important;
}

#previewIcon svg {
  padding: 1rem;
  min-width: 5rem;
}

#outputFieldsContainer .dropdown {
  width: 160px!important;
}

{%- endstyle -%}
{% if customer.tags contains 'member' %}

  <div id="reportcontainer" class="section-{{ section.id }}-padding" style="min-height: 100vh;padding-bottom: 5rem;display: none">
  <!-- Load d3.js -->
  <!-- <script src="https://d3js.org/d3.v4.js"></script> -->
  {% comment %} <script src="https://cdn.jsdelivr.net/npm/d3@7"></script> {% endcomment %}
  <script src="{{ 'cookie-handler.js' | asset_url }}"></script>
  {% render 'forsure-simple-notification' %}
  {% render 'forsure-confirmation' %}

  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

  {% comment %} <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script> {% endcomment %}

{% comment %} <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> {% endcomment %}
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>-->
{% comment %} <script src="https://code.jquery.com/jquery-3.6.0.js"></script> {% endcomment %}
{%comment %}<script
  src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
  integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
  crossorigin="anonymous"></script> {% endcomment %}
{% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script> {% endcomment %}
{% comment %} <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script> {% endcomment %}
{% comment %} <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.css" /> {% endcomment %}

  <!-- Create a div where the graph will take place -->
<div id="uploadSteps" class="border-uploads page-width" style="border-radius:1rem;">
    <div class="step" id="chooseoption">
        <h2 class="heading">Choose an Option</h2>
        <div class="display-flex" style="margin: auto; width: fit-content; justify-content: space-between; gap: 2rem;">
            <!-- Option: Create New Report -->
             <div id="createNewReportWrapper" style="position: relative">
              <div class="greyedout-tooltip-feature">Please upgrade to the full version to access this</div>
                <div id="createNewReport" class="option-card greyed_out" style="position: relative;background-color: #fafafa;" onclick="selectOption('new')">
                    <h3>Create New Report</h3>
                    <p>Start a new report by selecting<br>the required files and settings.</p>
                    <div style="height: 50%;margin-top: 5rem">
                      {% render 'icon-custom-compliance' %}
                    </div>
                </div>
            </div>

            <!-- Option: Upload Existing Reports -->
             <div id="uploadExistingReportsWrapper" style="position: relative">
              <div class="greyedout-tooltip-feature">Please upgrade to the full version to access this</div>
                <div id="uploadExistingReports" class="option-card greyed_out" style="position: relative;background-color: #fafafa;" onclick="selectOption('upload')">
                    <h3>Upload Reports</h3>
                    <p>Upload one or more completed<br>reports for submission.</p>
                    <div style="height: 50%;margin-top: 5rem">
                      {% render 'icon-auto-epr-report' %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="uploadExisting" id="uploadReport" style="display: none;">
        <h2 class="heading">Upload Existing Reports</h2>
        <div style="margin-bottom: 2rem;margin: auto;position: relative;background: rgb(250, 250, 250);padding: 1px 1rem;border-radius: 1rem;">
          <div style="display: flex; justify-content: space-evenly;gap: 2rem;">
          <div id="clientsUploadSection" style="margin: 0 2rem 2rem 2rem;position: relative;background:#fafafa;padding: 1rem;">
            <h3 style="margin-bottom: 1rem;text-align: center;">Client Credentials</h3>
            <button class="button button--secondary" onclick="openClientsModal()">Manage Login Details</button>
              {% comment %} <div id="clientsFileContainer" style="display: flex; align-items: center; padding: 0.5rem 0;border: 0.2rem solid #17161c;background-color: #fff;border-color: #ccc;margin-bottom: 1.5rem;">

                  {% comment %} <span id="clientsFileName" style="margin: auto">No file uploaded</span>
                  <a id="editIconClients" href="#" title="Edit" onclick="openClientsModal()" style="margin-left: 1rem;margin-right: 1rem;  margin-top: 0.5rem; display: none">
                    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="15" height="15" x="0px" y="0px" viewBox="0 0 117.74 122.88" style="enable-background:new 0 0 117.74 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path fill="#17161c" class="st0" d="M94.62,2c-1.46-1.36-3.14-2.09-5.02-1.99c-1.88,0-3.56,0.73-4.92,2.2L73.59,13.72l31.07,30.03l11.19-11.72 c1.36-1.36,1.88-3.14,1.88-5.02s-0.73-3.66-2.09-4.92L94.62,2L94.62,2L94.62,2z M41.44,109.58c-4.08,1.36-8.26,2.62-12.35,3.98 c-4.08,1.36-8.16,2.72-12.35,4.08c-9.73,3.14-15.07,4.92-16.22,5.23c-1.15,0.31-0.42-4.18,1.99-13.6l7.74-29.61l0.64-0.66 l30.56,30.56L41.44,109.58L41.44,109.58L41.44,109.58z M22.2,67.25l42.99-44.82l31.07,29.92L52.75,97.8L22.2,67.25L22.2,67.25z"/></g></svg>
                  </a> {% endcomment %}

                  {% comment %} <img width="20px" id="upload-clients" style="margin-left: 1rem; margin-right: 1rem; cursor: pointer" onclick="document.getElementById('clientsFileInput').click()" src="{{ section.settings.upload | image_url }}" alt="{{ section.settings.upload.alt | escape }}" loading="lazy"> {% endcomment %}
              </div> {% endcomment %}
              <input type="file" id="clientsFileInput" style="display: none;" accept=".xlsx" onchange="handleClientsUpload(this)">
          </div>
        </div>
        </div>

        <div class="dropZone" data-input="report_list" data-url="uploadreports/" style="overflow-y: auto;position: relative;background: #fafafa;" id="uploadreportlistContainer">
            <div style="width: 100%;margin: auto"><div style="height:100%">
                <div id="imagecontainer-imageuploadreports/" style="padding:2rem">
                  <img width="220px" id="upload-imageuploadreports/" src="{{ section.settings.upload | image_url }}" alt="{{ section.settings.upload.alt | escape }}" loading="lazy">
                </div>
                <div id="upload-textuploadreports/">Drag & Drop your Reports here.<br>You can upload multiple files at once.</div>
                <div class="fileList" id="fileList_report_list" style="width:100%; padding:2rem"></div>
              </div>
            </div>
        </div>
        <input type="file" id="report_list" style="display: none" multiple>
        <div id="errorsreport_list"></div>
        <div class="navButtons">
            <button class="button" style="background-color: #17161c;" onclick="openZeroDeclarationModal()">Add Zero Report</button>
            <button class="button" onclick="uploadReports()">Hand in reports</button>
        </div>

        <div id="editClientsModal" class="losensitive" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75%; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 91;">
            <div style="display: flex;justify-content: space-between;align-items: center;">
              <h3>Edit Client Credentials</h3>
              <div>
                  {% comment %} <a id="replaceFileBtn" onclick="document.getElementById('replaceClientsFileInput').click()" class="button button--secondary" style="border: 0.2rem solid #17161c !important;margin: 1rem;cursor: pointer;">Upload</a>     {% endcomment %}
                  <a id="addRowBtn" onclick="addNewRow()" class="button button--secondary" style="border: 0.2rem solid #17161c !important;margin: 1rem;cursor: pointer;">Add Row</a>
                  {% comment %} TODO enable once I define what columns they can choose {% endcomment %}
                  {% comment %} <a id="addColumnBtn" onclick="addNewColumn()" class="button button--secondary" style="border: 0.2rem solid #17161c !important;margin: 1rem;cursor: pointer;">Add Column</a> {% endcomment %}

              </div>
            </div>
            <div id="tabs-container"></div>
            <div id="clientsDatatableContainer">
                <!-- Datatable for Clients File will be dynamically rendered here -->
            </div>
            {% comment %} <input type="file" id="replaceClientsFileInput" accept=".xlsx" onchange="handleClientsUploadReplacePrompt(this)" style="display: none"> {% endcomment %}
            <div style="margin-top: 1rem;margin-left: auto;width: fit-content;">
              <button class="button button--secondary" onclick="closeClientsModal()">Cancel</button>
              <button class="button" onclick="saveClientsEdits()">Save</button>
            </div>
        </div>
        <div id="clientsModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 90;" onclick="closeClientsModal()"></div>

        <div id="zeroDeclarationModal" class="losensitive modal" style="z-index: 3;">
          <div class="modal-content" style="width: 80vw;">
            <h2 style="margin: 0;">Zero Declaration</h2>
            <p>Select the companies and countries for whichyou want to submit a zero declaration.</p>
            <div style="display: flex;flex-direction: column;gap: 1rem;margin-bottom: 3rem;">
              <div style="display: grid;grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));gap: 2rem;">
                <div class="filter-group" id="profile-filter-guide">
                  <div class="filter-group-heading">Country</div>
                  <select
                    id="countryDropdown"
                    class="selectpicker"
                    data-live-search="true"></select>
                </div>
                <div class="filter-group" id="profile-filter-guide">
                  <div class="filter-group-heading">Report Type</div>
                  <select
                    id="reporttypeDropdown"
                    class="selectpicker"
                    data-live-search="true"></select>
                </div>
                <div class="filter-group" id="profile-filter-guide">
                  <div class="filter-group-heading">PRO</div>
                  <select
                    id="proDropdown"
                    class="selectpicker"
                    data-live-search="true"></select>
                </div>
                <div class="filter-group" id="profile-filter-guide">
                  <div class="filter-group-heading">Timeframe</div>
                  <select
                    id="timeframeDropdown"
                    class="selectpicker"
                    data-live-search="true"></select>
                </div>
                <div class="filter-group" id="profile-filter-guide">
                  <div class="filter-group-heading">Company</div>
                  <select
                    id="companyDropdown"
                    class="selectpicker"
                    multiple
                    data-live-search="true" data-live-search-placeholder="Choose multiple companiesâ€¦"></select>
                </div>
              </div>
            </div>
            {% comment %} <div id="zeroDeclarationTableContainer" style="overflow-y: auto;height: 25rem;margin-bottom: 1rem;">
              <table style="width: -webkit-fill-available;max-width: 80vw;min-width: 60rem;table-layout: auto;">
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>Report Type</th>
                    <th>PRO</th>
                    <th>Timeframe</th>
                    <th>Company</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody id="zeroDeclarationTableBody">
                </tbody>
              </table>
              <!-- Datatable for Zero Declaration will be dynamically rendered here -->
            </div> {% endcomment %}
            <div style="display: flex;justify-content: space-between;">
              <button class="button button--secondary" onclick="closeZeroDeclarationModal()">Cancel</button>
              <button class="button" onclick="addZeroDeclaration()">Create</button>
            </div>
          </div>
        </div>

    </div>


    {% comment %} <div class="step losensitive" id="step0" style="display: none;">
        <h2 class="heading">Select Orderlist</h2>
        <div class="display-flex" style="margin: auto;width: fit-content;display:flex;height: 7rem;">
          <h3 id="liveDataText" class="toggle-options">Use live data</h3>
          <label id="liveData" class="toggle-container">
            <input type="checkbox" id="liveDataToggle">
            <span id="liveDataToggleSlider" class="toggle-slider">
              <div class="greyedout-tooltip">Contact us to set up live data</div>
            </span>
          </label>

        </div>
        <div id="ordersReceived" style="margin: auto;width: fit-content;display: none;color:red">
        </div>
        <div class="dropZone" data-input="order_list" data-url="uploadorders/" id="orderListDropZone" style="position: relative;background: #fafafa;">
            <div style="width: 100%;">
              <div style="padding:2rem">
                <img width="220px" id="upload-imageuploadorders/" src="{{ section.settings.upload | image_url }}" alt="{{ section.settings.upload.alt | escape }}" loading="lazy">
              </div>
              Drag & Drop your Order List here.<br>You can upload multiple files at once.<br>
              <div class="fileList" id="fileList_order_list" style="width:100%; padding:2rem"></div>
            </div>
        </div>
        <input type="file" id="order_list" style="display: none" multiple>
        <div id="errorsorder_list"></div>
        <div class="navButtons" id="navButtonsStep1">
            <button class="nextButton button" onclick="uploadOrders('uploadorders/')" id="nextBtnuploadorders" style="position: relative;" disabled>Next</button>
        </div>
      </div> {% endcomment %}

  {% comment %} <div class="step losensitive" id="step2" style="display: none">
      <h2 class="heading">Select Returnlist</h2>
      <div class="dropZone" data-input="return_list" data-url="uploadreturns/" id="returnListDropZone">
        <div style="width: 100%;">
          <div style="padding:2rem">
            <img width="220px" id="upload-imageuploadreturns/" src="{{ section.settings.upload | image_url }}" alt="{{ section.settings.upload.alt | escape }}" loading="lazy">
          </div>
          Drag & Drop your Returns here.<br>You can upload multiple files at once.<br>
          <div class="fileList" id="fileList_return_list" style="width:100%; padding:2rem"></div>
        </div>
      </div>
      <input type="file" id="return_list" style="display: none" multiple>
      <div id="errorsreturn_list"></div>
      <div class="navButtons">
          <button class="prevButton button button--secondary" onclick="prevStep(1)">Back</button>
          <button class="nextButton button" onclick="uploadReturns('uploadreturns/')" id="nextBtnuploadreturns">Next</button>
      </div>
     </div>
      {% endcomment %}
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
  <div id="profileModal" class="losensitive modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="profile-wrapper">
        <div style="display: flex; justify-content: space-between;">
          <h2>Select Mapping</h2>
          <div id="profileDropdownContainer" style="margin: auto 0;border-radius: 4px;padding-right: 0.4rem;">
            <select id="profileSelect" class="btn dropdown-toggle bs-placeholder btn-default" style="position: relative">
            </select>
            <a id="editIcon" href="#" title="Edit">
              <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="15" height="15" x="0px" y="0px" viewBox="0 0 117.74 122.88" style="enable-background:new 0 0 117.74 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path fill="#17161c" class="st0" d="M94.62,2c-1.46-1.36-3.14-2.09-5.02-1.99c-1.88,0-3.56,0.73-4.92,2.2L73.59,13.72l31.07,30.03l11.19-11.72 c1.36-1.36,1.88-3.14,1.88-5.02s-0.73-3.66-2.09-4.92L94.62,2L94.62,2L94.62,2z M41.44,109.58c-4.08,1.36-8.26,2.62-12.35,3.98 c-4.08,1.36-8.16,2.72-12.35,4.08c-9.73,3.14-15.07,4.92-16.22,5.23c-1.15,0.31-0.42-4.18,1.99-13.6l7.74-29.61l0.64-0.66 l30.56,30.56L41.44,109.58L41.44,109.58L41.44,109.58z M22.2,67.25l42.99-44.82l31.07,29.92L52.75,97.8L22.2,67.25L22.2,67.25z"/></g></svg>
              </a>
          </div>
          <button class="button" style="margin: auto 0;" id="saveProfile" onclick="saveMapping()" disabled>Save</button>
        </div>
        <div>Create the mapping you want to use for this file, each dropdown value with a star is required to be mapped.
          If you want to exclude a column, click the exclude button. Unmapped columns will be excluded from the report, but can be viewed in the dashboard.
        </div>
        <div id="profileDetails">
          <div style="display:flex;padding: 1rem 0;">
            <strong>File:</strong>
            <div id='profileFileName' style="margin-left:1rem"></div>
          </div>
          <div id='profileErrorMessage' style="margin-bottom:1rem;color:red;text-align: right;"></div>
          <table id="profileTable" style="margin: auto;">
            <tr>
              <th>Name</th>
              <th>Preview</th>
              <th>Mapping</th>
              <th>Exclude</th>
            </tr>
            <tbody id="profileTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="confirmOverwriteModal" class="losensitive" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30%;
     background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 91;border: 0.1rem solid #17161c;">
    <h2>Confirm Overwrite</h2>
    <p>Are you sure you want to overwrite the existing mapping?</p>
    <button class="button" onclick="confirmOverwrite()">Yes</button>
    <button class="button" onclick="closeConfirmOverwriteModal()">No</button>
  </div>
  <div class="step losensitive" id="step1" style="display: none;">
      <h2 class="heading">Select country and timeframe</h2>


      {% render 'forsure-rules' %}
      <div class="container">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="country" class="form-label">Select Country</label>
              <select id="country" class="selectpicker form-select" multiple data-live-search="true"></select>
            </div>
            <div class="col-md-6">
              <label for="category" class="form-label">Select Category</label>
              <select id="category" class="selectpicker form-select" data-live-search="true">
                <option value="Custom">Custom</option>
                <option value="Batteries">Batteries</option>
                <option value="Packaging">Packaging</option>
                <option value="WEEE">WEEE</option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="proSelect" class="form-label">Select PRO</label>
              <select id="proSelect" class="selectpicker form-select" data-live-search="true">
              </select>
            </div>


            <div class="col-md-6" style="position: relative">
              {% render 'forsure-custom-calendar' %}
              <div id="calendarError" style="color:red;text-align: right;font-size: 12px;"></div>
            </div>
          </div>

          <div id="customFieldsContainer" class="row mb-3" style="display: none;">
            <div class="col-md-6">
              <label for="groupByFields" class="form-label">Show one line per</label>
              <select id="groupByFields" class="selectpicker form-select wide-select" multiple data-live-search="true"></select>
            </div>
            <div class="col-md-6" style="display: flex;width: 250px;">
              <div style="width: 160px;" id="outputFieldsContainer">
                <label for="customFields" class="form-label">Show these totals</label>
                <select id="customFields" class="selectpicker form-select wide-select" multiple data-live-search="true"></select>
              </div>
              <div onclick="previewReport()" id="previewIcon" style="cursor:pointer;margin-bottom: -1rem;margin-top: auto;margin-left: 1rem;width: 5rem;" title="Preview Output">
                {% render 'icon-inspect' %}
              </div>
            </div>
          </div>

          <div id="templateContainer" class="row mb-3" style="display: none;">
            <div class="col-md-6">
              <label for="templateSelect" class="form-label">Load Predefined Template</label>
              <select id="templateSelect" class="selectpicker form-select" data-live-search="true">
              </select>
            </div>
            <div class="col-md-6">
              <label for="ruleSelect" class="form-label">Rules</label>
              <div style="display: flex;width: 220px;">
                  <select id="ruleSelect" class="selectpicker form-select wide-select" multiple data-live-search="true">
                  </select>
                  <div onclick="editRules()" style="cursor:pointer;margin: auto;margin-left: 1rem;">
                      <a id="editIcon" href="#" title="Edit">
                    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="15" height="15" x="0px" y="0px" viewBox="0 0 117.74 122.88" style="enable-background:new 0 0 117.74 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path fill="#17161c" class="st0" d="M94.62,2c-1.46-1.36-3.14-2.09-5.02-1.99c-1.88,0-3.56,0.73-4.92,2.2L73.59,13.72l31.07,30.03l11.19-11.72 c1.36-1.36,1.88-3.14,1.88-5.02s-0.73-3.66-2.09-4.92L94.62,2L94.62,2L94.62,2z M41.44,109.58c-4.08,1.36-8.26,2.62-12.35,3.98 c-4.08,1.36-8.16,2.72-12.35,4.08c-9.73,3.14-15.07,4.92-16.22,5.23c-1.15,0.31-0.42-4.18,1.99-13.6l7.74-29.61l0.64-0.66 l30.56,30.56L41.44,109.58L41.44,109.58L41.44,109.58z M22.2,67.25l42.99-44.82l31.07,29.92L52.75,97.8L22.2,67.25L22.2,67.25z"/></g></svg>
                    </a>
                  </div>
              </div>
            </div>
          </div>

          <div id="includeReturnsContainer" class="row mb-3" style="display: none">
            <div class="col-md-6 d-flex align-items-center">
              <input type="checkbox" class="form-check-input me-2" id="useReturns">
              <label class="form-check-label" for="useReturns">Include Returns</label>
            </div>
            <div class="col-md-6 d-flex align-items-center" style="display: flex;align-items: baseline;">
              <input type="checkbox" class="form-check-input me-2" id="useBoughtFromSameCountry">
              <label class="form-check-label" for="useBoughtFromSameCountry">Include Bought From Same Country</label>
            </div>
          </div>

          <div class="text-center mt-4">
            <button id="saveReportButton" class="button" style="background-color: #17161c;" onclick="saveReportOpenModal()" disabled  title="Please select all settings">Save Template</button>
            <button id="nextButtonSummary" class="nextButton button button" onclick="nextStep(2)" disabled title="Please select all settings">Next</button>
          </div>
      </div>
  </div>



  <div class="step losensitive" id="step2" style="display: none;">
      <h2 class="heading">Confirm</h2>

        <div class="container">
          <div class="row mb-4">
            <div class="col-12">
              <h4 style="text-align: center;">Information</h4>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>Category</th>
                    <th>Start</th>
                    <th>End</th>
                    {% comment %} <th>Returns</th> {% endcomment %}
                    <th>Orderlist</th>
                    <th>Returnlist</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td id="confirm-country"></td>
                    <td id="confirm-category"></td>
                    <td id="confirm-start"></td>
                    <td id="confirm-end"></td>
                    {% comment %} <td id="confirm-returns"></td> {% endcomment %}
                    <td id="confirm-orderlist"></td>
                    <td id="confirm-returnlist"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="confirmNoAgency" class="row mb-4" style="gap:3rem;display: none;">
            <h4 style="text-align: center;">Template Selection</h4>
            <div class="col-md-4 mb-3">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title"><i class="bi bi-list"></i> Fields</h5>
                  <div class="separator"></div>
                  <ul id="confirm-fields" class="list-group list-group-flush"></ul>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title"><i class="bi bi-diagram-3"></i> Grouped By</h5>
                  <div class="separator"></div>
                  <ul id="confirm-groupby" class="list-group list-group-flush"></ul>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title"><i class="bi bi-funnel"></i> Selected Rules</h5>
                  <div class="separator"></div>
                  <ul id="confirm-rules" class="list-group list-group-flush"></ul>
                </div>
              </div>
            </div>
          </div>
          <div id="confirmAgency" class="row mb-3" style="gap:3rem;display: none;">
            <div class="col-mb-6 d-flex align-items-center">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title"><i class="bi bi-diagram-3"></i> Template Overview</h5>
                  <div class="separator"></div>
                  <ul id="confirm-template" class="list-group list-group-flush"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>

      <div class="text-center mt-4" style="margin-bottom: 3rem;">
          <button class="prevButton button button--secondary" onclick="prevStep(1)">Back</button>
          <button class="nextButton button" onclick="createReport()">Create Report</button>
      </div>
  </div>
  <div class="step losensitive" id="stepDone" style="display: none;">
    <h2 class="heading">Report in progress</h2>
    <div id="reportInProgress" style="margin: auto;width: 20%;text-align:center;margin-top: 10rem;    font-size: 14pt;">Report is in progress, you can leave this page. If you have any questions, please contact the support at <a href="mailto:info@for-sure.net">info@for-sure.net</a></div>
    <div id="reportFailed" style="display:none;margin: auto;width: 20%;text-align:center;margin-top: 10rem;    font-size: 14pt;">Failed to create report, please try again or contact the support at <a href="mailto:info@for-sure.net">info@for-sure.net</a></div>
    <div id="showReport" style="display:none">
      <div style="margin: auto;width: 20%;text-align:center;margin-top: 10rem;    font-size: 14pt;">Report finished</div>
      <a href="/pages/forsure-downloads" class="nextButton button" id="btnShowReports"
      style="margin: auto;width: fit-content;display: flex;margin-top: 3rem;">Show Reports</a>
    </div>
    <div class="navButtons">
          <a href="/pages/forsure-dashboard" class="nextButton button" id="btnOverview">Overview</a>
      </div>
  </div>
</div>
<div id="loadingSpinnerContainer" style="display: none;">
  <div id="loadingSpinner" style="display: block!important;"></div>
</div>
<div id="errorModal" class="losensitive" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:80%; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:100;">
  <div style="display:flex;gap:1rem;">
    <h2 id="error-modal-title">Errors</h2>
    <div style="display:flex;gap:1rem;margin: auto;margin-right: 1rem;height: fit-content;">
      <select id="resolutionSelect" style="padding 1rem">
      </select>
      <button id="nextErrorButton" class="nextButton button">Next</button>
    </div>
    <span class="closeError" onclick="closeErrorModal()">&times;</span>
  </div>
  <div id="error-description">
  </div>
  <div id="error-table-data"></div>
  <input id="fileid" type="hidden" style="display:none;">
  <input id="orders" type="hidden" style="display:none;">
</div>
<div id="modalOverlayError" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;">
</div>
<div id="previewContainerModal"  style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:80%; height:fit-content; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:100;">
  <div id="previewContainerModalContent" style="width: 95%;margin: auto;margin-bottom: 3rem;">
    <div style="display:flex;gap:1rem;margin: auto;margin-right: 1rem;height: fit-content;justify-content: space-between;">
      <h2 id="preview-modal-title">Preview</h2>
      <span class="closePreview" onclick="closePreviewModal()">&times;</span>
    </div>
    <div style="margin-bottom: 1rem;">
      <p>Example output format of the report. The data is only a sample and not the actual data.</p>
    </div>
    <div id="previewContainer" class="losensitive">
    </div>
  </div>
</div>
<div id="modalOverlayPreview" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;">
</div>
<div id="saveReportModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); height:fit-content; background:white; overflow:auto; padding:1rem; border-radius:10px; box-shadow:0 4px 8px rgba(0, 0, 0, 0.2); z-index:100;">
  <div id="previewContainerModalContent" style="margin: auto; margin: 3rem; max-width: 800px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h2 id="save-modal-title" style="margin: 0;">Save Report</h2>
      <span class="closeSave closePreview" onclick="closeSaveModal()" aria-label="Close">&times;</span>
    </div>

    <form onsubmit="saveReport(); return false;">
      <div style="margin-bottom: 1rem;">
        <label for="saveReportName" style="display: block; width: 100%;margin-bottom: 1rem;">Please enter a name for the report:</label>
        <input type="text" id="saveReportName" placeholder="Report Name" style="padding: 0.5rem;width: 100%;margin-bottom: 1rem;">
      </div>

      <div style="flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
        <div style="flex: 1; min-width: 180px;">
          <label for="recurrence" style="display: block; width: 100%;margin-bottom: 1rem;">Recurrence:</label>
          <select id="recurrence" class="selectpicker form-control wide-select" style="width: 100%; padding: 0.5rem;width: 100%;margin-bottom: 1rem;">
            <option value="none">None</option>
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="halfyearly">Half Yearly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div style="flex: 1; min-width: 180px;">
          <label for="saveReportDate" style="display: block; width: 100%;margin-top: 1rem;margin-bottom: 1rem;">Report Deadline:</label>
          <input type="date" id="saveReportDate" style="padding: 0.5rem;width: 100%;margin-bottom: 1rem;">
        </div>

        <div id="overwriteReportCheckboxContainer" style="flex: 1; min-width: 180px; display: none; align-items: center; gap: 0.5rem; margin-top: 1.5rem;width: 100%;margin-bottom: 1rem;">
          <input type="checkbox" id="overwriteReportCheckbox" name="overwriteReportCheckbox" value="true">
          <label for="overwriteReportCheckbox" style="margin: 0;">Overwrite Existing</label>
        </div>
      </div>

      <div style="text-align: right;">
        <button id="saveReportButton" class="button" type="submit" style="padding: 0.6rem 1.2rem;">Save</button>
      </div>
    </form>
  </div>

</div>
<div id="modalOverlaySave" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.5); z-index:99;">
</div>

<script>
async function cancreatereports() {
    try {
        if (window.userPermissions['forsure-report'] === true && window.userPermissions['report-creation'] === true) {
            document.getElementById('createNewReport').classList.remove('greyed_out');
            document.getElementById('createNewReportWrapper').classList.remove('greyed_out_wrapper');
        } else {
            document.getElementById('createNewReport').classList.add('greyed_out');
            document.getElementById('createNewReportWrapper').classList.add('greyed_out_wrapper');
        }
        if (window.userPermissions['forsure-report'] === true && window.userPermissions['report-upload'] === true) {
            document.getElementById('uploadExistingReports').classList.remove('greyed_out');
            document.getElementById('uploadExistingReportsWrapper').classList.remove('greyed_out_wrapper');
        } else {
            document.getElementById('uploadExistingReports').classList.add('greyed_out');
            document.getElementById('uploadExistingReportsWrapper').classList.add('greyed_out_wrapper');
        }
        if (window.userPermissions['forsure-report'] === true && window.userPermissions['report-creation'] === true && window.userPermissions['report-upload'] === false) {
          selectOption('new');  // For end customers, we don't need to show the upload option
        }
        if (window.userPermissions['forsure-report'] === true && window.userPermissions['report-creation'] === false && window.userPermissions['report-upload'] === true) {
          selectOption('upload');
        }

    } catch (error) {
        console.error(error.message);
        showMessage('Failed to get history ' + error.message, false);
    }
}

var ordersReceived = 0;
async function getOrdersReceived() {
  try {
    let data = await unifiedSendRequest(ORDERVOLUMES, {method: 'GET'});
    ordersReceived = data['Orders']['used'];
    nextStep(1);
  } catch (error) {
    console.error(error.message);
  }
}

const createReportBtn = document.getElementById('createReport');


const steps = document.querySelectorAll('.step');
const dropZones = document.querySelectorAll('.dropZone');

var guideToShow = null;
async function selectOption(option) {
    document.getElementById('chooseoption').style.display = 'none';
    if (option === 'new') {
        document.getElementById('uploadReport').style.display = 'none';
        nextStep(1);
        sessionStorage.setItem('currentFlow', 'new');
        guideToShow = 'new';
        await getOrdersReceived();
    } else if (option === 'upload') {
        getClientsFile();
        document.getElementById('step1').style.display = 'none';
        document.getElementById('uploadReport').style.display = 'block';
        sessionStorage.setItem('currentFlow', 'upload');
        guideToShow = 'upload';
    } else if (option === 'overview') {
      document.getElementById('step1').style.display = 'none';
      document.getElementById('uploadReport').style.display = 'none';
      document.getElementById('chooseoption').style.display = 'block';
    }
}

dropZones.forEach(dropZone => {
    const inputId = dropZone.getAttribute('data-input');
    const fileInput = document.getElementById(inputId);
    const output = document.getElementById('selected'+ inputId);
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = "#e0e0e0";
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = "";
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = "";

        const files = e.dataTransfer.files;
        const inputId = dropZone.getAttribute('data-input');
        const fileInput = document.getElementById(inputId);

        if (files.length) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });
    dropZone.addEventListener('click', function() {
        const inputId = dropZone.getAttribute('data-input');
        const fileInput = document.getElementById(inputId);
        fileInput.click();
    });


    fileInput.addEventListener('change', async function() {
        const fileList = document.getElementById('fileList_' + inputId);
        var availableProfiles  = null;
        if (inputId === 'report_list') {
          for (let i = 0; i < fileInput.files.length; i++) {
            const row = createNewFileRow(fileInput.files[i].name, availableProfiles, dropZone.getAttribute('data-url'), inputId, fileInput.files[i]);
            fileList.appendChild(row);
          }
        } else {
          availableProfiles = await getProfiles();
          for (let i = 0; i < fileInput.files.length; i++) {
            const row = createNewFileRowCreation(fileInput.files[i].name, availableProfiles, dropZone.getAttribute('data-url'), inputId, fileInput.files[i]);
            fileList.appendChild(row);
          }
          updateNextButton(dropZone.getAttribute('data-url'));
        }
    });
});


document.querySelectorAll('.fileList').forEach(fileList => {
    fileList.addEventListener('click', function(event) {
        event.stopPropagation(); // This stops the event from bubbling up
    });
});

async function getProfiles() {
  try {
    const data = await unifiedSendRequest(GETPROFILES, {method: 'GET'});
    return data;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get profiles ' + error.message, false);
    TOKEN = false;
  }
}

let selectedFilesOrders = {};
let selectedFilesReturns = {};
let selectedFilesReports = {};
let fileCounter = 0;

function generateUniqueId() {
    return `file-${Date.now()}-${fileCounter++}`;
}

function createNewFileRow(fileName, availableProfiles, dataUrl, inputId, file) {
    var orders = (dataUrl === 'uploadorders/');
    var returns = (dataUrl === 'uploadreturns/');
    var reports = (dataUrl === 'uploadreports/');
    if (reports) {
        document.getElementById('upload-textuploadreports/').style.display = 'none';
        document.getElementById('imagecontainer-imageuploadreports/').style.display = 'none';
    }

    // Create a new "card" for the file
    const row = document.createElement('div');
    row.classList.add('file-row'); // Styled as a grid item
    const uniqueId = generateUniqueId();

    // Add filename
    const nameCell = document.createElement('div');
    const invisibleSpace = "\u200B"; // Unicode zero-width space
    const updatedFileName = fileName.replace(/_/g, `_${invisibleSpace}`);
    nameCell.textContent = updatedFileName;
    nameCell.style.fontWeight = 'bold';
    nameCell.style.marginBottom = '0.5rem';
    row.appendChild(nameCell);

    // Add profiles dropdown (if applicable)
    if (availableProfiles !== null) {
        const profileCell = document.createElement('div');
        const select = document.createElement('select');
        select.classList.add('btn', 'bs-placeholder', 'btn-default');

        // Populate dropdown with profiles
        availableProfiles.forEach(profile => {
            const option = document.createElement('option');
            option.value = profile.id;
            option.textContent = profile.name;
            select.appendChild(option);
        });

        profileCell.appendChild(select);
        row.appendChild(profileCell);
    }

    // Add delete button
    const deleteCell = document.createElement('div');
    deleteCell.style.margin = 'auto';
    const deleteButton = document.createElement('button');
    deleteButton.classList.add('deletebtn');
    deleteButton.textContent = 'X';
    deleteButton.style.marginTop = '0.5rem';
    deleteButton.addEventListener('click', function () {
        // Remove the row from the grid
        row.remove();

        if (document.getElementById('fileList_report_list').children.length == 0 && dataUrl == 'uploadreports/') {
          document.getElementById('upload-imageuploadreports/').style.display = 'flex';
          document.getElementById('upload-imageuploadreports/').style.margin = 'auto';
        }
        // Additional logic to handle file deletion
        handleFileDeletion(uniqueId, orders, returns, reports, dataUrl);
    });

    deleteCell.appendChild(deleteButton);
    row.appendChild(deleteCell);

    // Adjust image width (if applicable)
    var image = document.getElementById('upload-image' + dataUrl);
    var currentWidth = image.clientWidth;
    var decrement = 30; // define how much to decrease each time

    var newWidth = currentWidth - decrement;
    if (!reports && newWidth > 0) {
        image.style.width = newWidth + 'px';
    }
    if (document.getElementById("nextBtn" + dataUrl.replace('/', ''))) {
        document.getElementById("nextBtn" + dataUrl.replace('/', '')).disabled = false;
    }
    if (orders) {
        selectedFilesOrders[uniqueId] = { file: file, filename: fileName };
    } else if (returns) {
        selectedFilesReturns[uniqueId] = { file: file, filename: fileName };
    } else if (reports) {
        selectedFilesReports[uniqueId] = { file: file, filename: fileName };
    }
    row.id = uniqueId;
    return row;
}

var dataUrlCurrent = '';

function createNewFileRowCreation(fileName, availableProfiles, dataUrl, inputId, file) {
  dataUrlCurrent = dataUrl;
  var orders = (dataUrl === 'uploadorders/');
  var returns = (dataUrl === 'uploadreturns/');
  var reports = false;

  // Create a new "card" for the file
  const row = document.createElement('div');
  row.classList.add('file-row'); // Styled as a grid item
  const uniqueId = generateUniqueId();
  row.style.display = 'block';
  row.id = uniqueId;
  var filePartTitle = document.createElement('div');
  filePartTitle.style.display = 'flex';
  filePartTitle.classList.add('file-part-title');
  var filePartProfile = document.createElement('div');
  filePartProfile.title = 'Click to create mapping';
  filePartProfile.classList.add('file-part-profile');
  var filePartError = document.createElement('div');
  filePartError.classList.add('file-part-error');
  // Add filename
  const nameCell = document.createElement('div');
  {% comment %} const invisibleSpace = "\u200B"; // Unicode zero-width space
  const updatedFileName = fileName.replace(/_/g, `_${invisibleSpace}`); {% endcomment %}
  var updatedFileName = fileName;
  if (updatedFileName.length > 20) {
    updatedFileName = updatedFileName.slice(0, 10) + '...' + updatedFileName.slice(-10);
  }
  nameCell.textContent = updatedFileName;
  nameCell.style.fontWeight = 'bold';
  nameCell.style.marginBottom = '0.5rem';
  nameCell.style.cursor = 'pointer';
  nameCell.style.margin = 'auto';
  nameCell.addEventListener('click', async () => {
    await openProfileModal(availableProfiles, fileName, file, row.id, orders, returns);
  });
  filePartTitle.appendChild(nameCell);

  filePartTitle.appendChild(deleteButton(uniqueId, orders, returns, reports, dataUrl, row));

  // Add profile name
  const profileNameCell = document.createElement('div');
  profileNameCell.classList.add('profile-name');
  profileNameCell.textContent = 'Unmapped';
  profileNameCell.style.fontWeight = 'bold';
  profileNameCell.style.color = 'red';
  profileNameCell.style.margin = 'auto';
  profileNameCell.dataset.value = '';
  profileNameCell.addEventListener('click', async () => {
    await openProfileModal(availableProfiles, fileName, file, row.id, orders, returns);

  });
  filePartProfile.appendChild(profileNameCell);

  // Adjust image width (if applicable)
  updateImageWidth(dataUrl);

  if (orders) {
      selectedFilesOrders[uniqueId] = { file: file, filename: fileName };
  } else if (returns) {
      selectedFilesReturns[uniqueId] = { file: file, filename: fileName };
  }
  row.appendChild(filePartTitle);
  row.appendChild(filePartProfile);
  row.appendChild(filePartError);
  const resolvedCell = document.createElement('div');
  resolvedCell.classList.add('resolve-cell');
  resolvedCell.textContent = 'Click to resolve';
  resolvedCell.addEventListener('click', async () => {
    await openProfileModal(availableProfiles, fileName, file, row.id, orders, returns);
  });
  row.appendChild(resolvedCell);
  setTimeout(() => {
    row.style.transition = 'background-color 0.6s ease';
    row.style.backgroundColor = '#2255ff'; // light yellow

    setTimeout(() => {
        row.style.backgroundColor = '';
    }, 500);
  }, 100);
  return row;
}

var zeroDeclarationRows = {};
var zeroDeclarationToAdd = {};
function createNewFileRowZeroDeclaration(country, reportType, pro, timeframe, year, company) {
  // Create a new "card" for the file
  const row = document.createElement('div');
  row.classList.add('file-row'); // Styled as a grid item
  const uniqueId = 'Zero Declaration ' + country + ' ' + reportType + ' ' + pro + ' ' + timeframe + ' ' + year + ' ' + company;
  if (zeroDeclarationRows[uniqueId]) {
    return;
  }
  // Add filename
  const nameCell = document.createElement('div');
  nameCell.textContent = 'Zero Declaration ' + company + ' ' + country+ ' ' + reportType;
  nameCell.style.fontWeight = 'bold';
  nameCell.style.marginBottom = '0.5rem';
  row.appendChild(nameCell);

  // Add delete button
  const deleteCell = document.createElement('div');
  deleteCell.style.margin = 'auto';
  const deleteButton = document.createElement('button');
  deleteButton.classList.add('deletebtn');
  deleteButton.textContent = 'X';
  deleteButton.style.marginTop = '0.5rem';
  deleteButton.addEventListener('click', function () {
      // Remove the row from the grid
      row.remove();
      if (document.getElementById('fileList_report_list').children.length == 0) {
        document.getElementById('upload-imageuploadreports/').style.display = 'flex';
        document.getElementById('upload-imageuploadreports/').style.margin = 'auto';
      }
      delete zeroDeclarationRows[uniqueId];
  });

  deleteCell.appendChild(deleteButton);
  row.appendChild(deleteCell);
  zeroDeclarationRows[uniqueId] = {report_id: uniqueId, country: country, report_type: reportType, pro: pro, timeframe: timeframe, year: year, company: company};
  row.id = uniqueId;
  return row;
}

function updateNextButton(dataUrl) {
  var allFilesValid = true;
  var allfiles = document.querySelectorAll('.file-row');
  allfiles.forEach(file => {
    if (file.querySelector('.profile-name').getAttribute('data-value') === '') {
      allFilesValid = false;
    }
    if (file.querySelector('.file-part-error').getAttribute('data-value') === 'error') {
      allFilesValid = false;
    }
  });
  if (allfiles.length === 0 && ordersReceived == 0) {
    allFilesValid = false;
  }
  if (allFilesValid) {
    if (document.getElementById("nextBtn" + dataUrl.replace('/', ''))) {
      document.getElementById("nextBtn" + dataUrl.replace('/', '')).disabled = false;
      return;
    }
  }
  document.getElementById("nextBtn" + dataUrl.replace('/', '')).disabled = true;
}

function updateImageWidth(dataUrl) {
  var image = document.getElementById('upload-image' + dataUrl);
  var currentWidth = image.clientWidth;
  var decrement = 30; // define how much to decrease each time

  var newWidth = currentWidth - decrement;
  if (newWidth > 0) {
      image.style.width = newWidth + 'px';
  }
}

function deleteButton(uniqueId, orders, returns, reports, dataUrl, row) {
  // Add delete button
  const deleteCell = document.createElement('div');
  deleteCell.style.margin = 'auto';
  const deleteButton = document.createElement('button');
  deleteButton.classList.add('deletebtn');
  deleteButton.textContent = 'X';
  deleteButton.style.margin = 'auto';
  deleteButton.addEventListener('click', function (event) {
    event.stopPropagation();
      // Remove the row from the grid
      row.remove();

      // Additional logic to handle file deletion
      handleFileDeletion(uniqueId, orders, returns, reports, dataUrl);
      updateNextButton(dataUrl);
  });
  return deleteButton;
}

async function parseCSV(text, nrows=3) {
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      preview: nrows,
      complete: function(results) {
        const data = results.data;
        const columnDict = {};

        if (data.length > 0) {
          const keys = Object.keys(data[0]);
          keys.forEach(key => {
            columnDict[key] = data.map(row => row[key]);
          });
        }
        resolve(columnDict);
      },
      error: function(err) {
        console.error(err);
        showMessage('Error parsing file ' + err.message, false);
        reject(err);
      }
    });
  });
}

async function parseExcel(file, nrows = 3) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];

        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        const headers = jsonData[0];
        const rows = jsonData.slice(1, nrows + 1);

        const columnDict = {};
        headers.forEach((header, colIndex) => {
          columnDict[header] = rows.map(row => row[colIndex] ?? '');
        });

        resolve(columnDict);
      } catch (err) {
        console.error(err);
        showMessage('Error parsing Excel file: ' + err.message, false);
        reject(err);
      }
    };
    reader.onerror = err => reject(err);
    reader.readAsArrayBuffer(file);
  });
}


async function openProfileModal(availableProfiles, fileName, fileInput, rowId, orders, returns) {
  {% comment %} if (fileInput.type !== 'text/csv' && fileInput.type !== 'application/vnd.ms-excel') {
    showMessage('Please upload a CSV file', false);
    return;
  } {% endcomment %}
  let csvData;
  if (fileInput.name.endsWith('.csv')) {
    var text;
    if (orders) {
      if (rowId in selectedFilesOrders && selectedFilesOrders[rowId].text) {
        text = selectedFilesOrders[rowId].text;
      } else {
        text = await fileInput.text();
        selectedFilesOrders[rowId].text = text;
      }
    } else if (returns) {
      if (rowId in selectedFilesReturns && selectedFilesReturns[rowId].text) {
        text = selectedFilesReturns[rowId].text;
      } else {
        text = await fileInput.text();
        selectedFilesReturns[rowId].text = text;
      }
    }
    csvData = await parseCSV(text);
  } else if (
    fileInput.name.endsWith('.xls') ||
    fileInput.name.endsWith('.xlsx') ||
    fileInput.type.includes('sheet')
  ) {
    csvData = await parseExcel(fileInput);
  } else {
    showMessage('Unsupported file type. Please upload a CSV or Excel file.', false);
    return;
  }
  const modal = document.getElementById('profileModal');
  modal.dataset.row = rowId;
  {% comment %} try { {% endcomment %}

  await addProfileModal(availableProfiles, fileName, csvData, modal);
  setTimeout(() => {
    updateSaveButton();
  }, 200);
}

var requiredMappings = new Set();
async function addProfileModal(availableProfiles, fileName, csvData, modal) {
    if (dataUrlCurrent == 'uploadorders/') {
      var labelsV2Options = await getOrderlistLabelsV2Options();
    } else {
      var labelsV2Options = await getReturnlistLabelsV2Options();
    }
    requiredMappings.clear();
    labelsV2Options.forEach(option => {
      if (option.required) {
        requiredMappings.add((option));
      }
    });
    const profileSelect = document.getElementById('profileSelect');
    const profileDetails = document.getElementById('profileDetails');
    const profileFileName = document.getElementById('profileFileName');
    profileFileName.textContent = fileName;
    var profileTable = document.getElementById('profileTableBody');
    profileTable.innerHTML = '';
    Object.keys(csvData).forEach((key, index) => {
      const tr = document.createElement('tr');
      const tdKey = document.createElement('td');
      tdKey.textContent = key;
      tr.appendChild(tdKey);
      const tdEntry = document.createElement('td');
      var preview = csvData[key].join(', ');
      if (preview.length > 50) { // limit the preview to 100 characters
        preview = preview.slice(0, 50) + '...';
      }
      tdEntry.textContent = preview;
      tr.appendChild(tdEntry);

      const tdMapping = document.createElement('td');
      const selectMapping = document.createElement('select');
      selectMapping.classList.add('btn', 'bs-placeholder', 'btn-default');
      var defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Unmapped';
      defaultOption.selected = true;
      selectMapping.appendChild(defaultOption);
      selectMapping.setAttribute('data-name', key);
      labelsV2Options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.key;
        var star = '';
        if (option.required) {
          star = ' *';
        }
        optionElement.textContent = option.title + star;
        optionElement.setAttribute('data-description', option.description);
        optionElement.title = option.description;
        selectMapping.appendChild(optionElement);
      });
      selectMapping.addEventListener('change', function() {
        updateSaveButton();
      });
      tdMapping.appendChild(selectMapping);
      tr.appendChild(tdMapping);

      const tdExclude = document.createElement('td');
      const checkboxExclude = document.createElement('input');
      checkboxExclude.type = 'checkbox';
      checkboxExclude.title = 'Exclude this column from the upload';
      checkboxExclude.addEventListener('change', function() {
        toggleExclude(checkboxExclude);
      });
      tdExclude.appendChild(checkboxExclude);
      tr.appendChild(tdExclude);
      profileTable.appendChild(tr);
    });
    {% comment %} } catch (error) {
      console.error(error.message);
      showMessage('Failed to parse file ' + fileName, false);
      return;
    } {% endcomment %}


    // Populate the select dropdown
    profileSelect.innerHTML = '';
    availableProfiles.forEach(profile => {
      const option = document.createElement('option');
      option.value = profile.id;
      option.textContent = profile.name;
      profileSelect.appendChild(option);
    });
    addNewProfileOption(profileSelect);
    if (dataUrlCurrent == 'uploadorders/') {
      getOrderlistLabels(profileSelect.value);
    } else {
      getReturnlistLabels(profileSelect.value);
    }
    // Display column details (mockup for demonstration)

    // Show the modal
    modal.style.display = 'block';

    // Close modal on click of close button
    document.querySelector('.close').onclick = function() {
      modal.style.display = 'none';
    };
}

function updateSaveButton() {
  const saveProfile = document.getElementById('saveProfile');
  const profileTable = document.getElementById('profileTableBody');
  const rows = profileTable.querySelectorAll('tr');
  const foundMappings = Array.from(rows).map(row => {
    const dropdown = row.querySelector('select');
    return dropdown ? dropdown.value : null;
  });
  var allRequiredMapped = true;
  const errorBox = document.getElementById('profileErrorMessage');
  errorBox.textContent = '';
  errorBox.style.display = 'none';
  for (const mapping of requiredMappings) {
    if (!foundMappings.includes(mapping.key)) {
      allRequiredMapped = false;
      errorBox.textContent = 'Required mapping not found for ' + mapping.title;
      errorBox.style.display = 'block';
      break;
    }
  }
  saveProfile.disabled = !allRequiredMapped;
}

function toggleExclude(checkbox) {
  const row = checkbox.parentElement.parentElement;
  const exclude = checkbox.checked;
  row.classList.toggle('exclude', exclude);
  row.querySelector('select').disabled = exclude;
}
var request_data = {};

async function saveMapping() {
  const selectedProfile = document.getElementById('profileSelect').value;
  const mapping = {};
  const profileTable = document.getElementById('profileTableBody');
  const rows = profileTable.querySelectorAll('tr');
  rows.forEach(row => {
    var dropdown = row.querySelector('select');
    var key = dropdown.getAttribute('data-name');
    if (!dropdown.disabled) {
      var value = dropdown.value;
      mapping[key] = value;
    }
  });
  request_data = {'profile': selectedProfile, 'mapping': mapping};
  var url = GETORDERLISTLABELSV2COMPARE;
  if (dataUrlCurrent == 'uploadreturns/') {
    url = GETRETURNLISTLABELSV2COMPARE;
  }

  try {
    var response = await unifiedSendRequest(url, {formData: JSON.stringify(request_data), headerArgs: {'Content-Type': 'application/json'}});
    if (response) {
      confirmOverwrite();
    } else {
      showConfirmOverwriteModal();
    }
  } catch (error) {
    console.error(error.message);
    showMessage(error.message, false);
  }
}

async function confirmOverwrite() {
  try {
    var url = GETORDERLISTLABELSV2;
    if (dataUrlCurrent == 'uploadreturns/') {
      url = GETRETURNLISTLABELSV2;
    }
    var response = await unifiedSendRequest(url, {formData: JSON.stringify(request_data), headerArgs: {'Content-Type': 'application/json'}});
    document.getElementById('profileModal').style.display = 'none';
    showMessage('Mapping saved successfully', true);
    var fileId = document.getElementById('profileModal').dataset.row;
    var rowElement = document.getElementById(fileId);
    var profileName = document.getElementById('profileSelect').options[document.getElementById('profileSelect').selectedIndex].textContent;
    rowElement.querySelector('.profile-name').textContent = profileName;
    rowElement.querySelector('.profile-name').dataset.value = profileName;
    rowElement.querySelector('.profile-name').dataset.id = document.getElementById('profileSelect').value;
    rowElement.querySelector('.profile-name').style.color = 'green';
    if (dataUrlCurrent == 'uploadreturns/') {
      const filteredFile = await parseAndFilterCSV(selectedFilesReturns[fileId].text, request_data, selectedFilesReturns[fileId].file.name, selectedFilesReturns[fileId].file.type, selectedFilesReturns[fileId].file.lastModified, selectedFilesReturns[fileId].file.lastModifiedDate);
      selectedFilesReturns[fileId]['fileFiltered'] = filteredFile;
      selectedFilesReturns[fileId]['profileId'] = document.getElementById('profileSelect').value;
    } else {
      const filteredFile = await parseAndFilterCSV(selectedFilesOrders[fileId].text, request_data, selectedFilesOrders[fileId].file.name, selectedFilesOrders[fileId].file.type, selectedFilesOrders[fileId].file.lastModified, selectedFilesOrders[fileId].file.lastModifiedDate);
      selectedFilesOrders[fileId]['fileFiltered'] = filteredFile;
      selectedFilesOrders[fileId]['profileId'] = document.getElementById('profileSelect').value;
    }
    closeConfirmOverwriteModal();
    if (dataUrlCurrent == 'uploadreturns/') {
      await checkReturnsFile(fileId, rowElement);
    } else {
      await checkOrdersFile(fileId, rowElement);
    }
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to save mapping ' + error.message, false);
  }
}

async function parseAndFilterCSV(text, allowedColumns, fileName, fileType, lastModified, lastModifiedDate) {
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const filteredData = results.data.map(row => {
          const filteredRow = {};
          for (const key in row) {
            if (allowedColumns['mapping'].hasOwnProperty(key)) {
              filteredRow[key] = row[key];
            }
          }
          return filteredRow;
        });
        const csv = Papa.unparse(filteredData);
        const blob = new File([csv], fileName, {
          type: fileType,
          lastModified: lastModified,
          lastModifiedDate: lastModifiedDate,
        });
        resolve(blob);
      },
      error: function(err) {
        console.error(err);
        showMessage('Error parsing file ' + err.message, false);
        reject(err);
      }
    });
  });
}

async function checkOrdersFile(fileId, rowElement) {
  var file = selectedFilesOrders[fileId];
  var formData = new FormData();
  formData.append('order_list', file.fileFiltered);
  formData.append('profile', file.profileId);
  formData.append('file_id', fileId);
  var response = await unifiedSendRequest(CHECKORDERSFILE, {formData: formData});
  if (response.success) {
    selectedFilesOrders[fileId]['failed'] = {};
    rowElement.querySelector('.file-part-error').textContent = '';
    rowElement.querySelector('.file-part-error').style.display = 'none';
    rowElement.querySelector('.resolve-cell').style.display = 'none';
    rowElement.style.color = '#17161c';
  } else {
    var details = {};
    for (const [k, v] of Object.entries(response.details)) {
      details[k] = JSON.parse(v);
    }
    selectedFilesOrders[fileId]['failed'] = details;
    selectedFilesOrders[fileId]['failedDescription'] = response.description;
    rowElement.querySelector('.file-part-error').textContent = `${response.missing_orders}/${response.total_orders} orders failed`;
    rowElement.querySelector('.file-part-error').style.display = 'block';
    rowElement.style.cursor = 'pointer';
    rowElement.style.color = 'red';
    rowElement.querySelector('.file-part-error').setAttribute('data-value', 'error');
    rowElement.onclick = function() {
      displayErrorReport(details, fileId, true);
    }
    rowElement.querySelector('.file-part-profile').classList.add('disableclicks');
    rowElement.querySelector('.file-part-title div').classList.add('disableclicks');
    rowElement.querySelector('.resolve-cell').classList.add('disableclicks');
    rowElement.querySelector('.resolve-cell').style.display = 'block';
  }
  updateNextButton(dataUrlCurrent);
}


async function checkReturnsFile(fileId, rowElement) {
  var file = selectedFilesReturns[fileId];
  var formData = new FormData();
  formData.append('return_list', file.fileFiltered);
  formData.append('profile', file.profileId);
  formData.append('file_id', fileId);
  var response = await unifiedSendRequest(CHECKRETURNSFILE, {formData: formData});
  if (response.success) {
    selectedFilesReturns[fileId]['failed'] = {};
    rowElement.querySelector('.file-part-error').textContent = '';
    rowElement.querySelector('.file-part-error').style.display = 'none';
    rowElement.querySelector('.resolve-cell').style.display = 'none';
    rowElement.style.color = '#17161c';
  } else {
    var details = {};
    for (const [k, v] of Object.entries(response.details)) {
      details[k] = JSON.parse(v);
    }
    selectedFilesReturns[fileId]['failed'] = details;
    selectedFilesReturns[fileId]['failedDescription'] = response.description;
    rowElement.querySelector('.file-part-error').textContent = `${response.missing_returns}/${response.total_returns} returns failed`;
    rowElement.querySelector('.file-part-error').style.display = 'block';
    rowElement.style.cursor = 'pointer';
    rowElement.style.color = 'red';
    rowElement.querySelector('.file-part-error').setAttribute('data-value', 'error');
    rowElement.onclick = function() {
      displayErrorReport(details, fileId, false);
    }
    rowElement.querySelector('.file-part-profile').classList.add('disableclicks');
    rowElement.querySelector('.file-part-title div').classList.add('disableclicks');
    rowElement.querySelector('.resolve-cell').classList.add('disableclicks');
    rowElement.querySelector('.resolve-cell').style.display = 'block';
  }
  updateNextButton(dataUrlCurrent);
}


let currentErrorIndex = 0;
var resolutionMap = {};

function displayErrorReport(data, fileId, orders) {
  currentErrorIndex = 0;
  resolutionMap = {};  // Reset previous selections

  document.getElementById('errorModal').style.display = 'block';
  document.getElementById('modalOverlayError').style.display = 'block';
  document.getElementById('fileid').value = fileId;
  document.getElementById('orders').value = orders;
  loadErrorAtIndex(currentErrorIndex);
}

function loadErrorAtIndex(index) {
  const tableContainer = document.getElementById('error-table-data');
  tableContainer.innerHTML = ''; // Clear previous table
  var orders = document.getElementById('orders').value;
  var fileId = document.getElementById('fileid').value;
  var file = {};
  if (orders == 'true') {
    file = selectedFilesOrders[fileId];
  } else {
    file = selectedFilesReturns[fileId];
  }
  var errorTypes = Object.keys(file['failed']);
  if (index >= errorTypes.length) {
    file['resolutions'] = resolutionMap;
    var row = document.getElementById(fileId);
    row.style.color = '#17161c';
    var errorRow = row.querySelector('.file-part-error');
    errorRow.textContent = 'Resolved';
    errorRow.setAttribute('data-value', 'resolved');
    closeErrorModal();
    row.querySelector('.file-part-profile').classList.remove('disableclicks');
    row.querySelector('.file-part-title div').classList.remove('disableclicks');
    row.querySelector('.resolve-cell').classList.remove('disableclicks');
    row.querySelector('.resolve-cell').style.display = 'none';
    row.onclick = null;
    updateNextButton(dataUrlCurrent);
    return;
  }
  if (index == errorTypes.length - 1) {
    document.getElementById('nextErrorButton').textContent = 'Save';
  } else {
    document.getElementById('nextErrorButton').textContent = 'Next';
  }
  const errorType = errorTypes[index];
  const entries = file['failed'][errorType];
  var defaultResolution = 'ignore';
  document.getElementById('error-description').textContent = file['failedDescription'][errorType];
  // Update title
  if (errorType.includes('Duplicated')) {
    // update resolutionSelect to contain keep first and keep last
    const resolutionSelect = document.getElementById('resolutionSelect');
    resolutionSelect.innerHTML = '';
    const option1 = document.createElement('option');
    option1.value = 'keep_first';
    option1.textContent = 'Keep First';
    option1.title = 'Keep the first value and ignore the other values';
    resolutionSelect.appendChild(option1);
    const option2 = document.createElement('option');
    option2.value = 'keep_last';
    option2.textContent = 'Keep Last';
    option2.title = 'Keep the last value and ignore the other values';
    resolutionSelect.appendChild(option2);
    defaultResolution = 'keep_first';
  } else {
    resolutionSelect.innerHTML = '';
    const option1 = document.createElement('option');
    option1.value = 'ignore';
    option1.textContent = 'Keep old';
    option1.title = 'Keep the old values and ignore the new values';
    resolutionSelect.appendChild(option1);
    const option2 = document.createElement('option');
    option2.value = 'replace';
    option2.textContent = 'Replace';
    option2.title = 'Replace the old values with the new values';
    resolutionSelect.appendChild(option2);
    defaultResolution = 'ignore';
  }
  document.getElementById('error-modal-title').innerText = `Error: ${errorType}`;

  // Default resolution (if not set before)
  document.getElementById('resolutionSelect').value = resolutionMap[errorType] || defaultResolution;
  var sheetData = Object.values(entries);
  // Render Tabulator table
  new Tabulator("#error-table-data", {
    data: sheetData,
    layout: "fitDataFill",
    responsiveLayout: false,
    autoColumns: true,
    pagination: sheetData.length > 10,
    paginationCounter: "rows",
    paginationSize: 10
  });
}

// Save resolution and show next error
document.getElementById('nextErrorButton').addEventListener('click', () => {
  const resolution = document.getElementById('resolutionSelect').value;
  var orders = document.getElementById('orders').value;
  var fileId = document.getElementById('fileid').value;
  var file = {};
  if (orders == 'true') {
    file = selectedFilesOrders[fileId];
  } else {
    file = selectedFilesReturns[fileId];
  }
  const currentError = Object.keys(file['failed'])[currentErrorIndex];
  resolutionMap[currentError] = resolution;

  currentErrorIndex++;
  loadErrorAtIndex(currentErrorIndex);
});

document.getElementById('modalOverlayError').addEventListener('click', function() {
  closeErrorModal();
});

function closeErrorModal() {
  document.getElementById('errorModal').style.display = 'none';
  document.getElementById('modalOverlayError').style.display = 'none';
}


async function closeConfirmOverwriteModal() {
  document.getElementById('confirmOverwriteModal').style.display = 'none';
  updateNextButton(dataUrlCurrent);
}
async function showConfirmOverwriteModal() {
  document.getElementById('confirmOverwriteModal').style.display = 'block';
}

async function getOrderlistLabelsV2Options() {
  try {
    const data = await unifiedSendRequest(GETORDERLISTLABELSV2OPTIONS, {method: 'GET'});
    return data;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get orderlist label options ' + error.message, false);
    TOKEN = false;
  }
}

async function getReturnlistLabelsV2Options() {
  try {
    const data = await unifiedSendRequest(GETRETURNLISTLABELSV2OPTIONS, {method: 'GET'});
    return data;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get orderlist label options ' + error.message, false);
    TOKEN = false;
  }
}


function addNewProfileOption(profileSelect) {
  const addProfileOption = document.createElement('option');
  addProfileOption.value = 'add_new';
  addProfileOption.textContent = 'Add New Profile';
  profileSelect.appendChild(addProfileOption);
}


// Add an event listener to the SVG for click events
document.getElementById("editIcon").addEventListener("click", async function() {
  const dropdown = document.getElementById("profileSelect");
  const selectedOption = dropdown.options[dropdown.selectedIndex];
  const editIcon = document.getElementById("editIcon");

  // Change the selected option to an input field to edit the name
  const input = document.createElement("input");
  input.value = selectedOption.text;
  input.style.width = "70%";
  input.style.marginRight = '1rem';
  const checkIcon = document.createElement("span");
  checkIcon.innerHTML = "âœ”";
  checkIcon.style.cursor = "pointer";
  checkIcon.style.marginRight = "5px";
  const xIcon = document.createElement("span");
  xIcon.innerHTML = "âœ–";
  xIcon.style.cursor = "pointer";
  xIcon.style.marginRight = "5px";
  const deleteIcon = document.createElement("span");
  deleteIcon.innerHTML = '<img width="20px" src="{{ section.settings.trashcan | image_url }}" alt="{{ section.settings.trashcan.alt | escape }}" loading="lazy">';
  deleteIcon.style.cursor = "pointer";

  input.addEventListener("keyup", async function(event) {
      // If "Enter" key is pressed
      if (event.key === "Enter") {
          await handleSave();
      }
  });

  checkIcon.addEventListener("click", async function() {
      await handleSave();
  });
  async function handleSave() {
      selectedOption.text = input.value;
      try {
              var profile = {
                'id': selectedOption.value,
                'name': input.value
              }
              var response = await unifiedSendRequest(PROFILERENAME, {formData: JSON.stringify(profile), headerArgs: {'Content-Type': 'application/json'}});
          } catch (error) {
              console.error(error.message);
              showMessage('Failed to rename profile ' + error.message, false);
          }
      revertToOriginalState();
  }
  xIcon.addEventListener("click", function() {
      // Revert without changes
      revertToOriginalState();
  });
  function revertToOriginalState() {
    // Remove the input field and icons, show the dropdown and editIcon
    dropdown.parentElement.removeChild(input);
    dropdown.parentElement.removeChild(checkIcon);
    dropdown.parentElement.removeChild(deleteIcon);
    dropdown.parentElement.removeChild(xIcon);
    dropdown.style.removeProperty('display');  // Remove the display style
    editIcon.style.display = "inline";
}

deleteIcon.addEventListener("click", async function() {
    const isConfirmed = confirm("Are you sure you want to delete this profile?");
    if (isConfirmed) {
        try {
            // Send request to DELETEPROFILE endpoint
            const profileIdToDelete = selectedOption.value;
            const response = await unifiedSendRequest(DELETEPROFILE + `?profile_id=${profileIdToDelete}`, {method: 'DELETE'});

            // Check if deletion was successful
            if (response.success) {
                // Remove the profile from the dropdown
                dropdown.remove(dropdown.selectedIndex);
                revertToOriginalState();
            } else {
                alert("Failed to delete the profile.");
            }
        } catch (error) {
            console.error(error.message);
            showMessage('Failed to delete profile ' + error.message, false);
        }
    }
  });

  // Hide the dropdown and editIcon, and insert the input and icons
  dropdown.style.display = "none";
  editIcon.style.display = "none";
  dropdown.parentElement.insertBefore(input, dropdown);
  dropdown.parentElement.insertBefore(checkIcon, dropdown);
  dropdown.parentElement.insertBefore(xIcon, dropdown);
  dropdown.parentElement.insertBefore(deleteIcon, dropdown);
  input.focus();
});

document.getElementById("profileSelect").addEventListener("change", async function() {
  const dropdown = this;
  if (dropdown.value === "add_new") {
      try {
          // Send request to ADDPROFILE
          const profileName = `Profile ${dropdown.options.length}`;
          var profile = {
            name: profileName,
            liveData: false
          }
          var response = await unifiedSendRequest(ADDPROFILE, {formData: JSON.stringify(profile), headerArgs: {'Content-Type': 'application/json'}});
          // Remove the "add_new" option that was selected
          dropdown.remove(dropdown.selectedIndex);
          // Assume the response contains the new profile's ID
          const newProfileId = response.id;

          // Create a new profile option
          const newOption = document.createElement("option");
          newOption.value = newProfileId;
          newOption.text = response.name;
          dropdown.appendChild(newOption);

          // Re-add the "Add New Profile" option
          const addProfileOption = document.createElement("option");
          addProfileOption.value = "add_new";
          addProfileOption.text = "Add New Profile";
          dropdown.appendChild(addProfileOption);

          // Optionally, select the newly added profile
          newOption.selected = true;

      } catch (error) {
          console.error(error.message);
          showMessage('Failed to add profile ' + error.message, false);
      }
  } else {
    if (dataUrlCurrent == 'uploadorders/') {
      getOrderlistLabels(dropdown.value);
    } else {
      getReturnlistLabels(dropdown.value);
    }
  }

});

async function getOrderlistLabels(profile) {
  try {
    var orderlistLabels = await unifiedSendRequest(GETORDERLISTLABELSV2 + `?profile=${profile}`, {method: 'GET'});
    var profileTable = document.getElementById('profileTableBody');
    if (Object.keys(orderlistLabels).length > 0) {
      profileTable.querySelectorAll('tr').forEach(row => {
        var select = row.querySelector('select');
        if (select.getAttribute('data-name') in orderlistLabels) {
          select.value = orderlistLabels[select.getAttribute('data-name')];
        } else {
          row.querySelector('input').click(); // if the column is not in the orderlist labels, then it is excluded
        }
      });
    } else {
      // new profile, so set all to unmapped
      profileTable.querySelectorAll('tr').forEach(row => {
        var select = row.querySelector('select');
        select.value = '';
        if (row.querySelector('input').checked) {
          row.querySelector('input').click();
        }
      });
    }
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get orderlist labels ' + error.message, false);
  }
}

async function getReturnlistLabels(profile) {
  try {
    var returnlistLabels = await unifiedSendRequest(GETRETURNLISTLABELSV2 + `?profile=${profile}`, {method: 'GET'});
    var profileTable = document.getElementById('profileTableBody');
    if (Object.keys(returnlistLabels).length > 0) {
      profileTable.querySelectorAll('tr').forEach(row => {
        var select = row.querySelector('select');
        if (select.getAttribute('data-name') in returnlistLabels) {
          select.value = returnlistLabels[select.getAttribute('data-name')];
        } else {
          row.querySelector('input').click(); // if the column is not in the orderlist labels, then it is excluded
        }
      });
    } else {
      // new profile, so set all to unmapped
      profileTable.querySelectorAll('tr').forEach(row => {
        var select = row.querySelector('select');
        select.value = '';
        if (row.querySelector('input').checked) {
          row.querySelector('input').click();
        }
      });
    }
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get returnlist labels ' + error.message, false);
  }
}

function handleFileDeletion(uniqueId, orders, returns, reports, dataUrl) {
  if (orders) {
    if (selectedFilesOrders.hasOwnProperty(uniqueId)) {
      delete selectedFilesOrders[uniqueId];
    } else {
        console.log("Order File not found: ", uniqueId);
    }
  } else if (returns) {
    if (selectedFilesReturns.hasOwnProperty(uniqueId)) {
      delete selectedFilesReturns[uniqueId];
    } else {
        console.log("Return File not found: ", uniqueId);
    }
  } else if (reports) {
    if (selectedFilesReports.hasOwnProperty(uniqueId)) {
      delete selectedFilesReports[uniqueId];
    } else {
        console.log("Report File not found: ", uniqueId);
    }
    if (Object.keys(selectedFilesReports).length == 0) {
      document.getElementById('upload-textuploadreports/').style.display = 'block';
      document.getElementById('imagecontainer-imageuploadreports/').style.display = 'block';
    }
  }
  var image = document.getElementById('upload-image'+ dataUrl);
    var currentWidth = image.clientWidth;
    var increment = 30; // define how much to increase each time

    var newWidth = currentWidth + increment;
    image.style.width = newWidth + 'px';
}


async function uploadReports() {
    if (Object.keys(selectedFilesReports).length === 0 && Object.keys(zeroDeclarationRows).length === 0) {
      showMessage('Please upload your reports first', false);
      return;
    }
    document.getElementsByClassName('dropZone')[0].style.cursor = 'wait';
    if (Object.keys(zeroDeclarationRows).length > 0) {
      submitZeroDeclaration();
    }
    if (Object.keys(selectedFilesReports).length == 0) {
      document.getElementById('fileList_report_list').innerHTML = '';
      document.getElementsByClassName('dropZone')[0].style.cursor = 'pointer';
      return;
    }
    const formData = new FormData();
    // Assuming each row in your table has a class 'file-row'
    const rows = document.querySelectorAll('.file-row');
    rows.forEach((row, index)=> {
        const fileId = row.id;
        if (selectedFilesReports.hasOwnProperty(fileId)){
            formData.append('reports', selectedFilesReports[fileId].file);
            formData.append('fileId', fileId);
        }
    });

    try {
        const data = await unifiedSendRequest(UPLOADREPORTS, { formData: formData });
        // Check if an error message already exists
        if (data['status_code'] === 400) {
          data['data'].forEach(failedData => {
            var failedRow = document.getElementById(failedData['file_id']);
            failedRow.style.color = 'red';
            let errorMessage = failedRow.querySelector('.upload-error-message');
            if (!errorMessage) {
              errorMessage = document.createElement('td');

              errorMessage.className = 'upload-error-message';
              errorMessage.style.color = "red";
              errorMessage.textContent = failedData["error"];
              failedRow.appendChild(errorMessage);
            }

          });
        } else {
          showMessage('Successfully uploaded reports, they will be handed in now', true);
          document.getElementById('fileList_report_list').innerHTML = '';

          document.getElementById('upload-textuploadreports/').style.display = 'block';
          document.getElementById('imagecontainer-imageuploadreports/').style.display = 'block';
        }
        document.getElementsByClassName('dropZone')[0].style.cursor = 'pointer';
    } catch (error) {
        console.error(error);
        document.getElementsByClassName('dropZone')[0].style.cursor = 'pointer';
        showMessage('Failed to upload reports ' + error.message, false);
    }
}
var clientData = null;
async function getClientsFile() {
  try {
        const data = await unifiedSendRequest(CLIENTSFILE, {method: 'GET'});
        // Check if an error message already exists
        if (data['status_code'] === 200) {
          var data_found = data['data'];
          if (data_found['filename']) {
            {% comment %} document.getElementById('clientsFileName').textContent = data_found['filename']; {% endcomment %}
            {% comment %} document.getElementById('editIconClients').style.display = 'block';
            document.getElementById('upload-clients').style.display = 'none'; {% endcomment %}
            clientData = data_found['data'];
            return data_found['data'];
          }
        }
    } catch (error) {
        console.error(error);
        showMessage('Failed to fetch clients file ' + error.message, false);
    }
}

async function handleClientsUpload(input, additionalInfo) {
    const file = input.files[0];
    try {
        const formData = new FormData();
        formData.append('client_file', file);
        formData.append('country', additionalInfo.country || '');
        formData.append('wastestream', additionalInfo.wastestream || '');
        formData.append('scheme', additionalInfo.scheme || '');
        const data = await unifiedSendRequest(CLIENTSFILE, { formData: formData });
        // Check if an error message already exists
        if (data['status_code'] === 200) {
            {% comment %} document.getElementById('clientsFileName').textContent = file.name; {% endcomment %}
            {% comment %} document.getElementById('editIconClients').style.display = 'block';
            document.getElementById('upload-clients').style.display = 'none'; {% endcomment %}
        } else {
            console.error(data);
            showMessage('Failed to upload clients file', false);
        }
    } catch (error) {
        console.error(error);
        showMessage('Failed to upload clients file ' + error.message, false);
    }
}


var datatable = null;

async function openClientsModal() {
    var clientDataNew = await getClientsFile();
    document.getElementById('editClientsModal').style.display = 'block';
    document.getElementById('clientsModalOverlay').style.display = 'block';

    if (!clientDataNew) {
        console.error('No client data to display.');
        return;
    }

    // Parse JSON data into an HTML table
    const tabsContainer = document.getElementById('tabs-container');
    const dataContainer = document.getElementById('clientsDatatableContainer');
    tabsContainer.innerHTML = '';
    dataContainer.innerHTML = '';

    const countries = Object.keys(clientDataNew);
    countries.forEach((country, index) => {
        const tabButton = document.createElement('button');
        tabButton.textContent = country;
        tabButton.className = 'tab-button';
        tabButton.style.margin = '5px';
        tabButton.dataset.country = country;

        tabButton.addEventListener('click', () => {
            dataContainer.innerHTML = '';
            highlightActiveTab(index);
            renderCountryData(clientDataNew[country], country);
        });

        tabsContainer.appendChild(tabButton);
    });

    // Auto-click the first tab if available
    if (countries.length > 0) {
        document.querySelector('.tab-button').click();
    }

    function highlightActiveTab(activeIndex) {
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach((btn, index) => {
            btn.classList.toggle('active', index === activeIndex);
        });
    }

    function renderCountryData(data, country) {
        data = data.map(row => ({
            ...row,
            country: country
        }));
        if (data.length === 0) {
            dataContainer.innerHTML = '<p>No client data available for this country.</p>';
            return;
        }

        // Dynamically determine columns
        const dynamicColumns = Object.keys(data[0])
            .filter(key => key !== 'client')
            .reduce((acc, field) => {
                const baseField = field.split(' ')[1] + ' ' + field.split(' ').slice(2).join(' '); // Scheme + Wastestream
                if (!acc[baseField]) acc[baseField] = {};
                if (field.startsWith('Login')) acc[baseField]['Login'] = field;
                if (field.startsWith('Password')) acc[baseField]['Password'] = field;
                if (field.startsWith('Notes')) acc[baseField]['Notes'] = field;
                if (field.startsWith('ExtraInfo')) acc[baseField]['ExtraInfo'] = field;
                return acc;
            }, {});

        // Generate Tabulator column definitions
        const columns = [{ title: 'Client', field: 'client', headerSort: true, editor: 'input' },
                         { title: 'Country', field: 'country', headerSort: false, visible: false }];
        Object.keys(dynamicColumns).forEach((key) => {
            const group = dynamicColumns[key];
            if (group.Login) columns.push({ title: `Login ${key}`, field: group.Login, headerSort: true, editor: 'input' });
            if (group.Password) columns.push({ title: `Password ${key}`, field: group.Password, headerSort: true, editor: 'input',
              formatter: (cell) => {
                  const value = cell.getValue();
                  return `<div class="blurred" title="Content blurred for privacy">${value}</div>`;
              }
            });
            if (group.Notes) columns.push({ title: `Notes ${key}`, field: group.Notes, headerSort: true, editor: 'input' });
            if (group.ExtraInfo) columns.push({ title: `Extra Info ${key}`, field: group.ExtraInfo, headerSort: true, editor: 'input' });
        });

        const table = new Tabulator("#clientsDatatableContainer", {
            data: data,
            layout: "fitDataFill",
            pagination: data.length > 10,
            paginationSize: 10,
            columns: columns,
            movableColumns: true,
            columnDefaults: {
              headerMenu: [
                  {
                      label:"Hide Column",
                      action:function(e, column){
                          column.hide();
                      }
                  }
              ]
            }
        });
        datatable = table;
    }
}

// Function to add a new row after the last entry
function addNewRow() {
    datatable.addRow({});
}

function addNewColumn() {
    const table = datatable;

    // Prompt the user for a column name
    const columnName = prompt("Enter the name for the new column:");
    if (!columnName) return; // Exit if no column name is provided

    const columns = table.getColumnDefinitions(); // Get existing column definitions
    columns.push({
        title: columnName,
        field: columnName,
        editor: "input", // Make cells editable
    });

    const data = table.getData();

    // Add the new column to all existing rows
    data.forEach(row => {
        if (!(columnName in row)) {
            row[columnName] = ""; // Initialize new column with empty string
        }
    });

    // Reinitialize the table with updated columns and data
    table.setColumns(columns); // Update column definitions
    table.replaceData(data);

}


function closeClientsModal() {
    document.getElementById('editClientsModal').style.display = 'none';
    document.getElementById('clientsModalOverlay').style.display = 'none';
}

async function saveClientsEdits() {
    try {
        // Get Tabulator instance
        const table = datatable;

        // Retrieve all data from the table without transformation
        let data = table.getData();

        // Convert all inputs to strings and replace null with ''
        const formattedData = data.map(entry => {
            const updatedEntry = {};
            for (const key in entry) {
                if (entry.hasOwnProperty(key)) {
                    let val = entry[key] === null ? '' : String(entry[key]);
                    val = val.replace('undefined', '');
                    updatedEntry[key] = val;
                }
                entry['country'] = document.getElementsByClassName('tab-button active')[0].getAttribute('data-country');
            }
            return updatedEntry;
        });

        // Send the raw data to the backend
        const response = await unifiedSendRequest(CLIENTSFILEUPDATE, {
            formData: JSON.stringify({ clients: formattedData }),
            headerArgs: { 'Content-Type': 'application/json' }
        });

        // Handle response
        if (response.status_code === 200) {
            showMessage('Clients data saved successfully.', true);
            closeClientsModal();
        } else {
            console.error('Error saving data:', response);
            showMessage('Failed to save clients data.', false);
        }
    } catch (error) {
        console.error('Error in saveClientsEdits:', error);
        showMessage('Failed to save clients data: ' + error.message, false);
    }
}

function nextStep(stepNumber) {
    stepFunctions(stepNumber);
    steps.forEach(step => step.style.display = 'none');
    document.getElementById('step' + stepNumber).style.display = 'block';
}

function prevStep(stepNumber) {
    stepFunctions(stepNumber);
    steps.forEach(step => step.style.display = 'none');
    document.getElementById('step' + stepNumber).style.display = 'block';
}

function stepFunctions(stepNumber){
    if (stepNumber === 1) {
      getTimesAndCountry();
    }
    if (stepNumber === 2) {
      showConfirmationDetails();
    }
}

let allTemplates = [];
let minDate = null;
let maxDate = null;
async function getTimesAndCountry() {
  try {
    var loadingSpinnerContainer = document.getElementById('loadingSpinnerContainer');
    loadingSpinnerContainer.style.display = 'block';
    unifiedSendRequest(GETREPORTTIMES, { method: 'GET' }).then(data => {
        minDate = data[0];
        maxDate = data[1];
        const countries = data[2];
        const countryDropdown = document.getElementById('country');

        countryDropdown.innerHTML = '';
        countries.sort().forEach((country, index) => {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          {% comment %} if (index === 0) {
            option.selected = true;
            getDateOptions(country);
          } {% endcomment %}
          countryDropdown.appendChild(option);
        });

        $('.selectpicker').selectpicker('refresh');

        changeYear(0);
    }).catch(error => {
      console.error(error.message);
      showMessage('Failed to retrieve countries from orders ' + error.message, false);
    });
    unifiedSendRequest(CUSTOMCHARTCOLUMNS + '?flat=true', { method: 'GET' }).then(availableColumns => {
        document.getElementById('previewContainer').innerHTML = '';
        fillColumnSelectors(availableColumns);
    });
    await populateTemplateSelector();
    if (!window.userPermissions['reporttemplate']) {
      document.getElementById('confirmAgency').style.display = 'block';
      return;
    }
    document.getElementById('confirmNoAgency').style.display = 'block';
    document.getElementById('customFieldsContainer').style.display = 'flex';
    document.getElementById('templateContainer').style.display = 'flex';
    document.getElementById('includeReturnsContainer').style.display = 'flex';
    await populateRulesDropdown();
    var loadingSpinnerContainer = document.getElementById('loadingSpinnerContainer');
    loadingSpinnerContainer.style.display = 'none';
    updateSaveReportButton();
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to retrieve countries from orders ' + error.message, false);
  }
}

function fillColumnSelectors(columns) {
  const fieldsDropdown = document.getElementById('customFields');
  const groupByDropdown = document.getElementById('groupByFields');
  fieldsDropdown.innerHTML = '';
  groupByDropdown.innerHTML = '';

  Object.keys(columns).forEach(groupName => {
    const fieldsOptGroup = document.createElement('optgroup');
    fieldsOptGroup.label = groupName;
    fieldsOptions = [];

    const groupOptGroup = document.createElement('optgroup');
    groupOptGroup.label = groupName;
    groupOptions = [];

    columns[groupName].forEach(column => {
      const fieldOption = document.createElement('option');
      fieldOption.value = column['name'];
      fieldOption.textContent = convertStringFormat(column['name']);
      if (column['number'] == true) {
        fieldsOptGroup.appendChild(fieldOption);
        fieldsOptions.push(column['name']);
      }

      const groupOption = document.createElement('option');
      groupOption.value = column['name'];
      groupOption.textContent = convertStringFormat(column['name']);
      groupOptGroup.appendChild(groupOption);
      groupOptions.push(column['name']);

    });
    if (fieldsOptions.length > 0) {
    fieldsDropdown.appendChild(fieldsOptGroup);
    }
    if (groupOptions.length > 0) {
      groupByDropdown.appendChild(groupOptGroup);
    }
  });

  // Refresh Bootstrap selectpicker
  $('.selectpicker').selectpicker('refresh');
}


  const name_mapper = {
    'amount_total': 'Amount Total',
    'amount_b2b': 'Amount B2B',
    'amount_b2c': 'Amount B2C',
    'weight_total': 'Weight Total (kg)',
    'weight_b2b': 'Weight B2B (kg)',
    'weight_b2c': 'Weight B2C (kg)',
    'sku': 'SKU',
    'orderid': 'OrderID',
    'b2b': 'B2B'
  };

  function convertStringFormat(s) {
    if (name_mapper.hasOwnProperty(s)) {
      return name_mapper[s];
    }
    return s.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
  }


async function populateRulesDropdown() {
  const ruleSelect = document.getElementById('ruleSelect');
  ruleOptions = await getRules();
  ruleSelect.innerHTML = '';
  ruleOptions.forEach(rule => {
    const option = document.createElement('option');
    option.value = rule.ruleID;
    option.textContent = rule.ruleName;
    ruleSelect.appendChild(option);
  });
  $('.selectpicker').selectpicker('refresh');
}

async function editRules() {
    await displayRules(populateRulesDropdown);
}

async function populateTemplateSelector() {
  const templateSelect = document.getElementById('templateSelect');
  templateSelect.innerHTML = '<option value="default">-- Select a template --</option>';
  allTemplates = await unifiedSendRequest(GETTEMPLATES, { method: 'GET' });
  updateTemplateOptions();
  $('.selectpicker').selectpicker('refresh');

  $('#templateSelect').on('changed.bs.select', function () {
    updateSaveReportButton();
    const selectedTemplate = $(this).val();
    const template = allTemplates.find(t => `${t.country}-${t.year}-${t.report_type}-${t.pro}` === selectedTemplate || t.id === selectedTemplate);
    if (!template || selectedTemplate === "default") {
      document.getElementById('customFields').disabled = false;
      $('#customFields').selectpicker('refresh');
      document.getElementById('groupByFields').disabled = false;
      $('#groupByFields').selectpicker('refresh');
      document.getElementById('useBoughtFromSameCountry').disabled = false;
      document.getElementById('useReturns').disabled = false;
      return;
    }
    $('#customFields').selectpicker('val', null);
    document.getElementById('customFields').disabled = true;
    $('#customFields').selectpicker('refresh');
    $('#groupByFields').selectpicker('val', null);
    document.getElementById('groupByFields').disabled = true;
    $('#groupByFields').selectpicker('refresh');
    document.getElementById('useBoughtFromSameCountry').disabled = true;
    document.getElementById('useReturns').disabled = true;
    let dynamicRanges = {};

    if (template.deadlines) {
      template.deadlines.forEach(deadline => {
        if (!deadline.timeframeStart || !deadline.timeframeEnd || !deadline.recurrence) return;

        const recurrenceName = deadline.recurrence.replace('ly', ''); // Yearly -> Year, Monthly -> Month
        const label = `Last ${recurrenceName}`;

        const now = moment();

        if (deadline.recurrence.toLowerCase() === "monthly") {
          const lastMonth = now.clone().subtract(1, 'month');
          periodStart = lastMonth.clone().startOf('month');
          periodEnd = lastMonth.clone().endOf('month');

        } else if (deadline.recurrence.toLowerCase() === "quarterly") {
          const currentQuarter = Math.floor((now.month()) / 3) + 1;
          const lastQuarter = currentQuarter - 1 <= 0 ? 4 : currentQuarter - 1;
          const lastQuarterYear = currentQuarter - 1 <= 0 ? now.year() - 1 : now.year();
          const quarterStartMonth = (lastQuarter - 1) * 3;

          periodStart = moment({ year: lastQuarterYear, month: quarterStartMonth, day: 1 });
          periodEnd = periodStart.clone().add(2, 'months').endOf('month');
          // TODO periodEnd doesn't seem to be correct
        } else if (deadline.recurrence.toLowerCase() === "semesterly") {
          const month = now.month() + 1;
          if (month >= 1 && month <= 6) {
            // In Jan-Jun -> previous semester is July-Dec of last year
            periodStart = moment({ year: now.year() - 1, month: 6, day: 1 }); // July
            periodEnd = periodStart.clone().add(5, 'months').endOf('month'); // Dec
          } else {
            // In Jul-Dec -> previous semester is Jan-Jun this year
            periodStart = moment({ year: now.year(), month: 0, day: 1 }); // January
            periodEnd = periodStart.clone().add(5, 'months').endOf('month'); // June
          }

        } else if (deadline.recurrence.toLowerCase() === "yearly") {
          const lastYear = now.clone().subtract(1, 'year');
          periodStart = moment({ year: lastYear.year(), month: 0, day: 1 });
          periodEnd = moment({ year: lastYear.year(), month: 11, day: 31 });
        }
        const startDay = Number(deadline.timeframeStart.split('-')[2]);
        const endDay = Number(deadline.timeframeEnd.split('-')[2]);

        const from = periodStart.clone().date(startDay);

        const to = (endDay >= 28)
          ? periodEnd
          : periodStart.clone().date(endDay);

        dynamicRanges[label] = [from, to];
      });
    }

    // Fallback: if no template deadlines, at least offer standard choices
    if (Object.keys(dynamicRanges).length === 0) {
      dynamicRanges = {
        'Last Month': [
          moment().subtract(1, 'month').startOf('month'),
          moment().subtract(1, 'month').endOf('month')
        ],
        'Last Year': [
          moment().subtract(1, 'year').startOf('year'),
          moment().subtract(1, 'year').endOf('year')
        ]
      };
    }

    const sortedRangesArray = Object.entries(dynamicRanges).sort((a, b) => {
      const [ , [aStart, aEnd] ] = a;
      const [ , [bStart, bEnd] ] = b;

      const aDuration = aEnd.diff(aStart, 'days');
      const bDuration = bEnd.diff(bStart, 'days');

      return aDuration - bDuration; // Shortest first
    });

    // Step 2: Rebuild dynamicRanges object in sorted order
    dynamicRanges = Object.fromEntries(sortedRangesArray);
    var possibleRange = null;
    for (const [key, [start, end]] of Object.entries(dynamicRanges)) {
      if (anyDateInRange(availableDateOptions, new Date(start), new Date(end))) {
        possibleRange = [start, end];
        break;
      }
    }
    if (possibleRange) {
      $('#monthPicker').val(possibleRange[0].format('DD/MM/YYYY') + ' - ' + possibleRange[1].format('DD/MM/YYYY'));
      document.getElementById('calendarError').textContent = '';
      document.getElementById('calendarError').style.display = 'none';
    }
    else {
      $('#monthPicker').val('');
      document.getElementById('calendarError').textContent = 'No data available for the ' + Object.keys(dynamicRanges)[0];
      document.getElementById('calendarError').style.display = 'block';
    }
    document.getElementById('monthPicker').addEventListener('blur', updateCalendarError);
    // Replace existing datepicker with new dynamic ranges
    {% comment %} $('#monthPicker').daterangepicker({
      startDate: Object.values(dynamicRanges)[0][0],  // Set first option as default
      endDate: Object.values(dynamicRanges)[0][1],
      minDate: moment().subtract(5, 'year'),
      maxDate: moment().add(1, 'year'),
      locale: { format: 'DD/MM/YYYY' },
      ranges: dynamicRanges
    }); {% endcomment %}
  });
}

function updateSaveReportButton() {
  const saveReportButton = document.getElementById('saveReportButton');
  const nextButtonSummary = document.getElementById('nextButtonSummary');
  const [success, message] = checkAllSettingsSelected();
  if (success) {
    saveReportButton.disabled = false;
    nextButtonSummary.disabled = false;
    saveReportButton.title = '';
    nextButtonSummary.title = '';
  } else {
    saveReportButton.disabled = true;
    nextButtonSummary.disabled = true;
    saveReportButton.title = message;
    nextButtonSummary.title = message;
  }
}

function checkAllSettingsSelected() {
  const countrySelected = $('#country').val();
  const categorySelected = $('#category').val();
  const proSelected = $('#proSelect').val();
  const dateSelected = document.getElementById('monthPicker').value;
  const templateSelected = $('#templateSelect').val();
  const outputFieldsSelected = $('#customFields').val();
  const groupByFieldsSelected = $('#groupByFields').val();
  if (!window.userPermissions['reporttemplate']) {
    return [true, ''];
  }
  if (templateSelected === "default") {
    if (groupByFieldsSelected.length === 0) {
      return [false, 'Please select at least one field for "Show one line per" or template'];
    }
    if (outputFieldsSelected.length === 0) {
      return [false, 'Please select at least one field for "Show these totals" or template'];
    }
    return [true, ''];
  }
  return [true, ''];
}


function updateCalendarError() {
  const calendarError = document.getElementById('calendarError');
  calendarError.textContent = '';
  calendarError.style.display = 'none';
}

function updateTemplateOptions(refreshPRO=true) {
  updateCalendarError();
  const templateSelect = document.getElementById('templateSelect');
  const proDropdown = document.getElementById('proSelect');
  var initPro = false;
  if (refreshPRO) {
    $('#proSelect').val('');
    proDropdown.innerHTML = '<option value="">No PRO selected</option>';
  }
  const selectedPro = $('#proSelect').val();
  const selectedCountry = $('#country').val();
  const selectedCategory = $('#category').val();

  templateSelect.innerHTML = '<option value="default">-- Select a template --</option>'; // Clear

  lastTemplate = 'default';
  seenPro = new Set();
  allTemplates.forEach(template => {
    // Match filtering: if no selection, or matching the selected value
    const matchCountry = !selectedCountry || selectedCountry.includes(template.country);
    const matchCategory = !selectedCategory || template.report_type === selectedCategory;
    const matchPro = !selectedPro || template.pro === selectedPro;

    if (matchCountry && matchCategory && refreshPRO && template.pro) {
      if (seenPro.has(template.pro)) {
        return;
      }
      seenPro.add(template.pro);
      const option = document.createElement('option');
      option.value = template.pro;
      option.textContent = template.pro;
      proDropdown.appendChild(option);
    }

    if (matchCountry && matchCategory && matchPro) {
      if (template.id !== undefined) {
        const option = document.createElement('option');
        option.value = template.id;
        lastTemplate = option.value;
        option.textContent = template.report_name;
        templateSelect.appendChild(option);
      }
      else {
        const option = document.createElement('option');
        option.value = `${template.country}-${template.year}-${template.report_type}-${template.pro}`;
        lastTemplate = option.value;
        option.textContent = `${template.country} ${template.year} ${template.report_type} ${template.pro}`;
        templateSelect.appendChild(option);
      }
    }
  });
  if (refreshPRO == false) {
    $('#templateSelect').val(lastTemplate);
    $('#templateSelect').trigger('change');
    $('.selectpicker').selectpicker('refresh'); // needed twice for it to work
  } else {
    if (proDropdown.querySelectorAll('option').length == 1) {
      proDropdown.innerHTML = '<option value="">Add in Overview first</option>';
    }
  }
  $('.selectpicker').selectpicker('refresh'); // Re-render
}

$('#country').on('changed.bs.select', function() {
  getDateOptions($('#country').val());
  updateTemplateOptions();
  updateSaveReportButton();
});
$('#category').on('changed.bs.select', function() {
  updateTemplateOptions();
  updateSaveReportButton();
});

$('#proSelect').on('changed.bs.select', function() {
  updateTemplateOptions(refreshPRO=false);
  updateSaveReportButton();
});
$('#groupByFields').on('changed.bs.select', function() {
  updateSaveReportButton();

  if ($('#customFields').val().length > 0 && $('#groupByFields').val().length > 0) {
    document.getElementById('previewIcon').classList.add('previewActive');
    setTimeout(() => {
      document.getElementById('previewIcon').classList.remove('previewActive');
    }, 1000);
  }
});
$('#customFields').on('changed.bs.select', function() {
  updateSaveReportButton();
  
  if ($('#customFields').val().length > 0 && $('#groupByFields').val().length > 0) {
    document.getElementById('previewIcon').classList.add('previewActive');
    setTimeout(() => {
      document.getElementById('previewIcon').classList.remove('previewActive');
    }, 1000);
  }
});

async function showConfirmationDetails() {
    // Get the selected values
    var selectedCountries = $('#country').val() || [];
    document.getElementById('confirm-country').textContent = selectedCountries.join(', ') || 'All countries';
    document.getElementById('confirm-category').textContent = $('#category').val();

    const monthPickerValue = document.getElementById('monthPicker').value;
    if (monthPickerValue) {
      const [selectedStartDateValue, selectedEndDateValue] = monthPickerValue.split(' - ');
      document.getElementById('confirm-start').textContent = selectedStartDateValue;
      document.getElementById('confirm-end').textContent = selectedEndDateValue;
    } else {
      document.getElementById('confirm-start').textContent = minDate;
      document.getElementById('confirm-end').textContent = maxDate;
    }
    var selectedFields = $('#customFields').val() || [];
    var selectedGroupBy = $('#groupByFields').val() || [];
    var selectedTemplate = $('#templateSelect').val();
    if (!window.userPermissions['reporttemplate']) {
      var year = moment().year();
      selectedTemplate = `${$('#country').val()}-${year}-${$('#category').val()}-${$('#proSelect').val()}`;
    }
    selectedTemplateName = null;
    if (selectedTemplate !== "default" && selectedTemplate !== null) {
      selectedFields = [`Using template ${selectedTemplate}`];
      selectedGroupBy = [`Using template ${selectedTemplate}`];
      var pro = $('#proSelect').val();
      selectedTemplateName = [$('#country').val(), $('#category').val()];
      if (pro !== "default" && pro !== null) {
        selectedTemplateName.push(pro);
      }
    }
    if (selectedFields.length > 0) {
      addOptionsConfirmation(selectedFields, 'confirm-fields');
    }
    if (selectedGroupBy.length > 0) {
      addOptionsConfirmation(selectedGroupBy, 'confirm-groupby');
    }
    if (selectedTemplateName !== null) {
      addOptionsConfirmation(selectedTemplateName, 'confirm-template');
    }
    const selectedRules = $('#ruleSelect').val() || [];
    ruleOptions = await getRules();
    const selectedRulesText = selectedRules
      .map(r => {
        const rule = ruleOptions.find(rule => String(rule.ruleID) === String(r));
        return rule ? rule.ruleName : null;
      })
      .filter(name => name !== null);

    if (selectedRules.length > 0) {
      addOptionsConfirmation(selectedRulesText, 'confirm-rules', false);
    }

    {% comment %} document.getElementById('confirm-returns').textContent = document.getElementById('useReturns').checked ? 'Yes': 'No'; {% endcomment %}
    var selectedOrderListFileValue = Object.values(selectedFilesOrders).map(file => file.filename);
    var selectedReturnListFileValue = Object.values(selectedFilesReturns).map(file => file.filename);
    var textContentOrders = selectedOrderListFileValue.length > 0 ? selectedOrderListFileValue.join('<br>') : 'No file selected';
    var textContentReturns = selectedReturnListFileValue.length > 0 ? selectedReturnListFileValue.join('<br>') : 'No file selected';
    document.getElementById('confirm-orderlist').innerHTML = textContentOrders;
    document.getElementById('confirm-returnlist').innerHTML = textContentReturns;
}

function addOptionsConfirmation(selectedEntries, confirmationId, convert=true) {
    const group = document.getElementById(confirmationId);
    group.innerHTML = '';
    selectedEntries.forEach(field => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      if (convert) {
        field = convertStringFormat(field);
      }
      li.textContent = field;
      group.appendChild(li);
    });
}

function convertToISO(dateStr) {
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month}-${day}`;
}

var failedCreation = false;
async function createReport() {
    failedCreation = false;
    steps.forEach(step => step.style.display = 'none');
    document.getElementById('stepDone').style.display = 'block';
    const uploadStepsElem = document.getElementById('uploadSteps');

    // Add loading overlay
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    uploadStepsElem.style.position = 'relative'; // Ensure that the overlay covers this element
    uploadStepsElem.appendChild(overlay);

    uploadStepsElem.style.cursor = 'wait';
    document.querySelectorAll('.nextButton').forEach(node => {node.disabled = true;})
    document.querySelectorAll('.prevButton').forEach(node => {node.disabled = true;})
    var data;
    try {
        const countryData = new FormData();
        var selectedCountries = $('#country').val() || [];
        countryData.append("country_id", selectedCountries.join(','));
        countryData.append("category", document.getElementById('category').value);
        if (document.getElementById('monthPicker').value) {
          const [selectedStartDateValue, selectedEndDateValue] = document.getElementById('monthPicker').value.split(' - ');
          countryData.append("start_date", convertToISO(selectedStartDateValue));
          countryData.append("end_date", convertToISO(selectedEndDateValue));
        } else {
          countryData.append("start_date", minDate);
          countryData.append("end_date", maxDate);
        }
        var selectedTemplate = $('#templateSelect').val();
        if (!window.userPermissions['reporttemplate']) {
          var year = moment().year();
          selectedTemplate = `${$('#country').val()}-${year}-${$('#category').val()}-${$('#proSelect').val()}`;
        }
        countryData.append("template_id", selectedTemplate);
        countryData.append("use_returns", document.getElementById('useReturns').checked);
        countryData.append("use_bought_from_same_country", document.getElementById('useBoughtFromSameCountry').checked);
        const selectedFields = $('#customFields').val() || [];
        countryData.append("output_fields", selectedFields.join(','));
        const selectedGroupBy = $('#groupByFields').val() || [];
        countryData.append("groupby_fields", selectedGroupBy.join(','));
        const selectedRules = $('#ruleSelect').val() || [];
        countryData.append("rules", selectedRules.join(','));
        setTimeout(repeatAction, 100);
        data = await unifiedSendRequest(CREATEREPORT, {formData: countryData});        // Handle file response
    } catch (error) {
        console.error(error.message);
        TOKEN = false;
        failedCreation = true;
        document.getElementById('reportInProgress').style.display = 'none';
        document.getElementById('showReport').style.display = 'none';
        document.getElementById('reportFailed').style.display = 'block';
        showMessage('Failed to create report: ' + error.message, false);
    }
    uploadStepsElem.removeChild(overlay);
    document.getElementById('uploadSteps').style.cursor = 'default';
    document.querySelectorAll('.nextButton').forEach(node => {node.disabled = false;})
    document.querySelectorAll('.prevButton').forEach(node => {node.disabled = false;})
}

async function previewReport() {
  try {
      const countryData = new FormData();
      var selectedCountries = $('#country').val() || [];
      countryData.append("country_id", selectedCountries.join(','));
      countryData.append("category", document.getElementById('category').value || '');
      if (document.getElementById('monthPicker').value) {
        const [selectedStartDateValue, selectedEndDateValue] = document.getElementById('monthPicker').value.split(' - ');
        countryData.append("start_date", convertToISO(selectedStartDateValue));
        countryData.append("end_date", convertToISO(selectedEndDateValue));
      }
      countryData.append("preview", true);
      countryData.append("use_returns", document.getElementById('useReturns').checked || false);
      countryData.append("use_bought_from_same_country", document.getElementById('useBoughtFromSameCountry').checked || false);
      const selectedGroupBy = $('#groupByFields').val() || [];
      if (selectedGroupBy.length == 0) {
        showMessage('Please select at least one field for "Show one line per"', false);
        return;
      }
      countryData.append("groupby_fields", selectedGroupBy.join(','));
      const selectedFields = $('#customFields').val() || [];
      if (selectedFields.length == 0) {
        showMessage('Please select at least one field for "Show these totals"', false);
        return;
      }
      countryData.append("output_fields", selectedFields.join(','));
      const selectedRules = $('#ruleSelect').val() || [];
      countryData.append("rules", selectedRules.join(','));
      data = await unifiedSendRequest(CREATEREPORT, {formData: countryData});        // Handle file response
      document.getElementById('previewContainerModal').style.display = 'block';
      document.getElementById('modalOverlayPreview').style.display = 'block';
      document.getElementById('previewContainer').innerHTML = '';
      viewPreview(data);
  } catch (error) {
      console.error(error.message);
      TOKEN = false;
      showMessage(error.message, false);
  }
}

function closePreviewModal() {
  document.getElementById('previewContainerModal').style.display = 'none';
  document.getElementById('modalOverlayPreview').style.display = 'none';
}

document.getElementById('modalOverlayPreview').addEventListener('click', function(event) {
  if (event.target === this) {
    closePreviewModal();
  }
});

function viewPreview(data) {
    // Step 1: Get all column names
    const columnNames = Object.keys(data);

    // Step 2: Get the row count from the first column
    const rowCount = Object.keys(data[columnNames[0]]).length;

    // Step 3: Create the table
    const table = document.createElement("table");
    table.border = "1";
    table.style.width = '100%';
    table.style.margin = 'auto';

    // Step 4: Add header row
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    columnNames.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col.replaceAll('/', ' / ');
      th.style.overflow = 'clip';
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Step 5: Add data rows
    const tbody = document.createElement("tbody");
    for (let i = 0; i < rowCount; i++) {
      const tr = document.createElement("tr");
      columnNames.forEach(col => {
        const td = document.createElement("td");
        td.textContent = data[col][i] ?? '';
        td.style.overflow = 'clip';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);


  // Step 5: Add table to the document
  document.getElementById('previewContainer').appendChild(table);
}

function saveReportOpenModal() {
  if (!document.getElementById('monthPicker').value) {
    showMessage('Please select a timeframe', false);
    return;
  }
  document.getElementById('saveReportModal').style.display = 'block';
  document.getElementById('modalOverlaySave').style.display = 'block';
  if ($('#templateSelect').val() && $('#templateSelect').val().includes('custom-')) {
    templateName = allTemplates.filter(template => template.id === $('#templateSelect').val())[0].report_name;
    document.getElementById('saveReportName').value = templateName;
    document.getElementById('overwriteReportCheckboxContainer').style.display = 'flex';
    document.getElementById('overwriteReportCheckbox').checked = true;

  }
  document.getElementById('saveReportDate').value = moment().format('YYYY-MM-DD');
}

function closeSaveModal() {
  document.getElementById('saveReportModal').style.display = 'none';
  document.getElementById('modalOverlaySave').style.display = 'none';
}


async function saveReport() {
  try {
    const reportName = document.getElementById('saveReportName').value;
    console.log(reportName);
    const reportData = new FormData();
    reportData.append("report_name", reportName);
    reportData.append("report_type", document.getElementById('category').value);
    reportData.append("country", document.getElementById('country').value);
    reportData.append("pro", document.getElementById('proSelect').value);
    reportData.append('overwrite', document.getElementById('overwriteReportCheckbox').checked || false);
    reportData.append('recurrence', document.getElementById('recurrence').value);
    reportData.append('report_date', document.getElementById('saveReportDate').value);
    reportData.append('template_id', $('#templateSelect').val());
    const [selectedStartDateValue, selectedEndDateValue] = document.getElementById('monthPicker').value.split(' - ');
    reportData.append("start_date", convertToISO(selectedStartDateValue));
    reportData.append("end_date", convertToISO(selectedEndDateValue));
    reportData.append("output_fields", $('#customFields').val().join(','));
    reportData.append("groupby_fields", $('#groupByFields').val().join(','));
    reportData.append("rules", $('#ruleSelect').val().join(','));
    reportData.append("use_returns", document.getElementById('useReturns').checked || false);
    reportData.append("use_bought_from_same_country", document.getElementById('useBoughtFromSameCountry').checked || false);
    data = await unifiedSendRequest(SAVE_REPORT, {formData: reportData});
    showMessage('Report saved successfully', true);
    await populateTemplateSelector();
    closeSaveModal();
  } catch (error) {
    console.error(error.message);
    TOKEN = false;
    showMessage('Failed to save report template', false);
  }
}


async function openZeroDeclarationModal() {
  document.getElementById('zeroDeclarationModal').style.display = 'block';
  try {
    data = await unifiedSendRequest(REPORTTYPES, {method: 'GET'});
    clients = data['clients'];
    data = data['data'];
    console.log(clients);
    const countryDropdown = document.getElementById("countryDropdown");
    const reporttypeDropdown = document.getElementById("reporttypeDropdown");
    const proDropdown = document.getElementById("proDropdown");
    const timeframeDropdown = document.getElementById("timeframeDropdown");
    const companyDropdown = document.getElementById("companyDropdown");
    countryDropdown.innerHTML = '';
    reporttypeDropdown.innerHTML = '';
    proDropdown.innerHTML = '';
    timeframeDropdown.innerHTML = '';
    companyDropdown.innerHTML = '';
    Object.keys(data).sort().forEach(country => {
      const option = new Option(country, country);
      countryDropdown.appendChild(option);
    });

    // Handle country change
    countryDropdown.addEventListener("change", function () {
      const selectedCountry = this.value;
      const reportTypes = Object.keys(data[selectedCountry] || {});

      // Clear and populate report types
      reporttypeDropdown.innerHTML = "";
      reporttypeDropdown.value = "";
      timeframeDropdown.innerHTML = "";
      proDropdown.innerHTML = "";
      timeframeDropdown.innerHTML = "";
      companyDropdown.innerHTML = "";

      reportTypes.sort().forEach(reportType => {
        const option = new Option(reportType, reportType);
        reporttypeDropdown.appendChild(option);
      });
      // always select first value to avoid it being unselectable
      reporttypeDropdown.value = reportTypes[0];
      reporttypeDropdown.dispatchEvent(new Event('change'));
      console.log('Chose country, report type', country, reportTypes);
      $('.selectpicker').selectpicker('refresh');
    });

    // Handle report type change
    reporttypeDropdown.addEventListener("change", function () {
      const country = countryDropdown.value;
      const reportType = this.value;

      const pros = (data[country]?.[reportType] || {});
      proDropdown.innerHTML = "";
      proDropdown.value = "";
      timeframeDropdown.innerHTML = "";
      companyDropdown.innerHTML = "";

      Object.keys(pros).sort().forEach((pro) => {
        const label = `${pro}`;
        const option = new Option(label, label);
        proDropdown.appendChild(option);
      });
      // always select first value to avoid it being unselectable
      proDropdown.value = Object.keys(pros)[0];
      proDropdown.dispatchEvent(new Event('change'));
      console.log('Chose report type, pro', reportType, pros);
      $('.selectpicker').selectpicker('refresh');
    });

    proDropdown.addEventListener("change", function () {
      const country = countryDropdown.value;
      const reportType = reporttypeDropdown.value;
      const pro = this.value;
      const timeframes = (data[country]?.[reportType]?.[pro] || []);
      timeframeDropdown.innerHTML = "";
      timeframeDropdown.value = "";
      companyDropdown.innerHTML = "";
      timeframes.sort().forEach((timeframe) => {
        const [timeframeMonth, year] = timeframe;
        if (timeframeMonth === '') {
          label = `${year}`;
        } else {
          label = `${timeframeMonth} ${year}`;
        }
        const option = new Option(label, label);
        timeframeDropdown.appendChild(option);
      });
      // always select first value to avoid it being unselectable
      const lastTimeframe = timeframes[timeframes.length - 1];
      if (lastTimeframe) {
        const label = lastTimeframe[0] === '' ? `${lastTimeframe[1]}` : `${lastTimeframe[0]} ${lastTimeframe[1]}`;
        timeframeDropdown.value = label;
        timeframeDropdown.dispatchEvent(new Event('change'));
      }
      console.log('Chose pro, timeframe', pro, timeframes);
      $('.selectpicker').selectpicker('refresh');
    });

    timeframeDropdown.addEventListener("change", function () {
      const country = countryDropdown.value;
      const reportType = reporttypeDropdown.value;
      const pro = proDropdown.value;
      const timeframe = this.value;
      console.log('Chose timeframe', timeframe);
      console.log(clients);
      const companies = clients[country]?.[reportType]?.[pro] || [];
      companyDropdown.innerHTML = "";
      companyDropdown.value = "";
      companies.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase())).forEach(company => {
        const option = new Option(company, company);
        companyDropdown.appendChild(option);
      });
      $('.selectpicker').selectpicker('refresh');
    });

    companyDropdown.addEventListener("change", function () {
      const country = countryDropdown.value;
      const reportType = reporttypeDropdown.value;
      const pro = proDropdown.value;
      const timeframe = timeframeDropdown.value;
      for (const option of this.options) {
        let timeframeMonth = '';
        let year = timeframe;
        if (timeframe.includes(' ')) {
          timeframeMonth = timeframe.split(' ')[0];
          year = timeframe.split(' ')[1];
        }
        const key = `${country}_${reportType}_${pro}_${timeframe}_${year}_${option.value}`;
        console.log(key);
        if (option.selected) {
          zeroDeclarationToAdd[key] = {country: country, reportType: reportType, pro: pro, timeframe: timeframeMonth, year: year, company: option.value};
        } else {
          delete zeroDeclarationToAdd[key];
        }
      }
    });

    const firstCountry = Object.keys(data)[0];
    if (firstCountry) {
      countryDropdown.value = firstCountry;
      countryDropdown.dispatchEvent(new Event('change'));
      $('.selectpicker').selectpicker('refresh');
    }
    $('.selectpicker').selectpicker('refresh');

  } catch (error) {
    console.error(error.message);
    showMessage('Failed to create zero declaration ' + error.message, false);
  }
}

function closeZeroDeclarationModal() {
  zeroDeclarationToAdd = {};
  document.getElementById('zeroDeclarationModal').style.display = 'none';
}

async function addZeroDeclaration() {
  const fileList = document.getElementById('fileList_report_list');
  Object.values(zeroDeclarationToAdd).forEach(row => {
    row = createNewFileRowZeroDeclaration(row.country, row.reportType, row.pro, row.timeframe, row.year, row.company);
    fileList.appendChild(row);
    document.getElementById('upload-imageuploadreports/').style.display = 'none';
  });
  closeZeroDeclarationModal();
}


async function submitZeroDeclaration() {
  const data = [];
  Object.values(zeroDeclarationRows).forEach(row => {
    data.push(row);
  });
  console.log(data);
  try {
    res = await unifiedSendRequest(UPLOADZERO, {formData: JSON.stringify(data), headerArgs: {'Content-Type': 'application/json'}, method: 'POST'});
    console.log(res);
    if (res.status_code != 200) {
      showMessage('Failed to upload zero declaration ' + res.message, false);
      for (const row of res.data) {
        document.getElementById(row.report_id).style.backgroundColor = 'red';
        document.getElementById(row.report_id).style.color= '#fafafa';
        document.getElementById(row.report_id).title = row.error;
      }
      return;
    }
    showMessage('Zero declaration uploaded successfully', true);
    zeroDeclarationRows = {};
    closeZeroDeclarationModal();
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to upload zero declaration', false);
  }
}


function showGuide() {
  if(guideToShow == 'new') {// create new report
    var guideSteps = [];
    guideSteps.push({ element: "main", group: "{{ 'software.guide.report.create.group' | t }}", title: "{{ 'software.guide.report.create.title' | t }}", text: "{{ 'software.guide.report.create.text' | t }}", where: 'middle'});
    guideSteps.push({ element: "#liveDataToggleSlider", group: "{{ 'software.guide.report.liveData.group' | t }}", title: "{{ 'software.guide.report.liveData.title' | t }}", text: "{{ 'software.guide.report.liveData.text' | t }}", where: 'right', runBefore: function() {selectOption('new')} });
    guideSteps.push({ element: "#orderListDropZone", group: "{{ 'software.guide.report.orderListDropZone.group' | t }}", title: "{{ 'software.guide.report.orderListDropZone.title' | t }}", text: "{{ 'software.guide.report.orderListDropZone.text' | t }}", where: 'right', runBefore: function() {selectOption('new')} });
    guideSteps.push({ element: "#navButtonsStep1", group: "{{ 'software.guide.report.next.group' | t }}", title: "{{ 'software.guide.report.next.title' | t }}", text: "{{ 'software.guide.report.next.text' | t }}", where: 'right', runBefore: function() {selectOption('new')} });
    startGuide(guideSteps);
  } else if (guideToShow == 'upload') {
    var guideSteps = [];
    guideSteps.push({ element: "main", group: "{{ 'software.guide.report.upload.group' | t }}", title: "{{ 'software.guide.report.upload.title' | t }}", text: "{{ 'software.guide.report.upload.text' | t }}", where: 'middle'});
    guideSteps.push({ element: "#clientsUploadSection", group: "{{ 'software.guide.report.clients.group' | t }}", title: "{{ 'software.guide.report.clients.title' | t }}", text: "{{ 'software.guide.report.clients.text' | t }}", where: 'below', runBefore: function() {selectOption('upload')} });
    guideSteps.push({ element: "#uploadreportlistContainer", group: "{{ 'software.guide.report.uploadFile.group' | t }}", title: "{{ 'software.guide.report.uploadFile.title' | t }}", text: "{{ 'software.guide.report.uploadFile.text' | t }}", where: 'right', runBefore: function() {selectOption('upload')}  });
    {% comment %} guideSteps.push({ element: "#notificationBell", group: "{{ 'software.guide.report.notifications.group' | t }}", title: "{{ 'software.guide.report.notifications.title' | t }}", text: "{{ 'software.guide.report.notifications.text' | t }}", where: 'below', runBefore: function() {selectOption('upload')}  }); {% endcomment %}
    startGuide(guideSteps);
  } else {
    var guideSteps = [
      { element: "main", group: "{{ 'software.guide.report.welcome.group' | t }}", title: "{{ 'software.guide.report.welcome.title' | t }}", text: "{{ 'software.guide.report.welcome.text' | t }}", where: 'middle', runBefore: function() {selectOption('overview')} }

    ];
    if (window.userPermissions['report-creation']) {
      guideSteps.push({ element: "#createNewReport", group: "{{ 'software.guide.report.create.group' | t }}", title: "{{ 'software.guide.report.create.title' | t }}", text: "{{ 'software.guide.report.create.text' | t }}", where: 'right', runBefore: function() {selectOption('overview')} });
      guideSteps.push({ element: "#liveDataToggleSlider", group: "{{ 'software.guide.report.liveData.group' | t }}", title: "{{ 'software.guide.report.liveData.title' | t }}", text: "{{ 'software.guide.report.liveData.text' | t }}", where: 'right', runBefore: function() {selectOption('new')} });
      guideSteps.push({ element: "#orderListDropZone", group: "{{ 'software.guide.report.orderListDropZone.group' | t }}", title: "{{ 'software.guide.report.orderListDropZone.title' | t }}", text: "{{ 'software.guide.report.orderListDropZone.text' | t }}", where: 'right', runBefore: function() {selectOption('new')} });
      guideSteps.push({ element: "#navButtonsStep1", group: "{{ 'software.guide.report.next.group' | t }}", title: "{{ 'software.guide.report.next.title' | t }}", text: "{{ 'software.guide.report.next.text' | t }}", where: 'right', runBefore: function() {selectOption('new')} });
    }
    if (window.userPermissions['report-upload']) {
      guideSteps.push({ element: "#uploadExistingReports", group: "{{ 'software.guide.report.upload.group' | t }}", title: "{{ 'software.guide.report.upload.title' | t }}", text: "{{ 'software.guide.report.upload.text' | t }}", where: 'left', runBefore: function() {selectOption('overview')} });
      guideSteps.push({ element: "#clientsUploadSection", group: "{{ 'software.guide.report.clients.group' | t }}", title: "{{ 'software.guide.report.clients.title' | t }}", text: "{{ 'software.guide.report.clients.text' | t }}", where: 'below', runBefore: function() {selectOption('upload')} });
      guideSteps.push({ element: "#uploadreportlistContainer", group: "{{ 'software.guide.report.uploadFile.group' | t }}", title: "{{ 'software.guide.report.uploadFile.title' | t }}", text: "{{ 'software.guide.report.uploadFile.text' | t }}", where: 'right', runBefore: function() {selectOption('upload')}  });
      {% comment %} guideSteps.push({ element: "#notificationBell", group: "{{ 'software.guide.report.notifications.group' | t }}", title: "{{ 'software.guide.report.notifications.title' | t }}", text: "{{ 'software.guide.report.notifications.text' | t }}", where: 'below', runBefore: function() {selectOption('upload')}  }); {% endcomment %}
    }
    startGuide(guideSteps);
  }
  setCookie('showedGuideReport', 'true', 300);
}

function showGuideUpdates() {
  if (!window.userPermissions['report-upload']) {
    return;
  }
  startGuide([
    { element: "#clientsUploadSection", group: "{{ 'software.guide.reportUpdates.clients.group' | t }}", title: "{{ 'software.guide.reportUpdates.clients.title' | t }}", text: "{{ 'software.guide.reportUpdates.clients.text' | t }}", where: 'below', runBefore: function() {selectOption('upload')}  },
    { element: "#createZeroDeclarationWrapper", group: "{{ 'software.guide.reportUpdates.upload.group' | t }}", title: "{{ 'software.guide.reportUpdates.upload.title' | t }}", text: "{{ 'software.guide.reportUpdates.upload.text' | t }}", where: 'below', runBefore: function() {selectOption('upload')}  },
  ]);
  setCookie('showedGuideReportUpdates', 'true', 300);
}

waitForPermission(function() {
  if (window.userPermissions['forsure-report']) {
    document.getElementById('reportcontainer').style.display = 'block';
    cancreatereports();

    if(readCookie('showedGuideReport') === null) {
      setTimeout(showGuide, 1000); // Delay in milliseconds, adjust as necessary
    } else if (readCookie('showedGuideReportUpdates') === null) {
      setTimeout(showGuideUpdates, 1000);
    }
  }
});

function showGuideFromButton(element) {
  showGuide();
}


</script>

{% else %}
  <div class="image-with-text image-with-text--{{ section.settings.content_layout }} page-width isolate{% if settings.text_boxes_border_thickness > 0 and settings.text_boxes_border_opacity > 0 and settings.media_border_thickness > 0 and settings.media_border_opacity > 0 %} collapse-borders{% endif %}{% unless section.settings.color_scheme == 'background-1' and settings.media_border_thickness > 0 and settings.text_boxes_shadow_opacity == 0 and settings.text_boxes_border_thickness == 0 or settings.text_boxes_border_opacity == 0 %} collapse-corners{% endunless %} section-{{ section.id }}-padding">
        <h1>Welcome,</h1>
    <h2>Please log in to see this page</h2>
  </div>
{%  endif %}

{% schema %}
{
  "name": "t:sections.forsure_report.name",
  "class": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "upload",
      "label": "Upload"
    },
    {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
    },
    {
      "type": "select",
      "id": "desktop_image_width",
      "options": [
        {
          "value": "small",
          "label": "t:sections.forsure_report.settings.desktop_image_width.options__1.label"
        },
        {
          "value": "medium",
          "label": "t:sections.forsure_report.settings.desktop_image_width.options__2.label"
        },
        {
          "value": "large",
          "label": "t:sections.forsure_report.settings.desktop_image_width.options__3.label"
        }
      ],
      "default": "medium",
      "label": "t:sections.forsure_report.settings.desktop_image_width.label",
      "info": "t:sections.forsure_report.settings.desktop_image_width.info"
    },
    {
      "type": "select",
      "id": "layout",
      "options": [
        {
          "value": "image_first",
          "label": "t:sections.forsure_report.settings.layout.options__1.label"
        },
        {
          "value": "text_first",
          "label": "t:sections.forsure_report.settings.layout.options__2.label"
        }
      ],
      "default": "image_first",
      "label": "t:sections.forsure_report.settings.layout.label",
      "info": "t:sections.forsure_report.settings.layout.info"
    },
    {
      "type": "select",
      "id": "desktop_content_position",
      "options": [
        {
          "value": "top",
          "label": "t:sections.forsure_report.settings.desktop_content_position.options__1.label"
        },
        {
          "value": "middle",
          "label": "t:sections.forsure_report.settings.desktop_content_position.options__2.label"
        },
        {
          "value": "bottom",
          "label": "t:sections.forsure_report.settings.desktop_content_position.options__3.label"
        }
      ],
      "default": "top",
      "label": "t:sections.forsure_report.settings.desktop_content_position.label"
    },
    {
      "type": "select",
      "id": "desktop_content_alignment",
      "options": [
        {
          "value": "left",
          "label": "t:sections.forsure_report.settings.desktop_content_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:sections.forsure_report.settings.desktop_content_alignment.options__2.label"
        },
        {
          "value": "right",
          "label": "t:sections.forsure_report.settings.desktop_content_alignment.options__3.label"
        }
      ],
      "default": "left",
      "label": "t:sections.forsure_report.settings.desktop_content_alignment.label"
    },
    {
      "type": "select",
      "id": "content_layout",
      "options": [
        {
          "value": "no-overlap",
          "label": "t:sections.forsure_report.settings.content_layout.options__1.label"
        },
        {
          "value": "overlap",
          "label": "t:sections.forsure_report.settings.content_layout.options__2.label"
        }
      ],
      "default": "no-overlap",
      "label": "t:sections.forsure_report.settings.content_layout.label"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "options": [
        {
          "value": "accent-1",
          "label": "t:sections.all.colors.accent_1.label"
        },
        {
          "value": "accent-2",
          "label": "t:sections.all.colors.accent_2.label"
        },
        {
          "value": "background-1",
          "label": "t:sections.all.colors.background_1.label"
        },
        {
          "value": "background-2",
          "label": "t:sections.all.colors.background_2.label"
        },
        {
          "value": "inverse",
          "label": "t:sections.all.colors.inverse.label"
        }
      ],
      "default": "background-1",
      "label": "t:sections.all.colors.label"
    },
     {
      "type": "select",
      "id": "color_scheme2",
      "options": [
        {
          "value": "accent-1",
          "label": "t:sections.all.colors.accent_1.label"
        },
        {
          "value": "accent-2",
          "label": "t:sections.all.colors.accent_2.label"
        },
        {
          "value": "background-1",
          "label": "t:sections.all.colors.background_1.label"
        },
        {
          "value": "background-2",
          "label": "t:sections.all.colors.background_2.label"
        },
        {
          "value": "inverse",
          "label": "t:sections.all.colors.inverse.label"
        }
      ],
      "default": "background-1",
      "label": "t:sections.all.colors.label"
    },
    {
      "type": "header",
      "content": "Mobile layout"
    },
    {
      "type": "select",
      "id": "mobile_content_alignment",
      "options": [
        {
          "value": "left",
          "label": "t:sections.forsure_report.settings.mobile_content_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:sections.forsure_report.settings.mobile_content_alignment.options__2.label"
        },
        {
          "value": "right",
          "label": "t:sections.forsure_report.settings.mobile_content_alignment.options__3.label"
        }
      ],
      "default": "left",
      "label": "t:sections.forsure_report.settings.mobile_content_alignment.label"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "t:sections.forsure_report.presets.name"
    }
  ]
}
{% endschema %}
