{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}
{{ 'bootstrap3.4.1min.css' | asset_url | stylesheet_tag }}

{%- style -%}
.section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  
table {
    border-collapse: collapse;
    margin: 20px 0;
}
th, td {
    border: 1px solid black;
    padding: 8px;
    text-align: left;
}
.popup {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    border: 1px solid #ddd;
    padding: 30px;
    background-color: white;
    z-index: 1000;
}
.overlay {
    display: none;
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5);
    z-index: 500;
}

table {
    width: 100%;
    border-collapse: collapse;
}


.edit-btn, .modal button {
    padding: 5px 10px;
    /* color: white; */
    /* border: none; */
    cursor: pointer;
}

.modal {
    display: none;
    position: fixed;
    z-index: 101;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 34%;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.btn-check:checked + .btn {
    background-color: #2255ff;
    color: #fafafa;
}

.btn-check:not(:checked) + .btn {
    background-color: #fafafa;
    color: #17161c;
    border-color: #17161c;
    border-radius: 0.2rem;
}
.disabled-table {
    pointer-events: none;
    opacity: 0.5;
    /* background-color: grey; */
}

#role-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px; /* Space between items */
    max-width: 600px; /* Optional: limit the width of the container */
    margin: 0 auto;
}

.role-item {
    flex: 0 1 calc(33.33% - 20px); /* 3 items per row, with gap space accounted for */
    text-align: center;
    margin-bottom: 20px; /* Space below each row */
}


.tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 45px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}
    px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}
    px;
  }


  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}
      px;
      padding-bottom: {{ section.settings.padding_bottom }}
      px;
    }
  }
  .image-with-text p {
    text-align: left;
    hyphens: auto;
    -webkit-hyphens: auto;
  }
  .border {
    border: 0.2rem solid #17161c;
  }
  .bordertop {
    border-top: 0.2rem solid #17161c;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }
  td {
    border: none !important;
    border-top: 0.2rem solid #17161c !important;
  }

  .flex-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .table-header {
    text-decoration: underline; /* Underline the text */
    cursor: pointer; /* Change cursor to a hand pointer */
    margin-left: 10px;
  }
  .icons {
    margin-left: auto;
    margin-right: 0;
    flex-grow: 0;
    flex-shrink: 0;
    width: 35%; /* occupies 30% of the flex container */
    justify-content: flex-end; /* aligns icons to the right within their space */
    display: flex;
  }

  .arrow {
    margin-left: 10px;
    margin-right: 10px; /* Optional: Add some space between the arrow and the text */
    transition: transform 0.3s ease;
  }

  .icons i {
    margin-left: 10px;
    cursor: pointer;
  }

  .flex-header.rotated .arrow {
    transform: rotate(90deg);
  }
  .trashcan,
  .info {
    cursor: pointer;
  }
  .nonlivedata {
    display: block;
  }
  .livedata {
    display: none;
  }

  .toggle-container {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
    /* margin-left: 10px; */
    vertical-align: middle;
    margin: auto;
    flex-shrink: 0;
}

.toggle-container input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #2255ff;
}

input:focus + .toggle-slider {
    box-shadow: 0 0 1px #2255ff;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}
  .toggle-options {
  align-items: center;
  display: flex;
}
div.display-flex {
    display: flex;
    align-items: center; /* Align items vertically in the middle */
    justify-content: flex-start; /* Align items to the start of the container */
    gap: 10px; /* Adjust as needed, adds space between children */
}

.tab {
    cursor: pointer;
    padding: 10px;
    margin-right: 5px;
    background-color: #f1f1f1;
    border: solid 1px #ccc;
    border-bottom: none;
  }
  .tab:hover {
    background-color: #ddd;
  }
  .tab-content {
    border: solid 1px #ccc;
    padding: 10px;
    display: none;
  }
  .active, .tab:hover {
    background-color: #2255FF;
    color: #fafafa;
  }

#countrySelectionContainer {
  display: none; /* Start hidden */
  position: absolute; /* Position it below the icon or wherever it fits */
  background-color: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 10px;
  box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
  z-index: 1; /* Make sure it's above other content */
  border-radius: 1rem;
}

#countrySelectionContainer ul {
  list-style: none; /* Remove default list styling */
  margin: 0;
  padding: 0;
}

#countrySelectionContainer li {
  padding: 8px 12px;
  border-bottom: 1px solid #eee;
  cursor: pointer; /* Change cursor on hover */
}

#countrySelectionContainer li:hover {
  background-color: #f6f6f6;
}
#countrySelectionContainer li:last-child {
  border-bottom: none;
}
.modal-content {
    position: absolute!important;
    top: 50%;
    left: 50%;
    transform: translateX(-50%) translateY(-50%);
    width: 30%;
}

#editIntegrationForm label, #addIntegrationForm label {
    width: 49%;
    margin-bottom: 1rem;
}

#editIntegrationForm input, #addIntegrationForm input {
    width: 49%;
    margin-bottom: 1rem;
}
.icon-pause, .icon-play {
    height: 2rem;
}


.card-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
  margin: 2rem 0;
}

.card {
  flex: 1 1 200px;
  max-width: 220px;
  background-color: #fff;
  border-radius: 1rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  text-align: center;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
}

.card-body {
  padding: 1.5rem;
}

.card-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #333;
  margin: 0;
}

/* Optional: highlight selected connector */
.card.selected {
  border: 2px solid #007bff;
  box-shadow: 0 6px 16px rgba(0, 123, 255, 0.25);
}

/* Coming Soon: dim it */
.card.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}


{%- endstyle -%}
{% if customer.tags contains 'member' or customer.tags contains 'vendor' %}


  <!-- Load d3.js -->
  <!-- <script src="https://d3js.org/d3.v4.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"> </script>
<script src="{{ 'forsure-endpoints.js' | asset_url }}"></script>
<script src="{{ 'forsure-data-loader.js' | asset_url }}"></script>
{% render 'forsure-login' %}
{% render 'forsure-simple-notification' %}
{% render 'forsure-confirmation' %}
<div class="section-{{ section.id }}-padding">
    <div id="accessManagement" class="configbox page-width border" style="border-radius: 1rem;position:relative;background: #fafafa;">
        <div><h2>Integrations</h2></div>
        <table>
            <thead>
                <tr>
                    <th>Integration</th>
                    <th>Status</th>
                    <th>Last Data Received</th>
                    <th style="width: 10%;">Configure</th>
                    <th style="width: 10%">Delete</th>
                </tr>
            </thead>
            <tbody id="integrationList">          
            </tbody>
        </table>
        <div id="container" style="padding-bottom: 2rem; display: flex">
            <button id="addApiTokenButton" class="button" style="margin-left: auto;" onclick="addNewIntegration()">Add Integration</button>
        </div>
    </div>
</div>
<div id="editIntegrationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditIntegrationModal()">&times;</span>
        <h2>Edit Integration</h2>
        <div id="editIntegrationForm">
            <input type="hidden" id="integrationId" name="integrationId">
            <input type="hidden" id="integrationConnectorType" name="integrationConnectorType">
            <div>
                <label for="integrationName">Integration Name:</label>
                <input type="text" id="integrationName" name="integrationName" required>
            </div>
            <div>
                <label for="storeUrl">Store URL:</label>
                <input type="text" id="storeUrl" name="storeUrl" required>
            </div>
            <div>
                <label for="apiKey">API Key:</label>
                <input type="password" id="apiKey" name="apiKey" required>
            </div>
            <div style="display: flex; align-items: center;margin-bottom: 1rem;">
                <label for="integrationStatus" style="display: flex; align-items: center;">Status:</label>
                <div id="toggleContainer" style="margin-bottom: 1rem;cursor: pointer;">
                    <div id="toggleButton"  data-status="RUNNING">
                        <div id="togglePauseIcon" style="display: none;align-items: center;">
                            {%- render 'icon-pause' -%} Running
                        </div>
                        <div id="togglePlayIcon" style="display: none;align-items: center;">
                            {%- render 'icon-play' -%} Stopped
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="editIntegrationFormButtons" style="display: flex; justify-content: space-between;">
            <button class="button" style="background-color: #17161c;" onclick="closeEditIntegrationModal()">Close</button>
            <button id="saveIntegrationButton" class="button" onclick="saveIntegration()">Save</button>
        </div>
    </div>
</div>
<div id="addIntegrationModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddIntegrationModal()">&times;</span>
        <h2>Add Integration</h2>
        <div id="chooseConnectorType">
            <div class="card-container">
                <div class="card" onclick="selectConnectorType('SHOPIFY')">
                    <div class="card-body">
                        <h5 class="card-title">Shopify</h5>
                    </div>
                </div>
                <div class="card" onclick="selectConnectorType('ODOO')">
                    <div class="card-body">
                        <h5 class="card-title">Odoo</h5>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Coming Soon</h5>
                    </div>
                </div>
            </div>
        </div>
        <div id="addIntegrationForm" style="display: none;">
            <input type="hidden" id="integrationConnectorTypeNew" name="integrationConnectorType">
            <div>
                <label for="integrationNameNew">Integration Name:</label>
                <input type="text" id="integrationNameNew" name="integrationNameNew" required>
            </div>
            <div>
                <label for="storeUrl">Store URL:</label>
                <input type="text" id="storeUrlNew" name="storeUrlNew" required>
            </div>
            <div>
                <label for="apiKeyNew">API Key:</label>
                <input type="password" id="apiKeyNew" name="apiKeyNew" required>
            </div>
            <div id="addIntegrationFormButtons" style="display: flex; justify-content: space-between;">
                <button class="button" style="background-color: #17161c;" onclick="addNewIntegration()">Back</button>
                <button id="newIntegrationButton" class="button" onclick="saveNewIntegration()">Save</button>
            </div>
        </div>
       
    </div>
</div>

<script>
    async function getIntegrations() {
        try {
            var data = await unifiedSendRequest(GETINTEGRATIONS, {method: 'GET', headerArgs: {'Content-Type': 'application/json'}});
            console.log(data);
            document.getElementById('integrationList').innerHTML = '';
            for (integration of data) {
                addIntegration(integration);
            }
        } catch (error) {
            console.error('Failed to get integrations:', error);
            showMessage('Failed to get integrations: ' + error.message, false);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        getIntegrations();
    });

    function addIntegration(integration) {
        var table = document.getElementById('integrationList');
        var row = table.insertRow(-1);
        row.id = integration.id;
        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        cell1.innerHTML = integration.name;
        cell2.innerHTML = integration.status;
        cell3.innerHTML = integration.last_data_received ? integration.last_data_received : 'No data received';
        if (integration.can_edit) {
            cell4.innerHTML = `<div title="Edit the integration" style="margin: auto;width: fit-content;cursor: pointer"><svg onclick="openEditIntegrationModal('${integration.id}')" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="15" height="15" x="0px" y="0px" viewBox="0 0 117.74 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path fill="#17161c" class="st0" d="M94.62,2c-1.46-1.36-3.14-2.09-5.02-1.99c-1.88,0-3.56,0.73-4.92,2.2L73.59,13.72l31.07,30.03l11.19-11.72 c1.36-1.36,1.88-3.14,1.88-5.02s-0.73-3.66-2.09-4.92L94.62,2L94.62,2L94.62,2z M41.44,109.58c-4.08,1.36-8.26,2.62-12.35,3.98 c-4.08,1.36-8.16,2.72-12.35,4.08c-9.73,3.14-15.07,4.92-16.22,5.23c-1.15,0.31-0.42-4.18,1.99-13.6l7.74-29.61l0.64-0.66 l30.56,30.56L41.44,109.58L41.44,109.58L41.44,109.58z M22.2,67.25l42.99-44.82l31.07,29.92L52.75,97.8L22.2,67.25L22.2,67.25z"/></g></svg></div>`;
            if (integration.can_delete) {
                cell5.innerHTML = `<div title="Delete this integration" style="margin: auto;width: fit-content;cursor: pointer"><img onclick="validateDeleteIntegration('${integration.id}', '${integration.name}')" width="20px" src="{{ section.settings.trashcan | image_url }}" alt="{{ section.settings.trashcan.alt | escape }}" loading="lazy"></div>`;
            }
        } else {
            cell4.colSpan = 2;
            cell4.innerHTML = "You cannot edit this integration";
            row.deleteCell(4);
        }
    }

    function validateDeleteIntegration(integrationId, integrationName) {
        var text = `Are you sure you want to delete the following integration?<br><br>Name: ${integrationName}`;
        showConfirmationMessage("Delete Integration", text, "Cancel", "Delete", function() {deleteIntegration(integrationId)});
    }
    
    async function deleteIntegration(integrationId) {
        try {
            var formData = new FormData();
            formData.append('config_id', integrationId);
            const response = await unifiedSendRequest(GETINTEGRATIONS, {formData: formData, method: 'DELETE'});
            if (response.status) {
                showMessage('Integration deleted successfully!', true);
                closeConfirmationModal();
                getIntegrations();
            } else {
                console.error(response);
                showMessage('Failed to delete integration. Please try again.', false);
            }
        } catch (error) {
            console.error('Error deleting integration:', error);
            showMessage('Failed to delete integration' + error.message, false);
        }
    }
    
    
    async function openEditIntegrationModal(integrationId) {
        try {
            var integration = await unifiedSendRequest(GETINTEGRATIONBYID + '?id=' + integrationId, {method: 'GET'});
            console.log(integration);
            document.getElementById('integrationId').value = integration.id;
            document.getElementById('integrationConnectorType').value = integration.connector_type;
            document.getElementById('integrationName').value = integration.name;
            document.getElementById('storeUrl').value = integration.store_url;
            document.getElementById('apiKey').value = integration.api_token;
            if (integration.status == 'RUNNING') {
                document.getElementById('togglePauseIcon').style.display = 'flex';
                document.getElementById('togglePlayIcon').style.display = 'none';
                document.getElementById('toggleButton').dataset.status = 'RUNNING';
            } else {
                document.getElementById('togglePauseIcon').style.display = 'none';
                document.getElementById('togglePlayIcon').style.display = 'flex';
                document.getElementById('toggleButton').dataset.status = 'STOPPED';
            }
            document.getElementById('toggleButton').onclick = function() {
                if (document.getElementById('toggleButton').dataset.status == 'RUNNING') {
                    document.getElementById('togglePauseIcon').style.display = 'none';
                    document.getElementById('togglePlayIcon').style.display = 'flex';
                    document.getElementById('toggleButton').dataset.status = 'STOPPED';
                } else {
                    document.getElementById('togglePauseIcon').style.display = 'flex';
                    document.getElementById('togglePlayIcon').style.display = 'none';
                    document.getElementById('toggleButton').dataset.status = 'RUNNING';
                }
            }
            var modal = document.getElementById('editIntegrationModal');
            modal.style.display = "block";
        } catch (error) {
            console.error('Failed to get integration:', error);
            showMessage('Failed to get integration: ' + error.message, false);
        }
    }
    
    function closeEditIntegrationModal() {
        var modal = document.getElementById('editIntegrationModal');
        modal.style.display = "none";
    }

    function addNewIntegration() {
        var modal = document.getElementById('addIntegrationModal');
        modal.style.display = "block";    
        document.getElementById('addIntegrationForm').style.display = "none";
        document.getElementById('chooseConnectorType').style.display = "block";
    }

    function selectConnectorType(connectorType) {
        document.getElementById('integrationConnectorTypeNew').value = connectorType;
        document.getElementById('addIntegrationForm').style.display = "block";
        document.getElementById('chooseConnectorType').style.display = "none";
        document.getElementById('integrationNameNew').value = '';
        document.getElementById('integrationNameNew').placeholder = 'Enter integration name';
        document.getElementById('storeUrlNew').value = '';
        document.getElementById('storeUrlNew').placeholder = 'Enter store URL';
        document.getElementById('apiKeyNew').value = '';
        document.getElementById('apiKeyNew').placeholder = 'Enter API key';
    }

    async function saveNewIntegration() {
        var integrationData = {
            name: document.getElementById('integrationNameNew').value,
            store_url: document.getElementById('storeUrlNew').value,
            api_token: document.getElementById('apiKeyNew').value,
            status: 'RUNNING',
            connector_type: document.getElementById('integrationConnectorTypeNew').value
        }
        saveIntegration(integrationData);
    }

    function closeAddIntegrationModal() {
        var modal = document.getElementById('addIntegrationModal');
        modal.style.display = "none";
    }

    async function saveIntegration(integrationData=false) {
        if (!integrationData) {
            integrationData = {
                id: document.getElementById('integrationId').value,
                name: document.getElementById('integrationName').value,
                store_url: document.getElementById('storeUrl').value,
                api_token: document.getElementById('apiKey').value,
                status: document.getElementById('toggleButton').dataset.status,
                connector_type: document.getElementById('integrationConnectorType').value
            }
        }
        try {
            const response = await unifiedSendRequest(GETINTEGRATIONS, {formData: JSON.stringify(integrationData), headerArgs: {'Content-Type': 'application/json'}});
            if (response.success === true) {
                showMessage('Integration saved successfully!', true);
                closeEditIntegrationModal();
                closeAddIntegrationModal();
                getIntegrations();
            } else {
                console.error(response);
                showMessage('Failed to save integration. Please try again.', false);
            }
        } catch (error) {
            console.error('Failed to save integration:', error);
            showMessage('Failed to save integration: ' + error.message, false);
        }
    }

</script>
{% endif %}

{% schema %}
  {
    "name": "t:sections.forsure_api.name",
    "class": "section",
    "settings": [
        {
        "type": "image_picker",
        "id": "trashcan",
        "label": "Trashcan"
      },
      {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "t:sections.all.padding.padding_bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "t:sections.forsure_api.presets.name"
      }
    ]
  }
{% endschema %}