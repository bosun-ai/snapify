{% style %}
    #mapContainer {
        position: relative;
        /* z-index: 1; */
    }
    #eprMap {
        height: calc(100% - 40px);
        width: 100%;
        z-index: 1;
    }

    /* Ensure dropdown appears above map */
    #profile-filter-guide {
        position: relative;
        z-index: 1000;
    }

    /* Bootstrap Select dropdowns are appended to body, so target globally */
    #profile-filter-guide .bootstrap-select {
        z-index: 1000 !important;
    }

    /* Target all Bootstrap Select dropdown menus - they're appended to body */
    /* Use very high z-index to ensure it's above Leaflet map (which uses z-index 400-600) */
    .bootstrap-select .dropdown-menu,
    .bootstrap-select.open .dropdown-menu,
    .bootstrap-select .dropdown-toggle ~ .dropdown-menu {
        z-index: 10000 !important;
        width: 220px;
        /* position: absolute !important; */
    }

    /* Ensure the dropdown menu container has proper stacking */
    .bootstrap-select {
        z-index: 1000 !important;
    }

    #eprMapAdd {
      width: 80%;
      /* height: 50vh; */
      border-radius: 1rem;
    }

  .leaflet-tooltip.custom-tooltip {
    background-color: #fafafa;
    color: #17161c;
    padding: 0;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    border: none;
    max-width: none; /* let inner div control width */
    width: auto;
  }

  .leaflet-tooltip.custom-tooltip .tooltip-inner {
    padding: 8px 10px;
    font-size: 12px;
    white-space: pre-line;  /* allow wrapping and \n */
    word-wrap: break-word;
    line-height: 1.4;
  }

  .tooltip-inner.tooltip-narrow {
    max-width: 180px;
    min-width: 100px;
  }

  .tooltip-inner.tooltip-wide {
    min-width: 300px;
    max-width: 320px;
  }

  .tooltip-inner.tooltip-multiline {
    min-width: 200px;
    max-width: 240px;
  }

  .country-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }

  #countryList {
    display: flex;
    flex-direction: column;
    gap: 10px;
    height: 39.5vh;
    overflow-y: auto;
  }

  .modal-content-wide {
    width: 80%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 120rem;
    position: absolute !important;
    background-color: #fafafa;
    padding: 20px;
    border-radius: 1rem;
  }

  .modal-body {
    display: flex;
    gap: 20px;
  }

  .country-item {
    display: flex;
    gap: 1rem;
  }

  #mapAddOverlay, #mapAddCategoriesOverlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99;
  }

  #next-button {
    margin-left: auto;
    width: fit-content;
  }

#mapAddSelectCategories {
  display: none;
}

#category-list {
  flex: 1 1 0;
    min-height: 0;
    overflow: auto;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 3rem;
    align-content: start;
}

.category-item {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
  position: relative;
}

.button-unselected {
  border: 0.2rem solid #17161c;
  width: 70%;
  margin: auto;
}

.button-selected {
  border: 0.2rem solid #2255ff;
  width: 70%;
  margin: auto;
}

#category-list-container {
  display: flex;
  width: 80%;
  height: 45vh;
  flex-direction: column;
}

#add-category-button {
  display: flex;
  justify-content: space-between;
  width: fit-content;
  flex-direction: column;
  margin-left: calc(6% + 0.75rem * 0.7)
    /* aligned with button start, (80% width - 3 rem gap)  / 2 * 70% (button width) / 2 (padding on both sides)*/
}

#add-category-button-container {
  display: flex;
  gap: 10px;
}

.button-remove {
  position: absolute;
  right: 0;
  padding: 0;
  min-width: 0;
  width: 3rem;
  border: 0.2rem solid #17161c;
}



#tabs-container {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
    overflow-x: auto;
}

.tab-button, .tab-button-credentials {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

.tab-button:hover, .tab-button-credentials:hover {
    background-color: #eaeaea;
}

.tab-button.active, .tab-button-credentials.active {
    background-color: #2255ff;
    color: #fafafa;
    font-weight: bold;
}

.tab-button, .tab-button-credentials {
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-bottom: none;
    background-color: #f9f9f9;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    margin-right: 5px;
    border-radius: 8px 8px 0 0;
}

  .tab {
      cursor: pointer;
      padding: 10px;
      margin-right: 5px;
      background-color: #f1f1f1;
      border: solid 1px #ccc;
      border-bottom: none;
    }
    .tab:hover {
      background-color: #ddd;
    }
    .tab-content {
      border: solid 1px #ccc;
      padding: 10px;
      display: none;
    }
    .active, .tab:hover {
      background-color: #2255FF;
      color: #fafafa;
    }
    .button--secondary {
      border: 0.2rem solid #17161c;
    }
  
  .iconhomepage .st4 {
    stroke-width: 0;
  }
  .icon-container-reports {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
  }
  
  #mapLegend {
    position: absolute;
    top: 50px;
    right: 15px;
    background-color: #fafafa;
    border-radius: 8px;
    border: 0.2rem solid #17161c;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    z-index: 1;
    font-size: 12px;
    font-family: sans-serif;
    min-width: 200px;
    max-width: 300px;
    max-height: calc(90vh - 13rem - 45px);
    overflow-y: auto;
  }
  
  #mapLegendHeader {
    display: flex;
    align-items: center;
    cursor: pointer;
    gap: 5px;
    padding: 10px;
    background-color: #484B52;
  }
  
  #mapLegendHeader h4 {
    margin: 0;
    font-size: 14px;
    font-weight: bold;
    color: #fafafa;
    flex: 1;
  }
  
  
  #mapLegendContent {
    display: none;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    background-color: #fafafa;
    margin-bottom: 0.5rem;
    margin-top: 0.5rem;
  }
  
  #mapLegendContent.expanded {
    display: block;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 10px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  
  .legend-item:hover {
    background-color: #f0f0f0;
  }
  
  .legend-item.selected {
    background-color: #e3e8ff;
  }
  
  .legend-item.selected:hover {
    background-color: #d4dcff;
  }
  
  .legend-item.disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .legend-item.disabled:hover {
    background-color: transparent;
  }
  
  .legend-item:last-child {
    margin-bottom: 0;
  }
  
  .legend-color {
    width: 0.8em;
    height: 0.8em;
    border-radius: 50%;
    border: 1px solid #ddd;
    flex-shrink: 0;
  }
  
  .legend-label {
    color: #17161c;
    flex: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .legend-country-accordion {
    display: none;
    margin-top: 8px;
    margin-left: 1.5rem;
    max-height: 200px;
    overflow-y: auto;
    border-left: 2px solid #ddd;
    padding-left: 10px;
  }
  
  .legend-country-accordion.expanded {
    display: block;
  }
  
  .legend-country-item {
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 11px;
  }
  
  .legend-country-item:hover {
    background-color: #e0e0e0;
  }
  .modal-title {
    margin-left: 15px;
    margin-right: 15px;
    justify-content: space-between;
    display: flex;
  }
  .tooltip-table-key {
    width: 50%;
    margin-left: 1rem;
    text-align: left;
  }
  .tooltip-table-value {
    width: 50%;
    text-align: left;
  }
  .tooltip-table-row {
    display: flex;
    /* justify-content: space-between; */
    width: 100%;
  }
  .tooltip-table {
    width: 100%;
  }

  .map-settings-item {
    display: block;
  }
  .map-settings-item-country {
  }
  .map-settings-item-report-type {
  }
  .map-settings-item-pro {
  }

  
.collapsed {
  transform: rotate(270deg); /* Rotate arrow 90 degrees when collapsed */
}


.pro-active {
  background: #2255ff;
  width: fit-content;
  padding: 1rem;
  border-radius: 1rem;
  color: #fafafa;
}

.modal-body {
    display: flex;
    flex-direction: row;
    gap: 2rem;
    padding: 3rem 1.5rem;
    font-family: sans-serif;
  }

  #left-side-pro-country-list {
    width: 250px;
    border-right: 1px solid #ddd;
    padding-right: 1rem;
    overflow: auto;
    height: 45vh;
  }

  #main-section {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 45vh;
    overflow: auto;
  }

  #pro-name {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    border-bottom: 1px solid #ccc;
    padding-bottom: 0.5rem;
    font-size: 1.2rem;
    flex: 0 0 auto;
  }

  #pro-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem 2rem;
    flex: 1 1 auto;
  }

  #pro-details > div {
    display: flex;
    flex-direction: column;
  }

  #pro-details label {
    font-weight: bold;
    margin-bottom: 4px;
  }

  input[type="text"],
  input[type="password"],
  textarea {
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    width: 100%;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  #questions {
    grid-column: span 2;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .question-input {
    display: flex;
    flex-direction: column;
  }

  .question-input input {
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }

  #pro-status {
    font-size: large;
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  #pro-status svg {
    height: 30px;
    width: 30px;
  }

.questions-label {
  width: 50%;
  margin-right: 1rem;
}
.glyphicon-ok:before {
    content: "\2713"
}
.od-toggle {
  width:24px;
  height:24px;
  display:grid; place-items:center;
  margin: 0;                /* FIX: removed margin-right */
  justify-self: center;     /* center in caret column */
  cursor:pointer;
}
.legend-arrow{ 
  transition: transform .15s ease; 
  transform: rotate(-90deg);
  cursor: pointer;
  width: 25px;
}
.legend-arrow.expanded{ transform: rotate(0deg); }


{% endstyle %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>

<div id="mapContainer" class="widget grid-item widget-right">
  <div id="mapTitle" class="grid-title">
    <div>EPR Map</div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <div class="filter-group" id="profile-filter-guide" style="margin-left: 4rem">
        <select
          id="countryDropdown"
          class="selectpicker"
          data-size="5"
          placeholder="Select countries"
          data-live-search-placeholder="Choose country"
          data-live-search="true">
        </select>
      </div>
      <div class="icon-container" style="display: flex; align-items: center; gap: 1rem;">
        {% comment %} <select
          id="countrySearch"
          class="selectpicker"
          title="Search country">
          <option value="">All countries</option>
        </select> {% endcomment %}

        <div onclick="openMapAdd()">{% render 'icon-add' %}</div>
        <div onclick="openMapSettings()">{% render 'icon-gear' %}</div>
      </div>
    </div>
  </div>
    <div id="eprMap"></div>
    <div id="mapLegend">
      <div id="mapLegendHeader">
        <div class="legend-arrow" title="Showlegend">{% render 'icon-arrow-rounded-big' %}</div>
        <h4>Status Legend</h4>
      </div>
      <div id="mapLegendContent"></div>
    </div>
</div>

<div id="mapAddOverlay"></div>
<div id="mapAddModal" class="modal">
  <div class="modal-content-wide">
    <div id="mapAddCountrySelect">
      <h2 class="modal-title">Add Countries
        <div>
          <button class="button button--secondary" onclick="closeModalAdd()">Back</button>
          <button class="button" onclick="selectReportCategories()">Next</button>
        </div>
      </h2>
      <div class="modal-body">
        <div id="search-country-container" style="display: flex; flex-direction: column; gap: 1rem; width: 250px;">
          <input type="text" id="search-country" placeholder="Search country" style="width: 100%;" onkeyup="searchCountry()">
          <div id="countryList">
            <!-- list of all countries with a checkbox -->
          </div>
        </div>
        <div id="eprMapAdd">
        </div>
      </div>
    </div>
    <div id="mapAddSelectCategories">
      <h2 class="modal-title"> Select Report Categories
        <div>
          <button class="button button--secondary" onclick="backToAddCountries()">Back</button>
          <button class="button" onclick="selectPROs(true)">Next</button>
        </div>
      </h2>
      <div class="modal-body">
        <div class="icon-container-reports">
          <div class="iconhomepage" style="background-color:#fafafa; border-radius: 10%; display: flex;
                  justify-content: center; align-items: center;z-index: 2;height: 45vh;width: 45vh;
                  box-shadow: 0 10px 20px -10px rgba(0, 0, 0, 1);margin: auto;">
          {% render 'icon-goods-categories' %}
          </div>
          
        </div>
        <div id="category-list-container">
          <div id="category-list-header" style="display: none; text-align: center; margin-bottom: 1rem;"></div>
          <div id="category-list">
            <!-- list of all categories with a checkbox -->
          </div>
          <div id="add-category-button">
            <h6>Every category you add will be a recommendation for our roadmap.</h6>
            <div id="add-category-button-container" title="If you want to add a category that is not in the list, please enter the category name in the input field and click the button. We will put it on our roadmap and add it to the list as soon as possible.">
              <input type="text" id="input-category-others" placeholder="Add Category" style="width: 50%;">
              <button class="button" onclick="addCategory()">Add Category</button>
            </div>
            
          </div>
        </div>
      </div>
    </div>
    <div id="mapAddSelectPROs">
      <h2 class="modal-title">Select PROs
        <div style="display: flex;gap: 1rem;">
          <button id="back-button-pro" class="button button--secondary" onclick="selectReportCategories()">Back</button>
          <button id="save-button-pro" class="button" onclick="saveAndClose()">Close</button>
        </div>
      </h2>
        <div class="modal-body">
          <div>
            <input type="text" id="search-pro" placeholder="Search PRO" style="width: fit-content;" onkeyup="filterPROs()">
            <div id="left-side-pro-country-list">
              <!-- list of all countries, report_types and PROs -->
            </div>
          </div>
          <div id="main-section">
            <!-- Details of the selected PRO -->
            <input type="hidden" id="pro-id" value="">
            <input type="hidden" id="country" value="">
            <input type="hidden" id="reportType" value="">
            <input type="hidden" id="pro-name-input" value="">
            <h3 id="pro-name">
              <select id="pro-name-select" class="selectpicker">
                <option value="">Not set</option>
              </select>
              <span id="pro-status">Status</span>
            </h3>
        
            <div id="pro-details">
              <div id="login-name">
                <label for="login-name-input">Login Name</label>
                <input type="text" id="login-name-input" placeholder="Login Name" title="Login Name for the PRO">
              </div>
        
              <div id="password">
                <label for="password-input">Password</label>
                <input type="password" id="password-input" placeholder="Password" title="Password for the PRO">
              </div>

              <div id="agency_email">
                <label for="agency_email-input">Agency Email</label>
                <input type="text" id="agency_email-input" placeholder="Email of Agency if we should send the report to them" title="Email of Agency if we should send the report to them">
              </div>

              <div id="registration_number">
                <label for="registration_number-input">Registration Number</label>
                <input type="text" id="registration_number-input" placeholder="Registration Number" title="Registration Number for the PRO">
              </div>
        
              <div id="email-responsible">
                <label for="email-responsible-input">Email Responsible</label>
                <select id="email-responsible-input" title="Person(s) in company responsible for the PRO" onchange="updatePROStatus()"
                  class="selectpicker"
                  multiple
                  data-live-search="true">
                  <option value="">Not set</option>
                </select>
              </div>
        
              <div id="extra-info">
                <label for="extra-info-input">Extra Info</label>
                <textarea id="extra-info-input" placeholder="Extra Info" title="Extra Info for the login of the PRO"></textarea>
              </div>
        
              <div id="questions">
                <!-- Dynamic questions go here -->
                <!-- Example injected question below -->
                <!-- 
                <div class="question-input">
                  <label for="question-1-input">Question 1</label>
                  <input type="text" id="question-1-input" placeholder="Question 1">
                </div>
                -->
              </div>
          </div>
          <div id="add-pro-options">
          </div>
        </div>
    </div>
  </div>
</div>

<script>

      // Color mapping based on status
      const statusColors = {
        "DONE": "#21FF3D",          // Green
        "IN_PROGRESS": "#2255ff",   // Blue
        "WARNING": "#E6B83C",       // Yellow
        "ERROR": "#E63C6B",          // Red
        "UNKNOWN": "#4E5366",
        "UNAVAILABLE": "#ffffff",  // white
        "UNACCOUNTED_ORDERS": "#17161c", // black
      };

      // Status label mapping
      const statusLabels = {
        "DONE": "Done",
        "IN_PROGRESS": "In Progress",
        "WARNING": "Warning",
        "ERROR": "Error",
        "UNKNOWN": "Unknown",
        "UNAVAILABLE": "Unavailable",
        "UNACCOUNTED_ORDERS": "Unaccounted Orders",
      };

      // Status descriptions for tooltips
      const statusDescriptions = {
        "DONE": "All reports for this country are completed and validated",
        "IN_PROGRESS": "Reports are being processed or are in progress",
        "WARNING": "There are warnings that need attention for this country",
        "ERROR": "There are errors that need to be resolved for this country",
        "UNKNOWN": "Status is unknown for this country",
        "UNAVAILABLE": "This country is not yet available in the system",
        "UNACCOUNTED_ORDERS": "There are unaccounted orders for this country",
      };

      let countryStatusMap = {}; // Store country data by status
      let activeLegendStatus = ''; // Currently selected status in legend

      function updateMapFiltering(selectedCountries) {
        // Update opacity of countries based on selected status
        for (const alpha2 in countryLayers) {
          const layerList = countryLayers[alpha2];
          if (!layerList) continue;
          
          const countryInfo = countryStatusMap[alpha2];
          let opacity = 0.7; // Default opacity
          if (selectedCountries.length > 0 && !selectedCountries.includes(alpha2)) {
            opacity = 0.3;
          }
          
          for (const layer of layerList) {
            const currentStyle = layer.options;
            layer.setStyle({
              fillColor: currentStyle.fillColor || statusColors[countryInfo?.status] || '#4E5366',
              fillOpacity: opacity,
              weight: currentStyle.weight || 1
            });
          }
        }
      }

      function createMapLegend() {
        const legendContent = document.getElementById('mapLegendContent');
        if (!legendContent) return;
        
        // Setup header toggle
        const legendHeader = document.getElementById('mapLegendHeader');
        const legendArrow = legendHeader.querySelector('.legend-arrow');
        
        legendHeader.addEventListener('click', () => {
          const isExpanded = legendContent.classList.contains('expanded');
          if (isExpanded) {
            legendContent.classList.remove('expanded');
            legendArrow.classList.remove('expanded');
            selectedCountries = [];
            activeLegendStatus = '';
            updateMapFiltering([]);
            updateLegendContent();
            createDeadlineList(allDeadlines);
            updateInformation(latestInformation);
          } else {
            legendContent.classList.add('expanded');
            legendArrow.classList.add('expanded');
          }
        });
        
        // Build legend items
        updateLegendContent();
      }

      function updateLegendContent() {
        const legendContent = document.getElementById('mapLegendContent');
        if (!legendContent) return;
        
        legendContent.innerHTML = '';
        
        // Count countries by status
        const statusCounts = {};
        const statusCountries = {};
        
        for (const [alpha2, countryInfo] of Object.entries(countryStatusMap)) {
          const status = countryInfo.status;
          const countryName = countryLayers[alpha2]?.[0]?.feature?.properties?.COUNTRY_NAME || alpha2;
          
          if (!statusCounts[status]) {
            statusCounts[status] = 0;
            statusCountries[status] = [];
          }
          statusCounts[status]++;
          statusCountries[status].push({ alpha2, name: countryName });
        }
        
        // Create legend items
        for (const [status, color] of Object.entries(statusColors)) {
          const label = statusLabels[status] || status;
          const count = statusCounts[status] || 0;
          const countries = statusCountries[status] || [];
          
          const itemDiv = document.createElement('div');
          itemDiv.className = 'legend-item';
          itemDiv.dataset.status = status;
          
          // Color dot
          const colorDot = document.createElement('span');
          colorDot.className = 'legend-color';
          colorDot.style.backgroundColor = color;
          if (status === 'UNAVAILABLE') {
            colorDot.style.border = '1px solid #999';
          }
          
          // Label with count
          const labelSpan = document.createElement('span');
          labelSpan.className = 'legend-label';
          labelSpan.innerHTML = `<span>${label}</span><span>(${count})</span>`;
          
          itemDiv.appendChild(colorDot);
          itemDiv.appendChild(labelSpan);
          
          // Tooltip on hover - show description instead of countries
          const description = statusDescriptions[status] || `${label} status`;
          itemDiv.title = description;
          
          if (countries.length === 0) {
            itemDiv.classList.add('disabled');
          }
          
          // Click handler - only if there are countries
          if (countries.length > 0) {
            itemDiv.addEventListener('click', (e) => {
              e.stopPropagation();
              if (activeLegendStatus === status) {
                // Deselect
                selectedCountries = [];
                activeLegendStatus = '';
                updateMapFiltering([]);
                updateLegendContent();
                createDeadlineList(allDeadlines);
                updateInformation(latestInformation);
              } else {
                // Select this status
                selectedCountries = countries.map(country => country.alpha2);
                activeLegendStatus = status;
                updateMapFiltering(selectedCountries);
                updateLegendContent();
                createDeadlineList(allDeadlines);
                updateInformation(latestInformation);
              }
            });
          }
          
          // Add selected class and opacity for non-selected items
          // Only allow selection if there are countries
          if (activeLegendStatus === status && countries.length > 0) {
            itemDiv.classList.add('selected');
          } else if (activeLegendStatus && activeLegendStatus !== status && countries.length > 0) {
            // Only adjust opacity for non-disabled items
            itemDiv.style.opacity = '0.5';
          }
          
          legendContent.appendChild(itemDiv);
        }
      }

      let map = null;
      let mapAdd = null;
      const countryLayers = {}; // Store per-country layers
      let countryLayersAdd = {}; // Store per-country layers
      let geojsonLayer = null;

      let dbPromise = null;
      const categoryOrder = ['WEEE', 'Batteries', 'Packaging'];

      function customSort(a, b) {
        const order = categoryOrder;
        const indexA = order.indexOf(a);
        const indexB = order.indexOf(b);
        // unknown entries should be at the end
        if (indexA === -1 && indexB === -1) {
          // Both not in the fixed order â†’ sort alphabetically
          return a.localeCompare(b);
        }
        if (indexA == -1) return 1;  // a goes after anything in order
        if (indexB == -1) return -1; // b goes after anything in order
        return indexA - indexB;
      }
      
      function createTableFromDescription(descObj) {
        const order = ["WEEE", "Batteries", "Packaging"];
      
        // Sort entries by the predefined order
        const sortedEntries = Object.entries(descObj).sort((a, b) => customSort(a[0], b[0]));

        // Build table
        let table = `<table class="tooltip-table">`;
        for (const [key, value] of sortedEntries) {
          const text = value.trim();
          if (key == '') {
            table += text;
          } else {
            table += `<tr class="tooltip-table-row"><td class="tooltip-table-key"><strong>${key}</strong></td><td class="tooltip-table-value">${text}</td></tr>`;
          }
        }
        table += `</table>`;
      
        return table;
      }

      function initDB() {
        dbPromise = idb.openDB('GeoJSON-Cache', 1, {
          upgrade(db) {
            db.createObjectStore('geojson');
          }
        });
      }

      async function loadGeoJSON() {
        const db = await dbPromise;
        const cached = await db.get('geojson', 'countries_nld');
      
        if (cached) return cached;
      
        const res = await fetch('https://raw.githubusercontent.com/nadbot/Countries_ALPHA2_MAP/main/ne_10m_admin_0_countries_nld.geojson');
        const json = await res.json();
      
        await db.put('geojson', json, 'countries_nld');
        return json;
      }

      var countryCenters = null;
      async function loadCenters() {
        const res = await fetch('https://raw.githubusercontent.com/gavinr/world-countries-centroids/refs/heads/master/dist/countries.geojson');
        const json = await res.json();

        const rows = json.features;
        const centers = {};
        for (const row of rows) {
          const country = row.properties.ISO;
          const lat = row.geometry.coordinates[1];
          const lon = row.geometry.coordinates[0];
          centers[country] = {lat, lon};
        }
        countryCenters = centers;
      }

      function setInitialMap(data, id, countrylayer, tooltips=true, availableCountries=[]){
        var newMap = L.map(id).setView([51.505, 10], 4); // Center Europe
        newMap.attributionControl.setPrefix(false);
        geojsonLayer = L.geoJSON(data, {
          style: {
            color: '#4E5366',
            weight: 1,
            fillOpacity: 0.7,
            fillColor: '#4E5366'
          },
          onEachFeature: (feature, layer) => {
            const name = feature.properties.COUNTRY_NAME;
            let id = feature.properties['ISO_A2_EH'];
            if (id == '-99') {
               return; // skip id -99 name Bir Tawil, Guantanamo Bay USNB, Dhekelia, Spratly Is., Akrotiri, Scarborough Reef
            }
            if (!countrylayer[id]) {
              countrylayer[id] = [];
            }
            countrylayer[id].push(layer);
            if (tooltips) {
              layer.bindTooltip(`<div class="tooltip-inner tooltip-wide"><strong>${name}</strong><br>No data available</div>`, {
                direction: 'top',
                sticky: true,
                className: 'custom-tooltip'
              });
            }
          }
        }).addTo(newMap);

        return newMap;
      }

function toTitleCase(str) {
  return str
    .toLowerCase()
    .split(/[\s_]+/)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

function updateCountryData(newStatusMap) {
  // Update countryStatusMap
  countryStatusMap = {};
  
  for (const alpha2 in newStatusMap) {
    const info = newStatusMap[alpha2];
    const layerList = countryLayers[alpha2];

    if (!layerList) continue;
    
    // Store country status for legend
    countryStatusMap[alpha2] = {
      status: info.status,
      description: info.description
    };
    
    for (const layer of layerList) {
      const name = layer.feature.properties.COUNTRY_NAME;
      // Determine opacity based on active filter
      if (selectedCountries.length > 0 && !selectedCountries.includes(alpha2)) {
        layer.setStyle({
          fillOpacity: 0.3
        });
      }
      
      layer.setStyle({
        fillColor: statusColors[info.status] || '#4E5366',
      });
      if (info.status == 'UNACCOUNTED_ORDERS') {
        tableHTML = Object.values(info.description)[0];
      } else {
        tableHTML = createTableFromDescription(info.description);
      }
      tooltipHTML = `<div class="tooltip-inner tooltip-wide"><strong>${name} - ${toTitleCase(info.status)}</strong><br>${tableHTML}</div>`;
      layer.unbindTooltip();
      layer.bindTooltip(tooltipHTML, {
        direction: 'top',
        sticky: true,
        className: 'custom-tooltip'
      });
      
      // Add click handler to filter by country
      layer.off('click'); // Remove any existing handlers
      layer.on('click', () => {
        if (selectedCountries.includes(alpha2) && selectedCountries.length == 1) {
          selectedCountries = [];
          updateMapFiltering([]);
          updateLegendContent();
          createDeadlineList(allDeadlines);
          updateInformation(latestInformation);
        } else {
          selectedCountries = [alpha2];
          updateMapFiltering(selectedCountries);
          updateLegendContent();
          createDeadlineList(allDeadlines);
          updateInformation(latestInformation);
          // show tooltip
          layer.openTooltip();
        }
      });
    }
  }
  
  // Update legend with new data
  updateLegendContent();
  // Update country search dropdown
}


selectedCountries = [];


async function getCountries() {
    try {
        var data = await unifiedSendRequest(COUNTRIES, {method: 'GET'});
        return data;
    } catch (error) {
        console.error(error);
        showMessage(error.message, false);
    }
}

async function fillCountryDropdown() {
  const dropdown = document.getElementById('countryDropdown');
  dropdown.innerHTML = '';
  const option = document.createElement('option');
  option.value = '';
  option.textContent = 'Select country...';
  option.selected = true;
  dropdown.appendChild(option);
  const sortedCountriesName = Object.keys(countryLayers).sort((a, b) => countryLayers[a][0].feature.properties.COUNTRY_NAME.localeCompare(countryLayers[b][0].feature.properties.COUNTRY_NAME));
  for (const alpha2 of sortedCountriesName) {
    const option = document.createElement('option');
    option.value = alpha2;
    option.textContent = countryLayers[alpha2][0].feature.properties.COUNTRY_NAME;
    dropdown.appendChild(option);
  }
  $('#countryDropdown').selectpicker('refresh');
  $('#countryDropdown').selectpicker('val', '');
}

$('#countryDropdown').on('change', function() {
  if (this.value == '') {
    selectedCountries = [];
  } else {
    selectedCountries = [this.value];
  }
  updateMapFiltering(selectedCountries);
  updateLegendContent();
  createDeadlineList(allDeadlines);
  updateInformation(latestInformation);
  if (this.value == '') {
    return;
  }
  const bounds = countryLayers[this.value][0].getBounds();
  const center = bounds.getCenter();

  map.setView(center, map.getZoom());
});


var countries = null;
var availableCountries = [];
async function openMapAdd() {
  // only reset the checked countries if the modal is opened, not when going back
  checkedCountries.clear();
  checkedCountriesExisting.clear();
  const modal = document.getElementById('mapAddModal');
  modal.style.display = 'block';
  const overlay = document.getElementById('mapAddOverlay');
  overlay.style.display = 'block';
  document.getElementById('mapAddSelectCategories').style.display = 'none';
  document.getElementById('mapAddSelectPROs').style.display = 'none';
  document.getElementById('mapAddCountrySelect').style.display = 'block';
  countries = await getCountries();
  availableCountries = [];
  for (const country of Object.keys(countries)) {
    if (countries[country].data != null) {
      availableCountries.push(country);
    }
  }
  loadGeoJSON().then(data => {
    if (mapAdd == null) {
      countryLayersAdd = {};
      mapAdd = setInitialMap(data, 'eprMapAdd', countryLayersAdd, false, availableCountries);
    } else {
      for (const alpha2 in countryLayersAdd) {
        removeCountryMap(alpha2);
      }
    }
    updateCountryList(countryLayersAdd, true);
  });
}

async function backToAddCountries() {
  const modal = document.getElementById('mapAddModal');
  modal.style.display = 'block';
  const overlay = document.getElementById('mapAddOverlay');
  overlay.style.display = 'block';
  document.getElementById('mapAddSelectCategories').style.display = 'none';
  document.getElementById('mapAddSelectPROs').style.display = 'none';
  document.getElementById('mapAddCountrySelect').style.display = 'block';
}

function searchCountry() {
  var search = document.getElementById('search-country').value;
  if (search == '') {
    updateCountryList(countryLayersAdd);
    return;
  }
  var countriesFiltered = {};
  for (const alpha2 in countryLayersAdd) {
    foundMatch = false;
    for (const layer of countryLayersAdd[alpha2]) {
      const name = layer.feature.properties.COUNTRY_NAME;
      if (name.toLowerCase().includes(search.toLowerCase())) {
        foundMatch = true;
      }
    }
    if (foundMatch) {
      countriesFiltered[alpha2] = countryLayersAdd[alpha2];
    }
  }
  updateCountryList(countriesFiltered);
}

function sortCountries(alpha2A, alpha2B) {
  // sort countries by selected, then availability, then alphabetically
  if (checkedCountries.has(alpha2A) && !checkedCountries.has(alpha2B)) {
    return -1;
  }
  if (!checkedCountries.has(alpha2A) && checkedCountries.has(alpha2B)) {
    return 1;
  }
  if (availableCountries.includes(alpha2A) && !availableCountries.includes(alpha2B)) {
    return -1;
  }
  if (!availableCountries.includes(alpha2A) && availableCountries.includes(alpha2B)) {
    return 1;
  }
  return alpha2A.localeCompare(alpha2B);
}

function handleCountrySelect(alpha2, countriesMap, availableCountries) {
  console.log(`handleCountrySelect: ${alpha2}`);
  selectCountryDashboard(alpha2, availableCountries.includes(alpha2));
  updateCountryList(countriesMap);
  if (Object.keys(countriesMap).length === 1) {
    setTimeout(() => {
      const el = document.getElementById('search-country');
      if (el) { el.value = ''; searchCountry(); }
    }, 100);
  }
}

var checkedCountries = new Set();
var checkedCountriesExisting = new Set();
function updateCountryList(countriesFiltered, updateMap=false) {
  var countryList = document.getElementById('countryList');
  countryList.innerHTML = '';

  for (let alpha2 of Object.keys(countriesFiltered).sort(sortCountries)) {
    for (const countryLayer of countriesFiltered[alpha2]) {
      if (!countryLayer._selectHandler) {
        countryLayer._selectHandler = () => {
          const box = document.getElementById(alpha2);
          if (box) box.click();
          else handleCountrySelect(alpha2, countriesFiltered, availableCountries);
        };
        countryLayer.on('click', countryLayer._selectHandler);
      }
      if (!countryLayer.feature.properties.biggest) {
        continue; // only show biggest country
      }
      let container = document.createElement('div');
      container.className = 'country-item';
      let checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = alpha2;
      checkbox.name = countryLayer.feature.properties.COUNTRY_NAME;
      checkbox.onclick = () => handleCountrySelect(alpha2, countriesFiltered, availableCountries);
      let label = document.createElement('label');
      label.htmlFor = alpha2;
      label.textContent = countryLayer.feature.properties.COUNTRY_NAME;

      container.appendChild(checkbox);
      container.appendChild(label);
      if (checkedCountries.has(alpha2)) {
        checkbox.checked = true;
      }
      countryList.appendChild(container);
      if (countries[alpha2]?.data) {
        const selectedList = {};
        for (const [category, pros] of Object.entries(countries[alpha2].data)) {
            for (const [proName, status] of Object.entries(pros)) {
                if (status === 'selected' || status === 'unavailable') {
                    if (!selectedList[category]) {
                      if (proName == 'null') {
                        selectedList[category] = 'No PROs available';
                      } else {
                        selectedList[category] = proName;
                      }
                    } else {
                      selectedList[category] += ', ' + proName;
                    }
                }
            }
        }
        if (Object.keys(selectedList).length > 0) {
          checkbox.checked = true;
          checkbox.disabled = true;
          checkedCountriesExisting.add(alpha2);
          if (updateMap) {
            tableHTML = createTableFromDescription(selectedList);
            addCountryMap(alpha2, "#28a745", tableHTML, true, false);
          }
        }
      }
    }
  }
}

function addCountryMap(alpha2, color, data, available=true, zoom=true) {
    const layerList = countryLayersAdd[alpha2];
    if (!layerList) return;
    for (const layer of layerList) {
      const name = layer.feature.properties.COUNTRY_NAME;
      layer.setStyle({
        fillColor: color
      });
      if (!available) {
        let center = null;
        if (countryCenters[alpha2]) {
          center = { lat: countryCenters[alpha2].lat, lng: countryCenters[alpha2].lon }; // note: Leaflet uses `lng` not `lon`
        } else {
          center = layer.getBounds().getCenter();
        }

        const lockIcon = L.divIcon({
          html: `<div class="lock-icon">{% render 'icon-lock' %}</div>`,
          className: 'country-lock-icon',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        layer._lockMarker = L.marker(center, { icon: lockIcon }).addTo(mapAdd);
        if (layer._selectHandler) {
          layer._lockMarker.on('click', layer._selectHandler);
        }
        layer.unbindTooltip();
        // Add tooltip
        layer.bindTooltip(
          `<div class="tooltip-inner tooltip-wide"><strong>${name}</strong><br>Country not yet available.</div>`,
          {
            direction: 'top',
            className: 'custom-tooltip',
            sticky: true
          }
        );
      } else {
        const tooltipHTML = `<div class="tooltip-inner tooltip-wide"><strong>${name}</strong><br>${data}</div>`;
        layer.unbindTooltip();
        layer.bindTooltip(tooltipHTML, {
          direction: 'top',
          sticky: true,
          className: 'custom-tooltip'
        });
      }
      if (layer.feature.properties.biggest && zoom) {
        const bounds = layer.getBounds();
        mapAdd.fitBounds(bounds, {
            padding: [20, 20],   // Optional: padding around the feature
            maxZoom: 6           // Optional: prevent zooming in too far
        });
      }
    }
}

function removeCountryMap(alpha2, available=true) {
  const layerList = countryLayersAdd[alpha2];
  if (!layerList) return;
  for (const layer of layerList) {
    layer.setStyle({
      fillColor: '#4E5366'
    });
    layer.unbindTooltip();
    if (!available) {
      mapAdd.removeLayer(layer._lockMarker);
    }
  }
}

function selectCountryDashboard(alpha2, available=true) {
  const checkbox = document.getElementById(alpha2);
  if (checkbox.checked) {
    color = "#2255ff";
    if (!available) {
      color = "#ffffff";
    }
    checkedCountries.add(alpha2);
    addCountryMap(alpha2, color, 'Selected', available);
  } else {
    removeCountryMap(alpha2, available);
    checkedCountries.delete(alpha2);
  }
}

function closeModalAdd() {
  const modal = document.getElementById('mapAddModal');
  modal.style.display = 'none';
  const overlay = document.getElementById('mapAddOverlay');
  overlay.style.display = 'none';
}

function selectReportCategories() {
  countriesChecked = Array.from(checkedCountries).concat(Array.from(checkedCountriesExisting));
  {% comment %} countriesSelectedNew = Array.from(countriesSelected).filter(input => !input.disabled); {% endcomment %}
  if (countriesChecked.length == 0) {
    showMessage('Please select at least one country', false);
    return;
  }
  var categoryList = document.getElementById('category-list');
  categoryList.innerHTML = '';
  var categories = [];
  for (const alpha2 of countriesChecked) {
    if (countries[alpha2]?.data) {
      for (const category of Object.keys(countries[alpha2].data)) {
        if (!categories.includes(category)) {
          categories.push(category);
        }
      }
    }
  }
  selectedCategories.clear();
  if (categories.length == 0) {
    document.getElementById('category-list-header').style.display = 'block';
    document.getElementById('category-list-header').innerHTML = 'Country not yet available, choose the categories you want to stay informed about.';
    categories = categoryOrder;
  } else {
    document.getElementById('category-list-header').style.display = 'none';
  }
  categories.sort(customSort);
  for (const category of categories) {
    button = createCategoryButton(category);
    categoryList.appendChild(button);
  }
  document.getElementById('mapAddCountrySelect').style.display = 'none';
  document.getElementById('mapAddSelectCategories').style.display = 'block';
  document.getElementById('mapAddSelectPROs').style.display = 'none';
}

function addCategory() {
  var input = document.getElementById('input-category-others');
  var category = input.value;
  existingCategories = Array.from(document.getElementById('category-list').querySelectorAll('.addcategory'));
  if (category == '') {
    showMessage('Please enter a category', false);
    return;
  }
  if (existingCategories.some(item => item.textContent === category)) {
    showMessage('Category already exists', false);
    return;
  }
  categoryList = document.getElementById('category-list');
  button = createCategoryButton(category, true);
  categoryList.appendChild(button);
  input.value = '';
}

function createCategoryButton(category, can_remove=false) {
  let container = document.createElement('div');
  container.className = 'category-item';
  container.id = `category-item-${category}`;
  var button = document.createElement('button');
  button.className = 'addcategory button button-unselected button--secondary';
  button.textContent = category;
  button.id = `button-category-${category}`;
  button.onclick = () => selectCategory(category);
  container.appendChild(button);
  if (can_remove) {
    var removeButton = document.createElement('button');
    removeButton.className = 'button-remove button button--secondary';
    removeButton.textContent = 'X';
    removeButton.id = `button-category-remove-${category}`;
    removeButton.onclick = () => removeCategory(category);
    container.appendChild(removeButton);
  }
  return container;
}

var selectedCategories = new Set();
function selectCategory(category) {
  var button = document.getElementById(`button-category-${category}`);
  if (button.classList.contains('button--secondary')) {
    // selected button
    button.classList.remove('button--secondary');
    button.classList.remove('button-unselected');
    button.classList.add('button-selected');
    selectedCategories.add(category);
  } else {
    // unselected button
    button.classList.add('button--secondary');
    button.classList.add('button-unselected');
    button.classList.remove('button-selected');
    selectedCategories.delete(category);
  }
}

function removeCategory(category) {
  var categoryItem = document.getElementById(`category-item-${category}`);
  categoryItem.remove();
  selectedCategories.delete(category);
}

async function selectPROs(add_pro=false) {
  await getAvailableCountriesSettings();
  var countriesSelected = Array.from(checkedCountries).concat(Array.from(checkedCountriesExisting));
  if (selectedCategories.size == 0) {
    showMessage('Please select at least one category', false);
    return;
  }
  {% comment %} countriesSelectedNew = Array.from(countriesSelected).filter(input => !input.disabled); {% endcomment %}
  selected_countries = {};
  for (const country_code of countriesSelected) {
    if (!selected_countries[country_code]) {
      selected_countries[country_code] = {};
    }
    for (const category of selectedCategories) {
      const countryCfg = availableCountriesSettings?.[country_code]?.[category];
      if (!countryCfg) {
        selected_countries[country_code][category] = {'Default': 'No PROs available'};
        continue;
      }
      selected_countries[country_code][category] = {};
      for (const proName of Object.keys(countryCfg)) {
        selected_countries[country_code][category][proName] = proName;
      }
    }
  }
  await postSelectedCountries(countriesSelected, selectedCategories);
  openMapSettingsBool = false;
  createMapSettings(selected_countries, add_pro);

  document.getElementById('mapAddSelectCategories').style.display = 'none';
  document.getElementById('mapAddSelectPROs').style.display = 'block';
}

function addPRO(category) {
  var proSelect = document.getElementById('proSelect');
  proSelect.innerHTML = '';
  for (const pro of pros) {
    var option = document.createElement('option');
    option.value = pro.id;
    option.textContent = pro.name;
    proSelect.appendChild(option);
  }
}

async function getPROsSelected() {
  try {
    var data = await unifiedSendRequest(COUNTRIES_SELECTED, {method: 'GET'});
    return data;
  } catch (error) {
    console.error(error);
    showMessage(error.message, false);
  }
}
var openMapSettingsBool = false;
async function openMapSettings() {
  countries = await getCountries();
  var selected_countries = await getPROData();
  selectedCategories.clear();
  if (selected_countries.length == 0) {
    showMessage('Please add PROs first', false);
    return;
  }
  openMapSettingsBool = true;
  createMapSettings(selected_countries, false);
}

async function getPROData() {
  await getAvailableCountriesSettings();
  var data = await getPROsSelected();
  selected_countries = {};
  for (const item of data) {
    if (!selected_countries[item.country]) {
      selected_countries[item.country] = {};
    }
    if (!selected_countries[item.country][item.report_type]) {
      selected_countries[item.country][item.report_type] = {};
    }
    pros_available = availableCountriesSettings?.[item.country]?.[item.report_type];
    if (item.pro == null) {
      selected_countries[item.country][item.report_type]['Default'] = null;
    } else if (item.pro == 'Default') {
      if (pros_available) {
        selected_countries[item.country][item.report_type]['Select PRO'] = null;
      } else {
        selected_countries[item.country][item.report_type]['Default'] = null;
      }
    } else {
      selected_countries[item.country][item.report_type][item.pro] = item;
    }
    
  }
  console.log(`selected_countries: ${JSON.stringify(selected_countries)}`);
  return selected_countries;
}

async function createMapSettings(selected_countries, add_pro=false) {
  renderMapSettingsHierarchy('left-side-pro-country-list', selected_countries);
  if (!add_pro) {
    document.getElementById('back-button-pro').style.display = 'none';
  } else {
    document.getElementById('back-button-pro').style.display = 'block';
  }
  document.getElementById('mapAddModal').style.display = 'block';
  document.getElementById('mapAddCountrySelect').style.display = 'none';
  document.getElementById('mapAddSelectCategories').style.display = 'none';
  document.getElementById('mapAddSelectPROs').style.display = 'block';
  document.getElementById('mapAddOverlay').style.display = 'block';
}

async function postSelectedCountries(countriesSelected, selectedCategories) {
  try {
    countriesSelectedList = Array.from(countriesSelected);
    selectedCategoriesList = Array.from(selectedCategories);
    let data = await unifiedSendRequest(COUNTRIES_CHOSEN, { method: 'POST', formData: JSON.stringify({countries: countriesSelectedList, categories: selectedCategoriesList}), headerArgs: {'Content-Type': 'application/json'}});
    return data;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to save countries ' + error.message, false);
  }
}

function filterPROs() {
  var filtered_countries = {};
  var search = document.getElementById('search-pro').value.toLowerCase();
  if (search == '') {
    filtered_countries = selected_countries;
  } else {
    for (const country of Object.keys(selected_countries)) {
      for (const reportType of Object.keys(selected_countries[country])) {
        for (const pro of Object.keys(selected_countries[country][reportType])) {
          pro_details = selected_countries[country][reportType][pro];
          found = false;
          if (pro.toLowerCase().includes(search) || reportType.toLowerCase().includes(search) || 
              country.toLowerCase().includes(search)) {
            found = true;
          }
          if (!found) {
            for (const layer of countryLayers[country]) {
              if (layer.feature.properties.COUNTRY_NAME.toLowerCase().includes(search)) {
                found = true;
                break;
              }
            }
          }
          if (found) {
            if (!filtered_countries[country]) {
              filtered_countries[country] = {};
            }
            if (!filtered_countries[country][reportType]) {
              filtered_countries[country][reportType] = {};
            }
            filtered_countries[country][reportType][pro] = pro_details;
          }
        }
      }
    }
  }
  activePro = document.querySelector('.pro-active')?.id;
  renderMapSettingsHierarchy('left-side-pro-country-list', filtered_countries, activePro);
}

function renderMapSettingsHierarchy(containerId, selected_countries, activePro=null) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  function createCollapsibleItem(name, level = 0) {
    const wrapper = document.createElement('div');
    wrapper.style.margin = '2rem 0';
    wrapper.style.marginLeft = `${level * 1.5}rem`;

    const label = document.createElement('div');
    var labelText = document.createElement('span');
    const arrowSvg = `<svg class="svg-arrow collapsed" style="margin-right: 1rem; vertical-align: middle;" width="20.593" height="22.88" version="1.1" fill="2255ff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 122.88 66.91"><g><path fill="#2255ff" d="M11.68,1.95C8.95-0.7,4.6-0.64,1.95,2.08c-2.65,2.72-2.59,7.08,0.13,9.73l54.79,53.13l4.8-4.93l-4.8,4.95 c2.74,2.65,7.1,2.58,9.75-0.15c0.08-0.08,0.15-0.16,0.22-0.24l53.95-52.76c2.73-2.65,2.79-7.01,0.14-9.73 c-2.65-2.72-7.01-2.79-9.73-0.13L61.65,50.41L11.68,1.95L11.68,1.95z"/></g></svg>`;
    if (level < 2) {
      label.innerHTML = `${arrowSvg}`;
      labelText.style.fontWeight = 'bold';
    } else {
      labelText.style.fontWeight = 'normal';
    }
    labelText.textContent = name;
    label.appendChild(labelText);
    wrapper.appendChild(label);

    const childrenContainer = document.createElement('div');
    childrenContainer.style.display = 'none';
    childrenContainer.classList.add('children-container');
    wrapper.appendChild(childrenContainer);
    return { wrapper, label, childrenContainer };
  }
  first_country = null;
  first_report_type = null;
  first_pro = null;
  for (const alpha2 of Object.keys(selected_countries).sort()) {
    const { wrapper: countryDiv, label: countryLabel, childrenContainer: reportTypeContainer } = createCollapsibleItem(alpha2, 0);
    countryLabel.id = `label-${alpha2}`;
    countryLabel.classList.add('country-label');
    countryName = countryLayers[alpha2][0].feature.properties.COUNTRY_NAME;
    countryLabel.title = countryName;
    countryLabel.style.width = 'fit-content';
    countryLabel.style.cursor = 'pointer';
    countryLabel.addEventListener('click', () => {
      document.querySelectorAll('.country-label').forEach(label => {
        if (label.id != countryLabel.id) {
          label.querySelector('svg').classList.add('collapsed');
          label.nextElementSibling.style.display = 'none';
        }
      });
      reportTypeContainer.style.display = reportTypeContainer.style.display === 'none' ? 'block' : 'none';
      countryLabel.querySelector('svg').classList.toggle('collapsed');
      // click first element inside reportTypeContainer
      reportTypeContainer.querySelector('div:first-child').querySelector('div:first-child').click();
    });
    if (!first_country) {
      first_country = countryLabel;
    }
    for (const reportType of Object.keys(selected_countries[alpha2]).sort()) {
      const { wrapper: reportTypeDiv, label: reportTypeLabel, childrenContainer: proContainer } = createCollapsibleItem(reportType, 1);
      reportTypeLabel.id = `label-${country}-${reportType}`;
      reportTypeLabel.classList.add('report-type-label');
      reportTypeLabel.style.width = 'fit-content';
      reportTypeLabel.style.cursor = 'pointer';
      reportTypeLabel.addEventListener('click', () => {
        document.querySelectorAll('.report-type-label').forEach(label => {
          if (label.id != reportTypeLabel.id) {
            label.querySelector('svg').classList.add('collapsed');
            label.nextElementSibling.style.display = 'none';
          }
        });
        proContainer.style.display = proContainer.style.display === 'none' ? 'block' : 'none';
        reportTypeLabel.querySelector('svg').classList.toggle('collapsed');
        // click first element inside proContainer
        proContainer.querySelector('div:first-child').click();
      });
      if (!first_report_type) {
        first_report_type = reportTypeLabel;
      }
      var pros_names = Object.keys(selected_countries[alpha2][reportType]).sort();
      pros_new = pros_names;
      console.log(`pros_names: ${pros_names}`);
      console.log(`openMapSettingsBool: ${openMapSettingsBool}`);
      if (!openMapSettingsBool) {
        pros_new = [];
        if (pros_names.length > 0) {
          if (pros_names.includes('Lucid')) {
            pros_new = ['Lucid'];
            pros_names.splice(pros_names.indexOf('Lucid'), 1);
          }
          pros_new.push(pros_names[0]);
        } else {
          pros_new = [];
        }
      }
      for (const pro of pros_new) {
        const proDiv = document.createElement('div');
        if (!first_pro) {
          first_pro = proDiv;
        }
        proDiv.textContent = pro;
        proDiv.title = pro.replace('Default', 'No PROs available');
        proDiv.id = `pro-${alpha2}-${reportType}-${pro}`;
        proDiv.style.margin = '2rem 0';
        proDiv.style.marginLeft = '5rem';
        proDiv.style.cursor = 'pointer';
        proDiv.style.width = 'fit-content';
        proDiv.onclick = async () => {
          document.querySelectorAll('.pro-active').forEach(pro => {
            pro.classList.remove('pro-active');
          });
          proDiv.classList.add('pro-active');
          proDiv.scrollIntoView({behavior: 'smooth', block: 'center'});
          await getProDetails(alpha2, reportType, pro);
          document.getElementById(`pro-details`).style.display = 'grid';
          document.getElementById(`pro-name`).style.display = 'flex';
        }
        proContainer.appendChild(proDiv);
      }
      const proDiv2 = document.createElement('div');
      proDiv2.innerHTML = `{% render 'icon-add-black' %}`;
      proDiv2.querySelector('svg').style.width = '2rem';
      proDiv2.querySelector('svg').style.height = '2rem';
      proDiv2.querySelector('svg').style.fill = '#17161c';
      proDiv2.style.margin = '2rem 0';
      proDiv2.id = `pro-${alpha2}-${reportType}-Not Set`;
      proDiv2.style.marginLeft = '5rem';
      proDiv2.style.cursor = 'pointer';
      proDiv2.style.width = 'fit-content';
      proDiv2.onclick = async () => {
        document.querySelectorAll('.pro-active').forEach(pro => {
          pro.classList.remove('pro-active');
        });
        proDiv2.classList.add('pro-active');
        document.getElementById('pro-name-select').value = 'Not Set';
        document.getElementById('pro-name-input').value = 'Not Set';
        document.getElementById('pro-id').value = '';
        document.getElementById('pro-status').textContent = 'Not Set';
        proDiv2.textContent = 'Not Set';
        proDiv2.scrollIntoView({behavior: 'smooth', block: 'center'});
        await getProDetails(alpha2, reportType, 'Not Set');
      }
      proContainer.appendChild(proDiv2);
      reportTypeContainer.appendChild(reportTypeDiv);
    }
    container.appendChild(countryDiv);
  }
  if (activePro) {
    country = activePro.split('-')[1];
    reportType = activePro.split('-')[2];
    pro = activePro.split('-')[3];
    document.getElementById(`label-${country}`).click();
    content = document.getElementById(`label-${country}`).nextElementSibling.querySelector('.report-type-label').textContent;
    if (reportType != content) {
      document.getElementById(`label-${country}-${reportType}`).click();
    }
    document.getElementById(activePro).click();
  } else {
    first_country.click();
  }
}

var availableCountriesSettings = [];
async function getAvailableCountriesSettings() {
  try {
    if (availableCountriesSettings.length > 0) {
      return;
    }
    let data = await unifiedSendRequest(GETGENERALCONFIGCOUNTRY, { method: 'GET' });
    availableCountriesSettings = data;
  } catch (error) {
    console.error(error.message);
    showMessage('Failed to get settings definition ' + error.message, false);
  }
}

function showOnlyCurrentPRO() {
  var country = document.getElementById('country').value;
  var reportType = document.getElementById('reportType').value;
  var pro = document.getElementById('pro-name-select').value;
  
}

let currentCountry = null;
let currentReportType = null;
let currentPro = null;
async function getProDetails(country, reportType, pro) {
  if (currentCountry == country && currentReportType == reportType && currentPro == pro) {
    return;
  }
  currentCountry = country;
  currentReportType = reportType;
  currentPro = pro;
  await savePRO(); // save previous values
  proValues = await getPROData();
  proValues = proValues[country]?.[reportType]?.[pro] || {'login': '', 'password': '', 'email_responsible': [], 'extra_info': '', 'general_settings': {}, 'id': '', 'agency_email': '', 'registration_number': '', 'email_responsible_options': [], 'email_responsible': ''};
  const proDetails = (
    availableCountriesSettings?.[country]?.[reportType]?.[pro]
  ) || {};

  document.getElementById('pro-name-select').innerHTML = '';
  pros = availableCountriesSettings?.[country]?.[reportType] || {};
  var proOptions = [];
  var proOptionsKeys = Object.keys(pros);
  if (proOptionsKeys.length == 0) {
    proOptionsKeys = ['Default'];
  }
  for (const proOption of proOptionsKeys) {
    var option = document.createElement('option');
    option.value = proOption;
    option.textContent = proOption;
    document.getElementById('pro-name-select').appendChild(option);
    proOptions.push(proOption);
  }
  var option = document.createElement('option');
  option.value = 'Not Set';
  option.textContent = 'Not Set';
  proOptions.push('Not Set');
  document.getElementById('pro-name-select').appendChild(option);
  if (pro && proOptions.indexOf(pro) == -1) {
    var option = document.createElement('option');
    option.value = pro;
    option.textContent = pro;
    document.getElementById('pro-name-select').appendChild(option);
  }
  document.getElementById('email-responsible-input').innerHTML = '';
  for (const email of proValues.email_responsible_options) {
    var option = document.createElement('option');
    option.value = email;
    option.textContent = email;
    if (proValues.email_responsible.split(',').includes(email)) {
      option.selected = true;
    }
    document.getElementById('email-responsible-input').appendChild(option);
  }
  $('#email-responsible-input').selectpicker({
    dropupAuto: true,
    size: 3
  });

  document.getElementById('pro-name-select').value = pro;
  document.getElementById('pro-name-input').value = pro;
  $('.selectpicker').selectpicker('refresh');
  $('.selectpicker').selectpicker('refresh');

  document.getElementById('country').value = country;
  document.getElementById('reportType').value = reportType;
  document.getElementById('pro-id').value = proValues.id;

  document.getElementById('login-name-input').value = proValues.login;
  document.getElementById('password-input').value = proValues.password;
  document.getElementById('extra-info-input').value = proValues.extra_info;
  document.getElementById('agency_email-input').value = proValues.agency_email;
  document.getElementById('registration_number-input').value = proValues.registration_number;
  document.getElementById('questions').innerHTML = '';
  for (const [question, value] of Object.entries(proDetails)) {
    var questionDiv = document.createElement('div');
    questionDiv.id = `question-${question}-input`;
    var questionLabel = document.createElement('label');
    questionLabel.classList.add('questions-label');
    questionLabel.textContent = value.title;
    if (value.input_type == 'dropdown') {
      var questionInput = document.createElement('select');
      questionInput.className = 'selectpicker questions-answer';
      questionInput.id = `question-${question}-input`;
      for (const option of value.options) {
        var optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        questionInput.appendChild(optionElement);
      }
      questionDiv.appendChild(questionLabel);
      questionDiv.appendChild(questionInput);
      questionInput.value = proValues['general_settings'][question] || '';
      setTimeout(() => {
        $('.selectpicker').selectpicker('refresh');
      }, 50);
    } else if (value.input_type == 'text') {
      var questionInput = document.createElement('input');
      questionInput.classList.add('questions-answer');
      questionInput.id = `question-${question}-input`;
      questionInput.value = proValues['general_settings'][question] || '';
      questionDiv.appendChild(questionLabel);
      questionDiv.appendChild(questionInput);
    } else if (value.input_type == 'checkbox') {
      var questionInput = document.createElement('input');
      questionInput.type = 'checkbox';
      questionInput.classList.add('questions-answer');
      questionInput.id = `question-${question}-input`;
      questionInput.checked = proValues['general_settings'][question] || false;
      questionDiv.appendChild(questionLabel);
      questionDiv.appendChild(questionInput);
    }
    document.getElementById('questions').appendChild(questionDiv);
  }
  updatePROStatus();
}

document.getElementById('pro-name-select').onchange = async () => {
  var pro = document.getElementById('pro-name-select').value;
  var pro_old = document.getElementById('pro-name-input').value;
  var country = document.getElementById('country').value;
  var reportType = document.getElementById('reportType').value;
  var proDiv = document.getElementById(`pro-${country}-${reportType}-${pro_old}`);
  proDiv.id = `pro-${country}-${reportType}-${pro}`;
  proDiv.innerHTML = pro;
  document.getElementById('pro-name-input').value = pro;
  await getProDetails(country, reportType, pro);
}

async function saveAndClose() {
  if (await savePRO()) {
    closeModalAdd();
    getCountryStatus().then(data => {
      updateCountryData(data);
    });
    getReportsDue().then(results => {
      createDeadlineList(results);
    });
    getInformation().then(data => {
      updateInformation(data);
  });
  }
}

function updatePROStatus() {
  var error = false;
  status = "Done";
  const allAnswered = Array.from(
    document.querySelectorAll('#questions input, #questions select')
  ).every(el =>
    // for checkboxes / radios we care about â€œcheckedâ€,
    // otherwise we care about non-empty value
    (el.type === 'checkbox' || el.type === 'radio')
      ? true // for checkboxes / radios don't care about the value,
      : el.value.trim()
  );

  if (!document.getElementById('login-name-input').value || !document.getElementById('password-input').value) {
    if (!document.getElementById('agency_email-input').value) {
      status = "Log in info missing";
      error = true;
    }
  } else if (document.getElementById('email-responsible-input').value.length == 0) {
    status = "Email of responsible missing";
    error = true;
  } else if (!allAnswered) {
    status = "Not All Questions Answered";
    error = true;
  } else {
    error = false;
  }
  if (document.getElementById('pro-name-select').value == 'Not Set') { // if not set, it means that nothing has to be entered
    status = "Not Set";
    error = false;
  }
  if (error) {
    document.getElementById('pro-status').style.color = 'var(--forsure-main-red)';
    document.getElementById('pro-status').innerHTML = `{% render 'forsure-icon-error' %} ${status}`;
  } else {
    document.getElementById('pro-status').style.color = '#17161c';
    document.getElementById('pro-status').textContent = status;
  }
}

['login-name-input',
  'password-input',
  'agency_email-input',
  'registration_number-input'
 ].forEach(id =>
   document.getElementById(id).addEventListener('keyup', updatePROStatus)
 );
 
 // keyup bubbles from inputs inside #questions, so one listener is enough
 document.getElementById('questions').addEventListener('keyup', updatePROStatus);
 
 // select boxes change with â€˜changeâ€™, not â€˜keyupâ€™
 document.getElementById('questions').addEventListener('change', updatePROStatus);
 document.getElementById('pro-name-select').addEventListener('change', updatePROStatus);
 

async function savePRO() {
  var country = document.getElementById('country').value;
  var reportType = document.getElementById('reportType').value;
  var pro = document.getElementById('pro-name-select').value;
  if (!country || !reportType || !pro) {
    return true;
  }
  var proValues = {
    email_responsible: Array.from(document.getElementById('email-responsible-input').selectedOptions).map(option => option.value).join(','),
    login: document.getElementById('login-name-input').value,
    password: document.getElementById('password-input').value,
    extra_info: document.getElementById('extra-info-input').value,
    agency_email: document.getElementById('agency_email-input').value,
    registration_number: document.getElementById('registration_number-input').value,
  }
  questions = document.getElementById('questions').querySelectorAll('input, select');
  general_settings = {};
  for (const question of questions) {
    if (question.type == 'checkbox') {
      general_settings[question.id.replace('question-', '').replace('-input', '')] = question.checked;
    } else {
      general_settings[question.id.replace('question-', '').replace('-input', '')] = question.value;
    }
  }
  try {
    var body = {
      id: document.getElementById('pro-id').value,
      country_code: country,
      report_type: reportType,
      pro: pro,
      general_settings: general_settings,
      login: proValues.login,
      password: proValues.password,
      agency_email: proValues.agency_email,
      registration_number: proValues.registration_number,
      email_responsible: proValues.email_responsible,
      extra_info: proValues.extra_info,
    }
    var data = await unifiedSendRequest(COUNTRIES_SELECTED, {method: 'POST', formData: JSON.stringify(body), headerArgs: {'Content-Type': 'application/json'}});
    showMessage(country + ' ' + reportType + ' ' + pro + ' saved successfully!', true);
    return true;
  } catch (error) {
    console.error(error);
    showMessage(error.message, false);
    return false;
  }
}

async function getCountryStatus() {
  try {
    var data = await unifiedSendRequest(COUNTRY_STATUS, {method: 'GET'});
    return data;
  } catch (error) {
    console.error(error);
    showMessage(error.message, false);
  }
}

const loginNameInput = document.getElementById("login-name-input");
const passwordInput = document.getElementById("password-input");
const agencyEmailInput = document.getElementById("agency_email-input");

function handleAgencyEmailInput() {
  if (agencyEmailInput.value.trim() !== "") {
    loginNameInput.disabled = true;
    passwordInput.disabled = true;
  } else {
    loginNameInput.disabled = false;
    passwordInput.disabled = false;
  }
}

function handleLoginOrPasswordInput() {
  if (loginNameInput.value.trim() !== "" || passwordInput.value.trim() !== "") {
    agencyEmailInput.disabled = true;
  } else {
    agencyEmailInput.disabled = false;
  }
}

agencyEmailInput.addEventListener("input", handleAgencyEmailInput);
loginNameInput.addEventListener("input", handleLoginOrPasswordInput);
passwordInput.addEventListener("input", handleLoginOrPasswordInput);

waitForPermission(function() {
  if (window.userPermissions['forsure-dashboard']) {
    initDB();
    
    // Configure countryDropdown to render dropdown in a container above the map
    if ($('#countryDropdown').length && typeof $.fn.selectpicker !== 'undefined') {
      $('#countryDropdown').selectpicker({
        container: 'body'
      });
      // Ensure dropdown menu has high z-index
      $(document).on('shown.bs.select', '#countryDropdown', function() {
        $('.bootstrap-select.open .dropdown-menu').css('z-index', '10000');
      });
    }
    
    loadGeoJSON().then(data => {
        map = setInitialMap(data, 'eprMap', countryLayers);
        createMapLegend();
        getCountryStatus().then(data => {
          updateCountryData(data);
        });
        fillCountryDropdown();
    });
    loadCenters();

    setInterval(() => {
      getCountryStatus().then(data => {
        updateCountryData(data);
      });
    }, 15000);
  }
});

</script>
