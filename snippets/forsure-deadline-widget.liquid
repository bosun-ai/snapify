
{% style %}
#deadlineContainer {
  scrollbar-width: none;
  height: 60%;
}

#deadlineList {
  list-style-type: none;
  padding: 1rem 1rem 0 1rem;
  text-align: left;
}

.deadline {
  padding: 0.5rem 0;
  margin-bottom: 1rem;
  border-radius: 1rem;
  border: 0.2rem solid #17161c;
  padding: 0;
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeIn 0.5s ease-in-out forwards;
}

.past-deadline {
  background-color: #a80000;
  color: white;
}
.done-deadline {
  background-color: #2255ff;
  color: white;
}


.done-deadline div div svg #Electronics .st2,
.past-deadline div div svg #Electronics .st2 {
  stroke: #fafafa;
}
.done-deadline div div svg #Electronics .st5,
.past-deadline div div svg #Electronics .st5 {
  stroke: #fafafa;
  fill: #fafafa;
}
.done-deadline div div svg #Batterie .st2, 
.past-deadline div div svg #Batterie .st2 {
  stroke: #fafafa;
  /* fill: #fafafa; */
}
.done-deadline div div svg #Batterie .st5,
.past-deadline div div svg #Batterie .st5 {
  stroke: #fafafa;
  fill: #fafafa;
}

.done-deadline div div svg #Packaging .st2,
.past-deadline div div svg #Packaging .st2  {
  stroke: #fafafa;
  /* fill: #fafafa; */
}
.done-deadline div div svg #Packaging .st5,
.past-deadline div div svg #Packaging .st5  {
  stroke: #fafafa;
  /* fill: #fafafa; */
}
.reportDeadlineName {
  margin: auto;
  margin-left: 1rem;
  min-width: 8rem;
  text-align: left;
  padding-left: 1rem;
}
.typeDescription {
  flex: 1;
   display: flex; 
   /* justify-content: center; */
   margin-right: 3rem
}
.top-trigger {
  display: block!important;
  height: 1px;
}
@keyframes fadeIn {
  to {
      opacity: 1;
      transform: translateY(0);
  }
}

.rounded-deadline {
  flex: 1; /* Ensures it takes up available space */
  text-align: center;
  font-size: large;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  width: auto; /* Adjusts dynamically */
  position: relative;
  height: 100%; /* Ensures full height */
  padding: 0 1rem; /* Adds padding to prevent text from touching edges */
  border-radius: 0 8px 8px 0; /* Optional: Adds a rounded effect */
  padding: 1rem;
  padding-right: 2rem;
  padding-left: 2rem;
}

#no-deadlines {
  width: 50%;
  font-weight: bold;
}


.deadline-row {
  display: flex;
  align-items: center;
}

/* 1. left label grows to fill 1/2 remaining space */
.deadline-row .country {
  flex: 1;
  margin-left: 3rem;
  font-size: large;
  font-weight: bold;
  text-align: left;
}

/* 2. reserve exactly 24px (or whatever your SVGâ€™s width is) */
/*    flex: 0 0 fixes width, so even if empty it still takes up 24px */
.deadline-row .forecast-icon {
  flex: 0 0 24px;
  text-align: center;
  font-size: large;
  margin-right: 1rem;
  display: flex !important;
  /* font-weight:bold if you want the same styling */
}

/* 3. middle grows to fill the other 1/2 */
.deadline-row .typeDescription {
  flex: 1;
  display: flex;
  justify-content: center;
  margin-right: 3rem;
}

/* 4. deadline also flex:1, but since forecast-icon is fixed, its start-point is now stable */
.deadline-row .rounded-deadline {
  flex: 1;
  text-align: right;
  font-size: large;
  font-weight: bold;
}
{% endstyle %}

<div id="deadlineContainer" class="widget{% if gridItem %} grid-item{% else %}{% endif %} widget-left">
    <div id="deadlineTitle" class="grid-title">
      <div>Deadlines</div>
      <div class="icon-container">
        {% comment %} <div onclick="openDeadlinesSettings()">{% render 'icon-gear' %}</div> {% endcomment %}
      </div>
    </div>
      <ul id="deadlineList">
        <div class="warning-item">
          <div id="no-deadlines">
              No deadlines
          </div>
      </div>
      </ul>
  </div>
  
  <script>
    async function getReportsDue() {
      try {
          var data = await unifiedSendRequest(NEXTREPORTS, {method: 'GET'});
          return data;
      } catch(error){
          console.error(`Failed to get data, received error ${error}`);
          return errorMessage(error.message);
      }
  }

  function createDeadlineList(results) {
    const container = document.getElementById('deadlineContainer');
    const deadlineList = document.getElementById('deadlineList');
    deadlineList.innerHTML = '';

    
    const topTrigger = document.createElement('div');
    topTrigger.className = 'top-trigger';
    topTrigger.style.height = '1px';
    deadlineList.appendChild(topTrigger);

    let pastDeadlines = [];
    let displayedDeadlines = [];
    console.log('results', results);
    if (results.length === 0) {
      deadlineList.innerHTML = '<div id="no-deadlines">No deadlines</div>';
      return;
    }

    results.forEach(deadline => {
      const listItem = document.createElement('li');
      listItem.id = `${deadline.country}-${deadline.type}-${deadline.deadline}`;
      listItem.title = deadline.description;
      listItem.className = 'deadline';

      const deadlineDate = new Date(deadline.deadline_timestamp);
      const currentDate = new Date();
      var className = '';
      if (deadline.done === true) {
        className = 'done-deadline';
      }
      else if (deadlineDate < currentDate) {
        className = 'past-deadline';
      }
      if (deadlineDate < currentDate) {
        listItem.style.display = 'none';
        pastDeadlines.push(listItem);
      } else {
        displayedDeadlines.push(listItem);
      }

      let catImg;
      if (deadline.type === 'WEEE') {
        catImg = getWEEESVG();
      } else if (deadline.type === 'Batteries') {
        catImg = getBatteriesSVG();
      } else if (deadline.type === 'Packaging') {
        catImg = getPackagingSVG();
      } else {
        catImg = ''; // Default empty if unknown category
      }
      var forecastImg = '';
      if (deadline.forecast === true) {
        forecastImg = `{% render 'icon-forecast' %}`;
      }


      listItem.innerHTML = `
        <div class="deadline-row">
          <div class="country">${deadline.country}</div>
          <div class="forecast-icon">${forecastImg}</div>
          <div class="category-icon">${catImg}</div>
          <div class="typeDescription">
              {% if showName %}
                <div class="reportDeadlineName">${deadline.type}</div>
              {% endif %}
          </div>
          <div class="${className} rounded-deadline">
            ${deadline.deadline}
          </div>
        </div>
      `;

      deadlineList.appendChild(listItem);
    });

    
    function loadOlderDeadlines() {
      if (pastDeadlines.length === 0) return;

      const scrollYBeforeAdding = container.scrollHeight - container.scrollTop;

      // Take the next batch of past deadlines to display
      let nextBatch = pastDeadlines.splice(-5); // Show the next 5 past deadlines
      nextBatch.reverse();
      console.log(nextBatch);

      nextBatch.forEach(item => {
          item.style.display = 'block';
          deadlineList.insertBefore(item, deadlineList.firstChild);
      });

      // Maintain scroll position
      container.scrollTop = container.scrollHeight - scrollYBeforeAdding;
    }
    console.log(pastDeadlines);
    const observer = new IntersectionObserver((entries) => {
      console.log(entries);
        if (entries[0].isIntersecting) {
            loadOlderDeadlines();
        }
    }, { root: container, threshold: 0.1 });

    observer.observe(topTrigger);

  }

  

  

function getWEEESVG() {
  return `{% render 'icon-weee' %}`;
}

function getBatteriesSVG() {
  return `{% render 'icon-batteries' %}`;
}

function getPackagingSVG() {
  return `{% render 'icon-packaging' %}`;
}




waitForPermission(async function() {
  if (window.userPermissions['deadline'] && window.userPermissions['forsure-dashboard']) {
    results = await getReportsDue();
    createDeadlineList(results);
  }
});
</script>
